#!/bin/sh
#
# Copyright 2021, Sophos
#
# All rights reserved - Do Not Redistribute
# Script to start jilter in delivery servers during startup by checking the s3 flag

SERVER_NAME=<%= @instance_name %>
AWS_REGION="<%= @aws_region %>"
BUCKET_NAME="<%= @policy_bucket %>"
XGEMAIL_UTILS_DIR="<%= @xgemail_utils_dir %>"

enable_jilter_postfix_conf() {
  declare -a jilter_enable_configs=("smtpd_milters = inet:localhost:9876"
                                    "milter_connect_macros = {client_addr}, {j}"
                                    "milter_end_of_data_macros = {i}")

  for i in "${jilter_enable_configs[@]}"
  do
    postmulti -i postfix-$SERVER_NAME -x postconf "$i"
  done
}

echo "Enabling jilter in postfix ..."
# Update postfix to call jilter
enable_jilter_postfix_conf
