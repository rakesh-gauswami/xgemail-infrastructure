#!/bin/sh
#
# Copyright 2021, Sophos
#
# All rights reserved - Do Not Redistribute
# Script to start jilter in delivery servers during startup by checking the s3 flag

SERVER_NAME=<%= @instance_name %>
AWS_REGION="<%= @aws_region %>"
BUCKET_NAME="<%= @policy_bucket %>"
DELIVERY_JITLER_ENABLED_S3_PATH="<%= @delivery_jilter_enabled_s3_path %>"

enable_jilter_postfix_conf() {
  declare -a jilter_enable_configs=("smtpd_milters = inet:localhost:9876"
                                    "milter_connect_macros = {client_addr}, {j}"
                                    "milter_end_of_data_macros = {i}")

  for i in "${jilter_enable_configs[@]}"
  do
    postmulti -i postfix-$SERVER_NAME -x postconf "$i"
  done
}

# run the python script to check the flag
function is_jilter_enabled()
{
  flag_value=`python /opt/sophos/xgemail/utils/toggle_flag_s3.py --region $AWS_REGION --bucket $BUCKET_NAME --get $DELIVERY_JITLER_ENABLED_S3_PATH`
  echo "[$DELIVERY_JITLER_ENABLED_S3_PATH] [$flag_value]"
  if [[ $flag_value =~ "True" ]]; then
    return 0
  else
    return 1
  fi
}

if is_jilter_enabled; then
  echo "jilter is globally enabled. updating postfix with jilter config."
  # Update postfix to call jilter
  enable_jilter_postfix_conf
else
  echo "jilter is globally disabled."
fi
