<source>
  @type tail
  path /var/log/maillog
  time_format %b %d %H:%M:%S
  pos_file /var/log/td-agent/maillog.pos
  tag sophos.xgemail.<%= @application_name %>.maillog
<parse>
    @type multi_format
    <pattern>
        format regexp
        expression /^(?<time>(?:\S+\s+){2}\S+) (?<host>[^ ]+) (?<process>[^\/]+\/qmgr\[\d+\]): (?<queue_id>[0-9A-F]{6,}|[0-9a-zA-Z]{12,}): (?<message>(from=<(?<sender_address>([^>]+)(@(?<sender_domain>\S*)))>, size=(?<size>[^:]+), nrcpt=(?<nrcpt>[^:]+))? \(queue active\))/
        time_key time
        time_format %b %d %H:%M:%S
    </pattern>
    <pattern>
        format regexp
        expression /^(?<time>(?:\S+\s+){2}\S+) (?<host>[^ ]+) (?<process>[^\/]+\/qmgr\[\d+\]): (?<queue_id>[0-9A-F]{6,}|[0-9a-zA-Z]{12,}): (?<message>(removed)?)/
        time_key time
        time_format %b %d %H:%M:%S
    </pattern>
    <pattern>
        format regexp
        expression /^(?<time>(?:\S+\s+){2}\S+) (?<host>[^ ]+) (?<process>[^\/]+\/cleanup\[\d+\]): (?<queue_id>[0-9A-F]{6,}|[0-9a-zA-Z]{12,}): (?<message>(message-id=<)(?<message_id>([^>]+)).*)/
        time_key time
        time_format %b %d %H:%M:%S
    </pattern>
    <pattern>
        format regexp
        expression /^(?<time>(?:\S+\s+){2}\S+) (?<host>[^ ]+) (?<process>[^\/]+\/smtp\[\d+\]): (?<queue_id>[0-9A-F]{6,}|[0-9a-zA-Z]{12,}): (?<message>(to=<(?<rcpt_address>([^>]+)(@(?<rcpt_domain>\S*)))>, relay=(?<relay>[^:]+):(?<relay_port>[^:]+), delay=(?<delay>[^:]+), dsn=(?<dsn>[^:]+), status=(?<status>[^ ]+) \((?<status_details>[\s\S]+)\))?)/
        time_key time
        time_format %b %d %H:%M:%S
    </pattern>
    <pattern>
        format regexp
        expression /^(?<time>(?:\S+\s+){2}\S+) (?<host>[^ ]+) (?<process>[^:]+): (?<message>.*)/
        time_key time
        time_format %b %d %H:%M:%S
    </pattern>
  </parse>
</source>

<filter sophos.xgemail.<%= @application_name %>.maillog>
  @type grep
  <exclude>
    key message
    pattern \.<%= @region %>\.compute\.internal
  </exclude>
</filter>
