#!/bin/sh
#
# Copyright 2020, Sophos
#
# All rights reserved - Do Not Redistribute
# Script to toggle enable/disable sqs consumer multi-threading in delivery servers

AWS_REGION="<%= @aws_region %>"
BUCKET_NAME="<%= @policy_bucket %>"
DELIVERY_MULTITHREAD_ENABLED_S3_PATH="<%= @delivery_multithread_enabled_s3_path %>"
DELIVERY_MULTITHREAD_ENABLED_FILE_PATH="<%= @delivery_multithread_enabled_file_path %>"
XGEMAIL_UTILS_DIR="<%= xgemail_utils_dir %>"

restart_consumer() {
    echo "restarting xgemail-sqs-consumer"
    service xgemail-sqs-consumer restart
    echo "done"
}

local_disable() {
  echo "disabling local xgemail-sqs-consumer multithreading.."
  rm -rf $DELIVERY_MULTITHREAD_ENABLED_FILE_PATH
  restart_consumer
}

local_enable() {
  echo "enabling local xgemail-sqs-consumer multithreading.."
  touch $DELIVERY_MULTITHREAD_ENABLED_FILE_PATH
  restart_consumer
}

global_disable() {
  echo "disabling global xgemail-sqs-consumer multithreading.."
  # set s3 flag
  python $XGEMAIL_UTILS_DIR/toggle_flag_s3.py --region $AWS_REGION --bucket $BUCKET_NAME --unset $DELIVERY_MULTITHREAD_ENABLED_S3_PATH
}

global_enable() {
  echo "enabling global xgemail-sqs-consumer multithreading.."
  #unset s3 flag
  python $XGEMAIL_UTILS_DIR/toggle_flag_s3.py --region $AWS_REGION --bucket $BUCKET_NAME --set $DELIVERY_MULTITHREAD_ENABLED_S3_PATH
}

case "$1" in
    local_enable)
        $1
        ;;
    local_disable)
        $1
        ;;
    global_enable)
        $1
        ;;
    global_disable)
        $1
        ;;
    *)
        echo $"Usage: $0 {local_enable|local_disable|global_enable|global_disable}"
        exit 2
esac
exit $?
