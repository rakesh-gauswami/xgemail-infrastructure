#!/usr/bin/env python

import sys
sys.path.append("<%= @xgemail_utils_path %>")
import argparse
import boto3
import json
import sys
import traceback
import configformatter
import formatterutils
import gziputils
from awshandler import AwsHandler
from botocore.exceptions import ClientError

AWS_REGION = "<%= @aws_region %>"
ACCOUNT =  "<%= @account %>"
CUSTOM_ROUTE_TRANSPORT_PATH = "<%= @custom_route_transport_path %>"
CUSTOM_ROUTE_FILE_NAME       =  CUSTOM_ROUTE_TRANSPORT_PATH + "customer-delivery-custom-recipient-transport.CONFIG"

POLICY_BUCKET_NAME = "<%= @policy_bucket %>"
S3_ENCRYPTION_ALGORITHM = 'AES256'
MAGIC_NUMBER = b'\0SOPHCONFIG'
SCHEMA_VERSION = 20210215
# Nonce length is 0 because we are using AES256 algo for encrypting data along with magic byte
NONCE_LENGTH = 0
awshandler = AwsHandler(AWS_REGION)

# Binary file format with Big Endian (Network) byte order except encryption
# Magic Bytes:  { '\0', 'S', 'O', 'P', 'H', 'C', 'O', 'N', 'F', 'I', 'G' }
# Version: 64-bit long based on date
# Nonce (IV) Length: 0
# Nonce (IV): randomly generated bytes to use with AES encryption
# Blob:	custom route config data
def upload_to_s3(fileName,config_object):
  compressed_data = gziputils.gzip_data(json.dumps(config_object))
  formatted_data = formatterutils.get_formatted_object(
    MAGIC_NUMBER,
    SCHEMA_VERSION,
    NONCE_LENGTH,
    compressed_data
  )

  awshandler.upload_data_in_s3_without_expiration(
    POLICY_BUCKET_NAME,
    fileName,
    formatted_data,
    S3_ENCRYPTION_ALGORITHM
  )

def argument_parser():
    parser = argparse.ArgumentParser(description='Customer delivery recipient transport updater')
    parser.add_argument('command', metavar='command', choices=["LIST", "ADD_UPDATE", "DELETE"],help='Type of action/operation')
    parser.add_argument('--domainOrEmail', metavar='domainOrEmail', help='Domain name or email address ')
    parser.add_argument('--destination', metavar='destination',help="Destination Host/MX where mail delivered")
    parser.add_argument("--destination_type", metavar='destination_type', choices=["MX", "Host"],help='Type of Destination MX/Host')
    parser.add_argument('--port', metavar='port', type = int ,help="port number")
    parser.add_argument('--customer_id', metavar='customer_id',help="Customer id for which custom mail routing config is added.")
    args = parser.parse_args()
    portRange = range(1, 65353)
    if args.command == "DELETE":
        if args.domainOrEmail is None:
            parser.error("domainOrEmail is required attribute with command Delete")
    if args.command == "ADD_UPDATE":
        if args.domainOrEmail is None or args.destination is None or args.destination_type is None or args.port is None or args.customer_id is None:
            parser.error("All parameters are required for ADD/UPDATE record")
        if args.port not in portRange:
            parser.error("Warning: Port should be in range(1-65353) ")
    return args

if __name__ == "__main__":
    bucket_name = POLICY_BUCKET_NAME
    s3 = boto3.resource('s3')
    try:
        raw_config_data = awshandler.download_data_from_s3(POLICY_BUCKET_NAME, CUSTOM_ROUTE_FILE_NAME)
        config_data = configformatter.get_config_binary(raw_config_data)
        record = json.loads(config_data)
    except ClientError as ex:
        if ex.response['Error']['Code'] == 'NoSuchKey':
            print("Warning: Existing config file not found")
            record = {}
    args = argument_parser()
    command = args.command
    domainOrEmail = args.domainOrEmail
    if command == "ADD_UPDATE":
        if domainOrEmail is not None and domainOrEmail in record.keys():
            newObject = {}
            newObject["delivery_destination"] = {}
            newObject["delivery_destination"]["destination"] = args.destination
            newObject["delivery_destination"]["type"] = args.destination_type
            newObject["delivery_destination"]["port"] = args.port
            newObject["delivery_destination"]["customer_id"] = args.customer_id
            print("Old Record:")
            print(json.dumps(record[domainOrEmail], indent = 4))
            print("New Record:")
            print(json.dumps(newObject, indent = 4))
            query = raw_input("Do you want to Update Record. Enter 'y' to proceed further ? ")
            if query.lower() == 'y':
                record[domainOrEmail] = newObject
                # Save custom route record in file
                upload_to_s3(CUSTOM_ROUTE_FILE_NAME,record)
                print("Record Updated Successfully")
        else:
            record[domainOrEmail] = {}
            record[domainOrEmail]["delivery_destination"] = {}
            record[domainOrEmail]["delivery_destination"]["destination"] = args.destination
            record[domainOrEmail]["delivery_destination"]["type"] = args.destination_type
            record[domainOrEmail]["delivery_destination"]["port"] = args.port
            record[domainOrEmail]["delivery_destination"]["customer_id"] = args.customer_id
            print(json.dumps(record[domainOrEmail], indent = 4))
            # Save custom route record in file
            upload_to_s3(CUSTOM_ROUTE_FILE_NAME,record)
            print("Record Added Successfully")
    if command == "LIST":
        print("List of custom transport routes.")
        print(json.dumps(record, indent = 4))
    if command == "DELETE":
        if domainOrEmail is not None and domainOrEmail in record.keys():
            print(json.dumps(record[domainOrEmail], indent = 4))
            query = raw_input("Do you really want to delete Record. Enter 'y' to proceed further ? ")
            if query.lower() == 'y':
                del record[domainOrEmail]
                # Save custom route record in file
                upload_to_s3(CUSTOM_ROUTE_FILE_NAME,record)
                print("domainOrEmail {} is deleted".format(domainOrEmail))
        else:
            print("domainOrEmail {} does not exist".format(domainOrEmail))
