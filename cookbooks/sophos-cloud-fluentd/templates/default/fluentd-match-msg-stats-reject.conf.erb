# XGEMAIL_0004
# Mar  9 03:59:43 ip-172-20-0-4 postfix-is/smtpd[1237]: NOQUEUE: reject: RCPT from unknown[91.216.61.22]: 554 5.7.1 Service unavailable; Client host [91.216.61.22] is blacklisted. Visit https://www.sophos.com/en-us/threat-center/ip-lookup.aspx?ip=91.216.61.22 to request delisting; from=<badguy@bad-domain.com> to=<recipient@sophos-email-customer.com> proto=ESMTP helo=<[91.216.61.22]>
# XGEMAIL_0005
# Mar  9 03:59:43 ip-172-20-0-4 postfix-is/smtpd[1237]: NOQUEUE: reject: RCPT from unknown[192.210.213.76]: 554 5.7.1 Service unavailable; Sender address [badguy@bad-domain.com] blocked using uri.ire1.sophosxl.com; from=<badguy@bad-domain.com> to=<recipient@sophos-email-customer.com> proto=ESMTP helo=<bad-domain.com>
# XGEMAIL_0001 XGEMAIL_0003 XGEMAIL_0003
# Mar  9 03:59:43 ip-172-20-0-4 postfix-is/smtpd[1237]: NOQUEUE: milter-reject: RCPT from unknown[183.23.75.53]: 550 5.7.1 Command rejected; from=<badguy@bad-domain.com> to=<recipient@sophos-email-customer.com> proto=SMTP helo=<bad-domain.com>
# XGEMAIL_0001 XGEMAIL_0002 XGEMAIL_0003
# Mar  9 03:59:43 ip-172-20-0-4 postfix-is/smtpd[1237]: NOQUEUE: milter-reject: RCPT from unknown[183.23.75.53]: 550 5.7.1 XEMAIL_000X Command rejected; from=<badguy@bad-domain.com> to=<recipient@sophos-email-customer.com> proto=SMTP helo=<bad-domain.com>
#

<match raw.postfix.maillog>
  @type copy
   <store>
    @type rewrite_tag_filter
    <rule>
    key message
    pattern  (\.<%= @region %>.compute\.internal|table hash:|sm-msp-queue)
    tag clear
    </rule>
    <rule>
      key message
      pattern .+
      tag sophos.xgemail.<%= @application_name %>.maillog
    </rule>
   </store>
   <store>
    @type stdout
  </store>
  <store>
    @type rewrite_tag_filter
    <rule>
      key message
      pattern ([^ ]+) ([^\/]+\/smtpd\[\d+\]): ([^ ]+): (reject): ((RCPT from ([^ ]+)\[([^ ]+)\]:) (554 5.7.1 Service unavailable); (Client host \S* is blacklisted). (([^;]+)); from=<(([^>]+)(@(\S*)))> to=<(([^>]+)(@(\S*)))> proto=([^ ]+) helo=<(([^>]+))>)
      tag sns.msg_stats_reject.XGEMAIL_0004
    </rule>
    <rule>
      key message
      pattern ([^ ]+) ([^\/]+\/smtpd\[\d+\]): ([^ ]+): (reject): ((RCPT from ([^ ]+)\[([^ ]+)\]:) (554 5.7.1 Service unavailable); (Sender address \S* blocked using \S*.sophosxl.com); from=<(([^>]+)(@(\S*)))> to=<(([^>]+)(@(\S*)))> proto=([^ ]+) helo=<(([^>]+))>)
      tag sns.msg_stats_reject.XGEMAIL_0005
    </rule>
    <rule>
      key message
      pattern /XGEMAIL_0001/
      tag sns.msg_stats_reject.XGEMAIL_0001
    </rule>
    <rule>
      key message
      pattern /XGEMAIL_0002/
      tag sns.msg_stats_reject.XGEMAIL_0002
    </rule>
    <rule>
      key message
      pattern /XGEMAIL_0003/
      tag sns.msg_stats_reject.XGEMAIL_0003
    </rule>
  </store>
</match>

<match clear>
  @type null
</match>