---
- name: Create Xgemail AMI from EC2 Instance {{instance_id}}
  ec2_ami:
    description: "Sophos, Inc. Prepared image of {{build.branch}}-{{ami.xgemail.application_name}}-{{build.number}}"
    instance_id: "{{instance_id}}"
    state: present
    region: "{{ami.xgemail.region}}"
    wait: yes
    wait_timeout: 30
    name: "{{ami.xgemail.environment}}-{{build.branch}}-{{ami.xgemail.application_name}}-{{build.number}}-{{ansible_date_time.epoch}}"
    launch_permissions:
      user_ids: "{{ami.xgemail.ami_launch_permissions}}"
    tags:
      Name:         "{{ami.xgemail.environment}}-{{build.branch}}-{{ami.xgemail.application_name}}-{{build.number}}-{{ansible_date_time.epoch}}"
      branch:       "{{ami.xgemail.branch}}"
      build:        "{{ami.xgemail.build}}"
      build_id:     "{{ami.xgemail.build_id}}"
      ami_type:
  register: xgemail_ami

- name: "Set Fact xgemail_ami"
  set_fact:
    ec2_ami_image_id: "{{ xgemail_ami.results[0].image_id }}"
    when: xgemail_ami.failed != true

- name: "Display Xgemail AMI Id"
  debug:
    msg: "{{xgemail_ami.results[0].image_id}}"
    when: xgemail_ami.failed != true

- debug:
    var: xgemail_ami.results[0]
    verbosity: 3
    when: xgemail_ami.failed != true

- name: "Display Xgemail AMI Find Output"
  debug:
    msg: "{{xgemail_ami}}"
    verbosity: 3
    when: xgemail_ami.failed != true