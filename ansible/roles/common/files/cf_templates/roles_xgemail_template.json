{
  "AWSTemplateFormatVersion" : "2010-09-09",
  "Description" : "AMI builder roles template, XGEMAIL images only.",

  "Metadata": {
    "Copyright": [
      "Copyright 2018, Sophos Limited. All rights reserved.",
      "",
      "'Sophos' and 'Sophos Anti-Virus' are registered trademarks of",
      "Sophos Limited and Sophos Group.  All other product and company",
      "names mentioned are trademarks or registered trademarks of their",
      "respective owners."
    ],

    "Comments": [
      "IAM Roles Template for the Submit, Delivery, and Xdelivery Instances in the CloudEmail VPC"
    ]
  },

  "Parameters": {
    "Environment": {
      "Description": "Name of the AWS account. inf, dev, qa, prod",
      "Type": "String"
    },
    "XgemailMsgHistoryBucketName": {
      "Description": "Name of the Xgemail Message History bucket",
      "Type": "String"
    },
    "XgemailMsgHistoryMsBucketName": {
      "Description": "Name of the Xgemail Message History Micro-Service bucket",
      "Type": "String"
    },
    "XgemailPolicyBucketName": {
      "Description": "Name of the Xgemail Policy bucket",
      "Type": "String"
    },
    "XgemailQuarantineBucketName": {
      "Description": "Name of the quarantine bucket",
      "Type": "String"
    },
    "XgemailInternetSubmitBucketName": {
      "Description": "Name of the submit bucket",
      "Type": "String"
    },
    "XgemailCustomerSubmitBucketName": {
      "Description": "Name of the customer submit bucket",
      "Type": "String"
    },
    "DeliveryDirectorDynamodbTableName": {
      "Description": "Name of the delivery director dynamoDB table",
      "Type": "String"
    },
    "DeliveryDirectorBucketName": {
      "Description": "Name of the delivery director bucket",
      "Type": "String"
    }
  },

  "Resources" : {
    "AutoScalingInstanceRole" : {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [{
            "Effect": "Allow",
            "Principal": {
              "Service": [ "autoscaling.amazonaws.com" ]
            },
            "Action": [ "sts:AssumeRole" ]
          }]
        },
        "Path": "/",
        "Tags": [
          {
            "Key": "Application",
            "Value": { "Ref": "TagApplication" },
            "PropagateAtLaunch": true
          },
          {
            "Key": "BusinessUnit",
            "Value": "MSG",
            "PropagateAtLaunch": true
          },
          {
            "Key": "Name",
            "Value": { "Ref": "RoleName" },
            "PropagateAtLaunch": true
          },
          {
            "Key": "Project",
            "Value": "xgemail",
            "PropagateAtLaunch": true
          },
          {
            "Key": "OwnerEmail",
            "Value": "sophosmailops@sophos.com",
            "PropagateAtLaunch": true
          }
        ]
      }
    },
    "AutoScalingInstanceRolePolicies": {
      "Properties": {
        "PolicyDocument": {
          "Statement": [
            {
              "Action": [
                "sns:Publish"
              ],
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::Join": [
                    ":",
                    [
                      "arn:aws:sns",
                      { "Ref": "AWS::Region" },
                      { "Ref": "AWS::AccountId" },
                      "*"
                    ]
                  ]
                }
              ]
            },
            {
              "Action": [
                "sqs:GetQueueUrl",
                "sqs:SendMessage"
              ],
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::Join": [
                    ":",
                    [
                      "arn:aws:sqs",
                      {"Ref": "AWS::Region"},
                      {"Ref": "AWS::AccountId"},
                      "*"
                    ]
                  ]
                }
              ]
            }
          ]
        },
        "PolicyName": "root",
        "Roles": [
          {
            "Ref": "AutoScalingInstanceRole"
          }
        ]
      },
      "Type": "AWS::IAM::Policy"
    },

    "BastionInstanceProfile" : {
      "Type" : "AWS::IAM::InstanceProfile",
      "Properties" : {
        "Path" : "/",
        "Roles" : [
          {
            "Ref" : "BastionInstanceRole"
          }
        ]
      }
    },
    "BastionInstanceRole" : {
      "Type" : "AWS::IAM::Role",
      "Properties" : {
        "AssumeRolePolicyDocument" : {
          "Statement" : [
            {
              "Action" : ["sts:AssumeRole"],
              "Effect" : "Allow",
              "Principal" : {
                "Service" : ["ec2.amazonaws.com"]
              }
            }
          ]
        },
        "Path" : "/",
        "Tags": [
          {
            "Key": "Application",
            "Value": { "Ref": "TagApplication" },
            "PropagateAtLaunch": true
          },
          {
            "Key": "BusinessUnit",
            "Value": "MSG",
            "PropagateAtLaunch": true
          },
          {
            "Key": "Name",
            "Value": { "Ref": "RoleName" },
            "PropagateAtLaunch": true
          },
          {
            "Key": "Project",
            "Value": "xgemail",
            "PropagateAtLaunch": true
          },
          {
            "Key": "OwnerEmail",
            "Value": "sophosmailops@sophos.com",
            "PropagateAtLaunch": true
          }
        ]
      }
    },
    "BastionInstanceRolePolicies": {
      "Properties": {
        "PolicyDocument": {
          "Statement": [
            {
              "Effect": "Allow",
              "Action": [
                "iam:GetRole"
              ],
              "Resource": [
                "*"
              ]
            },
            {
              "Action": [
                "ec2:CreateTags"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action": [
                "s3:GetObject",
                "s3:PutObject",
                "s3:GetBucketLocation"

              ],
              "Effect": "Allow",
              "Resource": [
                "arn:aws:s3:::cloud-*"
              ]
            },
            {
              "Effect": "Allow",
              "Action": [
                "logs:CreateLogGroup",
                "logs:CreateLogStream",
                "logs:DescribeLogGroups",
                "logs:DescribeLogStreams",
                "logs:DescribeMetricFilters",
                "logs:PutLogEvents"
              ],
              "Resource": [
                "*"
              ]
            },
            {
              "Effect": "Allow",
              "Action": [
                "route53:ChangeResourceRecordSets",
                "route53:ListHostedZonesByName"
              ],
              "Resource": [
                "*"
              ]
            },
            {
              "Effect": "Allow",
              "Action": [
                "kms:Decrypt",
                "kms:DescribeKey",
                "kms:Encrypt",
                "kms:List*"
              ],
              "Resource": [
                "*"
              ]
            }
          ]
        },
        "PolicyName": "root",
        "Roles": [
          {
            "Ref": "BastionInstanceRole"
          }
        ]
      },
      "Type": "AWS::IAM::Policy"
    },

    "EipMonitorLambdaExecutionRole" : {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [{
            "Effect": "Allow",
            "Principal": {
              "Service": [ "lambda.amazonaws.com" ]
            },
            "Action": [ "sts:AssumeRole" ]
          }]
        },
        "Path": "/",
        "Tags": [
          {
            "Key": "Application",
            "Value": { "Ref": "TagApplication" },
            "PropagateAtLaunch": true
          },
          {
            "Key": "BusinessUnit",
            "Value": "MSG",
            "PropagateAtLaunch": true
          },
          {
            "Key": "Name",
            "Value": { "Ref": "RoleName" },
            "PropagateAtLaunch": true
          },
          {
            "Key": "Project",
            "Value": "xgemail",
            "PropagateAtLaunch": true
          },
          {
            "Key": "OwnerEmail",
            "Value": "sophosmailops@sophos.com",
            "PropagateAtLaunch": true
          }
        ]
      }
    },
    "EipMonitorLambdaExecutionRolePolicies": {
      "Properties": {
        "PolicyDocument": {
          "Statement": [
            {
              "Action": [
                "lambda:*"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action": [
                "logs:CreateLogGroup",
                "logs:CreateLogStream",
                "logs:PutLogEvents"
              ],
              "Effect": "Allow",
              "Resource": [
                "arn:aws:logs:*:*:*"
              ]
            },
            {
              "Action": [
                "ec2:CreateTags",
                "ec2:DescribeAddresses"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action" : [
                "kms:Decrypt",
                "kms:DescribeKey",
                "kms:ListAliases",
                "kms:ListKeys"
              ],
              "Effect" : "Allow",
              "Resource" : ["*"]
            },
            {
              "Action": [
                "s3:GetBucketLocation",
                "s3:ListBucket"
              ],
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::Join": [
                    "-", [
                      "arn:aws:s3:::cloud",
                      { "Ref": "Environment" },
                      "connections"
                    ]
                  ]
                }
              ]
            },
            {
              "Action": [
                "s3:GetObject"
              ],
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::Join": [
                    "-", [
                      "arn:aws:s3:::cloud",
                      { "Ref": "Environment" },
                      "connections/*"
                    ]
                  ]
                }
              ]
            }
          ]
        },
        "PolicyName": "root",
        "Roles": [
          {
            "Ref": "EipMonitorLambdaExecutionRole"
          }
        ]
      },
      "Type": "AWS::IAM::Policy"
    },

    "EipRotationLambdaExecutionRole" : {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [{
            "Effect": "Allow",
            "Principal": {
              "Service": [ "lambda.amazonaws.com" ]
            },
            "Action": [ "sts:AssumeRole" ]
          }]
        },
        "Path": "/",
        "Tags": [
          {
            "Key": "Application",
            "Value": { "Ref": "TagApplication" },
            "PropagateAtLaunch": true
          },
          {
            "Key": "BusinessUnit",
            "Value": "MSG",
            "PropagateAtLaunch": true
          },
          {
            "Key": "Name",
            "Value": { "Ref": "RoleName" },
            "PropagateAtLaunch": true
          },
          {
            "Key": "Project",
            "Value": "xgemail",
            "PropagateAtLaunch": true
          },
          {
            "Key": "OwnerEmail",
            "Value": "sophosmailops@sophos.com",
            "PropagateAtLaunch": true
          }
        ]
      }
    },
    "EipRotationLambdaExecutionRolePolicies": {
      "Properties": {
        "PolicyDocument": {
          "Statement": [
            {
              "Action": [
                "autoscaling:CompleteLifecycleAction",
                "autoscaling:DescribeAutoScalingInstances",
                "autoscaling:RecordLifecycleActionHeartbeat",
                "autoscaling:UpdateAutoScalingGroup"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action": [
                "lambda:*"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action": [
                "logs:CreateLogGroup",
                "logs:CreateLogStream",
                "logs:PutLogEvents"
              ],
              "Effect": "Allow",
              "Resource": [
                "arn:aws:logs:*:*:*"
              ]
            },
            {
              "Action": [
                "ec2:AssociateAddress",
                "ec2:CreateTags",
                "ec2:DescribeAddresses",
                "ec2:DescribeInstances",
                "ec2:DescribeInstanceStatus",
                "ec2:DisassociateAddress"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action": [
                "ssm:DescribeDocument",
                "ssm:GetCommandInvocation",
                "ssm:ListInstanceAssociations",
                "ssm:ListCommands",
                "ssm:SendCommand"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            }
          ]
        },
        "PolicyName": "root",
        "Roles": [
          {
            "Ref": "EipRotationLambdaExecutionRole"
          }
        ]
      },
      "Type": "AWS::IAM::Policy"
    },

    "FirehoseTransformationLambdaExecutionRole" : {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [{
            "Effect": "Allow",
            "Principal": {
              "Service": [ "lambda.amazonaws.com" ]
            },
            "Action": [ "sts:AssumeRole" ]
          }]
        },
        "Path": "/",
        "Tags": [
          {
            "Key": "Application",
            "Value": { "Ref": "TagApplication" },
            "PropagateAtLaunch": true
          },
          {
            "Key": "BusinessUnit",
            "Value": "MSG",
            "PropagateAtLaunch": true
          },
          {
            "Key": "Name",
            "Value": { "Ref": "RoleName" },
            "PropagateAtLaunch": true
          },
          {
            "Key": "Project",
            "Value": "xgemail",
            "PropagateAtLaunch": true
          },
          {
            "Key": "OwnerEmail",
            "Value": "sophosmailops@sophos.com",
            "PropagateAtLaunch": true
          }
        ]
      }
    },
    "FirehoseTransformationLambdaExecutionRolePolicies": {
      "Properties": {
        "PolicyDocument": {
          "Statement": [
            {
              "Action": [
                "logs:CreateLogGroup",
                "logs:CreateLogStream",
                "logs:PutLogEvents"
              ],
              "Effect": "Allow",
              "Resource": [
                "arn:aws:logs:*:*:*"
              ]
            }
          ]
        },
        "PolicyName": "root",
        "Roles": [
          {
            "Ref": "FirehoseTransformationLambdaExecutionRole"
          }
        ]
      },
      "Type": "AWS::IAM::Policy"
    },

    "LogicMonitorInstanceProfile": {
      "Properties": {
        "Path": "/",
        "Roles": [
          {
            "Ref": "LogicMonitorInstanceRole"
          }
        ]
      },
      "Type": "AWS::IAM::InstanceProfile"
    },
    "LogicMonitorInstanceRole": {
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Statement": [
            {
              "Action": [
                "sts:AssumeRole"
              ],
              "Effect": "Allow",
              "Principal": {
                "Service": [
                  "ec2.amazonaws.com"
                ]
              }
            }
          ]
        },
        "Path": "/",
        "Tags": [
          {
            "Key": "Application",
            "Value": { "Ref": "TagApplication" },
            "PropagateAtLaunch": true
          },
          {
            "Key": "BusinessUnit",
            "Value": "MSG",
            "PropagateAtLaunch": true
          },
          {
            "Key": "Name",
            "Value": { "Ref": "RoleName" },
            "PropagateAtLaunch": true
          },
          {
            "Key": "Project",
            "Value": "xgemail",
            "PropagateAtLaunch": true
          },
          {
            "Key": "OwnerEmail",
            "Value": "sophosmailops@sophos.com",
            "PropagateAtLaunch": true
          }
        ]
      },
      "Type": "AWS::IAM::Role"
    },
    "LogicMonitorInstancePolicies": {
      "Properties": {
        "PolicyDocument": {
          "Statement": [
            {
              "Action": [
                "ec2:DescribeClassicLinkInstances",
                "ec2:DescribeInstanceAttribute",
                "ec2:DescribeInstanceStatus",
                "ec2:DescribeInstances",
                "ec2:DescribeNetworkInterfaceAttribute",
                "ec2:DescribeNetworkInterfaces",
                "ec2:DescribeRegions",
                "ec2:DescribeTags",
                "ec2:DescribeVolumeAttribute",
                "ec2:DescribeVolumeStatus",
                "ec2:DescribeVolumes",
                "ec2:MonitorInstances",
                "autoscaling:DescribeAutoScalingGroups",
                "autoscaling:DescribeAutoScalingInstances",
                "autoscaling:DescribeTags"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action": [
                "s3:*"

              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },

            {
              "Effect": "Allow",
              "Action": [
                "logs:CreateLogGroup",
                "logs:CreateLogStream",
                "logs:DescribeLogGroups",
                "logs:DescribeLogStreams",
                "logs:DescribeMetricFilters",
                "logs:PutLogEvents"
              ],
              "Resource": [
                "*"
              ]
            },
            {
              "Action": [
                "ec2:DescribeInstances",
                "ec2:CreateTags"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Effect": "Allow",
              "Action": [
                "kms:Decrypt",
                "kms:DescribeKey",
                "kms:Encrypt",
                "kms:List*",
                "kms:GenerateDataKey"
              ],
              "Resource": [
                "*"
              ]
            }
          ]
        },
        "PolicyName": "root",
        "Roles": [
          {
            "Ref": "LogicMonitorInstanceRole"
          }
        ]
      },
      "Type": "AWS::IAM::Policy"
    },

    "XgemailCustomerDeliveryInstanceProfile" : {
      "Type" : "AWS::IAM::InstanceProfile",
      "Properties" : {
        "Path" : "/",
        "Roles" : [
          {
            "Ref" : "XgemailCustomerDeliveryInstanceRole"
          }
        ]
      }
    },
    "XgemailCustomerDeliveryInstanceRole" : {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "ManagedPolicyArns": [ "arn:aws:iam::aws:policy/service-role/AmazonEC2RoleforSSM" ],
        "AssumeRolePolicyDocument": {
          "Statement": [
            {
              "Action": ["sts:AssumeRole"],
              "Effect": "Allow",
              "Principal": {
                "Service": ["ec2.amazonaws.com"]
              }
            }
          ]
        },
        "Path": "/",
        "Tags": [
          {
            "Key": "Application",
            "Value": { "Ref": "TagApplication" },
            "PropagateAtLaunch": true
          },
          {
            "Key": "BusinessUnit",
            "Value": "MSG",
            "PropagateAtLaunch": true
          },
          {
            "Key": "Name",
            "Value": { "Ref": "RoleName" },
            "PropagateAtLaunch": true
          },
          {
            "Key": "Project",
            "Value": "xgemail",
            "PropagateAtLaunch": true
          },
          {
            "Key": "OwnerEmail",
            "Value": "sophosmailops@sophos.com",
            "PropagateAtLaunch": true
          }
        ]
      }
    },
    "XgemailCustomerDeliveryInstanceRolePolicies" : {
      "Type" : "AWS::IAM::Policy",
      "Properties" : {
        "PolicyDocument" : {
          "Statement" : [
            {
              "Action": [
                "autoscaling:CompleteLifecycleAction",
                "autoscaling:DescribeAutoScalingInstances",
                "autoscaling:DescribeLifecycleHooks",
                "autoscaling:RecordLifecycleActionHeartbeat",
                "autoscaling:UpdateAutoScalingGroup"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action" : [
                "ec2:AttachVolume",
                "ec2:CreateSnapshot",
                "ec2:CreateTags",
                "ec2:CreateVolume",
                "ec2:DeleteVolume",
                "ec2:DescribeImages",
                "ec2:DescribeSnapshots",
                "ec2:DescribeTags",
                "ec2:DescribeVolumes",
                "ec2:DescribeInstances",
                "ec2:DescribeInstanceAttribute",
                "ec2:DetachVolume",
                "ec2:DescribeVpcs",
                "ec2:DescribeNatGateways",
                "ec2:DescribeSubnets",
                "ec2:DescribeRouteTables",
                "ec2:ModifyInstanceAttribute",
                "ec2:ModifySnapshotAttribute"
              ],
              "Effect" : "Allow",
              "Resource" : ["*"]
            },
            {
              "Action": [
                "iam:GetRole"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action" : [
                "kms:CreateGrant",
                "kms:Decrypt",
                "kms:DescribeKey",
                "kms:Encrypt",
                "kms:GenerateDataKey",
                "kms:GenerateDataKeyWithoutPlaintext",
                "kms:List*",
                "kms:ReEncrypt*",
                "kms:RevokeGrant"
              ],
              "Effect" : "Allow",
              "Resource" : ["*"]
            },
            {
              "Action": [
                "logs:CreateLogGroup",
                "logs:CreateLogStream",
                "logs:DescribeLogGroups",
                "logs:DescribeLogStreams",
                "logs:DescribeMetricFilters",
                "logs:PutLogEvents"
              ],
              "Effect": "Allow",
              "Resource": [ "*" ]
            },
            {
              "Action" : [
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:ListBucket",
                "s3:PutObject",
                "s3:RestoreObject"
              ],
              "Effect" : "Allow",
              "Resource" : [{ "Fn::Join" : ["", ["arn:aws:s3:::", { "Ref" : "XgemailMsgHistoryBucketName" }, "/*"]]},
                { "Fn::Join" : ["", ["arn:aws:s3:::", { "Ref" : "XgemailMsgHistoryBucketName" }]]}]
            },
            {
              "Action" : [
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:ListBucket",
                "s3:PutObject",
                "s3:RestoreObject"
              ],
              "Effect" : "Allow",
              "Resource" : [{ "Fn::Join" : ["", ["arn:aws:s3:::", { "Ref" : "XgemailMsgHistoryMsBucketName" }, "/*"]]},
                { "Fn::Join" : ["", ["arn:aws:s3:::", { "Ref" : "XgemailMsgHistoryMsBucketName" }]]}]
            },
            {
              "Action" : [
                "s3:DeleteObject",
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:ListBucket",
                "s3:PutObject",
                "s3:RestoreObject"
              ],
              "Effect" : "Allow",
              "Resource" : [{ "Fn::Join" : ["", ["arn:aws:s3:::", { "Ref" : "XgemailQuarantineBucketName" }, "/*"]]},
                { "Fn::Join" : ["", ["arn:aws:s3:::", { "Ref" : "XgemailQuarantineBucketName" }]]}]
            },
            {
              "Action" : [
                "s3:DeleteObject",
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:ListBucket"
              ],
              "Effect" : "Allow",
              "Resource" : [{ "Fn::Join" : ["", ["arn:aws:s3:::", { "Ref" : "XgemailInternetSubmitBucketName" }, "/*"]]},
                { "Fn::Join" : ["", ["arn:aws:s3:::", { "Ref" : "XgemailInternetSubmitBucketName" }]]}]
            },
            {
              "Action" : [
                "s3:GetBucketLocation",
                "s3:ListBucket"
              ],
              "Effect" : "Allow",
              "Resource" : [ { "Fn::Join": [ "-", [ "arn:aws:s3:::logs-sophos-msg", { "Ref": "Environment" }, "*" ] ] } ]
            },
            {
              "Action" : [
                "s3:PutObject"
              ],
              "Effect" : "Allow",
              "Resource" : [ { "Fn::Join": [ "/", [ { "Fn::Join": [ "-", [ "arn:aws:s3:::logs-sophos-msg", { "Ref": "Environment" }, "*" ] ] }, "*" ] ] } ]
            },
            {
              "Action": [
                "s3:DeleteObject",
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:PutObject"
              ],
              "Effect": "Allow",
              "Resource": [
                "arn:aws:s3:::cloud-*"
              ]
            },
            {
              "Action": [
                "sdb:BatchDeleteAttributes",
                "sdb:BatchPutAttributes",
                "sdb:CreateDomain",
                "sdb:DeleteAttributes",
                "sdb:DeleteDomain",
                "sdb:DomainMetadata",
                "sdb:GetAttributes",
                "sdb:ListDomains",
                "sdb:PutAttributes",
                "sdb:Select"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action": [
                "sns:ListSubscriptionsByTopic",
                "sns:ListTopics",
                "sns:Publish",
                "sns:Subscribe",
                "sns:Unsubscribe"
              ],
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::Join": [
                    ":",
                    [
                      "arn:aws:sns",
                      { "Ref": "AWS::Region" },
                      { "Ref": "AWS::AccountId" },
                      "*"
                    ]
                  ]
                }
              ]
            },
            {
              "Action" : [
                "sqs:ChangeMessageVisibility",
                "sqs:CreateQueue",
                "sqs:DeleteMessage",
                "sqs:DeleteQueue",
                "sqs:GetQueueAttributes",
                "sqs:GetQueueUrl",
                "sqs:ListQueues",
                "sqs:SendMessage",
                "sqs:SetQueueAttributes",
                "sqs:ReceiveMessage"
              ],
              "Effect" : "Allow",
              "Resource" : ["*"]
            }
          ]
        },
        "PolicyName" : "root",
        "Roles" : [
          {
            "Ref" : "XgemailCustomerDeliveryInstanceRole"
          }
        ]
      }
    },

    "XgemailInternetDeliveryInstanceProfile" : {
      "Type" : "AWS::IAM::InstanceProfile",
      "Properties" : {
        "Path" : "/",
        "Roles" : [
          {
            "Ref" : "XgemailInternetDeliveryInstanceRole"
          }
        ]
      }
    },
    "XgemailInternetDeliveryInstanceRole" : {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "ManagedPolicyArns": [ "arn:aws:iam::aws:policy/service-role/AmazonEC2RoleforSSM" ],
        "AssumeRolePolicyDocument": {
          "Statement": [
            {
              "Action": ["sts:AssumeRole"],
              "Effect": "Allow",
              "Principal": {
                "Service": ["ec2.amazonaws.com"]
              }
            }
          ]
        },
        "Path": "/",
        "Tags": [
          {
            "Key": "Application",
            "Value": { "Ref": "TagApplication" },
            "PropagateAtLaunch": true
          },
          {
            "Key": "BusinessUnit",
            "Value": "MSG",
            "PropagateAtLaunch": true
          },
          {
            "Key": "Name",
            "Value": { "Ref": "RoleName" },
            "PropagateAtLaunch": true
          },
          {
            "Key": "Project",
            "Value": "xgemail",
            "PropagateAtLaunch": true
          },
          {
            "Key": "OwnerEmail",
            "Value": "sophosmailops@sophos.com",
            "PropagateAtLaunch": true
          }
        ]
      }
    },
    "XgemailInternetDeliveryInstanceRolePolicies" : {
      "Type" : "AWS::IAM::Policy",
      "Properties" : {
        "PolicyDocument" : {
          "Statement" : [
            {
              "Action": [
                "autoscaling:CompleteLifecycleAction",
                "autoscaling:DescribeAutoScalingInstances",
                "autoscaling:DescribeLifecycleHooks",
                "autoscaling:RecordLifecycleActionHeartbeat",
                "autoscaling:UpdateAutoScalingGroup"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action" : [
                "ec2:AssociateAddress",
                "ec2:AttachVolume",
                "ec2:CreateSnapshot",
                "ec2:CreateTags",
                "ec2:CreateVolume",
                "ec2:DeleteVolume",
                "ec2:DescribeAddresses",
                "ec2:DescribeImages",
                "ec2:DescribeSnapshots",
                "ec2:DescribeTags",
                "ec2:DescribeVolumes",
                "ec2:DescribeInstances",
                "ec2:DescribeInstanceAttribute",
                "ec2:DetachVolume",
                "ec2:DescribeVpcs",
                "ec2:DescribeNatGateways",
                "ec2:DescribeSubnets",
                "ec2:DescribeRouteTables",
                "ec2:ModifyInstanceAttribute",
                "ec2:ModifySnapshotAttribute"
              ],
              "Effect" : "Allow",
              "Resource" : ["*"]
            },
            {
              "Action": [
                "iam:GetRole"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action" : [
                "kms:CreateGrant",
                "kms:Decrypt",
                "kms:DescribeKey",
                "kms:Encrypt",
                "kms:GenerateDataKey",
                "kms:GenerateDataKeyWithoutPlaintext",
                "kms:List*",
                "kms:ReEncrypt*",
                "kms:RevokeGrant"
              ],
              "Effect" : "Allow",
              "Resource" : ["*"]
            },
            {
              "Action": [
                "logs:CreateLogGroup",
                "logs:CreateLogStream",
                "logs:DescribeLogGroups",
                "logs:DescribeLogStreams",
                "logs:DescribeMetricFilters",
                "logs:PutLogEvents"
              ],
              "Effect": "Allow",
              "Resource": [ "*" ]
            },
            {
              "Action" : [
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:ListBucket",
                "s3:PutObject",
                "s3:RestoreObject"
              ],
              "Effect" : "Allow",
              "Resource" : [{ "Fn::Join" : ["", ["arn:aws:s3:::", { "Ref" : "XgemailMsgHistoryBucketName" }, "/*"]]},
                { "Fn::Join" : ["", ["arn:aws:s3:::", { "Ref" : "XgemailMsgHistoryBucketName" }]]}]
            },
            {
              "Action" : [
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:ListBucket",
                "s3:PutObject",
                "s3:RestoreObject"
              ],
              "Effect" : "Allow",
              "Resource" : [{ "Fn::Join" : ["", ["arn:aws:s3:::", { "Ref" : "XgemailMsgHistoryMsBucketName" }, "/*"]]},
                { "Fn::Join" : ["", ["arn:aws:s3:::", { "Ref" : "XgemailMsgHistoryMsBucketName" }]]}]
            },
            {
              "Action" : [
                "s3:DeleteObject",
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:ListBucket"
              ],
              "Effect" : "Allow",
              "Resource" : [{ "Fn::Join" : ["", ["arn:aws:s3:::", { "Ref" : "XgemailCustomerSubmitBucketName" }, "/*"]]},
                { "Fn::Join" : ["", ["arn:aws:s3:::", { "Ref" : "XgemailCustomerSubmitBucketName" }]]}]
            },
            {
              "Action" : [
                "s3:GetBucketLocation",
                "s3:ListBucket"
              ],
              "Effect" : "Allow",
              "Resource" : [ { "Fn::Join": [ "-", [ "arn:aws:s3:::logs-sophos-msg", { "Ref": "Environment" }, "*" ] ] } ]
            },
            {
              "Action" : [
                "s3:PutObject"
              ],
              "Effect" : "Allow",
              "Resource" : [ { "Fn::Join": [ "/", [ { "Fn::Join": [ "-", [ "arn:aws:s3:::logs-sophos-msg", { "Ref": "Environment" }, "*" ] ] }, "*" ] ] } ]
            },
            {
              "Action": [
                "s3:DeleteObject",
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:PutObject"
              ],
              "Effect": "Allow",
              "Resource": [
                "arn:aws:s3:::cloud-*"
              ]
            },
            {
              "Action": [
                "sdb:BatchDeleteAttributes",
                "sdb:BatchPutAttributes",
                "sdb:CreateDomain",
                "sdb:DeleteAttributes",
                "sdb:DeleteDomain",
                "sdb:DomainMetadata",
                "sdb:GetAttributes",
                "sdb:ListDomains",
                "sdb:PutAttributes",
                "sdb:Select"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action": [
                "sns:ListSubscriptionsByTopic",
                "sns:ListTopics",
                "sns:Publish",
                "sns:Subscribe",
                "sns:Unsubscribe"
              ],
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::Join": [
                    ":",
                    [
                      "arn:aws:sns",
                      { "Ref": "AWS::Region" },
                      { "Ref": "AWS::AccountId" },
                      "*"
                    ]
                  ]
                }
              ]
            },
            {
              "Action" : [
                "sqs:ChangeMessageVisibility",
                "sqs:CreateQueue",
                "sqs:DeleteMessage",
                "sqs:DeleteQueue",
                "sqs:GetQueueAttributes",
                "sqs:GetQueueUrl",
                "sqs:ListQueues",
                "sqs:SendMessage",
                "sqs:SetQueueAttributes",
                "sqs:ReceiveMessage"
              ],
              "Effect" : "Allow",
              "Resource" : ["*"]
            }
          ]
        },
        "PolicyName" : "root",
        "Roles" : [
          {
            "Ref" : "XgemailInternetDeliveryInstanceRole"
          }
        ]
      }
    },

    "XgemailInternetSubmitInstanceProfile" : {
      "Type" : "AWS::IAM::InstanceProfile",
      "Properties" : {
        "Path" : "/",
        "Roles" : [
          {
            "Ref" : "XgemailInternetSubmitInstanceRole"
          }
        ]
      }
    },
    "XgemailInternetSubmitInstanceRole": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "ManagedPolicyArns": [ "arn:aws:iam::aws:policy/service-role/AmazonEC2RoleforSSM" ],
        "AssumeRolePolicyDocument": {
          "Statement": [
            {
              "Action": [ "sts:AssumeRole" ],
              "Effect": "Allow",
              "Principal": {
                "Service": [ "ec2.amazonaws.com" ]
              }
            }
          ]
        },
        "Path": "/",
        "Tags": [
          {
            "Key": "Application",
            "Value": { "Ref": "TagApplication" },
            "PropagateAtLaunch": true
          },
          {
            "Key": "BusinessUnit",
            "Value": "MSG",
            "PropagateAtLaunch": true
          },
          {
            "Key": "Name",
            "Value": { "Ref": "RoleName" },
            "PropagateAtLaunch": true
          },
          {
            "Key": "Project",
            "Value": "xgemail",
            "PropagateAtLaunch": true
          },
          {
            "Key": "OwnerEmail",
            "Value": "sophosmailops@sophos.com",
            "PropagateAtLaunch": true
          }
        ]
      }
    },
    "XgemailInternetSubmitInstanceRolePolicies": {
      "Type": "AWS::IAM::Policy",
      "Properties": {
        "PolicyDocument": {
          "Statement": [
            {
              "Action": [
                "autoscaling:CompleteLifecycleAction",
                "autoscaling:DescribeAutoScalingInstances",
                "autoscaling:DescribeLifecycleHooks",
                "autoscaling:RecordLifecycleActionHeartbeat",
                "autoscaling:UpdateAutoScalingGroup"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action": [
                "ec2:AttachVolume",
                "ec2:CreateSnapshot",
                "ec2:CreateTags",
                "ec2:CreateVolume",
                "ec2:DeleteVolume",
                "ec2:DescribeImages",
                "ec2:DescribeSnapshots",
                "ec2:DescribeTags",
                "ec2:DescribeVolumes",
                "ec2:DescribeInstances",
                "ec2:DescribeInstanceAttribute",
                "ec2:DetachVolume",
                "ec2:DescribeVpcs",
                "ec2:DescribeNatGateways",
                "ec2:DescribeSubnets",
                "ec2:DescribeRouteTables",
                "ec2:ModifyInstanceAttribute",
                "ec2:ModifySnapshotAttribute"
              ],
              "Effect": "Allow",
              "Resource": [ "*" ]
            },
            {
              "Action": [
                "iam:GetRole"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action": [
                "kms:CreateGrant",
                "kms:Decrypt",
                "kms:DescribeKey",
                "kms:Encrypt",
                "kms:GenerateDataKey",
                "kms:GenerateDataKeyWithoutPlaintext",
                "kms:List*",
                "kms:ReEncrypt*",
                "kms:RevokeGrant"
              ],
              "Effect": "Allow",
              "Resource": [ "*" ]
            },
            {
              "Action": [
                "logs:CreateLogGroup",
                "logs:CreateLogStream",
                "logs:DescribeLogGroups",
                "logs:DescribeLogStreams",
                "logs:DescribeMetricFilters",
                "logs:PutLogEvents"
              ],
              "Effect": "Allow",
              "Resource": [ "*" ]
            },
            {
              "Action": [
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:ListBucket",
                "s3:PutObject",
                "s3:RestoreObject"
              ],
              "Effect": "Allow",
              "Resource": [
                { "Fn::Join": [ "", [ "arn:aws:s3:::", { "Ref": "XgemailMsgHistoryBucketName" }, "/*" ] ] },
                { "Fn::Join": [ "", [ "arn:aws:s3:::", { "Ref": "XgemailMsgHistoryBucketName" } ] ] }
              ]
            },
            {
              "Action": [
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:ListBucket",
                "s3:PutObject",
                "s3:RestoreObject"
              ],
              "Effect": "Allow",
              "Resource": [
                { "Fn::Join": [ "", [ "arn:aws:s3:::", { "Ref": "XgemailMsgHistoryMsBucketName" }, "/*" ] ] },
                { "Fn::Join": [ "", [ "arn:aws:s3:::", { "Ref": "XgemailMsgHistoryMsBucketName" } ] ] }
              ]
            },
            {
              "Action": [
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:ListBucket"
              ],
              "Effect": "Allow",
              "Resource": [
                { "Fn::Join": [ "", [ "arn:aws:s3:::", { "Ref": "XgemailPolicyBucketName" }, "/*" ] ] },
                { "Fn::Join": [ "", [ "arn:aws:s3:::", { "Ref": "XgemailPolicyBucketName" } ] ] }
              ]
            },
            {
              "Action": [
                "s3:DeleteObject",
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:ListBucket",
                "s3:PutObject",
                "s3:RestoreObject"
              ],
              "Effect": "Allow",
              "Resource": [
                { "Fn::Join": [ "", [ "arn:aws:s3:::", { "Ref": "XgemailQuarantineBucketName" }, "/*" ] ] },
                { "Fn::Join": [ "", [ "arn:aws:s3:::", { "Ref": "XgemailQuarantineBucketName" } ] ] }
              ]
            },
            {
              "Action": [
                "s3:GetBucketLocation",
                "s3:ListBucket",
                "s3:PutObject"
              ],
              "Effect": "Allow",
              "Resource": [
                { "Fn::Join": [ "", [ "arn:aws:s3:::", { "Ref": "XgemailInternetSubmitBucketName" }, "/*" ] ] },
                { "Fn::Join": [ "", [ "arn:aws:s3:::", { "Ref": "XgemailInternetSubmitBucketName" } ] ] }
              ]
            },
            {
              "Action" : [
                "s3:GetBucketLocation",
                "s3:ListBucket"
              ],
              "Effect" : "Allow",
              "Resource" : [ { "Fn::Join": [ "-", [ "arn:aws:s3:::logs-sophos-msg", { "Ref": "Environment" }, "*" ] ] } ]
            },
            {
              "Action" : [
                "s3:PutObject"
              ],
              "Effect" : "Allow",
              "Resource" : [ { "Fn::Join": [ "/", [ { "Fn::Join": [ "-", [ "arn:aws:s3:::logs-sophos-msg", { "Ref": "Environment" }, "*" ] ] }, "*" ] ] } ]
            },
            {
              "Action": [
                "s3:DeleteObject",
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:PutObject"
              ],
              "Effect": "Allow",
              "Resource": [
                "arn:aws:s3:::cloud-*"
              ]
            },
            {
              "Action": [
                "sdb:BatchDeleteAttributes",
                "sdb:BatchPutAttributes",
                "sdb:CreateDomain",
                "sdb:DeleteAttributes",
                "sdb:DeleteDomain",
                "sdb:DomainMetadata",
                "sdb:GetAttributes",
                "sdb:ListDomains",
                "sdb:PutAttributes",
                "sdb:Select"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action": [
                "sns:GetSubscriptionAttributes",
                "sns:ListSubscriptionsByTopic",
                "sns:ListTopics",
                "sns:Publish",
                "sns:Subscribe",
                "sns:Unsubscribe"
              ],
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::Join": [
                    ":",
                    [
                      "arn:aws:sns",
                      { "Ref": "AWS::Region" },
                      { "Ref": "AWS::AccountId" },
                      "*"
                    ]
                  ]
                }
              ]
            },
            {
              "Action": [
                "sqs:ChangeMessageVisibility",
                "sqs:CreateQueue",
                "sqs:DeleteMessage",
                "sqs:DeleteQueue",
                "sqs:GetQueueAttributes",
                "sqs:GetQueueUrl",
                "sqs:ListQueues",
                "sqs:SendMessage",
                "sqs:SetQueueAttributes",
                "sqs:ReceiveMessage"
              ],
              "Effect": "Allow",
              "Resource": [ "*" ]
            },
            {
              "Action": [
                "cloudwatch:putMetricData"
              ],
              "Effect": "Allow",
              "Resource": [ "*" ]
            }
          ]
        },
        "PolicyName": "root",
        "Roles": [
          {
            "Ref": "XgemailInternetSubmitInstanceRole"
          }
        ]
      }
    },

    "XgemailCustomerSubmitInstanceProfile" : {
      "Type" : "AWS::IAM::InstanceProfile",
      "Properties" : {
        "Path" : "/",
        "Roles" : [
          {
            "Ref" : "XgemailCustomerSubmitInstanceRole"
          }
        ]
      }
    },
    "XgemailCustomerSubmitInstanceRole": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "ManagedPolicyArns": [ "arn:aws:iam::aws:policy/service-role/AmazonEC2RoleforSSM" ],
        "AssumeRolePolicyDocument": {
          "Statement": [
            {
              "Action": [ "sts:AssumeRole" ],
              "Effect": "Allow",
              "Principal": {
                "Service": [ "ec2.amazonaws.com" ]
              }
            }
          ]
        },
        "Path": "/",
        "Tags": [
          {
            "Key": "Application",
            "Value": { "Ref": "TagApplication" },
            "PropagateAtLaunch": true
          },
          {
            "Key": "BusinessUnit",
            "Value": "MSG",
            "PropagateAtLaunch": true
          },
          {
            "Key": "Name",
            "Value": { "Ref": "RoleName" },
            "PropagateAtLaunch": true
          },
          {
            "Key": "Project",
            "Value": "xgemail",
            "PropagateAtLaunch": true
          },
          {
            "Key": "OwnerEmail",
            "Value": "sophosmailops@sophos.com",
            "PropagateAtLaunch": true
          }
        ]
      }
    },
    "XgemailCustomerSubmitInstanceRolePolicies": {
      "Type": "AWS::IAM::Policy",
      "Properties": {
        "PolicyDocument": {
          "Statement": [
            {
              "Action": [
                "autoscaling:CompleteLifecycleAction",
                "autoscaling:DescribeAutoScalingInstances",
                "autoscaling:DescribeLifecycleHooks",
                "autoscaling:RecordLifecycleActionHeartbeat",
                "autoscaling:UpdateAutoScalingGroup"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action": [
                "ec2:AttachVolume",
                "ec2:CreateSnapshot",
                "ec2:CreateTags",
                "ec2:CreateVolume",
                "ec2:DeleteVolume",
                "ec2:DescribeImages",
                "ec2:DescribeSnapshots",
                "ec2:DescribeTags",
                "ec2:DescribeVolumes",
                "ec2:DescribeInstances",
                "ec2:DescribeInstanceAttribute",
                "ec2:DetachVolume",
                "ec2:DescribeVpcs",
                "ec2:DescribeNatGateways",
                "ec2:DescribeSubnets",
                "ec2:DescribeRouteTables",
                "ec2:ModifyInstanceAttribute",
                "ec2:ModifySnapshotAttribute"
              ],
              "Effect": "Allow",
              "Resource": [ "*" ]
            },
            {
              "Action": [
                "iam:GetRole"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action": [
                "kms:CreateGrant",
                "kms:Decrypt",
                "kms:DescribeKey",
                "kms:Encrypt",
                "kms:GenerateDataKey",
                "kms:GenerateDataKeyWithoutPlaintext",
                "kms:List*",
                "kms:ReEncrypt*",
                "kms:RevokeGrant"
              ],
              "Effect": "Allow",
              "Resource": [ "*" ]
            },
            {
              "Action": [
                "logs:CreateLogGroup",
                "logs:CreateLogStream",
                "logs:DescribeLogGroups",
                "logs:DescribeLogStreams",
                "logs:DescribeMetricFilters",
                "logs:PutLogEvents"
              ],
              "Effect": "Allow",
              "Resource": [ "*" ]
            },
            {
              "Action": [
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:ListBucket",
                "s3:PutObject",
                "s3:RestoreObject"
              ],
              "Effect": "Allow",
              "Resource": [
                { "Fn::Join": [ "", [ "arn:aws:s3:::", { "Ref": "XgemailMsgHistoryBucketName" }, "/*" ] ] },
                { "Fn::Join": [ "", [ "arn:aws:s3:::", { "Ref": "XgemailMsgHistoryBucketName" } ] ] }
              ]
            },
            {
              "Action": [
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:ListBucket",
                "s3:PutObject",
                "s3:RestoreObject"
              ],
              "Effect": "Allow",
              "Resource": [
                { "Fn::Join": [ "", [ "arn:aws:s3:::", { "Ref": "XgemailMsgHistoryMsBucketName" }, "/*" ] ] },
                { "Fn::Join": [ "", [ "arn:aws:s3:::", { "Ref": "XgemailMsgHistoryMsBucketName" } ] ] }
              ]
            },
            {
              "Action": [
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:ListBucket"
              ],
              "Effect": "Allow",
              "Resource": [
                { "Fn::Join": [ "", [ "arn:aws:s3:::", { "Ref": "XgemailPolicyBucketName" }, "/*" ] ] },
                { "Fn::Join": [ "", [ "arn:aws:s3:::", { "Ref": "XgemailPolicyBucketName" } ] ] }
              ]
            },
            {
              "Action": [
                "s3:GetBucketLocation",
                "s3:ListBucket",
                "s3:PutObject"
              ],
              "Effect": "Allow",
              "Resource": [
                { "Fn::Join": [ "", [ "arn:aws:s3:::", { "Ref": "XgemailCustomerSubmitBucketName" }, "/*" ] ] },
                { "Fn::Join": [ "", [ "arn:aws:s3:::", { "Ref": "XgemailCustomerSubmitBucketName" } ] ] }
              ]
            },
            {
              "Action" : [
                "s3:GetBucketLocation",
                "s3:ListBucket"
              ],
              "Effect" : "Allow",
              "Resource" : [ { "Fn::Join": [ "-", [ "arn:aws:s3:::logs-sophos-msg", { "Ref": "Environment" }, "*" ] ] } ]
            },
            {
              "Action" : [
                "s3:PutObject"
              ],
              "Effect" : "Allow",
              "Resource" : [ { "Fn::Join": [ "/", [ { "Fn::Join": [ "-", [ "arn:aws:s3:::logs-sophos-msg", { "Ref": "Environment" }, "*" ] ] }, "*" ] ] } ]
            },
            {
              "Action": [
                "s3:DeleteObject",
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:PutObject"
              ],
              "Effect": "Allow",
              "Resource": [
                "arn:aws:s3:::cloud-*"
              ]
            },
            {
              "Action": [
                "sdb:BatchDeleteAttributes",
                "sdb:BatchPutAttributes",
                "sdb:CreateDomain",
                "sdb:DeleteAttributes",
                "sdb:DeleteDomain",
                "sdb:DomainMetadata",
                "sdb:GetAttributes",
                "sdb:ListDomains",
                "sdb:PutAttributes",
                "sdb:Select"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action": [
                "sns:GetSubscriptionAttributes",
                "sns:ListSubscriptionsByTopic",
                "sns:ListTopics",
                "sns:Publish",
                "sns:Subscribe",
                "sns:Unsubscribe"
              ],
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::Join": [
                    ":",
                    [
                      "arn:aws:sns",
                      { "Ref": "AWS::Region" },
                      { "Ref": "AWS::AccountId" },
                      "*"
                    ]
                  ]
                }
              ]
            },
            {
              "Action": [
                "sqs:ChangeMessageVisibility",
                "sqs:CreateQueue",
                "sqs:DeleteMessage",
                "sqs:DeleteQueue",
                "sqs:GetQueueAttributes",
                "sqs:GetQueueUrl",
                "sqs:ListQueues",
                "sqs:SendMessage",
                "sqs:SetQueueAttributes",
                "sqs:ReceiveMessage"
              ],
              "Effect": "Allow",
              "Resource": [ "*" ]
            },
            {
              "Action": [
                "cloudwatch:putMetricData"
              ],
              "Effect": "Allow",
              "Resource": [ "*" ]
            },
            {
              "Action": [
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:ListBucket",
                "s3:PutObject"
              ],
              "Effect": "Allow",
              "Resource": [
                { "Fn::Join": [ "", [ "arn:aws:s3:::", { "Ref": "DeliveryDirectorBucketName" }, "/*" ] ] },
                { "Fn::Join": [ "", [ "arn:aws:s3:::", { "Ref": "DeliveryDirectorBucketName" } ] ] }
              ]
            },
            {
              "Action": [
                "dynamodb:BatchWriteItem",
                "dynamodb:DeleteItem",
                "dynamodb:BatchGetItem",
                "dynamodb:Scan",
                "dynamodb:ListTables",
                "dynamodb:GetItem",
                "dynamodb:GetRecords",
                "dynamodb:DescribeTable",
                "dynamodb:PutItem",
                "dynamodb:Query",
                "dynamodb:UpdateItem",
                "dynamodb:UpdateTable"
              ],
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::Sub": "arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${DeliveryDirectorDynamodbTableName}"
                }
              ]
            }
          ]
        },
        "PolicyName": "root",
        "Roles": [
          {
            "Ref": "XgemailCustomerSubmitInstanceRole"
          }
        ]
      }
    },

    "XgemailEncryptionDeliveryInstanceProfile": {
      "Type": "AWS::IAM::InstanceProfile",
      "Properties": {
        "Path": "/",
        "Roles": [
          {
            "Ref": "XgemailEncryptionDeliveryInstanceRole"
          }
        ]
      }
    },
    "XgemailEncryptionDeliveryInstanceRole": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "ManagedPolicyArns": [ "arn:aws:iam::aws:policy/service-role/AmazonEC2RoleforSSM" ],
        "AssumeRolePolicyDocument": {
          "Statement": [
            {
              "Action": [ "sts:AssumeRole" ],
              "Effect": "Allow",
              "Principal": {
                "Service": [ "ec2.amazonaws.com" ]
              }
            }
          ]
        },
        "Path": "/",
        "Tags": [
          {
            "Key": "Application",
            "Value": { "Ref": "TagApplication" },
            "PropagateAtLaunch": true
          },
          {
            "Key": "BusinessUnit",
            "Value": "MSG",
            "PropagateAtLaunch": true
          },
          {
            "Key": "Name",
            "Value": { "Ref": "RoleName" },
            "PropagateAtLaunch": true
          },
          {
            "Key": "Project",
            "Value": "xgemail",
            "PropagateAtLaunch": true
          },
          {
            "Key": "OwnerEmail",
            "Value": "sophosmailops@sophos.com",
            "PropagateAtLaunch": true
          }
        ]
      }
    },
    "XgemailEncryptionDeliveryInstanceRolePolicies" : {
      "Type" : "AWS::IAM::Policy",
      "Properties" : {
        "PolicyDocument" : {
          "Statement" : [
            {
              "Action": [
                "autoscaling:CompleteLifecycleAction",
                "autoscaling:DescribeAutoScalingInstances",
                "autoscaling:RecordLifecycleActionHeartbeat",
                "autoscaling:UpdateAutoScalingGroup"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action" : [
                "ec2:AttachVolume",
                "ec2:CreateSnapshot",
                "ec2:CreateTags",
                "ec2:CreateVolume",
                "ec2:DeleteVolume",
                "ec2:DescribeImages",
                "ec2:DescribeSnapshots",
                "ec2:DescribeTags",
                "ec2:DescribeVolumes",
                "ec2:DescribeInstances",
                "ec2:DescribeInstanceAttribute",
                "ec2:DetachVolume",
                "ec2:DescribeVpcs",
                "ec2:DescribeNatGateways",
                "ec2:DescribeSubnets",
                "ec2:DescribeRouteTables",
                "ec2:ModifyInstanceAttribute",
                "ec2:ModifySnapshotAttribute"
              ],
              "Effect" : "Allow",
              "Resource" : ["*"]
            },
            {
              "Action": [
                "iam:GetRole"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action" : [
                "kms:CreateGrant",
                "kms:Decrypt",
                "kms:DescribeKey",
                "kms:Encrypt",
                "kms:GenerateDataKey",
                "kms:GenerateDataKeyWithoutPlaintext",
                "kms:List*",
                "kms:ReEncrypt*",
                "kms:RevokeGrant"
              ],
              "Effect" : "Allow",
              "Resource" : ["*"]
            },
            {
              "Action": [
                "logs:CreateLogGroup",
                "logs:CreateLogStream",
                "logs:DescribeLogGroups",
                "logs:DescribeLogStreams",
                "logs:DescribeMetricFilters",
                "logs:PutLogEvents"
              ],
              "Effect": "Allow",
              "Resource": [ "*" ]
            },
            {
              "Action" : [
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:ListBucket",
                "s3:PutObject",
                "s3:RestoreObject"
              ],
              "Effect" : "Allow",
              "Resource" : [{ "Fn::Join" : ["", ["arn:aws:s3:::", { "Ref" : "XgemailMsgHistoryBucketName" }, "/*"]]},
                { "Fn::Join" : ["", ["arn:aws:s3:::", { "Ref" : "XgemailMsgHistoryBucketName" }]]}]
            },
            {
              "Action" : [
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:ListBucket",
                "s3:PutObject",
                "s3:RestoreObject"
              ],
              "Effect" : "Allow",
              "Resource" : [{ "Fn::Join" : ["", ["arn:aws:s3:::", { "Ref" : "XgemailMsgHistoryMsBucketName" }, "/*"]]},
                { "Fn::Join" : ["", ["arn:aws:s3:::", { "Ref" : "XgemailMsgHistoryMsBucketName" }]]}]
            },
            {
              "Action" : [
                "s3:DeleteObject",
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:ListBucket",
                "s3:PutObject",
                "s3:RestoreObject"
              ],
              "Effect" : "Allow",
              "Resource" : [{ "Fn::Join" : ["", ["arn:aws:s3:::", { "Ref" : "XgemailQuarantineBucketName" }, "/*"]]},
                { "Fn::Join" : ["", ["arn:aws:s3:::", { "Ref" : "XgemailQuarantineBucketName" }]]}]
            },
            {
              "Action" : [
                "s3:DeleteObject",
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:ListBucket"
              ],
              "Effect" : "Allow",
              "Resource" : [{ "Fn::Join" : ["", ["arn:aws:s3:::", { "Ref" : "XgemailInternetSubmitBucketName" }, "/*"]]},
                { "Fn::Join" : ["", ["arn:aws:s3:::", { "Ref" : "XgemailInternetSubmitBucketName" }]]}]
            },
            {
              "Action" : [
                "s3:GetBucketLocation",
                "s3:ListBucket"
              ],
              "Effect" : "Allow",
              "Resource" : [ { "Fn::Join": [ "-", [ "arn:aws:s3:::logs-sophos-msg", { "Ref": "Environment" }, "*" ] ] } ]
            },
            {
              "Action" : [
                "s3:PutObject"
              ],
              "Effect" : "Allow",
              "Resource" : [ { "Fn::Join": [ "/", [ { "Fn::Join": [ "-", [ "arn:aws:s3:::logs-sophos-msg", { "Ref": "Environment" }, "*" ] ] }, "*" ] ] } ]
            },
            {
              "Action": [
                "s3:DeleteObject",
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:PutObject"
              ],
              "Effect": "Allow",
              "Resource": [
                "arn:aws:s3:::cloud-*"
              ]
            },
            {
              "Action": [
                "sdb:BatchDeleteAttributes",
                "sdb:BatchPutAttributes",
                "sdb:CreateDomain",
                "sdb:DeleteAttributes",
                "sdb:DeleteDomain",
                "sdb:DomainMetadata",
                "sdb:GetAttributes",
                "sdb:ListDomains",
                "sdb:PutAttributes",
                "sdb:Select"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action": [
                "sns:ListSubscriptionsByTopic",
                "sns:ListTopics",
                "sns:Publish",
                "sns:Subscribe",
                "sns:Unsubscribe"
              ],
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::Join": [
                    ":",
                    [
                      "arn:aws:sns",
                      { "Ref": "AWS::Region" },
                      { "Ref": "AWS::AccountId" },
                      "*"
                    ]
                  ]
                }
              ]
            },
            {
              "Action" : [
                "sqs:ChangeMessageVisibility",
                "sqs:CreateQueue",
                "sqs:DeleteMessage",
                "sqs:DeleteQueue",
                "sqs:GetQueueAttributes",
                "sqs:GetQueueUrl",
                "sqs:ListQueues",
                "sqs:SendMessage",
                "sqs:SetQueueAttributes",
                "sqs:ReceiveMessage"
              ],
              "Effect" : "Allow",
              "Resource" : ["*"]
            }
          ]
        },
        "PolicyName" : "root",
        "Roles" : [
          {
            "Ref" : "XgemailEncryptionDeliveryInstanceRole"
          }
        ]
      }
    },

    "XgemailEncryptionSubmitInstanceProfile": {
      "Type": "AWS::IAM::InstanceProfile",
      "Properties": {
        "Path": "/",
        "Roles": [
          {
            "Ref": "XgemailEncryptionSubmitInstanceRole"
          }
        ]
      }
    },
    "XgemailEncryptionSubmitInstanceRole": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "ManagedPolicyArns": [ "arn:aws:iam::aws:policy/service-role/AmazonEC2RoleforSSM" ],
        "AssumeRolePolicyDocument": {
          "Statement": [
            {
              "Action": [ "sts:AssumeRole" ],
              "Effect": "Allow",
              "Principal": {
                "Service": [ "ec2.amazonaws.com" ]
              }
            }
          ]
        },
        "Path": "/",
        "Tags": [
          {
            "Key": "Application",
            "Value": { "Ref": "TagApplication" },
            "PropagateAtLaunch": true
          },
          {
            "Key": "BusinessUnit",
            "Value": "MSG",
            "PropagateAtLaunch": true
          },
          {
            "Key": "Name",
            "Value": { "Ref": "RoleName" },
            "PropagateAtLaunch": true
          },
          {
            "Key": "Project",
            "Value": "xgemail",
            "PropagateAtLaunch": true
          },
          {
            "Key": "OwnerEmail",
            "Value": "sophosmailops@sophos.com",
            "PropagateAtLaunch": true
          }
        ]
      }
    },
    "XgemailEncryptionSubmitInstanceRolePolicies" : {
      "Type" : "AWS::IAM::Policy",
      "Properties" : {
        "PolicyDocument" : {
          "Statement" : [
            {
              "Action": [
                "autoscaling:CompleteLifecycleAction",
                "autoscaling:DescribeAutoScalingInstances",
                "autoscaling:RecordLifecycleActionHeartbeat",
                "autoscaling:UpdateAutoScalingGroup"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action" : [
                "ec2:AttachVolume",
                "ec2:CreateSnapshot",
                "ec2:CreateTags",
                "ec2:CreateVolume",
                "ec2:DeleteVolume",
                "ec2:DescribeImages",
                "ec2:DescribeSnapshots",
                "ec2:DescribeTags",
                "ec2:DescribeVolumes",
                "ec2:DescribeInstances",
                "ec2:DescribeInstanceAttribute",
                "ec2:DetachVolume",
                "ec2:DescribeVpcs",
                "ec2:DescribeNatGateways",
                "ec2:DescribeSubnets",
                "ec2:DescribeRouteTables",
                "ec2:ModifyInstanceAttribute",
                "ec2:ModifySnapshotAttribute"
              ],
              "Effect" : "Allow",
              "Resource" : ["*"]
            },
            {
              "Action": [
                "iam:GetRole"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action" : [
                "kms:CreateGrant",
                "kms:Decrypt",
                "kms:DescribeKey",
                "kms:Encrypt",
                "kms:GenerateDataKey",
                "kms:GenerateDataKeyWithoutPlaintext",
                "kms:List*",
                "kms:ReEncrypt*",
                "kms:RevokeGrant"
              ],
              "Effect" : "Allow",
              "Resource" : ["*"]
            },
            {
              "Action": [
                "logs:CreateLogGroup",
                "logs:CreateLogStream",
                "logs:DescribeLogGroups",
                "logs:DescribeLogStreams",
                "logs:DescribeMetricFilters",
                "logs:PutLogEvents"
              ],
              "Effect": "Allow",
              "Resource": [ "*" ]
            },
            {
              "Action" : [
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:ListBucket",
                "s3:PutObject",
                "s3:RestoreObject"
              ],
              "Effect" : "Allow",
              "Resource" : [{ "Fn::Join" : ["", ["arn:aws:s3:::", { "Ref" : "XgemailMsgHistoryBucketName" }, "/*"]]},
                { "Fn::Join" : ["", ["arn:aws:s3:::", { "Ref" : "XgemailMsgHistoryBucketName" }]]}]
            },
            {
              "Action" : [
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:ListBucket",
                "s3:PutObject",
                "s3:RestoreObject"
              ],
              "Effect" : "Allow",
              "Resource" : [{ "Fn::Join" : ["", ["arn:aws:s3:::", { "Ref" : "XgemailMsgHistoryMsBucketName" }, "/*"]]},
                { "Fn::Join" : ["", ["arn:aws:s3:::", { "Ref" : "XgemailMsgHistoryMsBucketName" }]]}]
            },
            {
              "Action" : [
                "s3:DeleteObject",
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:ListBucket",
                "s3:PutObject",
                "s3:RestoreObject"
              ],
              "Effect" : "Allow",
              "Resource" : [{ "Fn::Join" : ["", ["arn:aws:s3:::", { "Ref" : "XgemailQuarantineBucketName" }, "/*"]]},
                { "Fn::Join" : ["", ["arn:aws:s3:::", { "Ref" : "XgemailQuarantineBucketName" }]]}]
            },
            {
              "Action" : [
                "s3:DeleteObject",
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:ListBucket"
              ],
              "Effect" : "Allow",
              "Resource" : [{ "Fn::Join" : ["", ["arn:aws:s3:::", { "Ref" : "XgemailInternetSubmitBucketName" }, "/*"]]},
                { "Fn::Join" : ["", ["arn:aws:s3:::", { "Ref" : "XgemailInternetSubmitBucketName" }]]}]
            },
            {
              "Action" : [
                "s3:GetBucketLocation",
                "s3:ListBucket"
              ],
              "Effect" : "Allow",
              "Resource" : [ { "Fn::Join": [ "-", [ "arn:aws:s3:::logs-sophos-msg", { "Ref": "Environment" }, "*" ] ] } ]
            },
            {
              "Action" : [
                "s3:PutObject"
              ],
              "Effect" : "Allow",
              "Resource" : [ { "Fn::Join": [ "/", [ { "Fn::Join": [ "-", [ "arn:aws:s3:::logs-sophos-msg", { "Ref": "Environment" }, "*" ] ] }, "*" ] ] } ]
            },
            {
              "Action": [
                "s3:DeleteObject",
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:PutObject"
              ],
              "Effect": "Allow",
              "Resource": [
                "arn:aws:s3:::cloud-*"
              ]
            },
            {
              "Action": [
                "sdb:BatchDeleteAttributes",
                "sdb:BatchPutAttributes",
                "sdb:CreateDomain",
                "sdb:DeleteAttributes",
                "sdb:DeleteDomain",
                "sdb:DomainMetadata",
                "sdb:GetAttributes",
                "sdb:ListDomains",
                "sdb:PutAttributes",
                "sdb:Select"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action": [
                "sns:ListSubscriptionsByTopic",
                "sns:ListTopics",
                "sns:Publish",
                "sns:Subscribe",
                "sns:Unsubscribe"
              ],
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::Join": [
                    ":",
                    [
                      "arn:aws:sns",
                      { "Ref": "AWS::Region" },
                      { "Ref": "AWS::AccountId" },
                      "*"
                    ]
                  ]
                }
              ]
            },
            {
              "Action" : [
                "sqs:ChangeMessageVisibility",
                "sqs:CreateQueue",
                "sqs:DeleteMessage",
                "sqs:DeleteQueue",
                "sqs:GetQueueAttributes",
                "sqs:GetQueueUrl",
                "sqs:ListQueues",
                "sqs:SendMessage",
                "sqs:SetQueueAttributes",
                "sqs:ReceiveMessage"
              ],
              "Effect" : "Allow",
              "Resource" : ["*"]
            }
          ]
        },
        "PolicyName" : "root",
        "Roles" : [
          {
            "Ref" : "XgemailEncryptionSubmitInstanceRole"
          }
        ]
      }
    },

    "XgemailXdeliveryInstanceProfile": {
      "Type": "AWS::IAM::InstanceProfile",
      "Properties": {
        "Path": "/",
        "Roles": [
          {
            "Ref": "XgemailXdeliveryInstanceRole"
          }
        ]
      }
    },
    "XgemailXdeliveryInstanceRole": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "ManagedPolicyArns": [ "arn:aws:iam::aws:policy/service-role/AmazonEC2RoleforSSM" ],
        "AssumeRolePolicyDocument": {
          "Statement": [
            {
              "Action": [ "sts:AssumeRole" ],
              "Effect": "Allow",
              "Principal": {
                "Service": [ "ec2.amazonaws.com" ]
              }
            }
          ]
        },
        "Path": "/",
        "Tags": [
          {
            "Key": "Application",
            "Value": { "Ref": "TagApplication" },
            "PropagateAtLaunch": true
          },
          {
            "Key": "BusinessUnit",
            "Value": "MSG",
            "PropagateAtLaunch": true
          },
          {
            "Key": "Name",
            "Value": { "Ref": "RoleName" },
            "PropagateAtLaunch": true
          },
          {
            "Key": "Project",
            "Value": "xgemail",
            "PropagateAtLaunch": true
          },
          {
            "Key": "OwnerEmail",
            "Value": "sophosmailops@sophos.com",
            "PropagateAtLaunch": true
          }
        ]
      }
    },
    "XgemailXdeliveryInstanceRolePolicies": {
      "Type": "AWS::IAM::Policy",
      "Properties": {
        "PolicyDocument": {
          "Statement": [
            {
              "Action": [
                "autoscaling:UpdateAutoScalingGroup",
                "autoscaling:DescribeAutoScalingInstances"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action": [
                "ec2:AttachVolume",
                "ec2:CreateSnapshot",
                "ec2:CreateTags",
                "ec2:CreateVolume",
                "ec2:DescribeImages",
                "ec2:DescribeSnapshots",
                "ec2:DescribeTags",
                "ec2:DescribeVolumes",
                "ec2:DescribeInstances",
                "ec2:DescribeInstanceAttribute",
                "ec2:DetachVolume",
                "ec2:DescribeVpcs",
                "ec2:DescribeNatGateways",
                "ec2:DescribeSubnets",
                "ec2:DescribeRouteTables",
                "ec2:ModifyInstanceAttribute",
                "ec2:ModifySnapshotAttribute"
              ],
              "Effect": "Allow",
              "Resource": [ "*" ]
            },
            {
              "Action": [
                "iam:GetRole"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action": [
                "kms:CreateGrant",
                "kms:Decrypt",
                "kms:DescribeKey",
                "kms:Encrypt",
                "kms:GenerateDataKey",
                "kms:GenerateDataKeyWithoutPlaintext",
                "kms:List*",
                "kms:ReEncrypt*",
                "kms:RevokeGrant"
              ],
              "Effect": "Allow",
              "Resource": [ "*" ]
            },
            {
              "Action": [
                "logs:CreateLogGroup",
                "logs:CreateLogStream",
                "logs:DescribeLogGroups",
                "logs:DescribeLogStreams",
                "logs:DescribeMetricFilters",
                "logs:PutLogEvents"
              ],
              "Effect": "Allow",
              "Resource": [ "*" ]
            },
            {
              "Action" : [
                "s3:GetBucketLocation",
                "s3:ListBucket"
              ],
              "Effect" : "Allow",
              "Resource" : [ { "Fn::Join": [ "-", [ "arn:aws:s3:::logs-sophos-msg", { "Ref": "Environment" }, "*" ] ] } ]
            },
            {
              "Action" : [
                "s3:PutObject"
              ],
              "Effect" : "Allow",
              "Resource" : [ { "Fn::Join": [ "/", [ { "Fn::Join": [ "-", [ "arn:aws:s3:::logs-sophos-msg", { "Ref": "Environment" }, "*" ] ] }, "*" ] ] } ]
            },
            {
              "Action": [
                "s3:DeleteObject",
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:PutObject"
              ],
              "Effect": "Allow",
              "Resource": [
                "arn:aws:s3:::cloud-*"
              ]
            },
            {
              "Action": [
                "sdb:BatchDeleteAttributes",
                "sdb:BatchPutAttributes",
                "sdb:CreateDomain",
                "sdb:DeleteAttributes",
                "sdb:DeleteDomain",
                "sdb:DomainMetadata",
                "sdb:GetAttributes",
                "sdb:ListDomains",
                "sdb:PutAttributes",
                "sdb:Select"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action": [
                "sns:ListSubscriptionsByTopic",
                "sns:ListTopics",
                "sns:Publish",
                "sns:Subscribe",
                "sns:Unsubscribe"
              ],
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::Join": [
                    ":",
                    [
                      "arn:aws:sns",
                      { "Ref": "AWS::Region" },
                      { "Ref": "AWS::AccountId" },
                      "*"
                    ]
                  ]
                }
              ]
            },
            {
              "Action": [
                "sqs:ChangeMessageVisibility",
                "sqs:CreateQueue",
                "sqs:DeleteMessage",
                "sqs:DeleteQueue",
                "sqs:GetQueueAttributes",
                "sqs:GetQueueUrl",
                "sqs:ListQueues",
                "sqs:SendMessage",
                "sqs:SetQueueAttributes",
                "sqs:ReceiveMessage"
              ],
              "Effect": "Allow",
              "Resource": [ "*" ]
            }

          ]
        },
        "PolicyName": "root",
        "Roles": [
          {
            "Ref": "XgemailXdeliveryInstanceRole"
          }
        ]
      }
    },

    "XgemailInternetXdeliveryInstanceProfile": {
      "Type": "AWS::IAM::InstanceProfile",
      "Properties": {
        "Path": "/",
        "Roles": [
          {
            "Ref": "XgemailInternetXdeliveryInstanceRole"
          }
        ]
      }
    },
    "XgemailInternetXdeliveryInstanceRole": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "ManagedPolicyArns": [ "arn:aws:iam::aws:policy/service-role/AmazonEC2RoleforSSM" ],
        "AssumeRolePolicyDocument": {
          "Statement": [
            {
              "Action": [ "sts:AssumeRole" ],
              "Effect": "Allow",
              "Principal": {
                "Service": [ "ec2.amazonaws.com" ]
              }
            }
          ]
        },
        "Path": "/",
        "Tags": [
          {
            "Key": "Application",
            "Value": { "Ref": "TagApplication" },
            "PropagateAtLaunch": true
          },
          {
            "Key": "BusinessUnit",
            "Value": "MSG",
            "PropagateAtLaunch": true
          },
          {
            "Key": "Name",
            "Value": { "Ref": "RoleName" },
            "PropagateAtLaunch": true
          },
          {
            "Key": "Project",
            "Value": "xgemail",
            "PropagateAtLaunch": true
          },
          {
            "Key": "OwnerEmail",
            "Value": "sophosmailops@sophos.com",
            "PropagateAtLaunch": true
          }
        ]
      }
    },
    "XgemailInternetXdeliveryInstanceRolePolicies": {
      "Type": "AWS::IAM::Policy",
      "Properties": {
        "PolicyDocument": {
          "Statement": [
            {
              "Action": [
                "autoscaling:UpdateAutoScalingGroup",
                "autoscaling:DescribeAutoScalingInstances"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action": [
                "ec2:AssociateAddress",
                "ec2:AttachVolume",
                "ec2:CreateSnapshot",
                "ec2:CreateTags",
                "ec2:CreateVolume",
                "ec2:DescribeAddresses",
                "ec2:DescribeImages",
                "ec2:DescribeSnapshots",
                "ec2:DescribeTags",
                "ec2:DescribeVolumes",
                "ec2:DescribeInstances",
                "ec2:DescribeInstanceAttribute",
                "ec2:DetachVolume",
                "ec2:DescribeVpcs",
                "ec2:DescribeNatGateways",
                "ec2:DescribeSubnets",
                "ec2:DescribeRouteTables",
                "ec2:ModifyInstanceAttribute",
                "ec2:ModifySnapshotAttribute"
              ],
              "Effect": "Allow",
              "Resource": [ "*" ]
            },
            {
              "Action": [
                "iam:GetRole"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action": [
                "kms:CreateGrant",
                "kms:Decrypt",
                "kms:DescribeKey",
                "kms:Encrypt",
                "kms:GenerateDataKey",
                "kms:GenerateDataKeyWithoutPlaintext",
                "kms:List*",
                "kms:ReEncrypt*",
                "kms:RevokeGrant"
              ],
              "Effect": "Allow",
              "Resource": [ "*" ]
            },
            {
              "Action": [
                "logs:CreateLogGroup",
                "logs:CreateLogStream",
                "logs:DescribeLogGroups",
                "logs:DescribeLogStreams",
                "logs:DescribeMetricFilters",
                "logs:PutLogEvents"
              ],
              "Effect": "Allow",
              "Resource": [ "*" ]
            },
            {
              "Action" : [
                "s3:GetBucketLocation",
                "s3:ListBucket"
              ],
              "Effect" : "Allow",
              "Resource" : [ { "Fn::Join": [ "-", [ "arn:aws:s3:::logs-sophos-msg", { "Ref": "Environment" }, "*" ] ] } ]
            },
            {
              "Action" : [
                "s3:PutObject"
              ],
              "Effect" : "Allow",
              "Resource" : [ { "Fn::Join": [ "/", [ { "Fn::Join": [ "-", [ "arn:aws:s3:::logs-sophos-msg", { "Ref": "Environment" }, "*" ] ] }, "*" ] ] } ]
            },
            {
              "Action": [
                "s3:DeleteObject",
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:PutObject"
              ],
              "Effect": "Allow",
              "Resource": [
                "arn:aws:s3:::cloud-*"
              ]
            },
            {
              "Action": [
                "sdb:BatchDeleteAttributes",
                "sdb:BatchPutAttributes",
                "sdb:CreateDomain",
                "sdb:DeleteAttributes",
                "sdb:DeleteDomain",
                "sdb:DomainMetadata",
                "sdb:GetAttributes",
                "sdb:ListDomains",
                "sdb:PutAttributes",
                "sdb:Select"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action": [
                "sns:ListSubscriptionsByTopic",
                "sns:ListTopics",
                "sns:Publish",
                "sns:Subscribe",
                "sns:Unsubscribe"
              ],
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::Join": [
                    ":",
                    [
                      "arn:aws:sns",
                      { "Ref": "AWS::Region" },
                      { "Ref": "AWS::AccountId" },
                      "*"
                    ]
                  ]
                }
              ]
            },
            {
              "Action" : [
                "sqs:ChangeMessageVisibility",
                "sqs:CreateQueue",
                "sqs:DeleteMessage",
                "sqs:DeleteQueue",
                "sqs:GetQueueAttributes",
                "sqs:GetQueueUrl",
                "sqs:ListQueues",
                "sqs:SendMessage",
                "sqs:SetQueueAttributes",
                "sqs:ReceiveMessage"
              ],
              "Effect" : "Allow",
              "Resource" : ["*"]
            }
          ]
        },
        "PolicyName": "root",
        "Roles": [
          {
            "Ref": "XgemailInternetXdeliveryInstanceRole"
          }
        ]
      }
    },

    "XgemailRiskyDeliveryInstanceProfile": {
      "Type": "AWS::IAM::InstanceProfile",
      "Properties": {
        "Path": "/",
        "Roles": [
          {
            "Ref": "XgemailRiskyDeliveryInstanceRole"
          }
        ]
      }
    },
    "XgemailRiskyDeliveryInstanceRole": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "ManagedPolicyArns": [
          "arn:aws:iam::aws:policy/service-role/AmazonEC2RoleforSSM"
        ],
        "AssumeRolePolicyDocument": {
          "Statement": [
            {
              "Action": [
                "sts:AssumeRole"
              ],
              "Effect": "Allow",
              "Principal": {
                "Service": [
                  "ec2.amazonaws.com"
                ]
              }
            }
          ]
        },
        "Path": "/",
        "Tags": [
          {
            "Key": "Application",
            "Value": { "Ref": "TagApplication" },
            "PropagateAtLaunch": true
          },
          {
            "Key": "BusinessUnit",
            "Value": "MSG",
            "PropagateAtLaunch": true
          },
          {
            "Key": "Name",
            "Value": { "Ref": "RoleName" },
            "PropagateAtLaunch": true
          },
          {
            "Key": "Project",
            "Value": "xgemail",
            "PropagateAtLaunch": true
          },
          {
            "Key": "OwnerEmail",
            "Value": "sophosmailops@sophos.com",
            "PropagateAtLaunch": true
          }
        ]
      }
    },
    "XgemailRiskyDeliveryInstanceRolePolicies": {
      "Type": "AWS::IAM::Policy",
      "Properties": {
        "PolicyDocument": {
          "Statement": [
            {
              "Action": [
                "autoscaling:CompleteLifecycleAction",
                "autoscaling:DescribeAutoScalingInstances",
                "autoscaling:DescribeLifecycleHooks",
                "autoscaling:RecordLifecycleActionHeartbeat",
                "autoscaling:UpdateAutoScalingGroup"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action": [
                "ec2:AssociateAddress",
                "ec2:AttachVolume",
                "ec2:CreateSnapshot",
                "ec2:CreateTags",
                "ec2:CreateVolume",
                "ec2:DeleteVolume",
                "ec2:DescribeAddresses",
                "ec2:DescribeImages",
                "ec2:DescribeSnapshots",
                "ec2:DescribeTags",
                "ec2:DescribeVolumes",
                "ec2:DescribeInstances",
                "ec2:DescribeInstanceAttribute",
                "ec2:DetachVolume",
                "ec2:DescribeVpcs",
                "ec2:DescribeNatGateways",
                "ec2:DescribeSubnets",
                "ec2:DescribeRouteTables",
                "ec2:ModifyInstanceAttribute",
                "ec2:ModifySnapshotAttribute"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action": [
                "iam:GetRole"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action": [
                "kms:CreateGrant",
                "kms:Decrypt",
                "kms:DescribeKey",
                "kms:Encrypt",
                "kms:GenerateDataKey",
                "kms:GenerateDataKeyWithoutPlaintext",
                "kms:List*",
                "kms:ReEncrypt*",
                "kms:RevokeGrant"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action": [
                "logs:CreateLogGroup",
                "logs:CreateLogStream",
                "logs:DescribeLogGroups",
                "logs:DescribeLogStreams",
                "logs:DescribeMetricFilters",
                "logs:PutLogEvents"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action": [
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:ListBucket",
                "s3:PutObject",
                "s3:RestoreObject"
              ],
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::Join": [
                    "",
                    [
                      "arn:aws:s3:::",
                      {
                        "Ref": "XgemailMsgHistoryBucketName"
                      },
                      "/*"
                    ]
                  ]
                },
                {
                  "Fn::Join": [
                    "",
                    [
                      "arn:aws:s3:::",
                      {
                        "Ref": "XgemailMsgHistoryBucketName"
                      }
                    ]
                  ]
                }
              ]
            },
            {
              "Action": [
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:ListBucket",
                "s3:PutObject",
                "s3:RestoreObject"
              ],
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::Join": [
                    "",
                    [
                      "arn:aws:s3:::",
                      {
                        "Ref": "XgemailMsgHistoryMsBucketName"
                      },
                      "/*"
                    ]
                  ]
                },
                {
                  "Fn::Join": [
                    "",
                    [
                      "arn:aws:s3:::",
                      {
                        "Ref": "XgemailMsgHistoryMsBucketName"
                      }
                    ]
                  ]
                }
              ]
            },
            {
              "Action": [
                "s3:DeleteObject",
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:ListBucket"
              ],
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::Join": [
                    "",
                    [
                      "arn:aws:s3:::",
                      {
                        "Ref": "XgemailCustomerSubmitBucketName"
                      },
                      "/*"
                    ]
                  ]
                },
                {
                  "Fn::Join": [
                    "",
                    [
                      "arn:aws:s3:::",
                      {
                        "Ref": "XgemailCustomerSubmitBucketName"
                      }
                    ]
                  ]
                }
              ]
            },
            {
              "Action": [
                "s3:GetBucketLocation",
                "s3:ListBucket"
              ],
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::Join": [
                    "-",
                    [
                      "arn:aws:s3:::logs-sophos-msg",
                      {
                        "Ref": "Environment"
                      },
                      "*"
                    ]
                  ]
                }
              ]
            },
            {
              "Action": [
                "s3:PutObject"
              ],
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::Join": [
                    "/",
                    [
                      {
                        "Fn::Join": [
                          "-",
                          [
                            "arn:aws:s3:::logs-sophos-msg",
                            {
                              "Ref": "Environment"
                            },
                            "*"
                          ]
                        ]
                      },
                      "*"
                    ]
                  ]
                }
              ]
            },
            {
              "Action": [
                "s3:DeleteObject",
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:PutObject"
              ],
              "Effect": "Allow",
              "Resource": [
                "arn:aws:s3:::cloud-*"
              ]
            },
            {
              "Action": [
                "sdb:BatchDeleteAttributes",
                "sdb:BatchPutAttributes",
                "sdb:CreateDomain",
                "sdb:DeleteAttributes",
                "sdb:DeleteDomain",
                "sdb:DomainMetadata",
                "sdb:GetAttributes",
                "sdb:ListDomains",
                "sdb:PutAttributes",
                "sdb:Select"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action": [
                "sns:ListSubscriptionsByTopic",
                "sns:ListTopics",
                "sns:Publish",
                "sns:Subscribe",
                "sns:Unsubscribe"
              ],
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::Join": [
                    ":",
                    [
                      "arn:aws:sns",
                      {
                        "Ref": "AWS::Region"
                      },
                      {
                        "Ref": "AWS::AccountId"
                      },
                      "*"
                    ]
                  ]
                }
              ]
            },
            {
              "Action": [
                "sqs:ChangeMessageVisibility",
                "sqs:CreateQueue",
                "sqs:DeleteMessage",
                "sqs:DeleteQueue",
                "sqs:GetQueueAttributes",
                "sqs:GetQueueUrl",
                "sqs:ListQueues",
                "sqs:SendMessage",
                "sqs:SetQueueAttributes",
                "sqs:ReceiveMessage"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            }
          ]
        },
        "PolicyName": "root",
        "Roles": [
          {
            "Ref": "XgemailRiskyDeliveryInstanceRole"
          }
        ]
      }
    },

    "XgemailRiskyXdeliveryInstanceProfile": {
      "Type": "AWS::IAM::InstanceProfile",
      "Properties": {
        "Path": "/",
        "Roles": [
          {
            "Ref": "XgemailRiskyXdeliveryInstanceRole"
          }
        ]
      }
    },
    "XgemailRiskyXdeliveryInstanceRole": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "ManagedPolicyArns": [
          "arn:aws:iam::aws:policy/service-role/AmazonEC2RoleforSSM"
        ],
        "AssumeRolePolicyDocument": {
          "Statement": [
            {
              "Action": [
                "sts:AssumeRole"
              ],
              "Effect": "Allow",
              "Principal": {
                "Service": [
                  "ec2.amazonaws.com"
                ]
              }
            }
          ]
        },
        "Path": "/",
        "Tags": [
          {
            "Key": "Application",
            "Value": { "Ref": "TagApplication" },
            "PropagateAtLaunch": true
          },
          {
            "Key": "BusinessUnit",
            "Value": "MSG",
            "PropagateAtLaunch": true
          },
          {
            "Key": "Name",
            "Value": { "Ref": "RoleName" },
            "PropagateAtLaunch": true
          },
          {
            "Key": "Project",
            "Value": "xgemail",
            "PropagateAtLaunch": true
          },
          {
            "Key": "OwnerEmail",
            "Value": "sophosmailops@sophos.com",
            "PropagateAtLaunch": true
          }
        ]
      }
    },
    "XgemailRiskyXdeliveryInstanceRolePolicies": {
      "Type": "AWS::IAM::Policy",
      "Properties": {
        "PolicyDocument": {
          "Statement": [
            {
              "Action": [
                "autoscaling:UpdateAutoScalingGroup",
                "autoscaling:DescribeAutoScalingInstances"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action": [
                "ec2:AssociateAddress",
                "ec2:AttachVolume",
                "ec2:CreateSnapshot",
                "ec2:CreateTags",
                "ec2:CreateVolume",
                "ec2:DescribeAddresses",
                "ec2:DescribeImages",
                "ec2:DescribeSnapshots",
                "ec2:DescribeTags",
                "ec2:DescribeVolumes",
                "ec2:DescribeInstances",
                "ec2:DescribeInstanceAttribute",
                "ec2:DetachVolume",
                "ec2:DescribeVpcs",
                "ec2:DescribeNatGateways",
                "ec2:DescribeSubnets",
                "ec2:DescribeRouteTables",
                "ec2:ModifyInstanceAttribute",
                "ec2:ModifySnapshotAttribute"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action": [
                "iam:GetRole"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action": [
                "kms:CreateGrant",
                "kms:Decrypt",
                "kms:DescribeKey",
                "kms:Encrypt",
                "kms:GenerateDataKey",
                "kms:GenerateDataKeyWithoutPlaintext",
                "kms:List*",
                "kms:ReEncrypt*",
                "kms:RevokeGrant"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action": [
                "logs:CreateLogGroup",
                "logs:CreateLogStream",
                "logs:DescribeLogGroups",
                "logs:DescribeLogStreams",
                "logs:DescribeMetricFilters",
                "logs:PutLogEvents"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action": [
                "s3:GetBucketLocation",
                "s3:ListBucket"
              ],
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::Join": [
                    "-",
                    [
                      "arn:aws:s3:::logs-sophos-msg",
                      {
                        "Ref": "Environment"
                      },
                      "*"
                    ]
                  ]
                }
              ]
            },
            {
              "Action": [
                "s3:PutObject"
              ],
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::Join": [
                    "/",
                    [
                      {
                        "Fn::Join": [
                          "-",
                          [
                            "arn:aws:s3:::logs-sophos-msg",
                            {
                              "Ref": "Environment"
                            },
                            "*"
                          ]
                        ]
                      },
                      "*"
                    ]
                  ]
                }
              ]
            },
            {
              "Action": [
                "s3:DeleteObject",
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:PutObject"
              ],
              "Effect": "Allow",
              "Resource": [
                "arn:aws:s3:::cloud-*"
              ]
            },
            {
              "Action": [
                "sdb:BatchDeleteAttributes",
                "sdb:BatchPutAttributes",
                "sdb:CreateDomain",
                "sdb:DeleteAttributes",
                "sdb:DeleteDomain",
                "sdb:DomainMetadata",
                "sdb:GetAttributes",
                "sdb:ListDomains",
                "sdb:PutAttributes",
                "sdb:Select"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action": [
                "sns:ListSubscriptionsByTopic",
                "sns:ListTopics",
                "sns:Publish",
                "sns:Subscribe",
                "sns:Unsubscribe"
              ],
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::Join": [
                    ":",
                    [
                      "arn:aws:sns",
                      {
                        "Ref": "AWS::Region"
                      },
                      {
                        "Ref": "AWS::AccountId"
                      },
                      "*"
                    ]
                  ]
                }
              ]
            },
            {
              "Action": [
                "sqs:ChangeMessageVisibility",
                "sqs:CreateQueue",
                "sqs:DeleteMessage",
                "sqs:DeleteQueue",
                "sqs:GetQueueAttributes",
                "sqs:GetQueueUrl",
                "sqs:ListQueues",
                "sqs:SendMessage",
                "sqs:SetQueueAttributes",
                "sqs:ReceiveMessage"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            }
          ]
        },
        "PolicyName": "root",
        "Roles": [
          {
            "Ref": "XgemailRiskyXdeliveryInstanceRole"
          }
        ]
      }
    },

    "XgemailWarmupDeliveryInstanceProfile": {
      "Type": "AWS::IAM::InstanceProfile",
      "Properties": {
        "Path": "/",
        "Roles": [
          {
            "Ref": "XgemailWarmupDeliveryInstanceRole"
          }
        ]
      }
    },
    "XgemailWarmupDeliveryInstanceRole": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "ManagedPolicyArns": [
          "arn:aws:iam::aws:policy/service-role/AmazonEC2RoleforSSM"
        ],
        "AssumeRolePolicyDocument": {
          "Statement": [
            {
              "Action": [
                "sts:AssumeRole"
              ],
              "Effect": "Allow",
              "Principal": {
                "Service": [
                  "ec2.amazonaws.com"
                ]
              }
            }
          ]
        },
        "Path": "/",
        "Tags": [
          {
            "Key": "Application",
            "Value": { "Ref": "TagApplication" },
            "PropagateAtLaunch": true
          },
          {
            "Key": "BusinessUnit",
            "Value": "MSG",
            "PropagateAtLaunch": true
          },
          {
            "Key": "Name",
            "Value": { "Ref": "RoleName" },
            "PropagateAtLaunch": true
          },
          {
            "Key": "Project",
            "Value": "xgemail",
            "PropagateAtLaunch": true
          },
          {
            "Key": "OwnerEmail",
            "Value": "sophosmailops@sophos.com",
            "PropagateAtLaunch": true
          }
        ]
      }
    },
    "XgemailWarmupDeliveryInstanceRolePolicies": {
      "Type": "AWS::IAM::Policy",
      "Properties": {
        "PolicyDocument": {
          "Statement": [
            {
              "Action": [
                "autoscaling:CompleteLifecycleAction",
                "autoscaling:DescribeAutoScalingInstances",
                "autoscaling:DescribeLifecycleHooks",
                "autoscaling:RecordLifecycleActionHeartbeat",
                "autoscaling:UpdateAutoScalingGroup"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action": [
                "ec2:AssociateAddress",
                "ec2:AttachVolume",
                "ec2:CreateSnapshot",
                "ec2:CreateTags",
                "ec2:CreateVolume",
                "ec2:DeleteVolume",
                "ec2:DescribeAddresses",
                "ec2:DescribeImages",
                "ec2:DescribeSnapshots",
                "ec2:DescribeTags",
                "ec2:DescribeVolumes",
                "ec2:DescribeInstances",
                "ec2:DescribeInstanceAttribute",
                "ec2:DetachVolume",
                "ec2:DescribeVpcs",
                "ec2:DescribeNatGateways",
                "ec2:DescribeSubnets",
                "ec2:DescribeRouteTables",
                "ec2:ModifyInstanceAttribute",
                "ec2:ModifySnapshotAttribute"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action": [
                "iam:GetRole"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action": [
                "kms:CreateGrant",
                "kms:Decrypt",
                "kms:DescribeKey",
                "kms:Encrypt",
                "kms:GenerateDataKey",
                "kms:GenerateDataKeyWithoutPlaintext",
                "kms:List*",
                "kms:ReEncrypt*",
                "kms:RevokeGrant"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action": [
                "logs:CreateLogGroup",
                "logs:CreateLogStream",
                "logs:DescribeLogGroups",
                "logs:DescribeLogStreams",
                "logs:DescribeMetricFilters",
                "logs:PutLogEvents"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action": [
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:ListBucket",
                "s3:PutObject",
                "s3:RestoreObject"
              ],
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::Join": [
                    "",
                    [
                      "arn:aws:s3:::",
                      {
                        "Ref": "XgemailMsgHistoryBucketName"
                      },
                      "/*"
                    ]
                  ]
                },
                {
                  "Fn::Join": [
                    "",
                    [
                      "arn:aws:s3:::",
                      {
                        "Ref": "XgemailMsgHistoryBucketName"
                      }
                    ]
                  ]
                }
              ]
            },
            {
              "Action": [
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:ListBucket",
                "s3:PutObject",
                "s3:RestoreObject"
              ],
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::Join": [
                    "",
                    [
                      "arn:aws:s3:::",
                      {
                        "Ref": "XgemailMsgHistoryMsBucketName"
                      },
                      "/*"
                    ]
                  ]
                },
                {
                  "Fn::Join": [
                    "",
                    [
                      "arn:aws:s3:::",
                      {
                        "Ref": "XgemailMsgHistoryMsBucketName"
                      }
                    ]
                  ]
                }
              ]
            },
            {
              "Action": [
                "s3:DeleteObject",
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:ListBucket"
              ],
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::Join": [
                    "",
                    [
                      "arn:aws:s3:::",
                      {
                        "Ref": "XgemailCustomerSubmitBucketName"
                      },
                      "/*"
                    ]
                  ]
                },
                {
                  "Fn::Join": [
                    "",
                    [
                      "arn:aws:s3:::",
                      {
                        "Ref": "XgemailCustomerSubmitBucketName"
                      }
                    ]
                  ]
                }
              ]
            },
            {
              "Action": [
                "s3:GetBucketLocation",
                "s3:ListBucket"
              ],
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::Join": [
                    "-",
                    [
                      "arn:aws:s3:::logs-sophos-msg",
                      {
                        "Ref": "Environment"
                      },
                      "*"
                    ]
                  ]
                }
              ]
            },
            {
              "Action": [
                "s3:PutObject"
              ],
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::Join": [
                    "/",
                    [
                      {
                        "Fn::Join": [
                          "-",
                          [
                            "arn:aws:s3:::logs-sophos-msg",
                            {
                              "Ref": "Environment"
                            },
                            "*"
                          ]
                        ]
                      },
                      "*"
                    ]
                  ]
                }
              ]
            },
            {
              "Action": [
                "s3:DeleteObject",
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:PutObject"
              ],
              "Effect": "Allow",
              "Resource": [
                "arn:aws:s3:::cloud-*"
              ]
            },
            {
              "Action": [
                "sns:ListSubscriptionsByTopic",
                "sns:ListTopics",
                "sns:Publish",
                "sns:Subscribe",
                "sns:Unsubscribe"
              ],
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::Join": [
                    ":",
                    [
                      "arn:aws:sns",
                      {
                        "Ref": "AWS::Region"
                      },
                      {
                        "Ref": "AWS::AccountId"
                      },
                      "*"
                    ]
                  ]
                }
              ]
            },
            {
              "Action": [
                "sqs:ChangeMessageVisibility",
                "sqs:CreateQueue",
                "sqs:DeleteMessage",
                "sqs:DeleteQueue",
                "sqs:GetQueueAttributes",
                "sqs:GetQueueUrl",
                "sqs:ListQueues",
                "sqs:SendMessage",
                "sqs:SetQueueAttributes",
                "sqs:ReceiveMessage"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            }
          ]
        },
        "PolicyName": "root",
        "Roles": [
          {
            "Ref": "XgemailWarmupDeliveryInstanceRole"
          }
        ]
      }
    },

    "XgemailWarmupXdeliveryInstanceProfile": {
      "Type": "AWS::IAM::InstanceProfile",
      "Properties": {
        "Path": "/",
        "Roles": [
          {
            "Ref": "XgemailWarmupXdeliveryInstanceRole"
          }
        ]
      }
    },
    "XgemailWarmupXdeliveryInstanceRole": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "ManagedPolicyArns": [
          "arn:aws:iam::aws:policy/service-role/AmazonEC2RoleforSSM"
        ],
        "AssumeRolePolicyDocument": {
          "Statement": [
            {
              "Action": [
                "sts:AssumeRole"
              ],
              "Effect": "Allow",
              "Principal": {
                "Service": [
                  "ec2.amazonaws.com"
                ]
              }
            }
          ]
        },
        "Path": "/",
        "Tags": [
          {
            "Key": "Application",
            "Value": { "Ref": "TagApplication" },
            "PropagateAtLaunch": true
          },
          {
            "Key": "BusinessUnit",
            "Value": "MSG",
            "PropagateAtLaunch": true
          },
          {
            "Key": "Name",
            "Value": { "Ref": "RoleName" },
            "PropagateAtLaunch": true
          },
          {
            "Key": "Project",
            "Value": "xgemail",
            "PropagateAtLaunch": true
          },
          {
            "Key": "OwnerEmail",
            "Value": "sophosmailops@sophos.com",
            "PropagateAtLaunch": true
          }
        ]
      }
    },
    "XgemailWarmupXdeliveryInstanceRolePolicies": {
      "Type": "AWS::IAM::Policy",
      "Properties": {
        "PolicyDocument": {
          "Statement": [
            {
              "Action": [
                "autoscaling:UpdateAutoScalingGroup",
                "autoscaling:DescribeAutoScalingInstances"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action": [
                "ec2:AssociateAddress",
                "ec2:AttachVolume",
                "ec2:CreateSnapshot",
                "ec2:CreateTags",
                "ec2:CreateVolume",
                "ec2:DescribeAddresses",
                "ec2:DescribeImages",
                "ec2:DescribeSnapshots",
                "ec2:DescribeTags",
                "ec2:DescribeVolumes",
                "ec2:DescribeInstances",
                "ec2:DescribeInstanceAttribute",
                "ec2:DetachVolume",
                "ec2:DescribeVpcs",
                "ec2:DescribeNatGateways",
                "ec2:DescribeSubnets",
                "ec2:DescribeRouteTables",
                "ec2:ModifyInstanceAttribute",
                "ec2:ModifySnapshotAttribute"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action": [
                "iam:GetRole"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action": [
                "kms:CreateGrant",
                "kms:Decrypt",
                "kms:DescribeKey",
                "kms:Encrypt",
                "kms:GenerateDataKey",
                "kms:GenerateDataKeyWithoutPlaintext",
                "kms:List*",
                "kms:ReEncrypt*",
                "kms:RevokeGrant"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action": [
                "logs:CreateLogGroup",
                "logs:CreateLogStream",
                "logs:DescribeLogGroups",
                "logs:DescribeLogStreams",
                "logs:DescribeMetricFilters",
                "logs:PutLogEvents"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action": [
                "s3:GetBucketLocation",
                "s3:ListBucket"
              ],
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::Join": [
                    "-",
                    [
                      "arn:aws:s3:::logs-sophos-msg",
                      {
                        "Ref": "Environment"
                      },
                      "*"
                    ]
                  ]
                }
              ]
            },
            {
              "Action": [
                "s3:PutObject"
              ],
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::Join": [
                    "/",
                    [
                      {
                        "Fn::Join": [
                          "-",
                          [
                            "arn:aws:s3:::logs-sophos-msg",
                            {
                              "Ref": "Environment"
                            },
                            "*"
                          ]
                        ]
                      },
                      "*"
                    ]
                  ]
                }
              ]
            },
            {
              "Action": [
                "s3:DeleteObject",
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:PutObject"
              ],
              "Effect": "Allow",
              "Resource": [
                "arn:aws:s3:::cloud-*"
              ]
            },
            {
              "Action": [
                "sdb:BatchDeleteAttributes",
                "sdb:BatchPutAttributes",
                "sdb:CreateDomain",
                "sdb:DeleteAttributes",
                "sdb:DeleteDomain",
                "sdb:DomainMetadata",
                "sdb:GetAttributes",
                "sdb:ListDomains",
                "sdb:PutAttributes",
                "sdb:Select"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action": [
                "sns:ListSubscriptionsByTopic",
                "sns:ListTopics",
                "sns:Publish",
                "sns:Subscribe",
                "sns:Unsubscribe"
              ],
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::Join": [
                    ":",
                    [
                      "arn:aws:sns",
                      {
                        "Ref": "AWS::Region"
                      },
                      {
                        "Ref": "AWS::AccountId"
                      },
                      "*"
                    ]
                  ]
                }
              ]
            },
            {
              "Action": [
                "sqs:ChangeMessageVisibility",
                "sqs:CreateQueue",
                "sqs:DeleteMessage",
                "sqs:DeleteQueue",
                "sqs:GetQueueAttributes",
                "sqs:GetQueueUrl",
                "sqs:ListQueues",
                "sqs:SendMessage",
                "sqs:SetQueueAttributes",
                "sqs:ReceiveMessage"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            }
          ]
        },
        "PolicyName": "root",
        "Roles": [
          {
            "Ref": "XgemailWarmupXdeliveryInstanceRole"
          }
        ]
      }
    }
  },

  "Outputs": {
    "AutoScalingInstanceRole": {
      "Description": "AutoScaling instance role",
      "Value": { "Ref": "AutoScalingInstanceRole" }
    },
    "AutoScalingInstanceRoleArn": {
      "Description": "AutoScaling instance role ARN",
      "Value": { "Fn::GetAtt" : [ "AutoScalingInstanceRole", "Arn" ] }
    },
    "BastionInstanceProfile": {
      "Description": "Bastion instance profile",
      "Value": { "Ref": "BastionInstanceProfile" }
    },
    "BastionInstanceRole": {
      "Description": "Bastion instance role",
      "Value": { "Ref": "BastionInstanceRole" }
    },
    "BastionInstanceRoleArn": {
      "Description": "Bastion instance role ARN",
      "Value": { "Fn::GetAtt" : [ "BastionInstanceRole", "Arn" ] }
    },
    "EipMonitorLambdaExecutionRole": {
      "Description": "Eip Monitor Lambda Execution role",
      "Value": { "Ref": "EipMonitorLambdaExecutionRole" }
    },
    "EipMonitorLambdaExecutionRoleArn": {
      "Description": "Eip Monitor Lambda Execution role ARN",
      "Value": { "Fn::GetAtt" : [ "EipMonitorLambdaExecutionRole", "Arn" ] }
    },
    "EipRotationLambdaExecutionRole": {
      "Description": "Eip Rotation Lambda Execution role",
      "Value": { "Ref": "EipRotationLambdaExecutionRole" }
    },
    "EipRotationLambdaExecutionRoleArn": {
      "Description": "Eip Rotation Lambda Execution role ARN",
      "Value": { "Fn::GetAtt" : [ "EipRotationLambdaExecutionRole", "Arn" ] }
    },
    "FirehoseTransformationLambdaExecutionRole": {
      "Description": "Firehose Transformation Lambda Execution role",
      "Value": { "Ref": "FirehoseTransformationLambdaExecutionRole" }
    },
    "FirehoseTransformationLambdaExecutionRoleArn": {
      "Description": "Firehose Transformation Lambda Execution role ARN",
      "Value": { "Fn::GetAtt" : [ "FirehoseTransformationLambdaExecutionRole", "Arn" ] }
    },
    "LogicMonitorInstanceProfile": {
      "Description": "Profile for logic monitor collectors to do their job",
      "Value": { "Ref": "LogicMonitorInstanceProfile" }
    },
    "LogicMonitorInstanceRole": {
      "Description": "LogicMonitor instance role",
      "Value": { "Ref": "LogicMonitorInstanceRole" }
    },
    "LogicMonitorInstanceRoleArn": {
      "Description": "LogicMonitor instance role ARN",
      "Value": { "Fn::GetAtt" : [ "LogicMonitorInstanceRole", "Arn" ] }
    },
    "XgemailCustomerDeliveryInstanceProfile": {
      "Description": "XGEMAIL Customer Delivery instance profile",
      "Value": { "Ref": "XgemailCustomerDeliveryInstanceProfile" }
    },
    "XgemailCustomerDeliveryInstanceRole": {
      "Description": "XGEMAIL Customer Delivery instance role",
      "Value": { "Ref": "XgemailCustomerDeliveryInstanceRole" }
    },
    "XgemailCustomerDeliveryInstanceRoleArn": {
      "Description": "XGEMAIL Customer Delivery instance role ARN",
      "Value": { "Fn::GetAtt" : [ "XgemailCustomerDeliveryInstanceRole", "Arn" ] }
    },
    "XgemailXdeliveryInstanceProfile": {
      "Description": "XGEMAIL Xdelivery instance profile",
      "Value": { "Ref": "XgemailXdeliveryInstanceProfile" }
    },
    "XgemailXdeliveryInstanceRole": {
      "Description": "XGEMAIL Xdelivery instance role",
      "Value": { "Ref": "XgemailXdeliveryInstanceRole" }
    },
    "XgemailXdeliveryInstanceRoleArn": {
      "Description": "XGEMAIL Xdelivery instance role ARN",
      "Value": { "Fn::GetAtt" : [ "XgemailXdeliveryInstanceRole", "Arn" ] }
    },
    "XgemailInternetDeliveryInstanceProfile": {
      "Description": "XGEMAIL Internet Delivery instance profile",
      "Value": { "Ref": "XgemailInternetDeliveryInstanceProfile" }
    },
    "XgemailInternetDeliveryInstanceRole": {
      "Description": "XGEMAIL Internet Delivery instance role",
      "Value": { "Ref": "XgemailInternetDeliveryInstanceRole" }
    },
    "XgemailInternetDeliveryInstanceRoleArn": {
      "Description": "XGEMAIL Internet Delivery instance role ARN",
      "Value": { "Fn::GetAtt" : [ "XgemailInternetDeliveryInstanceRole", "Arn" ] }
    },
    "XgemailInternetXdeliveryInstanceProfile": {
      "Description": "XGEMAIL Internet Xdelivery instance profile",
      "Value": { "Ref": "XgemailInternetXdeliveryInstanceProfile" }
    },
    "XgemailInternetXdeliveryInstanceRole": {
      "Description": "XGEMAIL Internet Xdelivery instance role",
      "Value": { "Ref": "XgemailInternetXdeliveryInstanceRole" }
    },
    "XgemailInternetXdeliveryInstanceRoleArn": {
      "Description": "XGEMAIL Internet Xdelivery instance role ARN",
      "Value": { "Fn::GetAtt" : [ "XgemailInternetXdeliveryInstanceRole", "Arn" ] }
    },
    "XgemailEncryptionDeliveryInstanceProfile": {
      "Description": "XGEMAIL Encryption Delivery instance profile",
      "Value": { "Ref": "XgemailEncryptionDeliveryInstanceProfile" }
    },
    "XgemailEncryptionDeliveryInstanceRole": {
      "Description": "XGEMAIL Encryption Delivery instance role",
      "Value": { "Ref": "XgemailEncryptionDeliveryInstanceRole" }
    },
    "XgemailEncryptionDeliveryInstanceRoleArn": {
      "Description": "XGEMAIL Encryption Delivery instance role ARN",
      "Value": { "Fn::GetAtt" : [ "XgemailEncryptionDeliveryInstanceRole", "Arn" ] }
    },
    "XgemailRiskyDeliveryInstanceProfile": {
      "Description": "XGEMAIL Risky Delivery instance profile",
      "Value": { "Ref": "XgemailRiskyDeliveryInstanceProfile" }
    },
    "XgemailRiskyDeliveryInstanceRole": {
      "Description": "XGEMAIL Risky Delivery instance role",
      "Value": { "Ref": "XgemailRiskyDeliveryInstanceRole" }
    },
    "XgemailRiskyDeliveryInstanceRoleArn": {
      "Description": "XGEMAIL Risky Delivery instance role ARN",
      "Value": { "Fn::GetAtt" : [ "XgemailRiskyDeliveryInstanceRole", "Arn" ] }
    },
    "XgemailRiskyXdeliveryInstanceProfile": {
      "Description": "XGEMAIL Risky Xdelivery instance profile",
      "Value": { "Ref": "XgemailRiskyXdeliveryInstanceProfile" }
    },
    "XgemailRiskyXdeliveryInstanceRole": {
      "Description": "XGEMAIL Risky Xdelivery instance role",
      "Value": { "Ref": "XgemailRiskyXdeliveryInstanceRole" }
    },
    "XgemailRiskyXdeliveryInstanceRoleArn": {
      "Description": "XGEMAIL Risky Xdelivery instance role ARN",
      "Value": { "Fn::GetAtt" : [ "XgemailRiskyXdeliveryInstanceRole", "Arn" ] }
    },
    "XgemailCustomerSubmitInstanceProfile": {
      "Description": "XGEMAIL Customer Submit instance profile",
      "Value": { "Ref": "XgemailCustomerSubmitInstanceProfile" }
    },
    "XgemailCustomerSubmitInstanceRole": {
      "Description": "XGEMAIL Customer Submit instance role",
      "Value": { "Ref": "XgemailCustomerSubmitInstanceRole" }
    },
    "XgemailCustomerSubmitInstanceRoleArn": {
      "Description": "XGEMAIL Customer Submit instance role ARN",
      "Value": { "Fn::GetAtt" : [ "XgemailCustomerSubmitInstanceRole", "Arn" ] }
    },
    "XgemailInternetSubmitInstanceProfile": {
      "Description": "XGEMAIL Internet Submit instance profile",
      "Value": { "Ref": "XgemailInternetSubmitInstanceProfile" }
    },
    "XgemailInternetSubmitInstanceRole": {
      "Description": "XGEMAIL Internet Submit instance role",
      "Value": { "Ref": "XgemailInternetSubmitInstanceRole" }
    },
    "XgemailInternetSubmitInstanceRoleArn": {
      "Description": "XGEMAIL Internet Submit instance role ARN",
      "Value": { "Fn::GetAtt" : [ "XgemailInternetSubmitInstanceRole", "Arn" ] }
    },
    "XgemailEncryptionSubmitInstanceProfile": {
      "Description": "XGEMAIL Encryption Submit instance profile",
      "Value": { "Ref": "XgemailEncryptionSubmitInstanceProfile" }
    },
    "XgemailEncryptionSubmitInstanceRole": {
      "Description": "XGEMAIL Encryption Submit instance role",
      "Value": { "Ref": "XgemailEncryptionSubmitInstanceRole" }
    },
    "XgemailEncryptionSubmitInstanceRoleArn": {
      "Description": "XGEMAIL Customer Encryption Submit instance role ARN",
      "Value": { "Fn::GetAtt" : [ "XgemailEncryptionSubmitInstanceRole", "Arn" ] }
    },
    "XgemailWarmupDeliveryInstanceProfile": {
      "Description": "XGEMAIL Warmup Delivery instance profile",
      "Value": { "Ref": "XgemailWarmupDeliveryInstanceProfile" }
    },
    "XgemailWarmupDeliveryInstanceRole": {
      "Description": "XGEMAIL Warmup Delivery instance role",
      "Value": { "Ref": "XgemailWarmupDeliveryInstanceRole" }
    },
    "XgemailWarmupDeliveryInstanceRoleArn": {
      "Description": "XGEMAIL Warmup Delivery instance role ARN",
      "Value": { "Fn::GetAtt" : [ "XgemailWarmupDeliveryInstanceRole", "Arn" ] }
    },
    "XgemailWarmupXdeliveryInstanceProfile": {
      "Description": "XGEMAIL Warmup Xdelivery instance profile",
      "Value": { "Ref": "XgemailWarmupXdeliveryInstanceProfile" }
    },
    "XgemailWarmupXdeliveryInstanceRole": {
      "Description": "XGEMAIL Warmup Xdelivery instance role",
      "Value": { "Ref": "XgemailWarmupXdeliveryInstanceRole" }
    },
    "XgemailWarmupXdeliveryInstanceRoleArn": {
      "Description": "XGEMAIL Warmup Xdelivery instance role ARN",
      "Value": { "Fn::GetAtt" : [ "XgemailWarmupXdeliveryInstanceRole", "Arn" ] }
    }
  }
}