{
  "AWSTemplateFormatVersion" : "2010-09-09",
  "Description" : "AMI builder roles template, XGEMAIL images only.",

  "Metadata": {
    "Copyright": [
      "Copyright 2021, Sophos Limited. All rights reserved.",
      "",
      "'Sophos' and 'Sophos Anti-Virus' are registered trademarks of",
      "Sophos Limited and Sophos Group.  All other product and company",
      "names mentioned are trademarks or registered trademarks of their",
      "respective owners."
    ],

    "Comments": [
      "IAM Roles Template for the Submit, Delivery, and Xdelivery Instances in the CloudEmail VPC"
    ]
  },

  "Parameters": {
    "Environment": {
      "Description": "Name of the AWS account. inf, dev, qa, prod",
      "Type": "String"
    },
    "XgemailMsgHistoryBucketName": {
      "Description": "Name of the Xgemail Message History bucket",
      "Type": "String"
    },
    "XgemailMsgHistoryMsBucketName": {
      "Description": "Name of the Xgemail Message History Micro-Service bucket",
      "Type": "String"
    },
    "XgemailPolicyBucketName": {
      "Description": "Name of the Xgemail Policy bucket",
      "Type": "String"
    },
    "XgemailQuarantineBucketName": {
      "Description": "Name of the quarantine bucket",
      "Type": "String"
    },
    "XgemailInternetSubmitBucketName": {
      "Description": "Name of the submit bucket",
      "Type": "String"
    },
    "XgemailCustomerSubmitBucketName": {
      "Description": "Name of the customer submit bucket",
      "Type": "String"
    },
    "DeliveryDirectorDynamodbTableName": {
      "Description": "Name of the delivery director dynamoDB table",
      "Type": "String"
    },
    "DeliveryDirectorBucketName": {
      "Description": "Name of the delivery director bucket",
      "Type": "String"
    },
    "MsgHistoryV2BucketName": {
      "Description": "Name of the Xgemail Message History V2 bucket",
      "Type": "String"
    },
    "MsgHistoryV2DynamoDbTableName": {
      "Description": "Name of the message history dynamoDB table",
      "Type": "String"
    },
    "MsgHistoryV2StreamName": {
      "Description": "Name of the message history stream name",
      "Type": "String"
    },
    "MsgHistoryDataStreamName": {
      "Description": "Name of the message history data stream",
      "Type": "String"
    }
  },

  "Conditions": {
    "isPreProd": {
      "Fn::And": [
        {
          "Fn::Equals": [
            {
              "Ref": "AWS::Region"
            },
            "eu-west-1"
          ]
        },
        {
          "Fn::Not": [
            {
              "Fn::Equals": [
                {
                  "Ref": "Environment"
                },
                "prod"
              ]
            }
          ]
        }
      ]
    },
    "isProd": {
      "Fn::And": [
        {
          "Fn::Equals": [
            {
              "Ref": "AWS::Region"
            },
            "eu-west-1"
          ]
        },
        {
          "Fn::Equals": [
            {
              "Ref": "Environment"
            },
            "prod"
          ]
        }
      ]
    }
  },

  "Resources" : {
    "AutoScalingInstanceRole" : {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [{
            "Effect": "Allow",
            "Principal": {
              "Service": [ "autoscaling.amazonaws.com" ]
            },
            "Action": [ "sts:AssumeRole" ]
          }]
        },
        "Path": "/",
        "Tags": [
          {
            "Key": "Application",
            "Value": "cloudemail"
          },
          {
            "Key": "BusinessUnit",
            "Value": "MSG"
          },
          {
            "Key": "Name",
            "Value": { "Fn::Join": [ "-", [ { "Ref" : "AWS::StackName" }, "AutoScalingInstanceRole" ] ] }
          },
          {
            "Key": "Project",
            "Value": "xgemail"
          },
          {
            "Key": "OwnerEmail",
            "Value": "sophosmailops@sophos.com"
          }
        ]
      }
    },
    "AutoScalingInstanceRolePolicies": {
      "Properties": {
        "PolicyDocument": {
          "Statement": [
            {
              "Action": [
                "sns:Publish"
              ],
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::Join": [
                    ":",
                    [
                      "arn:aws:sns",
                      { "Ref": "AWS::Region" },
                      { "Ref": "AWS::AccountId" },
                      "*"
                    ]
                  ]
                }
              ]
            },
            {
              "Action": [
                "sqs:GetQueueUrl",
                "sqs:SendMessage"
              ],
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::Join": [
                    ":",
                    [
                      "arn:aws:sqs",
                      {"Ref": "AWS::Region"},
                      {"Ref": "AWS::AccountId"},
                      "*"
                    ]
                  ]
                }
              ]
            }
          ]
        },
        "PolicyName": "root",
        "Roles": [
          {
            "Ref": "AutoScalingInstanceRole"
          }
        ]
      },
      "Type": "AWS::IAM::Policy"
    },

    "BastionInstanceProfile" : {
      "Type" : "AWS::IAM::InstanceProfile",
      "Properties" : {
        "Path" : "/",
        "Roles" : [
          {
            "Ref" : "BastionInstanceRole"
          }
        ]
      }
    },
    "BastionInstanceRole" : {
      "Type" : "AWS::IAM::Role",
      "Properties" : {
        "AssumeRolePolicyDocument" : {
          "Statement" : [
            {
              "Action" : ["sts:AssumeRole"],
              "Effect" : "Allow",
              "Principal" : {
                "Service" : ["ec2.amazonaws.com"]
              }
            }
          ]
        },
        "Path" : "/",
        "Tags": [
          {
            "Key": "Application",
            "Value": "bastion"
          },
          {
            "Key": "BusinessUnit",
            "Value": "MSG"
          },
          {
            "Key": "Name",
            "Value": { "Fn::Join": [ "-", [ { "Ref" : "AWS::StackName" }, "BastionInstanceRole" ] ] }
          },
          {
            "Key": "Project",
            "Value": "xgemail"
          },
          {
            "Key": "OwnerEmail",
            "Value": "sophosmailops@sophos.com"
          }
        ]
      }
    },
    "BastionInstanceRolePolicies": {
      "Properties": {
        "PolicyDocument": {
          "Statement": [
            {
              "Effect": "Allow",
              "Action": [
                "iam:GetRole"
              ],
              "Resource": [
                "*"
              ]
            },
            {
              "Action": [
                "ec2:CreateTags",
                "ec2:DescribeNetworkInterfaces",
                "ec2:DescribeVolumes"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action": [
                "s3:GetObject",
                "s3:PutObject",
                "s3:GetBucketLocation"

              ],
              "Effect": "Allow",
              "Resource": [
                "arn:aws:s3:::cloud-*"
              ]
            },
            {
              "Effect": "Allow",
              "Action": [
                "logs:CreateLogGroup",
                "logs:CreateLogStream",
                "logs:DescribeLogGroups",
                "logs:DescribeLogStreams",
                "logs:DescribeMetricFilters",
                "logs:PutLogEvents"
              ],
              "Resource": [
                "*"
              ]
            },
            {
              "Effect": "Allow",
              "Action": [
                "route53:ChangeResourceRecordSets",
                "route53:ListHostedZonesByName"
              ],
              "Resource": [
                "*"
              ]
            },
            {
              "Effect": "Allow",
              "Action": [
                "kms:Decrypt",
                "kms:DescribeKey",
                "kms:Encrypt",
                "kms:List*"
              ],
              "Resource": [
                "*"
              ]
            }
          ]
        },
        "PolicyName": "root",
        "Roles": [
          {
            "Ref": "BastionInstanceRole"
          }
        ]
      },
      "Type": "AWS::IAM::Policy"
    },

    "EipMonitorLambdaExecutionRole" : {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [{
            "Effect": "Allow",
            "Principal": {
              "Service": [ "lambda.amazonaws.com" ]
            },
            "Action": [ "sts:AssumeRole" ]
          }]
        },
        "Path": "/",
        "Tags": [
          {
            "Key": "Application",
            "Value": "cloudemail"
          },
          {
            "Key": "BusinessUnit",
            "Value": "MSG"
          },
          {
            "Key": "Name",
            "Value": { "Fn::Join": [ "-", [ { "Ref" : "AWS::StackName" }, "EipMonitorLambdaExecutionRole" ] ] }
          },
          {
            "Key": "Project",
            "Value": "xgemail"
          },
          {
            "Key": "OwnerEmail",
            "Value": "sophosmailops@sophos.com"
          }
        ]
      }
    },
    "EipMonitorLambdaExecutionRolePolicies": {
      "Properties": {
        "PolicyDocument": {
          "Statement": [
            {
              "Action": [
                "lambda:*"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action": [
                "logs:CreateLogGroup",
                "logs:CreateLogStream",
                "logs:PutLogEvents"
              ],
              "Effect": "Allow",
              "Resource": [
                "arn:aws:logs:*:*:*"
              ]
            },
            {
              "Action": [
                "ec2:CreateTags",
                "ec2:DescribeAddresses"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action" : [
                "kms:Decrypt",
                "kms:DescribeKey",
                "kms:ListAliases",
                "kms:ListKeys"
              ],
              "Effect" : "Allow",
              "Resource" : ["*"]
            },
            {
              "Action": [
                "s3:GetBucketLocation",
                "s3:ListBucket"
              ],
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::Join": [
                    "-", [
                      "arn:aws:s3:::cloud",
                      { "Ref": "Environment" },
                      "connections"
                    ]
                  ]
                }
              ]
            },
            {
              "Action": [
                "s3:GetObject"
              ],
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::Join": [
                    "-", [
                      "arn:aws:s3:::cloud",
                      { "Ref": "Environment" },
                      "connections/*"
                    ]
                  ]
                }
              ]
            }
          ]
        },
        "PolicyName": "root",
        "Roles": [
          {
            "Ref": "EipMonitorLambdaExecutionRole"
          }
        ]
      },
      "Type": "AWS::IAM::Policy"
    },

    "EipRotationLambdaExecutionRole" : {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [{
            "Effect": "Allow",
            "Principal": {
              "Service": [ "lambda.amazonaws.com" ]
            },
            "Action": [ "sts:AssumeRole" ]
          }]
        },
        "Path": "/",
        "Tags": [
          {
            "Key": "Application",
            "Value": "cloudemail"
          },
          {
            "Key": "BusinessUnit",
            "Value": "MSG"
          },
          {
            "Key": "Name",
            "Value": { "Fn::Join": [ "-", [ { "Ref" : "AWS::StackName" }, "EipRotationLambdaExecutionRole" ] ] }
          },
          {
            "Key": "Project",
            "Value": "xgemail"
          },
          {
            "Key": "OwnerEmail",
            "Value": "sophosmailops@sophos.com"
          }
        ]
      }
    },
    "EipRotationLambdaExecutionRolePolicies": {
      "Properties": {
        "PolicyDocument": {
          "Statement": [
            {
              "Action": [
                "autoscaling:CompleteLifecycleAction",
                "autoscaling:DescribeAutoScalingInstances",
                "autoscaling:RecordLifecycleActionHeartbeat",
                "autoscaling:UpdateAutoScalingGroup"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action": [
                "lambda:*"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action": [
                "logs:CreateLogGroup",
                "logs:CreateLogStream",
                "logs:PutLogEvents"
              ],
              "Effect": "Allow",
              "Resource": [
                "arn:aws:logs:*:*:*"
              ]
            },
            {
              "Action": [
                "ec2:AssociateAddress",
                "ec2:CreateTags",
                "ec2:DescribeAddresses",
                "ec2:DescribeInstances",
                "ec2:DescribeInstanceStatus",
                "ec2:DisassociateAddress"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action": [
                "ssm:DescribeDocument",
                "ssm:GetCommandInvocation",
                "ssm:ListInstanceAssociations",
                "ssm:ListCommands",
                "ssm:SendCommand"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            }
          ]
        },
        "PolicyName": "root",
        "Roles": [
          {
            "Ref": "EipRotationLambdaExecutionRole"
          }
        ]
      },
      "Type": "AWS::IAM::Policy"
    },

    "MultiEipRotationLambdaExecutionRole" : {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [{
            "Effect": "Allow",
            "Principal": {
              "Service": [ "lambda.amazonaws.com" ]
            },
            "Action": [ "sts:AssumeRole" ]
          }]
        },
        "Path": "/",
        "Tags": [
          {
            "Key": "Application",
            "Value": "cloudemail"
          },
          {
            "Key": "BusinessUnit",
            "Value": "MSG"
          },
          {
            "Key": "Name",
            "Value": { "Fn::Join": [ "-", [ { "Ref" : "AWS::StackName" }, "MultiEipRotationLambdaExecutionRole" ] ] }
          },
          {
            "Key": "Project",
            "Value": "xgemail"
          },
          {
            "Key": "OwnerEmail",
            "Value": "sophosmailops@sophos.com"
          }
        ]
      }
    },
    "MultiEipRotationLambdaExecutionRolePolicies": {
      "Properties": {
        "PolicyDocument": {
          "Statement": [
            {
              "Action": [
                "autoscaling:CompleteLifecycleAction",
                "autoscaling:DescribeAutoScalingInstances",
                "autoscaling:RecordLifecycleActionHeartbeat",
                "autoscaling:UpdateAutoScalingGroup"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action": [
                "lambda:*"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action": [
                "logs:CreateLogGroup",
                "logs:CreateLogStream",
                "logs:PutLogEvents"
              ],
              "Effect": "Allow",
              "Resource": [
                "arn:aws:logs:*:*:*"
              ]
            },
            {
              "Action": [
                "ec2:AssociateAddress",
                "ec2:CreateTags",
                "ec2:DescribeAddresses",
                "ec2:DescribeInstances",
                "ec2:DescribeInstanceStatus",
                "ec2:DisassociateAddress"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action": [
                "ec2:AssignPrivateIpAddresses",
                "ec2:AssociateAddress",
                "ec2:DescribeAddresses",
                "ec2:DescribeInstances",
                "ec2:DescribeInstanceStatus",
                "ec2:DescribeNetworkInterfaces",
                "ec2:DisassociateAddress"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action": [
                "ssm:DescribeDocument",
                "ssm:GetCommandInvocation",
                "ssm:ListInstanceAssociations",
                "ssm:ListCommands",
                "ssm:SendCommand"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            }
          ]
        },
        "PolicyName": "root",
        "Roles": [
          {
            "Ref": "MultiEipRotationLambdaExecutionRole"
          }
        ]
      },
      "Type": "AWS::IAM::Policy"
    },

    "MfElbO365IpSyncLambdaExecutionRole" : {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [{
            "Effect": "Allow",
            "Principal": {
              "Service": [ "lambda.amazonaws.com" ]
            },
            "Action": [ "sts:AssumeRole" ]
          }]
        },
        "Path": "/",
        "Tags": [
          {
            "Key": "Application",
            "Value": "cloudemail"
          },
          {
            "Key": "BusinessUnit",
            "Value": "MSG"
          },
          {
            "Key": "Name",
            "Value": { "Fn::Join": [ "-", [ { "Ref" : "AWS::StackName" }, "MfElbO365IpSyncLambdaExecutionRole" ] ] }
          },
          {
            "Key": "Project",
            "Value": "xgemail"
          },
          {
            "Key": "OwnerEmail",
            "Value": "sophosmailops@sophos.com"
          }
        ]
      }
    },
    "MfElbO365IpSyncLambdaExecutionRolePolicies": {
      "Properties": {
        "PolicyDocument": {
          "Statement": [
            {
              "Action": [
                "lambda:*"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action": [
                "logs:CreateLogGroup",
                "logs:CreateLogStream",
                "logs:PutLogEvents"
              ],
              "Effect": "Allow",
              "Resource": [
                "arn:aws:logs:*:*:*"
              ]
            },
            {
              "Action": [
                "ec2:AuthorizeSecurityGroupIngress",
                "ec2:DescribeSecurityGroups",
                "ec2:RevokeSecurityGroupIngress"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            }
          ]
        },
        "PolicyName": "root",
        "Roles": [
          {
            "Ref": "MfElbO365IpSyncLambdaExecutionRole"
          }
        ]
      },
      "Type": "AWS::IAM::Policy"
    },

    "FirehoseTransformationLambdaExecutionRole" : {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [{
            "Effect": "Allow",
            "Principal": {
              "Service": [ "lambda.amazonaws.com" ]
            },
            "Action": [ "sts:AssumeRole" ]
          }]
        },
        "Path": "/",
        "Tags": [
          {
            "Key": "Application",
            "Value": "cloudemail"
          },
          {
            "Key": "BusinessUnit",
            "Value": "MSG"
          },
          {
            "Key": "Name",
            "Value": { "Fn::Join": [ "-", [ { "Ref" : "AWS::StackName" }, "FirehoseTransformationLambdaExecutionRole" ] ] }
          },
          {
            "Key": "Project",
            "Value": "xgemail"
          },
          {
            "Key": "OwnerEmail",
            "Value": "sophosmailops@sophos.com"
          }
        ]
      }
    },
    "FirehoseTransformationLambdaExecutionRolePolicies": {
      "Properties": {
        "PolicyDocument": {
          "Statement": [
            {
              "Action": [
                "logs:CreateLogGroup",
                "logs:CreateLogStream",
                "logs:PutLogEvents"
              ],
              "Effect": "Allow",
              "Resource": [
                "arn:aws:logs:*:*:*"
              ]
            }
          ]
        },
        "PolicyName": "root",
        "Roles": [
          {
            "Ref": "FirehoseTransformationLambdaExecutionRole"
          }
        ]
      },
      "Type": "AWS::IAM::Policy"
    },

    "LogicMonitorInstanceProfile": {
      "Properties": {
        "Path": "/",
        "Roles": [
          {
            "Ref": "LogicMonitorInstanceRole"
          }
        ]
      },
      "Type": "AWS::IAM::InstanceProfile"
    },
    "LogicMonitorInstanceRole": {
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Statement": [
            {
              "Action": [
                "sts:AssumeRole"
              ],
              "Effect": "Allow",
              "Principal": {
                "Service": [
                  "ec2.amazonaws.com"
                ]
              }
            }
          ]
        },
        "Path": "/",
        "Tags": [
          {
            "Key": "Application",
            "Value": "LogicMonitor"
          },
          {
            "Key": "BusinessUnit",
            "Value": "MSG"
          },
          {
            "Key": "Name",
            "Value": { "Fn::Join": [ "-", [ { "Ref" : "AWS::StackName" }, "LogicMonitorInstanceRole" ] ] }
          },
          {
            "Key": "Project",
            "Value": "xgemail"
          },
          {
            "Key": "OwnerEmail",
            "Value": "sophosmailops@sophos.com"
          }
        ]
      },
      "Type": "AWS::IAM::Role"
    },
    "LogicMonitorInstancePolicies": {
      "Properties": {
        "PolicyDocument": {
          "Statement": [
            {
              "Action": [
                "ec2:DescribeClassicLinkInstances",
                "ec2:DescribeInstanceAttribute",
                "ec2:DescribeInstanceStatus",
                "ec2:DescribeInstances",
                "ec2:DescribeNetworkInterfaceAttribute",
                "ec2:DescribeNetworkInterfaces",
                "ec2:DescribeRegions",
                "ec2:DescribeTags",
                "ec2:DescribeVolumeAttribute",
                "ec2:DescribeVolumeStatus",
                "ec2:DescribeVolumes",
                "ec2:MonitorInstances",
                "autoscaling:DescribeAutoScalingGroups",
                "autoscaling:DescribeAutoScalingInstances",
                "autoscaling:DescribeTags"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action": [
                "s3:*"

              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },

            {
              "Effect": "Allow",
              "Action": [
                "logs:CreateLogGroup",
                "logs:CreateLogStream",
                "logs:DescribeLogGroups",
                "logs:DescribeLogStreams",
                "logs:DescribeMetricFilters",
                "logs:PutLogEvents"
              ],
              "Resource": [
                "*"
              ]
            },
            {
              "Action": [
                "ec2:DescribeInstances",
                "ec2:CreateTags"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Effect": "Allow",
              "Action": [
                "kms:Decrypt",
                "kms:DescribeKey",
                "kms:Encrypt",
                "kms:List*",
                "kms:GenerateDataKey"
              ],
              "Resource": [
                "*"
              ]
            }
          ]
        },
        "PolicyName": "root",
        "Roles": [
          {
            "Ref": "LogicMonitorInstanceRole"
          }
        ]
      },
      "Type": "AWS::IAM::Policy"
    },

    "XgemailCustomerDeliveryInstanceProfile" : {
      "Type" : "AWS::IAM::InstanceProfile",
      "Properties" : {
        "Path" : "/",
        "Roles" : [
          {
            "Ref" : "XgemailCustomerDeliveryInstanceRole"
          }
        ]
      }
    },
    "XgemailCustomerDeliveryInstanceRole" : {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "ManagedPolicyArns": [ "arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore" ],
        "AssumeRolePolicyDocument": {
          "Statement": [
            {
              "Action": ["sts:AssumeRole"],
              "Effect": "Allow",
              "Principal": {
                "Service": ["ec2.amazonaws.com"]
              }
            }
          ]
        },
        "Path": "/",
        "Tags": [
          {
            "Key": "Application",
            "Value": "customer-delivery"
          },
          {
            "Key": "BusinessUnit",
            "Value": "MSG"
          },
          {
            "Key": "Name",
            "Value": { "Fn::Join": [ "-", [ { "Ref" : "AWS::StackName" }, "XgemailCustomerDeliveryInstanceRole" ] ] }
          },
          {
            "Key": "Project",
            "Value": "xgemail"
          },
          {
            "Key": "OwnerEmail",
            "Value": "sophosmailops@sophos.com"
          }
        ]
      }
    },
    "XgemailCustomerDeliveryInstanceRolePolicies" : {
      "Type" : "AWS::IAM::Policy",
      "Properties" : {
        "PolicyDocument" : {
          "Statement" : [
            {
              "Action": [
                "autoscaling:CompleteLifecycleAction",
                "autoscaling:DescribeAutoScalingInstances",
                "autoscaling:DescribeLifecycleHooks",
                "autoscaling:RecordLifecycleActionHeartbeat",
                "autoscaling:UpdateAutoScalingGroup"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action" : [
                "ec2:AttachVolume",
                "ec2:CreateSnapshot",
                "ec2:CreateTags",
                "ec2:CreateVolume",
                "ec2:DeleteVolume",
                "ec2:DescribeImages",
                "ec2:DescribeInstanceAttribute",
                "ec2:DescribeInstances",
                "ec2:DescribeNatGateways",
                "ec2:DescribeNetworkInterfaces",
                "ec2:DescribeRouteTables",
                "ec2:DescribeSnapshots",
                "ec2:DescribeSubnets",
                "ec2:DescribeTags",
                "ec2:DescribeVolumes",
                "ec2:DescribeVpcs",
                "ec2:DetachVolume",
                "ec2:ModifyInstanceAttribute",
                "ec2:ModifySnapshotAttribute"
              ],
              "Effect" : "Allow",
              "Resource" : ["*"]
            },
            {
              "Action": [
                "iam:GetRole"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action" : [
                "kms:CreateGrant",
                "kms:Decrypt",
                "kms:DescribeKey",
                "kms:Encrypt",
                "kms:GenerateDataKey",
                "kms:GenerateDataKeyWithoutPlaintext",
                "kms:List*",
                "kms:ReEncrypt*",
                "kms:RevokeGrant"
              ],
              "Effect" : "Allow",
              "Resource" : ["*"]
            },
            {
              "Action": [
                "logs:CreateLogGroup",
                "logs:CreateLogStream",
                "logs:DescribeLogGroups",
                "logs:DescribeLogStreams",
                "logs:DescribeMetricFilters",
                "logs:PutLogEvents"
              ],
              "Effect": "Allow",
              "Resource": [ "*" ]
            },
            {
              "Action" : [
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:ListBucket",
                "s3:PutObject",
                "s3:RestoreObject"
              ],
              "Effect" : "Allow",
              "Resource" : [{ "Fn::Join" : ["", ["arn:aws:s3:::", { "Ref" : "XgemailMsgHistoryBucketName" }, "/*"]]},
                { "Fn::Join" : ["", ["arn:aws:s3:::", { "Ref" : "XgemailMsgHistoryBucketName" }]]}]
            },
            {
              "Action" : [
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:ListBucket",
                "s3:PutObject",
                "s3:RestoreObject"
              ],
              "Effect" : "Allow",
              "Resource" : [{ "Fn::Join" : ["", ["arn:aws:s3:::", { "Ref" : "XgemailMsgHistoryMsBucketName" }, "/*"]]},
                { "Fn::Join" : ["", ["arn:aws:s3:::", { "Ref" : "XgemailMsgHistoryMsBucketName" }]]}]
            },
            {
              "Action" : [
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:ListBucket",
                "s3:PutObject",
                "s3:RestoreObject"
              ],
              "Effect" : "Allow",
              "Resource" : [{ "Fn::Join" : ["", ["arn:aws:s3:::", { "Ref" : "MsgHistoryV2BucketName" }, "/*"]]},
                { "Fn::Join" : ["", ["arn:aws:s3:::", { "Ref" : "MsgHistoryV2BucketName" }]]}]
            },
            {
              "Action" : [
                "s3:DeleteObject",
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:ListBucket",
                "s3:PutObject",
                "s3:RestoreObject"
              ],
              "Effect" : "Allow",
              "Resource" : [{ "Fn::Join" : ["", ["arn:aws:s3:::", { "Ref" : "XgemailQuarantineBucketName" }, "/*"]]},
                { "Fn::Join" : ["", ["arn:aws:s3:::", { "Ref" : "XgemailQuarantineBucketName" }]]}]
            },
            {
              "Action": [
                "s3:DeleteObject",
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:ListBucket",
                "s3:PutObject"
              ],
              "Effect": "Allow",
              "Resource": [
                { "Fn::Join": [ "", [ "arn:aws:s3:::", { "Ref": "XgemailPolicyBucketName" }, "/*" ] ] },
                { "Fn::Join": [ "", [ "arn:aws:s3:::", { "Ref": "XgemailPolicyBucketName" } ] ] }
              ]
            },
            {
              "Action" : [
                "s3:DeleteObject",
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:ListBucket"
              ],
              "Effect" : "Allow",
              "Resource" : [{ "Fn::Join" : ["", ["arn:aws:s3:::", { "Ref" : "XgemailInternetSubmitBucketName" }, "/*"]]},
                { "Fn::Join" : ["", ["arn:aws:s3:::", { "Ref" : "XgemailInternetSubmitBucketName" }]]}]
            },
            {
              "Action" : [
                "s3:GetBucketLocation",
                "s3:ListBucket"
              ],
              "Effect" : "Allow",
              "Resource" : [ { "Fn::Join": [ "-", [ "arn:aws:s3:::logs-sophos-msg", { "Ref": "Environment" }, "*" ] ] } ]
            },
            {
              "Action" : [
                "s3:PutObject"
              ],
              "Effect" : "Allow",
              "Resource" : [ { "Fn::Join": [ "/", [ { "Fn::Join": [ "-", [ "arn:aws:s3:::logs-sophos-msg", { "Ref": "Environment" }, "*" ] ] }, "*" ] ] } ]
            },
            {
              "Action": [
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:PutObject",
                "s3:GetEncryptionConfiguration",
                "s3:AbortMultipartUpload",
                "s3:ListMultipartUploadParts",
                "s3:ListBucket",
                "s3:ListBucketMultipartUploads"
              ],
              "Resource": [
                { "Fn::Join" : ["-", ["arn:aws:s3:::cloud", { "Ref": "Environment" }, "ssm-session-logs/*"]]},
                { "Fn::Join" : ["-", ["arn:aws:s3:::cloud", { "Ref": "Environment" }, "ssm-session-logs" ]]}
              ],
              "Effect": "Allow"
            },
            {
              "Action": [
                "s3:DeleteObject",
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:PutObject"
              ],
              "Effect": "Allow",
              "Resource": [
                "arn:aws:s3:::cloud-*"
              ]
            },
            {
              "Action": [
                "sdb:BatchDeleteAttributes",
                "sdb:BatchPutAttributes",
                "sdb:CreateDomain",
                "sdb:DeleteAttributes",
                "sdb:DeleteDomain",
                "sdb:DomainMetadata",
                "sdb:GetAttributes",
                "sdb:ListDomains",
                "sdb:PutAttributes",
                "sdb:Select"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action": [
                "sns:ListSubscriptionsByTopic",
                "sns:ListTopics",
                "sns:Publish",
                "sns:Subscribe",
                "sns:Unsubscribe"
              ],
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::Join": [
                    ":",
                    [
                      "arn:aws:sns",
                      { "Ref": "AWS::Region" },
                      { "Ref": "AWS::AccountId" },
                      "*"
                    ]
                  ]
                }
              ]
            },
            {
              "Action" : [
                "sqs:ChangeMessageVisibility",
                "sqs:CreateQueue",
                "sqs:DeleteMessage",
                "sqs:DeleteQueue",
                "sqs:GetQueueAttributes",
                "sqs:GetQueueUrl",
                "sqs:ListQueues",
                "sqs:SendMessage",
                "sqs:SetQueueAttributes",
                "sqs:ReceiveMessage"
              ],
              "Effect" : "Allow",
              "Resource" : ["*"]
            },
            {
              "Action": [
                "firehose:DescribeDeliveryStream",
                "firehose:PutRecord",
                "firehose:PutRecordBatch"
              ],
              "Effect" : "Allow",
              "Resource": [
                {
                  "Fn::Join": [
                    ":",
                    [
                      "arn:aws:firehose",
                      { "Ref": "AWS::Region" },
                      { "Ref": "AWS::AccountId" },
                      {
                        "Fn::Join": [
                          "-",
                          [
                            "deliverystream/tf-e2e-latency-telemetry",
                            { "Ref": "AWS::Region" },
                            { "Ref": "Environment" },
                            "firehose"
                          ]
                        ]
                      }
                    ]
                  ]
                }
              ]
            },
            {
              "Action": [
                "firehose:DescribeDeliveryStream",
                "firehose:PutRecord",
                "firehose:PutRecordBatch"
              ],
              "Effect" : "Allow",
              "Resource": [
                {
                  "Fn::Sub": "arn:aws:firehose:${AWS::Region}:${AWS::AccountId}:deliverystream/${MsgHistoryV2StreamName}"
                }
              ]
            },
            {
              "Action": [
                "kinesis:DescribeStream",
                "kinesis:PutRecord",
                "kinesis:PutRecords"
              ],
              "Effect" : "Allow",
              "Resource": [
                {
                  "Fn::Sub": "arn:aws:kinesis:${AWS::Region}:${AWS::AccountId}:stream/${MsgHistoryDataStreamName}"
                }
              ]
            },
            {
              "Action": [
                "dynamodb:BatchWriteItem",
                "dynamodb:DeleteItem",
                "dynamodb:BatchGetItem",
                "dynamodb:Scan",
                "dynamodb:ListTables",
                "dynamodb:GetItem",
                "dynamodb:GetRecords",
                "dynamodb:DescribeTable",
                "dynamodb:PutItem",
                "dynamodb:Query",
                "dynamodb:UpdateItem",
                "dynamodb:UpdateTable"
              ],
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::Sub": "arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${MsgHistoryV2DynamoDbTableName}"
                }
              ]
            },
            {
              "Action": [
                "secretsmanager:ListSecrets"
              ],
              "Effect" : "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action": [
                "secretsmanager:GetResourcePolicy",
                "secretsmanager:GetSecretValue",
                "secretsmanager:DescribeSecret",
                "secretsmanager:ListSecretVersionIds"
              ],
              "Effect" : "Allow",
              "Resource": [
                {
                  "Fn::Sub": "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:/central/newrelic/license*"
                }
              ]
            }
          ]
        },
        "PolicyName" : "root",
        "Roles" : [
          {
            "Ref" : "XgemailCustomerDeliveryInstanceRole"
          }
        ]
      }
    },

    "XgemailMfInboundDeliveryInstanceProfile" : {
      "Type" : "AWS::IAM::InstanceProfile",
      "Properties" : {
        "Path" : "/",
        "Roles" : [
          {
            "Ref" : "XgemailMfInboundDeliveryInstanceRole"
          }
        ]
      }
    },
    "XgemailMfInboundDeliveryInstanceRole" : {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "ManagedPolicyArns": [ "arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore" ],
        "AssumeRolePolicyDocument": {
          "Statement": [
            {
              "Action": ["sts:AssumeRole"],
              "Effect": "Allow",
              "Principal": {
                "Service": ["ec2.amazonaws.com"]
              }
            }
          ]
        },
        "Path": "/",
        "Tags": [
          {
            "Key": "Application",
            "Value": "mf-inbound-delivery"
          },
          {
            "Key": "BusinessUnit",
            "Value": "MSG"
          },
          {
            "Key": "Name",
            "Value": { "Fn::Join": [ "-", [ { "Ref" : "AWS::StackName" }, "XgemailMfInboundDeliveryInstanceRole" ] ] }
          },
          {
            "Key": "Project",
            "Value": "xgemail"
          },
          {
            "Key": "OwnerEmail",
            "Value": "sophosmailops@sophos.com"
          }
        ]
      }
    },
    "XgemailMfInboundDeliveryInstanceRolePolicies" : {
      "Type" : "AWS::IAM::Policy",
      "Properties" : {
        "PolicyDocument" : {
          "Statement" : [
            {
              "Action": [
                "autoscaling:CompleteLifecycleAction",
                "autoscaling:DescribeAutoScalingInstances",
                "autoscaling:DescribeLifecycleHooks",
                "autoscaling:RecordLifecycleActionHeartbeat",
                "autoscaling:UpdateAutoScalingGroup"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action" : [
                "ec2:AttachVolume",
                "ec2:CreateSnapshot",
                "ec2:CreateTags",
                "ec2:CreateVolume",
                "ec2:DeleteVolume",
                "ec2:DescribeImages",
                "ec2:DescribeInstanceAttribute",
                "ec2:DescribeInstances",
                "ec2:DescribeNatGateways",
                "ec2:DescribeNetworkInterfaces",
                "ec2:DescribeRouteTables",
                "ec2:DescribeSnapshots",
                "ec2:DescribeSubnets",
                "ec2:DescribeTags",
                "ec2:DescribeVolumes",
                "ec2:DescribeVpcs",
                "ec2:DetachVolume",
                "ec2:ModifyInstanceAttribute",
                "ec2:ModifySnapshotAttribute"
              ],
              "Effect" : "Allow",
              "Resource" : ["*"]
            },
            {
              "Action": [
                "iam:GetRole"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action" : [
                "kms:CreateGrant",
                "kms:Decrypt",
                "kms:DescribeKey",
                "kms:Encrypt",
                "kms:GenerateDataKey",
                "kms:GenerateDataKeyWithoutPlaintext",
                "kms:List*",
                "kms:ReEncrypt*",
                "kms:RevokeGrant"
              ],
              "Effect" : "Allow",
              "Resource" : ["*"]
            },
            {
              "Action": [
                "logs:CreateLogGroup",
                "logs:CreateLogStream",
                "logs:DescribeLogGroups",
                "logs:DescribeLogStreams",
                "logs:DescribeMetricFilters",
                "logs:PutLogEvents"
              ],
              "Effect": "Allow",
              "Resource": [ "*" ]
            },
            {
              "Action" : [
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:ListBucket",
                "s3:PutObject",
                "s3:RestoreObject"
              ],
              "Effect" : "Allow",
              "Resource" : [{ "Fn::Join" : ["", ["arn:aws:s3:::", { "Ref" : "XgemailMsgHistoryBucketName" }, "/*"]]},
                { "Fn::Join" : ["", ["arn:aws:s3:::", { "Ref" : "XgemailMsgHistoryBucketName" }]]}]
            },
            {
              "Action" : [
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:ListBucket",
                "s3:PutObject",
                "s3:RestoreObject"
              ],
              "Effect" : "Allow",
              "Resource" : [{ "Fn::Join" : ["", ["arn:aws:s3:::", { "Ref" : "XgemailMsgHistoryMsBucketName" }, "/*"]]},
                { "Fn::Join" : ["", ["arn:aws:s3:::", { "Ref" : "XgemailMsgHistoryMsBucketName" }]]}]
            },
            {
              "Action" : [
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:ListBucket",
                "s3:PutObject",
                "s3:RestoreObject"
              ],
              "Effect" : "Allow",
              "Resource" : [{ "Fn::Join" : ["", ["arn:aws:s3:::", { "Ref" : "MsgHistoryV2BucketName" }, "/*"]]},
                { "Fn::Join" : ["", ["arn:aws:s3:::", { "Ref" : "MsgHistoryV2BucketName" }]]}]
            },
            {
              "Action" : [
                "s3:DeleteObject",
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:ListBucket",
                "s3:PutObject",
                "s3:RestoreObject"
              ],
              "Effect" : "Allow",
              "Resource" : [{ "Fn::Join" : ["", ["arn:aws:s3:::", { "Ref" : "XgemailQuarantineBucketName" }, "/*"]]},
                { "Fn::Join" : ["", ["arn:aws:s3:::", { "Ref" : "XgemailQuarantineBucketName" }]]}]
            },
            {
              "Action": [
                "s3:DeleteObject",
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:ListBucket",
                "s3:PutObject"
              ],
              "Effect": "Allow",
              "Resource": [
                { "Fn::Join": [ "", [ "arn:aws:s3:::", { "Ref": "XgemailPolicyBucketName" }, "/*" ] ] },
                { "Fn::Join": [ "", [ "arn:aws:s3:::", { "Ref": "XgemailPolicyBucketName" } ] ] }
              ]
            },
            {
              "Action" : [
                "s3:DeleteObject",
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:ListBucket"
              ],
              "Effect" : "Allow",
              "Resource" : [{ "Fn::Join" : ["", ["arn:aws:s3:::", { "Ref" : "XgemailInternetSubmitBucketName" }, "/*"]]},
                { "Fn::Join" : ["", ["arn:aws:s3:::", { "Ref" : "XgemailInternetSubmitBucketName" }]]}]
            },
            {
              "Action" : [
                "s3:GetBucketLocation",
                "s3:ListBucket"
              ],
              "Effect" : "Allow",
              "Resource" : [ { "Fn::Join": [ "-", [ "arn:aws:s3:::logs-sophos-msg", { "Ref": "Environment" }, "*" ] ] } ]
            },
            {
              "Action" : [
                "s3:PutObject"
              ],
              "Effect" : "Allow",
              "Resource" : [ { "Fn::Join": [ "/", [ { "Fn::Join": [ "-", [ "arn:aws:s3:::logs-sophos-msg", { "Ref": "Environment" }, "*" ] ] }, "*" ] ] } ]
            },
            {
              "Action": [
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:PutObject",
                "s3:GetEncryptionConfiguration",
                "s3:AbortMultipartUpload",
                "s3:ListMultipartUploadParts",
                "s3:ListBucket",
                "s3:ListBucketMultipartUploads"
              ],
              "Resource": [
                { "Fn::Join" : ["-", ["arn:aws:s3:::cloud", { "Ref": "Environment" }, "ssm-session-logs/*"]]},
                { "Fn::Join" : ["-", ["arn:aws:s3:::cloud", { "Ref": "Environment" }, "ssm-session-logs" ]]}
              ],
              "Effect": "Allow"
            },
            {
              "Action": [
                "s3:DeleteObject",
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:PutObject"
              ],
              "Effect": "Allow",
              "Resource": [
                "arn:aws:s3:::cloud-*"
              ]
            },
            {
              "Action": [
                "sdb:BatchDeleteAttributes",
                "sdb:BatchPutAttributes",
                "sdb:CreateDomain",
                "sdb:DeleteAttributes",
                "sdb:DeleteDomain",
                "sdb:DomainMetadata",
                "sdb:GetAttributes",
                "sdb:ListDomains",
                "sdb:PutAttributes",
                "sdb:Select"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action": [
                "sns:ListSubscriptionsByTopic",
                "sns:ListTopics",
                "sns:Publish",
                "sns:Subscribe",
                "sns:Unsubscribe"
              ],
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::Join": [
                    ":",
                    [
                      "arn:aws:sns",
                      { "Ref": "AWS::Region" },
                      { "Ref": "AWS::AccountId" },
                      "*"
                    ]
                  ]
                }
              ]
            },
            {
              "Action" : [
                "sqs:ChangeMessageVisibility",
                "sqs:CreateQueue",
                "sqs:DeleteMessage",
                "sqs:DeleteQueue",
                "sqs:GetQueueAttributes",
                "sqs:GetQueueUrl",
                "sqs:ListQueues",
                "sqs:SendMessage",
                "sqs:SetQueueAttributes",
                "sqs:ReceiveMessage"
              ],
              "Effect" : "Allow",
              "Resource" : ["*"]
            },
            {
              "Action": [
                "firehose:DescribeDeliveryStream",
                "firehose:PutRecord",
                "firehose:PutRecordBatch"
              ],
              "Effect" : "Allow",
              "Resource": [
                {
                  "Fn::Join": [
                    ":",
                    [
                      "arn:aws:firehose",
                      { "Ref": "AWS::Region" },
                      { "Ref": "AWS::AccountId" },
                      {
                        "Fn::Join": [
                          "-",
                          [
                            "deliverystream/tf-e2e-latency-telemetry",
                            { "Ref": "AWS::Region" },
                            { "Ref": "Environment" },
                            "firehose"
                          ]
                        ]
                      }
                    ]
                  ]
                }
              ]
            },
            {
              "Action": [
                "firehose:DescribeDeliveryStream",
                "firehose:PutRecord",
                "firehose:PutRecordBatch"
              ],
              "Effect" : "Allow",
              "Resource": [
                {
                  "Fn::Sub": "arn:aws:firehose:${AWS::Region}:${AWS::AccountId}:deliverystream/${MsgHistoryV2StreamName}"
                }
              ]
            },
            {
              "Action": [
                "kinesis:DescribeStream",
                "kinesis:PutRecord",
                "kinesis:PutRecords"
              ],
              "Effect" : "Allow",
              "Resource": [
                {
                  "Fn::Sub": "arn:aws:kinesis:${AWS::Region}:${AWS::AccountId}:stream/${MsgHistoryDataStreamName}"
                }
              ]
            },
            {
              "Action": [
                "dynamodb:BatchWriteItem",
                "dynamodb:DeleteItem",
                "dynamodb:BatchGetItem",
                "dynamodb:Scan",
                "dynamodb:ListTables",
                "dynamodb:GetItem",
                "dynamodb:GetRecords",
                "dynamodb:DescribeTable",
                "dynamodb:PutItem",
                "dynamodb:Query",
                "dynamodb:UpdateItem",
                "dynamodb:UpdateTable"
              ],
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::Sub": "arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${MsgHistoryV2DynamoDbTableName}"
                }
              ]
            },
            {
              "Action": [
                "secretsmanager:ListSecrets"
              ],
              "Effect" : "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action": [
                "secretsmanager:GetResourcePolicy",
                "secretsmanager:GetSecretValue",
                "secretsmanager:DescribeSecret",
                "secretsmanager:ListSecretVersionIds"
              ],
              "Effect" : "Allow",
              "Resource": [
                {
                  "Fn::Sub": "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:/central/newrelic/license*"
                }
              ]
            }
          ]
        },
        "PolicyName" : "root",
        "Roles" : [
          {
            "Ref" : "XgemailMfInboundDeliveryInstanceRole"
          }
        ]
      }
    },

    "XgemailInternetDeliveryInstanceProfile" : {
      "Type" : "AWS::IAM::InstanceProfile",
      "Properties" : {
        "Path" : "/",
        "Roles" : [
          {
            "Ref" : "XgemailInternetDeliveryInstanceRole"
          }
        ]
      }
    },
    "XgemailInternetDeliveryInstanceRole" : {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "ManagedPolicyArns": [ "arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore" ],
        "AssumeRolePolicyDocument": {
          "Statement": [
            {
              "Action": ["sts:AssumeRole"],
              "Effect": "Allow",
              "Principal": {
                "Service": ["ec2.amazonaws.com"]
              }
            }
          ]
        },
        "Path": "/",
        "Tags": [
          {
            "Key": "Application",
            "Value": "internet-delivery"
          },
          {
            "Key": "BusinessUnit",
            "Value": "MSG"
          },
          {
            "Key": "Name",
            "Value": { "Fn::Join": [ "-", [ { "Ref" : "AWS::StackName" }, "XgemailInternetDeliveryInstanceRole" ] ] }
          },
          {
            "Key": "Project",
            "Value": "xgemail"
          },
          {
            "Key": "OwnerEmail",
            "Value": "sophosmailops@sophos.com"
          }
        ]
      }
    },
    "XgemailInternetDeliveryInstanceRolePolicies" : {
      "Type" : "AWS::IAM::Policy",
      "Properties" : {
        "PolicyDocument" : {
          "Statement" : [
            {
              "Action": [
                "autoscaling:CompleteLifecycleAction",
                "autoscaling:DescribeAutoScalingInstances",
                "autoscaling:DescribeLifecycleHooks",
                "autoscaling:RecordLifecycleActionHeartbeat",
                "autoscaling:UpdateAutoScalingGroup"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action" : [
                "ec2:AssociateAddress",
                "ec2:AttachVolume",
                "ec2:CreateSnapshot",
                "ec2:CreateTags",
                "ec2:CreateVolume",
                "ec2:DeleteVolume",
                "ec2:DescribeAddresses",
                "ec2:DescribeImages",
                "ec2:DescribeInstanceAttribute",
                "ec2:DescribeInstances",
                "ec2:DescribeNatGateways",
                "ec2:DescribeNetworkInterfaces",
                "ec2:DescribeRouteTables",
                "ec2:DescribeSnapshots",
                "ec2:DescribeSubnets",
                "ec2:DescribeTags",
                "ec2:DescribeVolumes",
                "ec2:DescribeVpcs",
                "ec2:DetachVolume",
                "ec2:ModifyInstanceAttribute",
                "ec2:ModifySnapshotAttribute"
              ],
              "Effect" : "Allow",
              "Resource" : ["*"]
            },
            {
              "Action": [
                "iam:GetRole"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action" : [
                "kms:CreateGrant",
                "kms:Decrypt",
                "kms:DescribeKey",
                "kms:Encrypt",
                "kms:GenerateDataKey",
                "kms:GenerateDataKeyWithoutPlaintext",
                "kms:List*",
                "kms:ReEncrypt*",
                "kms:RevokeGrant"
              ],
              "Effect" : "Allow",
              "Resource" : ["*"]
            },
            {
              "Action": [
                "logs:CreateLogGroup",
                "logs:CreateLogStream",
                "logs:DescribeLogGroups",
                "logs:DescribeLogStreams",
                "logs:DescribeMetricFilters",
                "logs:PutLogEvents"
              ],
              "Effect": "Allow",
              "Resource": [ "*" ]
            },
            {
              "Action" : [
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:ListBucket",
                "s3:PutObject",
                "s3:RestoreObject"
              ],
              "Effect" : "Allow",
              "Resource" : [{ "Fn::Join" : ["", ["arn:aws:s3:::", { "Ref" : "XgemailMsgHistoryBucketName" }, "/*"]]},
                { "Fn::Join" : ["", ["arn:aws:s3:::", { "Ref" : "XgemailMsgHistoryBucketName" }]]}]
            },
            {
              "Action" : [
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:ListBucket",
                "s3:PutObject",
                "s3:RestoreObject"
              ],
              "Effect" : "Allow",
              "Resource" : [{ "Fn::Join" : ["", ["arn:aws:s3:::", { "Ref" : "XgemailMsgHistoryMsBucketName" }, "/*"]]},
                { "Fn::Join" : ["", ["arn:aws:s3:::", { "Ref" : "XgemailMsgHistoryMsBucketName" }]]}]
            },
            {
              "Action" : [
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:ListBucket",
                "s3:PutObject",
                "s3:RestoreObject"
              ],
              "Effect" : "Allow",
              "Resource" : [{ "Fn::Join" : ["", ["arn:aws:s3:::", { "Ref" : "MsgHistoryV2BucketName" }, "/*"]]},
                { "Fn::Join" : ["", ["arn:aws:s3:::", { "Ref" : "MsgHistoryV2BucketName" }]]}]
            },
            {
              "Action" : [
                "s3:DeleteObject",
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:ListBucket"
              ],
              "Effect" : "Allow",
              "Resource" : [{ "Fn::Join" : ["", ["arn:aws:s3:::", { "Ref" : "XgemailCustomerSubmitBucketName" }, "/*"]]},
                { "Fn::Join" : ["", ["arn:aws:s3:::", { "Ref" : "XgemailCustomerSubmitBucketName" }]]}]
            },
            {
              "Action": [
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:ListBucket"
              ],
              "Effect": "Allow",
              "Resource": [
                { "Fn::Join": [ "", [ "arn:aws:s3:::", { "Ref": "XgemailPolicyBucketName" }, "/*" ] ] },
                { "Fn::Join": [ "", [ "arn:aws:s3:::", { "Ref": "XgemailPolicyBucketName" } ] ] }
              ]
            },
            {
              "Action" : [
                "s3:GetBucketLocation",
                "s3:ListBucket"
              ],
              "Effect" : "Allow",
              "Resource" : [ { "Fn::Join": [ "-", [ "arn:aws:s3:::logs-sophos-msg", { "Ref": "Environment" }, "*" ] ] } ]
            },
            {
              "Action" : [
                "s3:PutObject"
              ],
              "Effect" : "Allow",
              "Resource" : [ { "Fn::Join": [ "/", [ { "Fn::Join": [ "-", [ "arn:aws:s3:::logs-sophos-msg", { "Ref": "Environment" }, "*" ] ] }, "*" ] ] } ]
            },
            {
              "Action": [
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:PutObject",
                "s3:GetEncryptionConfiguration",
                "s3:AbortMultipartUpload",
                "s3:ListMultipartUploadParts",
                "s3:ListBucket",
                "s3:ListBucketMultipartUploads"
              ],
              "Resource": [
                { "Fn::Join" : ["-", ["arn:aws:s3:::cloud", { "Ref": "Environment" }, "ssm-session-logs/*"]]},
                { "Fn::Join" : ["-", ["arn:aws:s3:::cloud", { "Ref": "Environment" }, "ssm-session-logs" ]]}
              ],
              "Effect": "Allow"
            },
            {
              "Action": [
                "s3:DeleteObject",
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:PutObject"
              ],
              "Effect": "Allow",
              "Resource": [
                "arn:aws:s3:::cloud-*"
              ]
            },
            {
              "Action": [
                "sdb:BatchDeleteAttributes",
                "sdb:BatchPutAttributes",
                "sdb:CreateDomain",
                "sdb:DeleteAttributes",
                "sdb:DeleteDomain",
                "sdb:DomainMetadata",
                "sdb:GetAttributes",
                "sdb:ListDomains",
                "sdb:PutAttributes",
                "sdb:Select"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action": [
                "sns:ListSubscriptionsByTopic",
                "sns:ListTopics",
                "sns:Publish",
                "sns:Subscribe",
                "sns:Unsubscribe"
              ],
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::Join": [
                    ":",
                    [
                      "arn:aws:sns",
                      { "Ref": "AWS::Region" },
                      { "Ref": "AWS::AccountId" },
                      "*"
                    ]
                  ]
                }
              ]
            },
            {
              "Action" : [
                "sqs:ChangeMessageVisibility",
                "sqs:CreateQueue",
                "sqs:DeleteMessage",
                "sqs:DeleteQueue",
                "sqs:GetQueueAttributes",
                "sqs:GetQueueUrl",
                "sqs:ListQueues",
                "sqs:SendMessage",
                "sqs:SetQueueAttributes",
                "sqs:ReceiveMessage"
              ],
              "Effect" : "Allow",
              "Resource" : ["*"]
            },
            {
              "Action": [
                "firehose:DescribeDeliveryStream",
                "firehose:PutRecord",
                "firehose:PutRecordBatch"
              ],
              "Effect" : "Allow",
              "Resource": [
                {
                  "Fn::Join": [
                    ":",
                    [
                      "arn:aws:firehose",
                      { "Ref": "AWS::Region" },
                      { "Ref": "AWS::AccountId" },
                      {
                        "Fn::Join": [
                          "-",
                          [
                            "deliverystream/tf-e2e-latency-telemetry",
                            { "Ref": "AWS::Region" },
                            { "Ref": "Environment" },
                            "firehose"
                          ]
                        ]
                      }
                    ]
                  ]
                }
              ]
            },
            {
              "Action": [
                "firehose:DescribeDeliveryStream",
                "firehose:PutRecord",
                "firehose:PutRecordBatch"
              ],
              "Effect" : "Allow",
              "Resource": [
                {
                  "Fn::Sub": "arn:aws:firehose:${AWS::Region}:${AWS::AccountId}:deliverystream/${MsgHistoryV2StreamName}"
                }
              ]
            },
            {
              "Action": [
                "kinesis:DescribeStream",
                "kinesis:PutRecord",
                "kinesis:PutRecords"
              ],
              "Effect" : "Allow",
              "Resource": [
                {
                  "Fn::Sub": "arn:aws:kinesis:${AWS::Region}:${AWS::AccountId}:stream/${MsgHistoryDataStreamName}"
                }
              ]
            },
            {
              "Action": [
                "dynamodb:BatchWriteItem",
                "dynamodb:DeleteItem",
                "dynamodb:BatchGetItem",
                "dynamodb:Scan",
                "dynamodb:ListTables",
                "dynamodb:GetItem",
                "dynamodb:GetRecords",
                "dynamodb:DescribeTable",
                "dynamodb:PutItem",
                "dynamodb:Query",
                "dynamodb:UpdateItem",
                "dynamodb:UpdateTable"
              ],
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::Sub": "arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${MsgHistoryV2DynamoDbTableName}"
                }
              ]
            },
            {
              "Action": [
                "secretsmanager:ListSecrets"
              ],
              "Effect" : "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action": [
                "secretsmanager:GetResourcePolicy",
                "secretsmanager:GetSecretValue",
                "secretsmanager:DescribeSecret",
                "secretsmanager:ListSecretVersionIds"
              ],
              "Effect" : "Allow",
              "Resource": [
                {
                  "Fn::Sub": "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:/central/newrelic/license*"
                }
              ]
            }
          ]
        },
        "PolicyName" : "root",
        "Roles" : [
          {
            "Ref" : "XgemailInternetDeliveryInstanceRole"
          }
        ]
      }
    },

    "XgemailInternetSubmitInstanceProfile" : {
      "Type" : "AWS::IAM::InstanceProfile",
      "Properties" : {
        "Path" : "/",
        "Roles" : [
          {
            "Ref" : "XgemailInternetSubmitInstanceRole"
          }
        ]
      }
    },
    "XgemailInternetSubmitInstanceRole": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "ManagedPolicyArns": [ "arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore" ],
        "AssumeRolePolicyDocument": {
          "Statement": [
            {
              "Action": [ "sts:AssumeRole" ],
              "Effect": "Allow",
              "Principal": {
                "Service": [ "ec2.amazonaws.com" ]
              }
            }
          ]
        },
        "Path": "/",
        "Tags": [
          {
            "Key": "Application",
            "Value": "internet-submit"
          },
          {
            "Key": "BusinessUnit",
            "Value": "MSG"
          },
          {
            "Key": "Name",
            "Value": { "Fn::Join": [ "-", [ { "Ref" : "AWS::StackName" }, "XgemailInternetSubmitInstanceRole" ] ] }
          },
          {
            "Key": "Project",
            "Value": "xgemail"
          },
          {
            "Key": "OwnerEmail",
            "Value": "sophosmailops@sophos.com"
          }
        ]
      }
    },
    "XgemailInternetSubmitInstanceRolePolicies": {
      "Type": "AWS::IAM::Policy",
      "Properties": {
        "PolicyDocument": {
          "Statement": [
            {
              "Action": [
                "autoscaling:CompleteLifecycleAction",
                "autoscaling:DescribeAutoScalingInstances",
                "autoscaling:DescribeLifecycleHooks",
                "autoscaling:RecordLifecycleActionHeartbeat",
                "autoscaling:UpdateAutoScalingGroup"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action": [
                "ec2:AttachVolume",
                "ec2:CreateSnapshot",
                "ec2:CreateTags",
                "ec2:CreateVolume",
                "ec2:DeleteVolume",
                "ec2:DescribeImages",
                "ec2:DescribeInstanceAttribute",
                "ec2:DescribeInstances",
                "ec2:DescribeNatGateways",
                "ec2:DescribeNetworkInterfaces",
                "ec2:DescribeRouteTables",
                "ec2:DescribeSnapshots",
                "ec2:DescribeSubnets",
                "ec2:DescribeTags",
                "ec2:DescribeVolumes",
                "ec2:DescribeVpcs",
                "ec2:DetachVolume",
                "ec2:ModifyInstanceAttribute",
                "ec2:ModifySnapshotAttribute"
              ],
              "Effect": "Allow",
              "Resource": [ "*" ]
            },
            {
              "Action": [
                "iam:GetRole"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action": [
                "kms:CreateGrant",
                "kms:Decrypt",
                "kms:DescribeKey",
                "kms:Encrypt",
                "kms:GenerateDataKey",
                "kms:GenerateDataKeyWithoutPlaintext",
                "kms:List*",
                "kms:ReEncrypt*",
                "kms:RevokeGrant"
              ],
              "Effect": "Allow",
              "Resource": [ "*" ]
            },
            {
              "Action": [
                "logs:CreateLogGroup",
                "logs:CreateLogStream",
                "logs:DescribeLogGroups",
                "logs:DescribeLogStreams",
                "logs:DescribeMetricFilters",
                "logs:PutLogEvents"
              ],
              "Effect": "Allow",
              "Resource": [ "*" ]
            },
            {
              "Action": [
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:ListBucket",
                "s3:PutObject",
                "s3:RestoreObject"
              ],
              "Effect": "Allow",
              "Resource": [
                { "Fn::Join": [ "", [ "arn:aws:s3:::", { "Ref": "XgemailMsgHistoryBucketName" }, "/*" ] ] },
                { "Fn::Join": [ "", [ "arn:aws:s3:::", { "Ref": "XgemailMsgHistoryBucketName" } ] ] }
              ]
            },
            {
              "Action" : [
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:ListBucket",
                "s3:PutObject",
                "s3:RestoreObject"
              ],
              "Effect" : "Allow",
              "Resource" : [{ "Fn::Join" : ["", ["arn:aws:s3:::", { "Ref" : "MsgHistoryV2BucketName" }, "/*"]]},
                { "Fn::Join" : ["", ["arn:aws:s3:::", { "Ref" : "MsgHistoryV2BucketName" }]]}]
            },
            {
              "Action": [
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:ListBucket",
                "s3:PutObject"
              ],
              "Effect": "Allow",
              "Resource": [
                { "Fn::Join": [ "", [ "arn:aws:s3:::", { "Ref": "DeliveryDirectorBucketName" }, "/*" ] ] },
                { "Fn::Join": [ "", [ "arn:aws:s3:::", { "Ref": "DeliveryDirectorBucketName" } ] ] }
              ]
            },
            {
              "Action": [
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:ListBucket",
                "s3:PutObject",
                "s3:RestoreObject"
              ],
              "Effect": "Allow",
              "Resource": [
                { "Fn::Join": [ "", [ "arn:aws:s3:::", { "Ref": "XgemailMsgHistoryMsBucketName" }, "/*" ] ] },
                { "Fn::Join": [ "", [ "arn:aws:s3:::", { "Ref": "XgemailMsgHistoryMsBucketName" } ] ] }
              ]
            },
            {
              "Action": [
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:ListBucket"
              ],
              "Effect": "Allow",
              "Resource": [
                { "Fn::Join": [ "", [ "arn:aws:s3:::", { "Ref": "XgemailPolicyBucketName" }, "/*" ] ] },
                { "Fn::Join": [ "", [ "arn:aws:s3:::", { "Ref": "XgemailPolicyBucketName" } ] ] }
              ]
            },
            {
              "Action": [
                "s3:DeleteObject",
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:ListBucket",
                "s3:PutObject",
                "s3:RestoreObject"
              ],
              "Effect": "Allow",
              "Resource": [
                { "Fn::Join": [ "", [ "arn:aws:s3:::", { "Ref": "XgemailQuarantineBucketName" }, "/*" ] ] },
                { "Fn::Join": [ "", [ "arn:aws:s3:::", { "Ref": "XgemailQuarantineBucketName" } ] ] }
              ]
            },
            {
              "Action": [
                "s3:GetBucketLocation",
                "s3:ListBucket",
                "s3:GetObject",
                "s3:PutObject"
              ],
              "Effect": "Allow",
              "Resource": [
                { "Fn::Join": [ "", [ "arn:aws:s3:::", { "Ref": "XgemailInternetSubmitBucketName" }, "/*" ] ] },
                { "Fn::Join": [ "", [ "arn:aws:s3:::", { "Ref": "XgemailInternetSubmitBucketName" } ] ] }
              ]
            },
            {
              "Action": [
                "dynamodb:BatchWriteItem",
                "dynamodb:DeleteItem",
                "dynamodb:BatchGetItem",
                "dynamodb:Scan",
                "dynamodb:ListTables",
                "dynamodb:GetItem",
                "dynamodb:GetRecords",
                "dynamodb:DescribeTable",
                "dynamodb:PutItem",
                "dynamodb:Query",
                "dynamodb:UpdateItem",
                "dynamodb:UpdateTable"
              ],
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::Sub": "arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${DeliveryDirectorDynamodbTableName}"
                }
              ]
            },
            {
              "Action" : [
                "s3:GetBucketLocation",
                "s3:ListBucket"
              ],
              "Effect" : "Allow",
              "Resource" : [ { "Fn::Join": [ "-", [ "arn:aws:s3:::logs-sophos-msg", { "Ref": "Environment" }, "*" ] ] } ]
            },
            {
              "Action" : [
                "s3:PutObject"
              ],
              "Effect" : "Allow",
              "Resource" : [ { "Fn::Join": [ "/", [ { "Fn::Join": [ "-", [ "arn:aws:s3:::logs-sophos-msg", { "Ref": "Environment" }, "*" ] ] }, "*" ] ] } ]
            },
            {
              "Action": [
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:PutObject",
                "s3:GetEncryptionConfiguration",
                "s3:AbortMultipartUpload",
                "s3:ListMultipartUploadParts",
                "s3:ListBucket",
                "s3:ListBucketMultipartUploads"
              ],
              "Resource": [
                { "Fn::Join" : ["-", ["arn:aws:s3:::cloud", { "Ref": "Environment" }, "ssm-session-logs/*"]]},
                { "Fn::Join" : ["-", ["arn:aws:s3:::cloud", { "Ref": "Environment" }, "ssm-session-logs" ]]}
              ],
              "Effect": "Allow"
            },
            {
              "Action": [
                "s3:DeleteObject",
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:PutObject"
              ],
              "Effect": "Allow",
              "Resource": [
                "arn:aws:s3:::cloud-*"
              ]
            },
            {
              "Action": [
                "sdb:BatchDeleteAttributes",
                "sdb:BatchPutAttributes",
                "sdb:CreateDomain",
                "sdb:DeleteAttributes",
                "sdb:DeleteDomain",
                "sdb:DomainMetadata",
                "sdb:GetAttributes",
                "sdb:ListDomains",
                "sdb:PutAttributes",
                "sdb:Select"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action": [
                "sns:GetSubscriptionAttributes",
                "sns:ListSubscriptionsByTopic",
                "sns:ListTopics",
                "sns:Publish",
                "sns:Subscribe",
                "sns:Unsubscribe"
              ],
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::Join": [
                    ":",
                    [
                      "arn:aws:sns",
                      { "Ref": "AWS::Region" },
                      { "Ref": "AWS::AccountId" },
                      "*"
                    ]
                  ]
                }
              ]
            },
            {
              "Action": [
                "sqs:ChangeMessageVisibility",
                "sqs:CreateQueue",
                "sqs:DeleteMessage",
                "sqs:DeleteQueue",
                "sqs:GetQueueAttributes",
                "sqs:GetQueueUrl",
                "sqs:ListQueues",
                "sqs:SendMessage",
                "sqs:SetQueueAttributes",
                "sqs:ReceiveMessage"
              ],
              "Effect": "Allow",
              "Resource": [ "*" ]
            },
            {
              "Action": [
                "cloudwatch:putMetricData"
              ],
              "Effect": "Allow",
              "Resource": [ "*" ]
            },
            {
              "Action": [
                "firehose:DescribeDeliveryStream",
                "firehose:PutRecord",
                "firehose:PutRecordBatch"
              ],
              "Effect" : "Allow",
              "Resource": [
                {
                  "Fn::Sub": "arn:aws:firehose:${AWS::Region}:${AWS::AccountId}:deliverystream/${MsgHistoryV2StreamName}"
                }
              ]
            },
            {
              "Action": [
                "kinesis:DescribeStream",
                "kinesis:PutRecord",
                "kinesis:PutRecords"
              ],
              "Effect" : "Allow",
              "Resource": [
                {
                  "Fn::Sub": "arn:aws:kinesis:${AWS::Region}:${AWS::AccountId}:stream/${MsgHistoryDataStreamName}"
                }
              ]
            },
            {
              "Action": [
                "secretsmanager:ListSecrets"
              ],
              "Effect" : "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action": [
                "secretsmanager:GetResourcePolicy",
                "secretsmanager:GetSecretValue",
                "secretsmanager:DescribeSecret",
                "secretsmanager:ListSecretVersionIds"
              ],
              "Effect" : "Allow",
              "Resource": [
                {
                  "Fn::Sub": "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:/central/newrelic/license*"
                }
              ]
            }
          ]
        },
        "PolicyName": "root",
        "Roles": [
          {
            "Ref": "XgemailInternetSubmitInstanceRole"
          }
        ]
      }
    },

    "XgemailMfInboundSubmitInstanceProfile" : {
      "Type" : "AWS::IAM::InstanceProfile",
      "Properties" : {
        "Path" : "/",
        "Roles" : [
          {
            "Ref" : "XgemailMfInboundSubmitInstanceRole"
          }
        ]
      }
    },
    "XgemailMfInboundSubmitInstanceRole": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "ManagedPolicyArns": [ "arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore" ],
        "AssumeRolePolicyDocument": {
          "Statement": [
            {
              "Action": [ "sts:AssumeRole" ],
              "Effect": "Allow",
              "Principal": {
                "Service": [ "ec2.amazonaws.com" ]
              }
            }
          ]
        },
        "Path": "/",
        "Tags": [
          {
            "Key": "Application",
            "Value": "mf-inbound-submit"
          },
          {
            "Key": "BusinessUnit",
            "Value": "MSG"
          },
          {
            "Key": "Name",
            "Value": { "Fn::Join": [ "-", [ { "Ref" : "AWS::StackName" }, "XgemailMfInboundSubmitInstanceRole" ] ] }
          },
          {
            "Key": "Project",
            "Value": "xgemail"
          },
          {
            "Key": "OwnerEmail",
            "Value": "sophosmailops@sophos.com"
          }
        ]
      }
    },
    "XgemailMfInboundSubmitInstanceRolePolicies": {
      "Type": "AWS::IAM::Policy",
      "Properties": {
        "PolicyDocument": {
          "Statement": [
            {
              "Action": [
                "autoscaling:CompleteLifecycleAction",
                "autoscaling:DescribeAutoScalingInstances",
                "autoscaling:DescribeLifecycleHooks",
                "autoscaling:RecordLifecycleActionHeartbeat",
                "autoscaling:UpdateAutoScalingGroup"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action": [
                "ec2:AttachVolume",
                "ec2:CreateSnapshot",
                "ec2:CreateTags",
                "ec2:CreateVolume",
                "ec2:DeleteVolume",
                "ec2:DescribeImages",
                "ec2:DescribeInstanceAttribute",
                "ec2:DescribeInstances",
                "ec2:DescribeNatGateways",
                "ec2:DescribeNetworkInterfaces",
                "ec2:DescribeRouteTables",
                "ec2:DescribeSnapshots",
                "ec2:DescribeSubnets",
                "ec2:DescribeTags",
                "ec2:DescribeVolumes",
                "ec2:DescribeVpcs",
                "ec2:DetachVolume",
                "ec2:ModifyInstanceAttribute",
                "ec2:ModifySnapshotAttribute"
              ],
              "Effect": "Allow",
              "Resource": [ "*" ]
            },
            {
              "Action": [
                "iam:GetRole"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action": [
                "kms:CreateGrant",
                "kms:Decrypt",
                "kms:DescribeKey",
                "kms:Encrypt",
                "kms:GenerateDataKey",
                "kms:GenerateDataKeyWithoutPlaintext",
                "kms:List*",
                "kms:ReEncrypt*",
                "kms:RevokeGrant"
              ],
              "Effect": "Allow",
              "Resource": [ "*" ]
            },
            {
              "Action": [
                "logs:CreateLogGroup",
                "logs:CreateLogStream",
                "logs:DescribeLogGroups",
                "logs:DescribeLogStreams",
                "logs:DescribeMetricFilters",
                "logs:PutLogEvents"
              ],
              "Effect": "Allow",
              "Resource": [ "*" ]
            },
            {
              "Action": [
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:ListBucket",
                "s3:PutObject",
                "s3:RestoreObject"
              ],
              "Effect": "Allow",
              "Resource": [
                { "Fn::Join": [ "", [ "arn:aws:s3:::", { "Ref": "XgemailMsgHistoryBucketName" }, "/*" ] ] },
                { "Fn::Join": [ "", [ "arn:aws:s3:::", { "Ref": "XgemailMsgHistoryBucketName" } ] ] }
              ]
            },
            {
              "Action" : [
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:ListBucket",
                "s3:PutObject",
                "s3:RestoreObject"
              ],
              "Effect" : "Allow",
              "Resource" : [{ "Fn::Join" : ["", ["arn:aws:s3:::", { "Ref" : "MsgHistoryV2BucketName" }, "/*"]]},
                { "Fn::Join" : ["", ["arn:aws:s3:::", { "Ref" : "MsgHistoryV2BucketName" }]]}]
            },
            {
              "Action": [
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:ListBucket",
                "s3:PutObject"
              ],
              "Effect": "Allow",
              "Resource": [
                { "Fn::Join": [ "", [ "arn:aws:s3:::", { "Ref": "DeliveryDirectorBucketName" }, "/*" ] ] },
                { "Fn::Join": [ "", [ "arn:aws:s3:::", { "Ref": "DeliveryDirectorBucketName" } ] ] }
              ]
            },
            {
              "Action": [
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:ListBucket",
                "s3:PutObject",
                "s3:RestoreObject"
              ],
              "Effect": "Allow",
              "Resource": [
                { "Fn::Join": [ "", [ "arn:aws:s3:::", { "Ref": "XgemailMsgHistoryMsBucketName" }, "/*" ] ] },
                { "Fn::Join": [ "", [ "arn:aws:s3:::", { "Ref": "XgemailMsgHistoryMsBucketName" } ] ] }
              ]
            },
            {
              "Action": [
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:ListBucket",
                "s3:PutObject"
              ],
              "Effect": "Allow",
              "Resource": [
                { "Fn::Join": [ "", [ "arn:aws:s3:::", { "Ref": "XgemailPolicyBucketName" }, "/*" ] ] },
                { "Fn::Join": [ "", [ "arn:aws:s3:::", { "Ref": "XgemailPolicyBucketName" } ] ] }
              ]
            },
            {
              "Action": [
                "s3:DeleteObject",
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:ListBucket",
                "s3:PutObject",
                "s3:RestoreObject"
              ],
              "Effect": "Allow",
              "Resource": [
                { "Fn::Join": [ "", [ "arn:aws:s3:::", { "Ref": "XgemailQuarantineBucketName" }, "/*" ] ] },
                { "Fn::Join": [ "", [ "arn:aws:s3:::", { "Ref": "XgemailQuarantineBucketName" } ] ] }
              ]
            },
            {
              "Action": [
                "s3:GetBucketLocation",
                "s3:ListBucket",
                "s3:GetObject",
                "s3:PutObject"
              ],
              "Effect": "Allow",
              "Resource": [
                { "Fn::Join": [ "", [ "arn:aws:s3:::", { "Ref": "XgemailInternetSubmitBucketName" }, "/*" ] ] },
                { "Fn::Join": [ "", [ "arn:aws:s3:::", { "Ref": "XgemailInternetSubmitBucketName" } ] ] }
              ]
            },
            {
              "Action": [
                "dynamodb:BatchWriteItem",
                "dynamodb:DeleteItem",
                "dynamodb:BatchGetItem",
                "dynamodb:Scan",
                "dynamodb:ListTables",
                "dynamodb:GetItem",
                "dynamodb:GetRecords",
                "dynamodb:DescribeTable",
                "dynamodb:PutItem",
                "dynamodb:Query",
                "dynamodb:UpdateItem",
                "dynamodb:UpdateTable"
              ],
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::Sub": "arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${DeliveryDirectorDynamodbTableName}"
                }
              ]
            },
            {
              "Action" : [
                "s3:GetBucketLocation",
                "s3:ListBucket"
              ],
              "Effect" : "Allow",
              "Resource" : [ { "Fn::Join": [ "-", [ "arn:aws:s3:::logs-sophos-msg", { "Ref": "Environment" }, "*" ] ] } ]
            },
            {
              "Action" : [
                "s3:PutObject"
              ],
              "Effect" : "Allow",
              "Resource" : [ { "Fn::Join": [ "/", [ { "Fn::Join": [ "-", [ "arn:aws:s3:::logs-sophos-msg", { "Ref": "Environment" }, "*" ] ] }, "*" ] ] } ]
            },
            {
              "Action": [
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:PutObject",
                "s3:GetEncryptionConfiguration",
                "s3:AbortMultipartUpload",
                "s3:ListMultipartUploadParts",
                "s3:ListBucket",
                "s3:ListBucketMultipartUploads"
              ],
              "Resource": [
                { "Fn::Join" : ["-", ["arn:aws:s3:::cloud", { "Ref": "Environment" }, "ssm-session-logs/*"]]},
                { "Fn::Join" : ["-", ["arn:aws:s3:::cloud", { "Ref": "Environment" }, "ssm-session-logs" ]]}
              ],
              "Effect": "Allow"
            },
            {
              "Action": [
                "s3:DeleteObject",
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:PutObject"
              ],
              "Effect": "Allow",
              "Resource": [
                "arn:aws:s3:::cloud-*"
              ]
            },
            {
              "Action": [
                "sdb:BatchDeleteAttributes",
                "sdb:BatchPutAttributes",
                "sdb:CreateDomain",
                "sdb:DeleteAttributes",
                "sdb:DeleteDomain",
                "sdb:DomainMetadata",
                "sdb:GetAttributes",
                "sdb:ListDomains",
                "sdb:PutAttributes",
                "sdb:Select"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action": [
                "sns:GetSubscriptionAttributes",
                "sns:ListSubscriptionsByTopic",
                "sns:ListTopics",
                "sns:Publish",
                "sns:Subscribe",
                "sns:Unsubscribe"
              ],
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::Join": [
                    ":",
                    [
                      "arn:aws:sns",
                      { "Ref": "AWS::Region" },
                      { "Ref": "AWS::AccountId" },
                      "*"
                    ]
                  ]
                }
              ]
            },
            {
              "Action": [
                "sqs:ChangeMessageVisibility",
                "sqs:CreateQueue",
                "sqs:DeleteMessage",
                "sqs:DeleteQueue",
                "sqs:GetQueueAttributes",
                "sqs:GetQueueUrl",
                "sqs:ListQueues",
                "sqs:SendMessage",
                "sqs:SetQueueAttributes",
                "sqs:ReceiveMessage"
              ],
              "Effect": "Allow",
              "Resource": [ "*" ]
            },
            {
              "Action": [
                "cloudwatch:putMetricData"
              ],
              "Effect": "Allow",
              "Resource": [ "*" ]
            },
            {
              "Action": [
                "firehose:DescribeDeliveryStream",
                "firehose:PutRecord",
                "firehose:PutRecordBatch"
              ],
              "Effect" : "Allow",
              "Resource": [
                {
                  "Fn::Sub": "arn:aws:firehose:${AWS::Region}:${AWS::AccountId}:deliverystream/${MsgHistoryV2StreamName}"
                }
              ]
            },
            {
              "Action": [
                "kinesis:DescribeStream",
                "kinesis:PutRecord",
                "kinesis:PutRecords"
              ],
              "Effect" : "Allow",
              "Resource": [
                {
                  "Fn::Sub": "arn:aws:kinesis:${AWS::Region}:${AWS::AccountId}:stream/${MsgHistoryDataStreamName}"
                }
              ]
            },
            {
              "Action": [
                "secretsmanager:ListSecrets"
              ],
              "Effect" : "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action": [
                "secretsmanager:GetResourcePolicy",
                "secretsmanager:GetSecretValue",
                "secretsmanager:DescribeSecret",
                "secretsmanager:ListSecretVersionIds"
              ],
              "Effect" : "Allow",
              "Resource": [
                {
                  "Fn::Sub": "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:/central/newrelic/license*"
                }
              ]
            }
          ]
        },
        "PolicyName": "root",
        "Roles": [
          {
            "Ref": "XgemailMfInboundSubmitInstanceRole"
          }
        ]
      }
    },

    "XgemailCustomerSubmitInstanceProfile" : {
      "Type" : "AWS::IAM::InstanceProfile",
      "Properties" : {
        "Path" : "/",
        "Roles" : [
          {
            "Ref" : "XgemailCustomerSubmitInstanceRole"
          }
        ]
      }
    },
    "XgemailCustomerSubmitInstanceRole": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "ManagedPolicyArns": [ "arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore" ],
        "AssumeRolePolicyDocument": {
          "Statement": [
            {
              "Action": [ "sts:AssumeRole" ],
              "Effect": "Allow",
              "Principal": {
                "Service": [ "ec2.amazonaws.com" ]
              }
            }
          ]
        },
        "Path": "/",
        "Tags": [
          {
            "Key": "Application",
            "Value": "customer-submit"
          },
          {
            "Key": "BusinessUnit",
            "Value": "MSG"
          },
          {
            "Key": "Name",
            "Value": { "Fn::Join": [ "-", [ { "Ref" : "AWS::StackName" }, "XgemailCustomerSubmitInstanceRole" ] ] }
          },
          {
            "Key": "Project",
            "Value": "xgemail"
          },
          {
            "Key": "OwnerEmail",
            "Value": "sophosmailops@sophos.com"
          }
        ]
      }
    },
    "XgemailCustomerSubmitInstanceRolePolicies": {
      "Type": "AWS::IAM::Policy",
      "Properties": {
        "PolicyDocument": {
          "Statement": [
            {
              "Action": [
                "autoscaling:CompleteLifecycleAction",
                "autoscaling:DescribeAutoScalingInstances",
                "autoscaling:DescribeLifecycleHooks",
                "autoscaling:RecordLifecycleActionHeartbeat",
                "autoscaling:UpdateAutoScalingGroup"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action": [
                "ec2:AttachVolume",
                "ec2:CreateSnapshot",
                "ec2:CreateTags",
                "ec2:CreateVolume",
                "ec2:DeleteVolume",
                "ec2:DescribeImages",
                "ec2:DescribeInstanceAttribute",
                "ec2:DescribeInstances",
                "ec2:DescribeNatGateways",
                "ec2:DescribeNetworkInterfaces",
                "ec2:DescribeRouteTables",
                "ec2:DescribeSnapshots",
                "ec2:DescribeSubnets",
                "ec2:DescribeTags",
                "ec2:DescribeVolumes",
                "ec2:DescribeVpcs",
                "ec2:DetachVolume",
                "ec2:ModifyInstanceAttribute",
                "ec2:ModifySnapshotAttribute"
              ],
              "Effect": "Allow",
              "Resource": [ "*" ]
            },
            {
              "Action": [
                "iam:GetRole"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action": [
                "kms:CreateGrant",
                "kms:Decrypt",
                "kms:DescribeKey",
                "kms:Encrypt",
                "kms:GenerateDataKey",
                "kms:GenerateDataKeyWithoutPlaintext",
                "kms:List*",
                "kms:ReEncrypt*",
                "kms:RevokeGrant"
              ],
              "Effect": "Allow",
              "Resource": [ "*" ]
            },
            {
              "Action": [
                "logs:CreateLogGroup",
                "logs:CreateLogStream",
                "logs:DescribeLogGroups",
                "logs:DescribeLogStreams",
                "logs:DescribeMetricFilters",
                "logs:PutLogEvents"
              ],
              "Effect": "Allow",
              "Resource": [ "*" ]
            },
            {
              "Action": [
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:ListBucket",
                "s3:PutObject",
                "s3:RestoreObject"
              ],
              "Effect": "Allow",
              "Resource": [
                { "Fn::Join": [ "", [ "arn:aws:s3:::", { "Ref": "XgemailMsgHistoryBucketName" }, "/*" ] ] },
                { "Fn::Join": [ "", [ "arn:aws:s3:::", { "Ref": "XgemailMsgHistoryBucketName" } ] ] }
              ]
            },
            {
              "Action" : [
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:ListBucket",
                "s3:PutObject",
                "s3:RestoreObject"
              ],
              "Effect" : "Allow",
              "Resource" : [{ "Fn::Join" : ["", ["arn:aws:s3:::", { "Ref" : "MsgHistoryV2BucketName" }, "/*"]]},
                { "Fn::Join" : ["", ["arn:aws:s3:::", { "Ref" : "MsgHistoryV2BucketName" }]]}]
            },
            {
              "Action": [
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:ListBucket",
                "s3:PutObject"
              ],
              "Effect": "Allow",
              "Resource": [
                { "Fn::Join": [ "", [ "arn:aws:s3:::", { "Ref": "DeliveryDirectorBucketName" }, "/*" ] ] },
                { "Fn::Join": [ "", [ "arn:aws:s3:::", { "Ref": "DeliveryDirectorBucketName" } ] ] }
              ]
            },
            {
              "Action": [
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:ListBucket",
                "s3:PutObject",
                "s3:RestoreObject"
              ],
              "Effect": "Allow",
              "Resource": [
                { "Fn::Join": [ "", [ "arn:aws:s3:::", { "Ref": "XgemailMsgHistoryMsBucketName" }, "/*" ] ] },
                { "Fn::Join": [ "", [ "arn:aws:s3:::", { "Ref": "XgemailMsgHistoryMsBucketName" } ] ] }
              ]
            },
            {
              "Action": [
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:PutObject",
                "s3:ListBucket"
              ],
              "Effect": "Allow",
              "Resource": [
                { "Fn::Join": [ "", [ "arn:aws:s3:::", { "Ref": "XgemailPolicyBucketName" }, "/*" ] ] },
                { "Fn::Join": [ "", [ "arn:aws:s3:::", { "Ref": "XgemailPolicyBucketName" } ] ] }
              ]
            },
            {
              "Action": [
                "s3:GetBucketLocation",
                "s3:ListBucket",
                "s3:GetObject",
                "s3:PutObject"
              ],
              "Effect": "Allow",
              "Resource": [
                { "Fn::Join": [ "", [ "arn:aws:s3:::", { "Ref": "XgemailCustomerSubmitBucketName" }, "/*" ] ] },
                { "Fn::Join": [ "", [ "arn:aws:s3:::", { "Ref": "XgemailCustomerSubmitBucketName" } ] ] }
              ]
            },
            {
              "Action" : [
                "s3:GetBucketLocation",
                "s3:ListBucket"
              ],
              "Effect" : "Allow",
              "Resource" : [ { "Fn::Join": [ "-", [ "arn:aws:s3:::logs-sophos-msg", { "Ref": "Environment" }, "*" ] ] } ]
            },
            {
              "Action" : [
                "s3:PutObject"
              ],
              "Effect" : "Allow",
              "Resource" : [ { "Fn::Join": [ "/", [ { "Fn::Join": [ "-", [ "arn:aws:s3:::logs-sophos-msg", { "Ref": "Environment" }, "*" ] ] }, "*" ] ] } ]
            },
            {
              "Action": [
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:PutObject",
                "s3:GetEncryptionConfiguration",
                "s3:AbortMultipartUpload",
                "s3:ListMultipartUploadParts",
                "s3:ListBucket",
                "s3:ListBucketMultipartUploads"
              ],
              "Resource": [
                { "Fn::Join" : ["-", ["arn:aws:s3:::cloud", { "Ref": "Environment" }, "ssm-session-logs/*"]]},
                { "Fn::Join" : ["-", ["arn:aws:s3:::cloud", { "Ref": "Environment" }, "ssm-session-logs" ]]}
              ],
              "Effect": "Allow"
            },
            {
              "Action": [
                "s3:DeleteObject",
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:PutObject"
              ],
              "Effect": "Allow",
              "Resource": [
                "arn:aws:s3:::cloud-*"
              ]
            },
            {
              "Action": [
                "sdb:BatchDeleteAttributes",
                "sdb:BatchPutAttributes",
                "sdb:CreateDomain",
                "sdb:DeleteAttributes",
                "sdb:DeleteDomain",
                "sdb:DomainMetadata",
                "sdb:GetAttributes",
                "sdb:ListDomains",
                "sdb:PutAttributes",
                "sdb:Select"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action": [
                "sns:GetSubscriptionAttributes",
                "sns:ListSubscriptionsByTopic",
                "sns:ListTopics",
                "sns:Publish",
                "sns:Subscribe",
                "sns:Unsubscribe"
              ],
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::Join": [
                    ":",
                    [
                      "arn:aws:sns",
                      { "Ref": "AWS::Region" },
                      { "Ref": "AWS::AccountId" },
                      "*"
                    ]
                  ]
                }
              ]
            },
            {
              "Action": [
                "sqs:ChangeMessageVisibility",
                "sqs:CreateQueue",
                "sqs:DeleteMessage",
                "sqs:DeleteQueue",
                "sqs:GetQueueAttributes",
                "sqs:GetQueueUrl",
                "sqs:ListQueues",
                "sqs:SendMessage",
                "sqs:SetQueueAttributes",
                "sqs:ReceiveMessage"
              ],
              "Effect": "Allow",
              "Resource": [ "*" ]
            },
            {
              "Action": [
                "cloudwatch:putMetricData"
              ],
              "Effect": "Allow",
              "Resource": [ "*" ]
            },
            {
              "Action": [
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:ListBucket",
                "s3:PutObject"
              ],
              "Effect": "Allow",
              "Resource": [
                { "Fn::Join": [ "", [ "arn:aws:s3:::", { "Ref": "DeliveryDirectorBucketName" }, "/*" ] ] },
                { "Fn::Join": [ "", [ "arn:aws:s3:::", { "Ref": "DeliveryDirectorBucketName" } ] ] }
              ]
            },
            {
              "Action": [
                "dynamodb:BatchWriteItem",
                "dynamodb:DeleteItem",
                "dynamodb:BatchGetItem",
                "dynamodb:Scan",
                "dynamodb:ListTables",
                "dynamodb:GetItem",
                "dynamodb:GetRecords",
                "dynamodb:DescribeTable",
                "dynamodb:PutItem",
                "dynamodb:Query",
                "dynamodb:UpdateItem",
                "dynamodb:UpdateTable"
              ],
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::Sub": "arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${DeliveryDirectorDynamodbTableName}"
                }
              ]
            },
            {
              "Action": [
                "firehose:DescribeDeliveryStream",
                "firehose:PutRecord",
                "firehose:PutRecordBatch"
              ],
              "Effect" : "Allow",
              "Resource": [
                {
                  "Fn::Sub": "arn:aws:firehose:${AWS::Region}:${AWS::AccountId}:deliverystream/${MsgHistoryV2StreamName}"
                }
              ]
            },
            {
              "Action": [
                "kinesis:DescribeStream",
                "kinesis:PutRecord",
                "kinesis:PutRecords"
              ],
              "Effect" : "Allow",
              "Resource": [
                {
                  "Fn::Sub": "arn:aws:kinesis:${AWS::Region}:${AWS::AccountId}:stream/${MsgHistoryDataStreamName}"
                }
              ]
            },
            {
              "Action": [
                "secretsmanager:ListSecrets"
              ],
              "Effect" : "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action": [
                "secretsmanager:GetResourcePolicy",
                "secretsmanager:GetSecretValue",
                "secretsmanager:DescribeSecret",
                "secretsmanager:ListSecretVersionIds"
              ],
              "Effect" : "Allow",
              "Resource": [
                {
                  "Fn::Sub": "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:/central/newrelic/license*"
                }
              ]
            }
          ]
        },
        "PolicyName": "root",
        "Roles": [
          {
            "Ref": "XgemailCustomerSubmitInstanceRole"
          }
        ]
      }
    },

    "XgemailEncryptionDeliveryInstanceProfile": {
      "Type": "AWS::IAM::InstanceProfile",
      "Properties": {
        "Path": "/",
        "Roles": [
          {
            "Ref": "XgemailEncryptionDeliveryInstanceRole"
          }
        ]
      }
    },
    "XgemailEncryptionDeliveryInstanceRole": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "ManagedPolicyArns": [ "arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore" ],
        "AssumeRolePolicyDocument": {
          "Statement": [
            {
              "Action": [ "sts:AssumeRole" ],
              "Effect": "Allow",
              "Principal": {
                "Service": [ "ec2.amazonaws.com" ]
              }
            }
          ]
        },
        "Path": "/",
        "Tags": [
          {
            "Key": "Application",
            "Value": "encryption-delivery"
          },
          {
            "Key": "BusinessUnit",
            "Value": "MSG"
          },
          {
            "Key": "Name",
            "Value": { "Fn::Join": [ "-", [ { "Ref" : "AWS::StackName" }, "XgemailEncryptionDeliveryInstanceRole" ] ] }
          },
          {
            "Key": "Project",
            "Value": "xgemail"
          },
          {
            "Key": "OwnerEmail",
            "Value": "sophosmailops@sophos.com"
          }
        ]
      }
    },
    "XgemailEncryptionDeliveryInstanceRolePolicies" : {
      "Type" : "AWS::IAM::Policy",
      "Properties" : {
        "PolicyDocument" : {
          "Statement" : [
            {
              "Action": [
                "autoscaling:CompleteLifecycleAction",
                "autoscaling:DescribeAutoScalingInstances",
                "autoscaling:RecordLifecycleActionHeartbeat",
                "autoscaling:UpdateAutoScalingGroup"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action" : [
                "ec2:AttachVolume",
                "ec2:CreateSnapshot",
                "ec2:CreateTags",
                "ec2:CreateVolume",
                "ec2:DeleteVolume",
                "ec2:DescribeImages",
                "ec2:DescribeInstanceAttribute",
                "ec2:DescribeInstances",
                "ec2:DescribeNatGateways",
                "ec2:DescribeNetworkInterfaces",
                "ec2:DescribeRouteTables",
                "ec2:DescribeSnapshots",
                "ec2:DescribeSubnets",
                "ec2:DescribeTags",
                "ec2:DescribeVolumes",
                "ec2:DescribeVpcs",
                "ec2:DetachVolume",
                "ec2:ModifyInstanceAttribute",
                "ec2:ModifySnapshotAttribute"
              ],
              "Effect" : "Allow",
              "Resource" : ["*"]
            },
            {
              "Action": [
                "iam:GetRole"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action" : [
                "kms:CreateGrant",
                "kms:Decrypt",
                "kms:DescribeKey",
                "kms:Encrypt",
                "kms:GenerateDataKey",
                "kms:GenerateDataKeyWithoutPlaintext",
                "kms:List*",
                "kms:ReEncrypt*",
                "kms:RevokeGrant"
              ],
              "Effect" : "Allow",
              "Resource" : ["*"]
            },
            {
              "Action": [
                "logs:CreateLogGroup",
                "logs:CreateLogStream",
                "logs:DescribeLogGroups",
                "logs:DescribeLogStreams",
                "logs:DescribeMetricFilters",
                "logs:PutLogEvents"
              ],
              "Effect": "Allow",
              "Resource": [ "*" ]
            },
            {
              "Action" : [
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:ListBucket",
                "s3:PutObject",
                "s3:RestoreObject"
              ],
              "Effect" : "Allow",
              "Resource" : [{ "Fn::Join" : ["", ["arn:aws:s3:::", { "Ref" : "XgemailMsgHistoryBucketName" }, "/*"]]},
                { "Fn::Join" : ["", ["arn:aws:s3:::", { "Ref" : "XgemailMsgHistoryBucketName" }]]}]
            },
            {
              "Action" : [
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:ListBucket",
                "s3:PutObject",
                "s3:RestoreObject"
              ],
              "Effect" : "Allow",
              "Resource" : [{ "Fn::Join" : ["", ["arn:aws:s3:::", { "Ref" : "XgemailMsgHistoryMsBucketName" }, "/*"]]},
                { "Fn::Join" : ["", ["arn:aws:s3:::", { "Ref" : "XgemailMsgHistoryMsBucketName" }]]}]
            },
            {
              "Action" : [
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:ListBucket",
                "s3:PutObject",
                "s3:RestoreObject"
              ],
              "Effect" : "Allow",
              "Resource" : [{ "Fn::Join" : ["", ["arn:aws:s3:::", { "Ref" : "MsgHistoryV2BucketName" }, "/*"]]},
                { "Fn::Join" : ["", ["arn:aws:s3:::", { "Ref" : "MsgHistoryV2BucketName" }]]}]
            },
            {
              "Action" : [
                "s3:DeleteObject",
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:ListBucket",
                "s3:PutObject",
                "s3:RestoreObject"
              ],
              "Effect" : "Allow",
              "Resource" : [{ "Fn::Join" : ["", ["arn:aws:s3:::", { "Ref" : "XgemailQuarantineBucketName" }, "/*"]]},
                { "Fn::Join" : ["", ["arn:aws:s3:::", { "Ref" : "XgemailQuarantineBucketName" }]]}]
            },
            {
              "Action" : [
                "s3:DeleteObject",
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:ListBucket"
              ],
              "Effect" : "Allow",
              "Resource" : [{ "Fn::Join" : ["", ["arn:aws:s3:::", { "Ref" : "XgemailCustomerSubmitBucketName" }, "/*"]]},
                { "Fn::Join" : ["", ["arn:aws:s3:::", { "Ref" : "XgemailCustomerSubmitBucketName" }]]}]
            },
            {
              "Action": [
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:ListBucket"
              ],
              "Effect": "Allow",
              "Resource": [
                { "Fn::Join": [ "", [ "arn:aws:s3:::", { "Ref": "XgemailPolicyBucketName" }, "/*" ] ] },
                { "Fn::Join": [ "", [ "arn:aws:s3:::", { "Ref": "XgemailPolicyBucketName" } ] ] }
              ]
            },
            {
              "Action" : [
                "s3:GetBucketLocation",
                "s3:ListBucket"
              ],
              "Effect" : "Allow",
              "Resource" : [ { "Fn::Join": [ "-", [ "arn:aws:s3:::logs-sophos-msg", { "Ref": "Environment" }, "*" ] ] } ]
            },
            {
              "Action" : [
                "s3:PutObject"
              ],
              "Effect" : "Allow",
              "Resource" : [ { "Fn::Join": [ "/", [ { "Fn::Join": [ "-", [ "arn:aws:s3:::logs-sophos-msg", { "Ref": "Environment" }, "*" ] ] }, "*" ] ] } ]
            },
            {
              "Action": [
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:PutObject",
                "s3:GetEncryptionConfiguration",
                "s3:AbortMultipartUpload",
                "s3:ListMultipartUploadParts",
                "s3:ListBucket",
                "s3:ListBucketMultipartUploads"
              ],
              "Resource": [
                { "Fn::Join" : ["-", ["arn:aws:s3:::cloud", { "Ref": "Environment" }, "ssm-session-logs/*"]]},
                { "Fn::Join" : ["-", ["arn:aws:s3:::cloud", { "Ref": "Environment" }, "ssm-session-logs" ]]}
              ],
              "Effect": "Allow"
            },
            {
              "Action": [
                "s3:DeleteObject",
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:PutObject"
              ],
              "Effect": "Allow",
              "Resource": [
                "arn:aws:s3:::cloud-*"
              ]
            },
            {
              "Action": [
                "sdb:BatchDeleteAttributes",
                "sdb:BatchPutAttributes",
                "sdb:CreateDomain",
                "sdb:DeleteAttributes",
                "sdb:DeleteDomain",
                "sdb:DomainMetadata",
                "sdb:GetAttributes",
                "sdb:ListDomains",
                "sdb:PutAttributes",
                "sdb:Select"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action": [
                "sns:ListSubscriptionsByTopic",
                "sns:ListTopics",
                "sns:Publish",
                "sns:Subscribe",
                "sns:Unsubscribe"
              ],
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::Join": [
                    ":",
                    [
                      "arn:aws:sns",
                      { "Ref": "AWS::Region" },
                      { "Ref": "AWS::AccountId" },
                      "*"
                    ]
                  ]
                }
              ]
            },
            {
              "Action" : [
                "sqs:ChangeMessageVisibility",
                "sqs:CreateQueue",
                "sqs:DeleteMessage",
                "sqs:DeleteQueue",
                "sqs:GetQueueAttributes",
                "sqs:GetQueueUrl",
                "sqs:ListQueues",
                "sqs:SendMessage",
                "sqs:SetQueueAttributes",
                "sqs:ReceiveMessage"
              ],
              "Effect" : "Allow",
              "Resource" : ["*"]
            },
            {
              "Action": [
                "dynamodb:BatchWriteItem",
                "dynamodb:DeleteItem",
                "dynamodb:BatchGetItem",
                "dynamodb:Scan",
                "dynamodb:ListTables",
                "dynamodb:GetItem",
                "dynamodb:GetRecords",
                "dynamodb:DescribeTable",
                "dynamodb:PutItem",
                "dynamodb:Query",
                "dynamodb:UpdateItem",
                "dynamodb:UpdateTable"
              ],
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::Sub": "arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${MsgHistoryV2DynamoDbTableName}"
                }
              ]
            },
            {
              "Action": [
                "firehose:DescribeDeliveryStream",
                "firehose:PutRecord",
                "firehose:PutRecordBatch"
              ],
              "Effect" : "Allow",
              "Resource": [
                {
                  "Fn::Sub": "arn:aws:firehose:${AWS::Region}:${AWS::AccountId}:deliverystream/${MsgHistoryV2StreamName}"
                }
              ]
            },
            {
              "Action": [
                "kinesis:DescribeStream",
                "kinesis:PutRecord",
                "kinesis:PutRecords"
              ],
              "Effect" : "Allow",
              "Resource": [
                {
                  "Fn::Sub": "arn:aws:kinesis:${AWS::Region}:${AWS::AccountId}:stream/${MsgHistoryDataStreamName}"
                }
              ]
            },
            {
              "Action": [
                "secretsmanager:ListSecrets"
              ],
              "Effect" : "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action": [
                "secretsmanager:GetResourcePolicy",
                "secretsmanager:GetSecretValue",
                "secretsmanager:DescribeSecret",
                "secretsmanager:ListSecretVersionIds"
              ],
              "Effect" : "Allow",
              "Resource": [
                {
                  "Fn::Sub": "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:/central/newrelic/license*"
                }
              ]
            }
          ]
        },
        "PolicyName" : "root",
        "Roles" : [
          {
            "Ref" : "XgemailEncryptionDeliveryInstanceRole"
          }
        ]
      }
    },

    "XgemailEncryptionSubmitInstanceProfile": {
      "Type": "AWS::IAM::InstanceProfile",
      "Properties": {
        "Path": "/",
        "Roles": [
          {
            "Ref": "XgemailEncryptionSubmitInstanceRole"
          }
        ]
      }
    },
    "XgemailEncryptionSubmitInstanceRole": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "ManagedPolicyArns": [ "arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore" ],
        "AssumeRolePolicyDocument": {
          "Statement": [
            {
              "Action": [ "sts:AssumeRole" ],
              "Effect": "Allow",
              "Principal": {
                "Service": [ "ec2.amazonaws.com" ]
              }
            }
          ]
        },
        "Path": "/",
        "Tags": [
          {
            "Key": "Application",
            "Value": "encryption-submit"
          },
          {
            "Key": "BusinessUnit",
            "Value": "MSG"
          },
          {
            "Key": "Name",
            "Value": { "Fn::Join": [ "-", [ { "Ref" : "AWS::StackName" }, "XgemailEncryptionSubmitInstanceRole" ] ] }
          },
          {
            "Key": "Project",
            "Value": "xgemail"
          },
          {
            "Key": "OwnerEmail",
            "Value": "sophosmailops@sophos.com"
          }
        ]
      }
    },
    "XgemailEncryptionSubmitInstanceRolePolicies" : {
      "Type" : "AWS::IAM::Policy",
      "Properties" : {
        "PolicyDocument" : {
          "Statement" : [
            {
              "Action": [
                "autoscaling:CompleteLifecycleAction",
                "autoscaling:DescribeAutoScalingInstances",
                "autoscaling:RecordLifecycleActionHeartbeat",
                "autoscaling:UpdateAutoScalingGroup"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action" : [
                "ec2:AttachVolume",
                "ec2:CreateSnapshot",
                "ec2:CreateTags",
                "ec2:CreateVolume",
                "ec2:DeleteVolume",
                "ec2:DescribeImages",
                "ec2:DescribeInstanceAttribute",
                "ec2:DescribeInstances",
                "ec2:DescribeNatGateways",
                "ec2:DescribeNetworkInterfaces",
                "ec2:DescribeRouteTables",
                "ec2:DescribeSnapshots",
                "ec2:DescribeSubnets",
                "ec2:DescribeTags",
                "ec2:DescribeVolumes",
                "ec2:DescribeVpcs",
                "ec2:DetachVolume",
                "ec2:ModifyInstanceAttribute",
                "ec2:ModifySnapshotAttribute"
              ],
              "Effect" : "Allow",
              "Resource" : ["*"]
            },
            {
              "Action": [
                "iam:GetRole"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action" : [
                "kms:CreateGrant",
                "kms:Decrypt",
                "kms:DescribeKey",
                "kms:Encrypt",
                "kms:GenerateDataKey",
                "kms:GenerateDataKeyWithoutPlaintext",
                "kms:List*",
                "kms:ReEncrypt*",
                "kms:RevokeGrant"
              ],
              "Effect" : "Allow",
              "Resource" : ["*"]
            },
            {
              "Action": [
                "logs:CreateLogGroup",
                "logs:CreateLogStream",
                "logs:DescribeLogGroups",
                "logs:DescribeLogStreams",
                "logs:DescribeMetricFilters",
                "logs:PutLogEvents"
              ],
              "Effect": "Allow",
              "Resource": [ "*" ]
            },
            {
              "Action" : [
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:ListBucket",
                "s3:PutObject",
                "s3:RestoreObject"
              ],
              "Effect" : "Allow",
              "Resource" : [{ "Fn::Join" : ["", ["arn:aws:s3:::", { "Ref" : "XgemailMsgHistoryBucketName" }, "/*"]]},
                { "Fn::Join" : ["", ["arn:aws:s3:::", { "Ref" : "XgemailMsgHistoryBucketName" }]]}]
            },
            {
              "Action" : [
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:ListBucket",
                "s3:PutObject",
                "s3:RestoreObject"
              ],
              "Effect" : "Allow",
              "Resource" : [{ "Fn::Join" : ["", ["arn:aws:s3:::", { "Ref" : "XgemailMsgHistoryMsBucketName" }, "/*"]]},
                { "Fn::Join" : ["", ["arn:aws:s3:::", { "Ref" : "XgemailMsgHistoryMsBucketName" }]]}]
            },
            {
              "Action" : [
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:ListBucket",
                "s3:PutObject",
                "s3:RestoreObject"
              ],
              "Effect" : "Allow",
              "Resource" : [{ "Fn::Join" : ["", ["arn:aws:s3:::", { "Ref" : "MsgHistoryV2BucketName" }, "/*"]]},
                { "Fn::Join" : ["", ["arn:aws:s3:::", { "Ref" : "MsgHistoryV2BucketName" }]]}]
            },
            {
              "Action" : [
                "s3:DeleteObject",
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:ListBucket",
                "s3:PutObject",
                "s3:RestoreObject"
              ],
              "Effect" : "Allow",
              "Resource" : [{ "Fn::Join" : ["", ["arn:aws:s3:::", { "Ref" : "XgemailQuarantineBucketName" }, "/*"]]},
                { "Fn::Join" : ["", ["arn:aws:s3:::", { "Ref" : "XgemailQuarantineBucketName" }]]}]
            },
            {
              "Action" : [
                "s3:DeleteObject",
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:ListBucket",
                "s3:PutObject"
              ],
              "Effect" : "Allow",
              "Resource" : [{ "Fn::Join" : ["", ["arn:aws:s3:::", { "Ref" : "XgemailCustomerSubmitBucketName" }, "/*"]]},
                { "Fn::Join" : ["", ["arn:aws:s3:::", { "Ref" : "XgemailCustomerSubmitBucketName" }]]}]
            },
            {
              "Action" : [
                "s3:DeleteObject",
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:ListBucket",
                "s3:PutObject"
              ],
              "Effect" : "Allow",
              "Resource" : [{ "Fn::Join" : ["", ["arn:aws:s3:::", { "Ref" : "XgemailInternetSubmitBucketName" }, "/*"]]},
                { "Fn::Join" : ["", ["arn:aws:s3:::", { "Ref" : "XgemailInternetSubmitBucketName" }]]}]
            },
            {
              "Action" : [
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:GetObjectMetadataRequest",
                "s3:ListBucket"
              ],
              "Effect" : "Allow",
              "Resource" : [{ "Fn::Join" : ["", ["arn:aws:s3:::", { "Ref" : "XgemailPolicyBucketName" }, "/*"]]},
                { "Fn::Join" : ["", ["arn:aws:s3:::", { "Ref" : "XgemailPolicyBucketName" }]]}]
            },
            {
              "Action": [
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:GetObjectMetadataRequest",
                "s3:ListBucket"
              ],
              "Effect": "Allow",
              "Resource": [
                { "Fn::Join" : ["-", ["arn:aws:s3:::tf-o365-xgemail-infra-da-settings", { "Ref": "AWS::Region" }, { "Ref": "Environment" }, "bucket/*"]]},
                { "Fn::Join" : ["-", ["arn:aws:s3:::tf-o365-xgemail-infra-da-settings", { "Ref": "AWS::Region" }, { "Ref": "Environment" }, "bucket" ]]}]
            },
            {
              "Action" : [
                "s3:GetBucketLocation",
                "s3:ListBucket"
              ],
              "Effect" : "Allow",
              "Resource" : [ { "Fn::Join": [ "-", [ "arn:aws:s3:::logs-sophos-msg", { "Ref": "Environment" }, "*" ] ] } ]
            },
            {
              "Action" : [
                "s3:PutObject"
              ],
              "Effect" : "Allow",
              "Resource" : [ { "Fn::Join": [ "/", [ { "Fn::Join": [ "-", [ "arn:aws:s3:::logs-sophos-msg", { "Ref": "Environment" }, "*" ] ] }, "*" ] ] } ]
            },
            {
              "Action": [
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:PutObject",
                "s3:GetEncryptionConfiguration",
                "s3:AbortMultipartUpload",
                "s3:ListMultipartUploadParts",
                "s3:ListBucket",
                "s3:ListBucketMultipartUploads"
              ],
              "Resource": [
                { "Fn::Join" : ["-", ["arn:aws:s3:::cloud", { "Ref": "Environment" }, "ssm-session-logs/*"]]},
                { "Fn::Join" : ["-", ["arn:aws:s3:::cloud", { "Ref": "Environment" }, "ssm-session-logs" ]]}
              ],
              "Effect": "Allow"
            },
            {
              "Action": [
                "s3:DeleteObject",
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:PutObject"
              ],
              "Effect": "Allow",
              "Resource": [
                "arn:aws:s3:::cloud-*"
              ]
            },
            {
              "Action": [
                "sdb:BatchDeleteAttributes",
                "sdb:BatchPutAttributes",
                "sdb:CreateDomain",
                "sdb:DeleteAttributes",
                "sdb:DeleteDomain",
                "sdb:DomainMetadata",
                "sdb:GetAttributes",
                "sdb:ListDomains",
                "sdb:PutAttributes",
                "sdb:Select"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action": [
                "sns:ListSubscriptionsByTopic",
                "sns:ListTopics",
                "sns:Publish",
                "sns:Subscribe",
                "sns:Unsubscribe"
              ],
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::Join": [
                    ":",
                    [
                      "arn:aws:sns",
                      { "Ref": "AWS::Region" },
                      { "Ref": "AWS::AccountId" },
                      "*"
                    ]
                  ]
                }
              ]
            },
            {
              "Action" : [
                "sqs:ChangeMessageVisibility",
                "sqs:CreateQueue",
                "sqs:DeleteMessage",
                "sqs:DeleteQueue",
                "sqs:GetQueueAttributes",
                "sqs:GetQueueUrl",
                "sqs:ListQueues",
                "sqs:SendMessage",
                "sqs:SetQueueAttributes",
                "sqs:ReceiveMessage"
              ],
              "Effect" : "Allow",
              "Resource" : ["*"]
            },
            {
              "Action": [
                "firehose:DescribeDeliveryStream",
                "firehose:PutRecord",
                "firehose:PutRecordBatch"
              ],
              "Effect" : "Allow",
              "Resource": [
                {
                  "Fn::Sub": "arn:aws:firehose:${AWS::Region}:${AWS::AccountId}:deliverystream/${MsgHistoryV2StreamName}"
                }
              ]
            },
            {
              "Action": [
                "kinesis:DescribeStream",
                "kinesis:PutRecord",
                "kinesis:PutRecords"
              ],
              "Effect" : "Allow",
              "Resource": [
                {
                  "Fn::Sub": "arn:aws:kinesis:${AWS::Region}:${AWS::AccountId}:stream/${MsgHistoryDataStreamName}"
                }
              ]
            },
            {
              "Action": [
                "dynamodb:BatchWriteItem",
                "dynamodb:DeleteItem",
                "dynamodb:BatchGetItem",
                "dynamodb:Scan",
                "dynamodb:ListTables",
                "dynamodb:GetItem",
                "dynamodb:GetRecords",
                "dynamodb:DescribeTable",
                "dynamodb:PutItem",
                "dynamodb:Query",
                "dynamodb:UpdateItem",
                "dynamodb:UpdateTable"
              ],
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::Sub": "arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${MsgHistoryV2DynamoDbTableName}"
                }
              ]
            },
            {
              "Action": [
                "secretsmanager:ListSecrets"
              ],
              "Effect" : "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action": [
                "secretsmanager:GetResourcePolicy",
                "secretsmanager:GetSecretValue",
                "secretsmanager:DescribeSecret",
                "secretsmanager:ListSecretVersionIds"
              ],
              "Effect" : "Allow",
              "Resource": [
                {
                  "Fn::Sub": "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:/central/newrelic/license*"
                }
              ]
            }
          ]
        },
        "PolicyName" : "root",
        "Roles" : [
          {
            "Ref" : "XgemailEncryptionSubmitInstanceRole"
          }
        ]
      }
    },

    "XgemailXdeliveryInstanceProfile": {
      "Type": "AWS::IAM::InstanceProfile",
      "Properties": {
        "Path": "/",
        "Roles": [
          {
            "Ref": "XgemailXdeliveryInstanceRole"
          }
        ]
      }
    },
    "XgemailXdeliveryInstanceRole": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "ManagedPolicyArns": [ "arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore" ],
        "AssumeRolePolicyDocument": {
          "Statement": [
            {
              "Action": [ "sts:AssumeRole" ],
              "Effect": "Allow",
              "Principal": {
                "Service": [ "ec2.amazonaws.com" ]
              }
            }
          ]
        },
        "Path": "/",
        "Tags": [
          {
            "Key": "Application",
            "Value": "customer-xdelivery"
          },
          {
            "Key": "BusinessUnit",
            "Value": "MSG"
          },
          {
            "Key": "Name",
            "Value": { "Fn::Join": [ "-", [ { "Ref" : "AWS::StackName" }, "XgemailXdeliveryInstanceRole" ] ] }
          },
          {
            "Key": "Project",
            "Value": "xgemail"
          },
          {
            "Key": "OwnerEmail",
            "Value": "sophosmailops@sophos.com"
          }
        ]
      }
    },
    "XgemailXdeliveryInstanceRolePolicies": {
      "Type": "AWS::IAM::Policy",
      "Properties": {
        "PolicyDocument": {
          "Statement": [
            {
              "Action": [
                "autoscaling:UpdateAutoScalingGroup",
                "autoscaling:DescribeAutoScalingInstances"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action": [
                "ec2:AttachVolume",
                "ec2:CreateSnapshot",
                "ec2:CreateTags",
                "ec2:CreateVolume",
                "ec2:DescribeImages",
                "ec2:DescribeInstanceAttribute",
                "ec2:DescribeInstances",
                "ec2:DescribeNatGateways",
                "ec2:DescribeNetworkInterfaces",
                "ec2:DescribeRouteTables",
                "ec2:DescribeSnapshots",
                "ec2:DescribeSubnets",
                "ec2:DescribeTags",
                "ec2:DescribeVolumes",
                "ec2:DescribeVpcs",
                "ec2:DetachVolume",
                "ec2:ModifyInstanceAttribute",
                "ec2:ModifySnapshotAttribute"
              ],
              "Effect": "Allow",
              "Resource": [ "*" ]
            },
            {
              "Action": [
                "iam:GetRole"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action": [
                "kms:CreateGrant",
                "kms:Decrypt",
                "kms:DescribeKey",
                "kms:Encrypt",
                "kms:GenerateDataKey",
                "kms:GenerateDataKeyWithoutPlaintext",
                "kms:List*",
                "kms:ReEncrypt*",
                "kms:RevokeGrant"
              ],
              "Effect": "Allow",
              "Resource": [ "*" ]
            },
            {
              "Action": [
                "logs:CreateLogGroup",
                "logs:CreateLogStream",
                "logs:DescribeLogGroups",
                "logs:DescribeLogStreams",
                "logs:DescribeMetricFilters",
                "logs:PutLogEvents"
              ],
              "Effect": "Allow",
              "Resource": [ "*" ]
            },
            {
              "Action" : [
                "s3:GetBucketLocation",
                "s3:ListBucket"
              ],
              "Effect" : "Allow",
              "Resource" : [ { "Fn::Join": [ "-", [ "arn:aws:s3:::logs-sophos-msg", { "Ref": "Environment" }, "*" ] ] } ]
            },
            {
              "Action" : [
                "s3:PutObject"
              ],
              "Effect" : "Allow",
              "Resource" : [ { "Fn::Join": [ "/", [ { "Fn::Join": [ "-", [ "arn:aws:s3:::logs-sophos-msg", { "Ref": "Environment" }, "*" ] ] }, "*" ] ] } ]
            },
            {
              "Action": [
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:PutObject",
                "s3:GetEncryptionConfiguration",
                "s3:AbortMultipartUpload",
                "s3:ListMultipartUploadParts",
                "s3:ListBucket",
                "s3:ListBucketMultipartUploads"
              ],
              "Resource": [
                { "Fn::Join" : ["-", ["arn:aws:s3:::cloud", { "Ref": "Environment" }, "ssm-session-logs/*"]]},
                { "Fn::Join" : ["-", ["arn:aws:s3:::cloud", { "Ref": "Environment" }, "ssm-session-logs" ]]}
              ],
              "Effect": "Allow"
            },
            {
              "Action": [
                "s3:DeleteObject",
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:PutObject"
              ],
              "Effect": "Allow",
              "Resource": [
                "arn:aws:s3:::cloud-*"
              ]
            },
            {
              "Action": [
                "sdb:BatchDeleteAttributes",
                "sdb:BatchPutAttributes",
                "sdb:CreateDomain",
                "sdb:DeleteAttributes",
                "sdb:DeleteDomain",
                "sdb:DomainMetadata",
                "sdb:GetAttributes",
                "sdb:ListDomains",
                "sdb:PutAttributes",
                "sdb:Select"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action": [
                "sns:ListSubscriptionsByTopic",
                "sns:ListTopics",
                "sns:Publish",
                "sns:Subscribe",
                "sns:Unsubscribe"
              ],
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::Join": [
                    ":",
                    [
                      "arn:aws:sns",
                      { "Ref": "AWS::Region" },
                      { "Ref": "AWS::AccountId" },
                      "*"
                    ]
                  ]
                }
              ]
            },
            {
              "Action": [
                "sqs:ChangeMessageVisibility",
                "sqs:CreateQueue",
                "sqs:DeleteMessage",
                "sqs:DeleteQueue",
                "sqs:GetQueueAttributes",
                "sqs:GetQueueUrl",
                "sqs:ListQueues",
                "sqs:SendMessage",
                "sqs:SetQueueAttributes",
                "sqs:ReceiveMessage"
              ],
              "Effect": "Allow",
              "Resource": [ "*" ]
            },
            {
              "Action" : [
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:ListBucket",
                "s3:PutObject",
                "s3:RestoreObject"
              ],
              "Effect" : "Allow",
              "Resource" : [{ "Fn::Join" : ["", ["arn:aws:s3:::", { "Ref" : "MsgHistoryV2BucketName" }, "/*"]]},
                { "Fn::Join" : ["", ["arn:aws:s3:::", { "Ref" : "MsgHistoryV2BucketName" }]]}]
            },
            {
              "Action": [
                "dynamodb:BatchWriteItem",
                "dynamodb:DeleteItem",
                "dynamodb:BatchGetItem",
                "dynamodb:Scan",
                "dynamodb:ListTables",
                "dynamodb:GetItem",
                "dynamodb:GetRecords",
                "dynamodb:DescribeTable",
                "dynamodb:PutItem",
                "dynamodb:Query",
                "dynamodb:UpdateItem",
                "dynamodb:UpdateTable"
              ],
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::Sub": "arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${MsgHistoryV2DynamoDbTableName}"
                }
              ]
            },
            {
              "Action": [
                "firehose:DescribeDeliveryStream",
                "firehose:PutRecord",
                "firehose:PutRecordBatch"
              ],
              "Effect" : "Allow",
              "Resource": [
                {
                  "Fn::Sub": "arn:aws:firehose:${AWS::Region}:${AWS::AccountId}:deliverystream/${MsgHistoryV2StreamName}"
                }
              ]
            },
            {
              "Action": [
                "kinesis:DescribeStream",
                "kinesis:PutRecord",
                "kinesis:PutRecords"
              ],
              "Effect" : "Allow",
              "Resource": [
                {
                  "Fn::Sub": "arn:aws:kinesis:${AWS::Region}:${AWS::AccountId}:stream/${MsgHistoryDataStreamName}"
                }
              ]
            },
            {
              "Action": [
                "secretsmanager:ListSecrets"
              ],
              "Effect" : "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action": [
                "secretsmanager:GetResourcePolicy",
                "secretsmanager:GetSecretValue",
                "secretsmanager:DescribeSecret",
                "secretsmanager:ListSecretVersionIds"
              ],
              "Effect" : "Allow",
              "Resource": [
                {
                  "Fn::Sub": "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:/central/newrelic/license*"
                }
              ]
            }
          ]
        },
        "PolicyName": "root",
        "Roles": [
          {
            "Ref": "XgemailXdeliveryInstanceRole"
          }
        ]
      }
    },

    "XgemailInternetXdeliveryInstanceProfile": {
      "Type": "AWS::IAM::InstanceProfile",
      "Properties": {
        "Path": "/",
        "Roles": [
          {
            "Ref": "XgemailInternetXdeliveryInstanceRole"
          }
        ]
      }
    },
    "XgemailInternetXdeliveryInstanceRole": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "ManagedPolicyArns": [ "arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore" ],
        "AssumeRolePolicyDocument": {
          "Statement": [
            {
              "Action": [ "sts:AssumeRole" ],
              "Effect": "Allow",
              "Principal": {
                "Service": [ "ec2.amazonaws.com" ]
              }
            }
          ]
        },
        "Path": "/",
        "Tags": [
          {
            "Key": "Application",
            "Value": "internet-xdelivery"
          },
          {
            "Key": "BusinessUnit",
            "Value": "MSG"
          },
          {
            "Key": "Name",
            "Value": { "Fn::Join": [ "-", [ { "Ref" : "AWS::StackName" }, "XgemailInternetXdeliveryInstanceRole" ] ] }
          },
          {
            "Key": "Project",
            "Value": "xgemail"
          },
          {
            "Key": "OwnerEmail",
            "Value": "sophosmailops@sophos.com"
          }
        ]
      }
    },
    "XgemailInternetXdeliveryInstanceRolePolicies": {
      "Type": "AWS::IAM::Policy",
      "Properties": {
        "PolicyDocument": {
          "Statement": [
            {
              "Action": [
                "autoscaling:UpdateAutoScalingGroup",
                "autoscaling:DescribeAutoScalingInstances"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action": [
                "ec2:AssociateAddress",
                "ec2:AttachVolume",
                "ec2:CreateSnapshot",
                "ec2:CreateTags",
                "ec2:CreateVolume",
                "ec2:DescribeAddresses",
                "ec2:DescribeImages",
                "ec2:DescribeInstanceAttribute",
                "ec2:DescribeInstances",
                "ec2:DescribeNatGateways",
                "ec2:DescribeNetworkInterfaces",
                "ec2:DescribeRouteTables",
                "ec2:DescribeSnapshots",
                "ec2:DescribeSubnets",
                "ec2:DescribeTags",
                "ec2:DescribeVolumes",
                "ec2:DescribeVpcs",
                "ec2:DetachVolume",
                "ec2:ModifyInstanceAttribute",
                "ec2:ModifySnapshotAttribute"
              ],
              "Effect": "Allow",
              "Resource": [ "*" ]
            },
            {
              "Action": [
                "iam:GetRole"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action": [
                "kms:CreateGrant",
                "kms:Decrypt",
                "kms:DescribeKey",
                "kms:Encrypt",
                "kms:GenerateDataKey",
                "kms:GenerateDataKeyWithoutPlaintext",
                "kms:List*",
                "kms:ReEncrypt*",
                "kms:RevokeGrant"
              ],
              "Effect": "Allow",
              "Resource": [ "*" ]
            },
            {
              "Action": [
                "logs:CreateLogGroup",
                "logs:CreateLogStream",
                "logs:DescribeLogGroups",
                "logs:DescribeLogStreams",
                "logs:DescribeMetricFilters",
                "logs:PutLogEvents"
              ],
              "Effect": "Allow",
              "Resource": [ "*" ]
            },
            {
              "Action" : [
                "s3:GetBucketLocation",
                "s3:ListBucket"
              ],
              "Effect" : "Allow",
              "Resource" : [ { "Fn::Join": [ "-", [ "arn:aws:s3:::logs-sophos-msg", { "Ref": "Environment" }, "*" ] ] } ]
            },
            {
              "Action" : [
                "s3:PutObject"
              ],
              "Effect" : "Allow",
              "Resource" : [ { "Fn::Join": [ "/", [ { "Fn::Join": [ "-", [ "arn:aws:s3:::logs-sophos-msg", { "Ref": "Environment" }, "*" ] ] }, "*" ] ] } ]
            },
            {
              "Action": [
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:PutObject",
                "s3:GetEncryptionConfiguration",
                "s3:AbortMultipartUpload",
                "s3:ListMultipartUploadParts",
                "s3:ListBucket",
                "s3:ListBucketMultipartUploads"
              ],
              "Resource": [
                { "Fn::Join" : ["-", ["arn:aws:s3:::cloud", { "Ref": "Environment" }, "ssm-session-logs/*"]]},
                { "Fn::Join" : ["-", ["arn:aws:s3:::cloud", { "Ref": "Environment" }, "ssm-session-logs" ]]}
              ],
              "Effect": "Allow"
            },
            {
              "Action": [
                "s3:DeleteObject",
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:PutObject"
              ],
              "Effect": "Allow",
              "Resource": [
                "arn:aws:s3:::cloud-*"
              ]
            },
            {
              "Action": [
                "sdb:BatchDeleteAttributes",
                "sdb:BatchPutAttributes",
                "sdb:CreateDomain",
                "sdb:DeleteAttributes",
                "sdb:DeleteDomain",
                "sdb:DomainMetadata",
                "sdb:GetAttributes",
                "sdb:ListDomains",
                "sdb:PutAttributes",
                "sdb:Select"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action": [
                "sns:ListSubscriptionsByTopic",
                "sns:ListTopics",
                "sns:Publish",
                "sns:Subscribe",
                "sns:Unsubscribe"
              ],
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::Join": [
                    ":",
                    [
                      "arn:aws:sns",
                      { "Ref": "AWS::Region" },
                      { "Ref": "AWS::AccountId" },
                      "*"
                    ]
                  ]
                }
              ]
            },
            {
              "Action" : [
                "sqs:ChangeMessageVisibility",
                "sqs:CreateQueue",
                "sqs:DeleteMessage",
                "sqs:DeleteQueue",
                "sqs:GetQueueAttributes",
                "sqs:GetQueueUrl",
                "sqs:ListQueues",
                "sqs:SendMessage",
                "sqs:SetQueueAttributes",
                "sqs:ReceiveMessage"
              ],
              "Effect" : "Allow",
              "Resource" : ["*"]
            },
            {
              "Action" : [
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:ListBucket",
                "s3:PutObject",
                "s3:RestoreObject"
              ],
              "Effect" : "Allow",
              "Resource" : [{ "Fn::Join" : ["", ["arn:aws:s3:::", { "Ref" : "MsgHistoryV2BucketName" }, "/*"]]},
                { "Fn::Join" : ["", ["arn:aws:s3:::", { "Ref" : "MsgHistoryV2BucketName" }]]}]
            },
            {
              "Action": [
                "dynamodb:BatchWriteItem",
                "dynamodb:DeleteItem",
                "dynamodb:BatchGetItem",
                "dynamodb:Scan",
                "dynamodb:ListTables",
                "dynamodb:GetItem",
                "dynamodb:GetRecords",
                "dynamodb:DescribeTable",
                "dynamodb:PutItem",
                "dynamodb:Query",
                "dynamodb:UpdateItem",
                "dynamodb:UpdateTable"
              ],
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::Sub": "arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${MsgHistoryV2DynamoDbTableName}"
                }
              ]
            },
            {
              "Action": [
                "firehose:DescribeDeliveryStream",
                "firehose:PutRecord",
                "firehose:PutRecordBatch"
              ],
              "Effect" : "Allow",
              "Resource": [
                {
                  "Fn::Sub": "arn:aws:firehose:${AWS::Region}:${AWS::AccountId}:deliverystream/${MsgHistoryV2StreamName}"
                }
              ]
            },
            {
              "Action": [
                "kinesis:DescribeStream",
                "kinesis:PutRecord",
                "kinesis:PutRecords"
              ],
              "Effect" : "Allow",
              "Resource": [
                {
                  "Fn::Sub": "arn:aws:kinesis:${AWS::Region}:${AWS::AccountId}:stream/${MsgHistoryDataStreamName}"
                }
              ]
            },
            {
              "Action": [
                "secretsmanager:ListSecrets"
              ],
              "Effect" : "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action": [
                "secretsmanager:GetResourcePolicy",
                "secretsmanager:GetSecretValue",
                "secretsmanager:DescribeSecret",
                "secretsmanager:ListSecretVersionIds"
              ],
              "Effect" : "Allow",
              "Resource": [
                {
                  "Fn::Sub": "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:/central/newrelic/license*"
                }
              ]
            }
          ]
        },
        "PolicyName": "root",
        "Roles": [
          {
            "Ref": "XgemailInternetXdeliveryInstanceRole"
          }
        ]
      }
    },

    "XgemailMfOutboundSubmitInstanceProfile" : {
      "Type" : "AWS::IAM::InstanceProfile",
      "Properties" : {
        "Path" : "/",
        "Roles" : [
          {
            "Ref" : "XgemailMfOutboundSubmitInstanceRole"
          }
        ]
      }
    },
    "XgemailMfOutboundSubmitInstanceRole": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "ManagedPolicyArns": [ "arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore" ],
        "AssumeRolePolicyDocument": {
          "Statement": [
            {
              "Action": [ "sts:AssumeRole" ],
              "Effect": "Allow",
              "Principal": {
                "Service": [ "ec2.amazonaws.com" ]
              }
            }
          ]
        },
        "Path": "/",
        "Tags": [
          {
            "Key": "Application",
            "Value": "mf-outbound-submit"
          },
          {
            "Key": "BusinessUnit",
            "Value": "MSG"
          },
          {
            "Key": "Name",
            "Value": { "Fn::Join": [ "-", [ { "Ref" : "AWS::StackName" }, "XgemailMfOutboundSubmitInstanceRole" ] ] }
          },
          {
            "Key": "Project",
            "Value": "xgemail"
          },
          {
            "Key": "OwnerEmail",
            "Value": "sophosmailops@sophos.com"
          }
        ]
      }
    },
    "XgemailMfOutboundSubmitInstanceRolePolicies": {
      "Type": "AWS::IAM::Policy",
      "Properties": {
        "PolicyDocument": {
          "Statement": [
            {
              "Action": [
                "autoscaling:CompleteLifecycleAction",
                "autoscaling:DescribeAutoScalingInstances",
                "autoscaling:DescribeLifecycleHooks",
                "autoscaling:RecordLifecycleActionHeartbeat",
                "autoscaling:UpdateAutoScalingGroup"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action": [
                "ec2:AttachVolume",
                "ec2:CreateSnapshot",
                "ec2:CreateTags",
                "ec2:CreateVolume",
                "ec2:DeleteVolume",
                "ec2:DescribeImages",
                "ec2:DescribeInstanceAttribute",
                "ec2:DescribeInstances",
                "ec2:DescribeNatGateways",
                "ec2:DescribeNetworkInterfaces",
                "ec2:DescribeRouteTables",
                "ec2:DescribeSnapshots",
                "ec2:DescribeSubnets",
                "ec2:DescribeTags",
                "ec2:DescribeVolumes",
                "ec2:DescribeVpcs",
                "ec2:DetachVolume",
                "ec2:ModifyInstanceAttribute",
                "ec2:ModifySnapshotAttribute"
              ],
              "Effect": "Allow",
              "Resource": [ "*" ]
            },
            {
              "Action": [
                "iam:GetRole"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action": [
                "kms:CreateGrant",
                "kms:Decrypt",
                "kms:DescribeKey",
                "kms:Encrypt",
                "kms:GenerateDataKey",
                "kms:GenerateDataKeyWithoutPlaintext",
                "kms:List*",
                "kms:ReEncrypt*",
                "kms:RevokeGrant"
              ],
              "Effect": "Allow",
              "Resource": [ "*" ]
            },
            {
              "Action": [
                "logs:CreateLogGroup",
                "logs:CreateLogStream",
                "logs:DescribeLogGroups",
                "logs:DescribeLogStreams",
                "logs:DescribeMetricFilters",
                "logs:PutLogEvents"
              ],
              "Effect": "Allow",
              "Resource": [ "*" ]
            },
            {
              "Action": [
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:ListBucket",
                "s3:PutObject",
                "s3:RestoreObject"
              ],
              "Effect": "Allow",
              "Resource": [
                { "Fn::Join": [ "", [ "arn:aws:s3:::", { "Ref": "XgemailMsgHistoryBucketName" }, "/*" ] ] },
                { "Fn::Join": [ "", [ "arn:aws:s3:::", { "Ref": "XgemailMsgHistoryBucketName" } ] ] }
              ]
            },
            {
              "Action" : [
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:ListBucket",
                "s3:PutObject",
                "s3:RestoreObject"
              ],
              "Effect" : "Allow",
              "Resource" : [{ "Fn::Join" : ["", ["arn:aws:s3:::", { "Ref" : "MsgHistoryV2BucketName" }, "/*"]]},
                { "Fn::Join" : ["", ["arn:aws:s3:::", { "Ref" : "MsgHistoryV2BucketName" }]]}]
            },
            {
              "Action": [
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:ListBucket",
                "s3:PutObject"
              ],
              "Effect": "Allow",
              "Resource": [
                { "Fn::Join": [ "", [ "arn:aws:s3:::", { "Ref": "DeliveryDirectorBucketName" }, "/*" ] ] },
                { "Fn::Join": [ "", [ "arn:aws:s3:::", { "Ref": "DeliveryDirectorBucketName" } ] ] }
              ]
            },
            {
              "Action": [
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:ListBucket",
                "s3:PutObject",
                "s3:RestoreObject"
              ],
              "Effect": "Allow",
              "Resource": [
                { "Fn::Join": [ "", [ "arn:aws:s3:::", { "Ref": "XgemailMsgHistoryMsBucketName" }, "/*" ] ] },
                { "Fn::Join": [ "", [ "arn:aws:s3:::", { "Ref": "XgemailMsgHistoryMsBucketName" } ] ] }
              ]
            },
            {
              "Action": [
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:ListBucket"
              ],
              "Effect": "Allow",
              "Resource": [
                { "Fn::Join": [ "", [ "arn:aws:s3:::", { "Ref": "XgemailPolicyBucketName" }, "/*" ] ] },
                { "Fn::Join": [ "", [ "arn:aws:s3:::", { "Ref": "XgemailPolicyBucketName" } ] ] }
              ]
            },
            {
              "Action": [
                "s3:GetBucketLocation",
                "s3:ListBucket",
                "s3:GetObject",
                "s3:PutObject"
              ],
              "Effect": "Allow",
              "Resource": [
                { "Fn::Join": [ "", [ "arn:aws:s3:::", { "Ref": "XgemailCustomerSubmitBucketName" }, "/*" ] ] },
                { "Fn::Join": [ "", [ "arn:aws:s3:::", { "Ref": "XgemailCustomerSubmitBucketName" } ] ] }
              ]
            },
            {
              "Action" : [
                "s3:GetBucketLocation",
                "s3:ListBucket"
              ],
              "Effect" : "Allow",
              "Resource" : [ { "Fn::Join": [ "-", [ "arn:aws:s3:::logs-sophos-msg", { "Ref": "Environment" }, "*" ] ] } ]
            },
            {
              "Action" : [
                "s3:PutObject"
              ],
              "Effect" : "Allow",
              "Resource" : [ { "Fn::Join": [ "/", [ { "Fn::Join": [ "-", [ "arn:aws:s3:::logs-sophos-msg", { "Ref": "Environment" }, "*" ] ] }, "*" ] ] } ]
            },
            {
              "Action": [
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:PutObject",
                "s3:GetEncryptionConfiguration",
                "s3:AbortMultipartUpload",
                "s3:ListMultipartUploadParts",
                "s3:ListBucket",
                "s3:ListBucketMultipartUploads"
              ],
              "Resource": [
                { "Fn::Join" : ["-", ["arn:aws:s3:::cloud", { "Ref": "Environment" }, "ssm-session-logs/*"]]},
                { "Fn::Join" : ["-", ["arn:aws:s3:::cloud", { "Ref": "Environment" }, "ssm-session-logs" ]]}
              ],
              "Effect": "Allow"
            },
            {
              "Action": [
                "s3:DeleteObject",
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:PutObject"
              ],
              "Effect": "Allow",
              "Resource": [
                "arn:aws:s3:::cloud-*"
              ]
            },
            {
              "Action": [
                "sdb:BatchDeleteAttributes",
                "sdb:BatchPutAttributes",
                "sdb:CreateDomain",
                "sdb:DeleteAttributes",
                "sdb:DeleteDomain",
                "sdb:DomainMetadata",
                "sdb:GetAttributes",
                "sdb:ListDomains",
                "sdb:PutAttributes",
                "sdb:Select"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action": [
                "sns:GetSubscriptionAttributes",
                "sns:ListSubscriptionsByTopic",
                "sns:ListTopics",
                "sns:Publish",
                "sns:Subscribe",
                "sns:Unsubscribe"
              ],
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::Join": [
                    ":",
                    [
                      "arn:aws:sns",
                      { "Ref": "AWS::Region" },
                      { "Ref": "AWS::AccountId" },
                      "*"
                    ]
                  ]
                }
              ]
            },
            {
              "Action": [
                "sqs:ChangeMessageVisibility",
                "sqs:CreateQueue",
                "sqs:DeleteMessage",
                "sqs:DeleteQueue",
                "sqs:GetQueueAttributes",
                "sqs:GetQueueUrl",
                "sqs:ListQueues",
                "sqs:SendMessage",
                "sqs:SetQueueAttributes",
                "sqs:ReceiveMessage"
              ],
              "Effect": "Allow",
              "Resource": [ "*" ]
            },
            {
              "Action": [
                "cloudwatch:putMetricData"
              ],
              "Effect": "Allow",
              "Resource": [ "*" ]
            },
            {
              "Action": [
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:ListBucket",
                "s3:PutObject"
              ],
              "Effect": "Allow",
              "Resource": [
                { "Fn::Join": [ "", [ "arn:aws:s3:::", { "Ref": "DeliveryDirectorBucketName" }, "/*" ] ] },
                { "Fn::Join": [ "", [ "arn:aws:s3:::", { "Ref": "DeliveryDirectorBucketName" } ] ] }
              ]
            },
            {
              "Action": [
                "dynamodb:BatchWriteItem",
                "dynamodb:DeleteItem",
                "dynamodb:BatchGetItem",
                "dynamodb:Scan",
                "dynamodb:ListTables",
                "dynamodb:GetItem",
                "dynamodb:GetRecords",
                "dynamodb:DescribeTable",
                "dynamodb:PutItem",
                "dynamodb:Query",
                "dynamodb:UpdateItem",
                "dynamodb:UpdateTable"
              ],
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::Sub": "arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${DeliveryDirectorDynamodbTableName}"
                }
              ]
            },
            {
              "Action": [
                "firehose:DescribeDeliveryStream",
                "firehose:PutRecord",
                "firehose:PutRecordBatch"
              ],
              "Effect" : "Allow",
              "Resource": [
                {
                  "Fn::Sub": "arn:aws:firehose:${AWS::Region}:${AWS::AccountId}:deliverystream/${MsgHistoryV2StreamName}"
                }
              ]
            },
            {
              "Action": [
                "kinesis:DescribeStream",
                "kinesis:PutRecord",
                "kinesis:PutRecords"
              ],
              "Effect" : "Allow",
              "Resource": [
                {
                  "Fn::Sub": "arn:aws:kinesis:${AWS::Region}:${AWS::AccountId}:stream/${MsgHistoryDataStreamName}"
                }
              ]
            },
            {
              "Action": [
                "secretsmanager:ListSecrets"
              ],
              "Effect" : "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action": [
                "secretsmanager:GetResourcePolicy",
                "secretsmanager:GetSecretValue",
                "secretsmanager:DescribeSecret",
                "secretsmanager:ListSecretVersionIds"
              ],
              "Effect" : "Allow",
              "Resource": [
                {
                  "Fn::Sub": "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:/central/newrelic/license*"
                }
              ]
            }
          ]
        },
        "PolicyName": "root",
        "Roles": [
          {
            "Ref": "XgemailMfOutboundSubmitInstanceRole"
          }
        ]
      }
    },

    "XgemailMfOutboundDeliveryInstanceProfile" : {
      "Type" : "AWS::IAM::InstanceProfile",
      "Properties" : {
        "Path" : "/",
        "Roles" : [
          {
            "Ref" : "XgemailMfOutboundDeliveryInstanceRole"
          }
        ]
      }
    },
    "XgemailMfOutboundDeliveryInstanceRole" : {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "ManagedPolicyArns": [ "arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore" ],
        "AssumeRolePolicyDocument": {
          "Statement": [
            {
              "Action": ["sts:AssumeRole"],
              "Effect": "Allow",
              "Principal": {
                "Service": ["ec2.amazonaws.com"]
              }
            }
          ]
        },
        "Path": "/",
        "Tags": [
          {
            "Key": "Application",
            "Value": "mf-outbound-delivery"
          },
          {
            "Key": "BusinessUnit",
            "Value": "MSG"
          },
          {
            "Key": "Name",
            "Value": { "Fn::Join": [ "-", [ { "Ref" : "AWS::StackName" }, "XgemailMfOutboundDeliveryInstanceRole" ] ] }
          },
          {
            "Key": "Project",
            "Value": "xgemail"
          },
          {
            "Key": "OwnerEmail",
            "Value": "sophosmailops@sophos.com"
          }
        ]
      }
    },
    "XgemailMfOutboundDeliveryInstanceRolePolicies" : {
      "Type" : "AWS::IAM::Policy",
      "Properties" : {
        "PolicyDocument" : {
          "Statement" : [
            {
              "Action": [
                "autoscaling:CompleteLifecycleAction",
                "autoscaling:DescribeAutoScalingInstances",
                "autoscaling:DescribeLifecycleHooks",
                "autoscaling:RecordLifecycleActionHeartbeat",
                "autoscaling:UpdateAutoScalingGroup"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action" : [
                "ec2:AssociateAddress",
                "ec2:AttachVolume",
                "ec2:CreateSnapshot",
                "ec2:CreateTags",
                "ec2:CreateVolume",
                "ec2:DeleteVolume",
                "ec2:DescribeAddresses",
                "ec2:DescribeImages",
                "ec2:DescribeInstanceAttribute",
                "ec2:DescribeInstances",
                "ec2:DescribeNatGateways",
                "ec2:DescribeNetworkInterfaces",
                "ec2:DescribeRouteTables",
                "ec2:DescribeSnapshots",
                "ec2:DescribeSubnets",
                "ec2:DescribeTags",
                "ec2:DescribeVolumes",
                "ec2:DescribeVpcs",
                "ec2:DetachVolume",
                "ec2:ModifyInstanceAttribute",
                "ec2:ModifySnapshotAttribute"
              ],
              "Effect" : "Allow",
              "Resource" : ["*"]
            },
            {
              "Action": [
                "iam:GetRole"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action" : [
                "kms:CreateGrant",
                "kms:Decrypt",
                "kms:DescribeKey",
                "kms:Encrypt",
                "kms:GenerateDataKey",
                "kms:GenerateDataKeyWithoutPlaintext",
                "kms:List*",
                "kms:ReEncrypt*",
                "kms:RevokeGrant"
              ],
              "Effect" : "Allow",
              "Resource" : ["*"]
            },
            {
              "Action": [
                "logs:CreateLogGroup",
                "logs:CreateLogStream",
                "logs:DescribeLogGroups",
                "logs:DescribeLogStreams",
                "logs:DescribeMetricFilters",
                "logs:PutLogEvents"
              ],
              "Effect": "Allow",
              "Resource": [ "*" ]
            },
            {
              "Action" : [
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:ListBucket",
                "s3:PutObject",
                "s3:RestoreObject"
              ],
              "Effect" : "Allow",
              "Resource" : [{ "Fn::Join" : ["", ["arn:aws:s3:::", { "Ref" : "XgemailMsgHistoryBucketName" }, "/*"]]},
                { "Fn::Join" : ["", ["arn:aws:s3:::", { "Ref" : "XgemailMsgHistoryBucketName" }]]}]
            },
            {
              "Action" : [
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:ListBucket",
                "s3:PutObject",
                "s3:RestoreObject"
              ],
              "Effect" : "Allow",
              "Resource" : [{ "Fn::Join" : ["", ["arn:aws:s3:::", { "Ref" : "XgemailMsgHistoryMsBucketName" }, "/*"]]},
                { "Fn::Join" : ["", ["arn:aws:s3:::", { "Ref" : "XgemailMsgHistoryMsBucketName" }]]}]
            },
            {
              "Action" : [
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:ListBucket",
                "s3:PutObject",
                "s3:RestoreObject"
              ],
              "Effect" : "Allow",
              "Resource" : [{ "Fn::Join" : ["", ["arn:aws:s3:::", { "Ref" : "MsgHistoryV2BucketName" }, "/*"]]},
                { "Fn::Join" : ["", ["arn:aws:s3:::", { "Ref" : "MsgHistoryV2BucketName" }]]}]
            },
            {
              "Action" : [
                "s3:DeleteObject",
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:ListBucket"
              ],
              "Effect" : "Allow",
              "Resource" : [{ "Fn::Join" : ["", ["arn:aws:s3:::", { "Ref" : "XgemailCustomerSubmitBucketName" }, "/*"]]},
                { "Fn::Join" : ["", ["arn:aws:s3:::", { "Ref" : "XgemailCustomerSubmitBucketName" }]]}]
            },
            {
              "Action": [
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:ListBucket"
              ],
              "Effect": "Allow",
              "Resource": [
                { "Fn::Join": [ "", [ "arn:aws:s3:::", { "Ref": "XgemailPolicyBucketName" }, "/*" ] ] },
                { "Fn::Join": [ "", [ "arn:aws:s3:::", { "Ref": "XgemailPolicyBucketName" } ] ] }
              ]
            },
            {
              "Action" : [
                "s3:GetBucketLocation",
                "s3:ListBucket"
              ],
              "Effect" : "Allow",
              "Resource" : [ { "Fn::Join": [ "-", [ "arn:aws:s3:::logs-sophos-msg", { "Ref": "Environment" }, "*" ] ] } ]
            },
            {
              "Action" : [
                "s3:PutObject"
              ],
              "Effect" : "Allow",
              "Resource" : [ { "Fn::Join": [ "/", [ { "Fn::Join": [ "-", [ "arn:aws:s3:::logs-sophos-msg", { "Ref": "Environment" }, "*" ] ] }, "*" ] ] } ]
            },
            {
              "Action": [
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:PutObject",
                "s3:GetEncryptionConfiguration",
                "s3:AbortMultipartUpload",
                "s3:ListMultipartUploadParts",
                "s3:ListBucket",
                "s3:ListBucketMultipartUploads"
              ],
              "Resource": [
                { "Fn::Join" : ["-", ["arn:aws:s3:::cloud", { "Ref": "Environment" }, "ssm-session-logs/*"]]},
                { "Fn::Join" : ["-", ["arn:aws:s3:::cloud", { "Ref": "Environment" }, "ssm-session-logs" ]]}
              ],
              "Effect": "Allow"
            },
            {
              "Action": [
                "s3:DeleteObject",
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:PutObject"
              ],
              "Effect": "Allow",
              "Resource": [
                "arn:aws:s3:::cloud-*"
              ]
            },
            {
              "Action": [
                "sdb:BatchDeleteAttributes",
                "sdb:BatchPutAttributes",
                "sdb:CreateDomain",
                "sdb:DeleteAttributes",
                "sdb:DeleteDomain",
                "sdb:DomainMetadata",
                "sdb:GetAttributes",
                "sdb:ListDomains",
                "sdb:PutAttributes",
                "sdb:Select"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action": [
                "sns:ListSubscriptionsByTopic",
                "sns:ListTopics",
                "sns:Publish",
                "sns:Subscribe",
                "sns:Unsubscribe"
              ],
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::Join": [
                    ":",
                    [
                      "arn:aws:sns",
                      { "Ref": "AWS::Region" },
                      { "Ref": "AWS::AccountId" },
                      "*"
                    ]
                  ]
                }
              ]
            },
            {
              "Action" : [
                "sqs:ChangeMessageVisibility",
                "sqs:CreateQueue",
                "sqs:DeleteMessage",
                "sqs:DeleteQueue",
                "sqs:GetQueueAttributes",
                "sqs:GetQueueUrl",
                "sqs:ListQueues",
                "sqs:SendMessage",
                "sqs:SetQueueAttributes",
                "sqs:ReceiveMessage"
              ],
              "Effect" : "Allow",
              "Resource" : ["*"]
            },
            {
              "Action": [
                "firehose:DescribeDeliveryStream",
                "firehose:PutRecord",
                "firehose:PutRecordBatch"
              ],
              "Effect" : "Allow",
              "Resource": [
                {
                  "Fn::Join": [
                    ":",
                    [
                      "arn:aws:firehose",
                      { "Ref": "AWS::Region" },
                      { "Ref": "AWS::AccountId" },
                      {
                        "Fn::Join": [
                          "-",
                          [
                            "deliverystream/tf-e2e-latency-telemetry",
                            { "Ref": "AWS::Region" },
                            { "Ref": "Environment" },
                            "firehose"
                          ]
                        ]
                      }
                    ]
                  ]
                }
              ]
            },
            {
              "Action": [
                "firehose:DescribeDeliveryStream",
                "firehose:PutRecord",
                "firehose:PutRecordBatch"
              ],
              "Effect" : "Allow",
              "Resource": [
                {
                  "Fn::Sub": "arn:aws:firehose:${AWS::Region}:${AWS::AccountId}:deliverystream/${MsgHistoryV2StreamName}"
                }
              ]
            },
            {
              "Action": [
                "kinesis:DescribeStream",
                "kinesis:PutRecord",
                "kinesis:PutRecords"
              ],
              "Effect" : "Allow",
              "Resource": [
                {
                  "Fn::Sub": "arn:aws:kinesis:${AWS::Region}:${AWS::AccountId}:stream/${MsgHistoryDataStreamName}"
                }
              ]
            },
            {
              "Action": [
                "dynamodb:BatchWriteItem",
                "dynamodb:DeleteItem",
                "dynamodb:BatchGetItem",
                "dynamodb:Scan",
                "dynamodb:ListTables",
                "dynamodb:GetItem",
                "dynamodb:GetRecords",
                "dynamodb:DescribeTable",
                "dynamodb:PutItem",
                "dynamodb:Query",
                "dynamodb:UpdateItem",
                "dynamodb:UpdateTable"
              ],
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::Sub": "arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${MsgHistoryV2DynamoDbTableName}"
                }
              ]
            },
            {
              "Action": [
                "secretsmanager:ListSecrets"
              ],
              "Effect" : "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action": [
                "secretsmanager:GetResourcePolicy",
                "secretsmanager:GetSecretValue",
                "secretsmanager:DescribeSecret",
                "secretsmanager:ListSecretVersionIds"
              ],
              "Effect" : "Allow",
              "Resource": [
                {
                  "Fn::Sub": "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:/central/newrelic/license*"
                }
              ]
            }
          ]
        },
        "PolicyName" : "root",
        "Roles" : [
          {
            "Ref" : "XgemailMfOutboundDeliveryInstanceRole"
          }
        ]
      }
    },

    "XgemailMfInboundXdeliveryInstanceProfile": {
      "Type": "AWS::IAM::InstanceProfile",
      "Properties": {
        "Path": "/",
        "Roles": [
          {
            "Ref": "XgemailMfInboundXdeliveryInstanceRole"
          }
        ]
      }
    },
    "XgemailMfInboundXdeliveryInstanceRole": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "ManagedPolicyArns": [ "arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore" ],
        "AssumeRolePolicyDocument": {
          "Statement": [
            {
              "Action": [ "sts:AssumeRole" ],
              "Effect": "Allow",
              "Principal": {
                "Service": [ "ec2.amazonaws.com" ]
              }
            }
          ]
        },
        "Path": "/",
        "Tags": [
          {
            "Key": "Application",
            "Value": "mf-inbound-xdelivery"
          },
          {
            "Key": "BusinessUnit",
            "Value": "MSG"
          },
          {
            "Key": "Name",
            "Value": { "Fn::Join": [ "-", [ { "Ref" : "AWS::StackName" }, "XgemailMfInboundXdeliveryInstanceRole" ] ] }
          },
          {
            "Key": "Project",
            "Value": "xgemail"
          },
          {
            "Key": "OwnerEmail",
            "Value": "sophosmailops@sophos.com"
          }
        ]
      }
    },
    "XgemailMfInboundXdeliveryInstanceRolePolicies": {
      "Type": "AWS::IAM::Policy",
      "Properties": {
        "PolicyDocument": {
          "Statement": [
            {
              "Action": [
                "autoscaling:UpdateAutoScalingGroup",
                "autoscaling:DescribeAutoScalingInstances"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action": [
                "ec2:AttachVolume",
                "ec2:CreateSnapshot",
                "ec2:CreateTags",
                "ec2:CreateVolume",
                "ec2:DescribeImages",
                "ec2:DescribeInstanceAttribute",
                "ec2:DescribeInstances",
                "ec2:DescribeNatGateways",
                "ec2:DescribeNetworkInterfaces",
                "ec2:DescribeRouteTables",
                "ec2:DescribeSnapshots",
                "ec2:DescribeSubnets",
                "ec2:DescribeTags",
                "ec2:DescribeVolumes",
                "ec2:DescribeVpcs",
                "ec2:DetachVolume",
                "ec2:ModifyInstanceAttribute",
                "ec2:ModifySnapshotAttribute"
              ],
              "Effect": "Allow",
              "Resource": [ "*" ]
            },
            {
              "Action": [
                "iam:GetRole"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action": [
                "kms:CreateGrant",
                "kms:Decrypt",
                "kms:DescribeKey",
                "kms:Encrypt",
                "kms:GenerateDataKey",
                "kms:GenerateDataKeyWithoutPlaintext",
                "kms:List*",
                "kms:ReEncrypt*",
                "kms:RevokeGrant"
              ],
              "Effect": "Allow",
              "Resource": [ "*" ]
            },
            {
              "Action": [
                "logs:CreateLogGroup",
                "logs:CreateLogStream",
                "logs:DescribeLogGroups",
                "logs:DescribeLogStreams",
                "logs:DescribeMetricFilters",
                "logs:PutLogEvents"
              ],
              "Effect": "Allow",
              "Resource": [ "*" ]
            },
            {
              "Action" : [
                "s3:GetBucketLocation",
                "s3:ListBucket"
              ],
              "Effect" : "Allow",
              "Resource" : [ { "Fn::Join": [ "-", [ "arn:aws:s3:::logs-sophos-msg", { "Ref": "Environment" }, "*" ] ] } ]
            },
            {
              "Action" : [
                "s3:PutObject"
              ],
              "Effect" : "Allow",
              "Resource" : [ { "Fn::Join": [ "/", [ { "Fn::Join": [ "-", [ "arn:aws:s3:::logs-sophos-msg", { "Ref": "Environment" }, "*" ] ] }, "*" ] ] } ]
            },
            {
              "Action": [
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:PutObject",
                "s3:GetEncryptionConfiguration",
                "s3:AbortMultipartUpload",
                "s3:ListMultipartUploadParts",
                "s3:ListBucket",
                "s3:ListBucketMultipartUploads"
              ],
              "Resource": [
                { "Fn::Join" : ["-", ["arn:aws:s3:::cloud", { "Ref": "Environment" }, "ssm-session-logs/*"]]},
                { "Fn::Join" : ["-", ["arn:aws:s3:::cloud", { "Ref": "Environment" }, "ssm-session-logs" ]]}
              ],
              "Effect": "Allow"
            },
            {
              "Action": [
                "s3:DeleteObject",
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:PutObject"
              ],
              "Effect": "Allow",
              "Resource": [
                "arn:aws:s3:::cloud-*"
              ]
            },
            {
              "Action": [
                "sdb:BatchDeleteAttributes",
                "sdb:BatchPutAttributes",
                "sdb:CreateDomain",
                "sdb:DeleteAttributes",
                "sdb:DeleteDomain",
                "sdb:DomainMetadata",
                "sdb:GetAttributes",
                "sdb:ListDomains",
                "sdb:PutAttributes",
                "sdb:Select"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action": [
                "sns:ListSubscriptionsByTopic",
                "sns:ListTopics",
                "sns:Publish",
                "sns:Subscribe",
                "sns:Unsubscribe"
              ],
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::Join": [
                    ":",
                    [
                      "arn:aws:sns",
                      { "Ref": "AWS::Region" },
                      { "Ref": "AWS::AccountId" },
                      "*"
                    ]
                  ]
                }
              ]
            },
            {
              "Action": [
                "sqs:ChangeMessageVisibility",
                "sqs:CreateQueue",
                "sqs:DeleteMessage",
                "sqs:DeleteQueue",
                "sqs:GetQueueAttributes",
                "sqs:GetQueueUrl",
                "sqs:ListQueues",
                "sqs:SendMessage",
                "sqs:SetQueueAttributes",
                "sqs:ReceiveMessage"
              ],
              "Effect": "Allow",
              "Resource": [ "*" ]
            },
            {
              "Action" : [
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:ListBucket",
                "s3:PutObject",
                "s3:RestoreObject"
              ],
              "Effect" : "Allow",
              "Resource" : [{ "Fn::Join" : ["", ["arn:aws:s3:::", { "Ref" : "MsgHistoryV2BucketName" }, "/*"]]},
                { "Fn::Join" : ["", ["arn:aws:s3:::", { "Ref" : "MsgHistoryV2BucketName" }]]}]
            },
            {
              "Action": [
                "dynamodb:BatchWriteItem",
                "dynamodb:DeleteItem",
                "dynamodb:BatchGetItem",
                "dynamodb:Scan",
                "dynamodb:ListTables",
                "dynamodb:GetItem",
                "dynamodb:GetRecords",
                "dynamodb:DescribeTable",
                "dynamodb:PutItem",
                "dynamodb:Query",
                "dynamodb:UpdateItem",
                "dynamodb:UpdateTable"
              ],
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::Sub": "arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${MsgHistoryV2DynamoDbTableName}"
                }
              ]
            },
            {
              "Action": [
                "firehose:DescribeDeliveryStream",
                "firehose:PutRecord",
                "firehose:PutRecordBatch"
              ],
              "Effect" : "Allow",
              "Resource": [
                {
                  "Fn::Sub": "arn:aws:firehose:${AWS::Region}:${AWS::AccountId}:deliverystream/${MsgHistoryV2StreamName}"
                }
              ]
            },
            {
              "Action": [
                "kinesis:DescribeStream",
                "kinesis:PutRecord",
                "kinesis:PutRecords"
              ],
              "Effect" : "Allow",
              "Resource": [
                {
                  "Fn::Sub": "arn:aws:kinesis:${AWS::Region}:${AWS::AccountId}:stream/${MsgHistoryDataStreamName}"
                }
              ]
            },
            {
              "Action": [
                "secretsmanager:ListSecrets"
              ],
              "Effect" : "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action": [
                "secretsmanager:GetResourcePolicy",
                "secretsmanager:GetSecretValue",
                "secretsmanager:DescribeSecret",
                "secretsmanager:ListSecretVersionIds"
              ],
              "Effect" : "Allow",
              "Resource": [
                {
                  "Fn::Sub": "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:/central/newrelic/license*"
                }
              ]
            }
          ]
        },
        "PolicyName": "root",
        "Roles": [
          {
            "Ref": "XgemailMfInboundXdeliveryInstanceRole"
          }
        ]
      }
    },

    "XgemailMfOutboundXdeliveryInstanceProfile": {
      "Type": "AWS::IAM::InstanceProfile",
      "Properties": {
        "Path": "/",
        "Roles": [
          {
            "Ref": "XgemailMfOutboundXdeliveryInstanceRole"
          }
        ]
      }
    },
    "XgemailMfOutboundXdeliveryInstanceRole": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "ManagedPolicyArns": [ "arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore" ],
        "AssumeRolePolicyDocument": {
          "Statement": [
            {
              "Action": [ "sts:AssumeRole" ],
              "Effect": "Allow",
              "Principal": {
                "Service": [ "ec2.amazonaws.com" ]
              }
            }
          ]
        },
        "Path": "/",
        "Tags": [
          {
            "Key": "Application",
            "Value": "mf-outbound-xdelivery"
          },
          {
            "Key": "BusinessUnit",
            "Value": "MSG"
          },
          {
            "Key": "Name",
            "Value": { "Fn::Join": [ "-", [ { "Ref" : "AWS::StackName" }, "XgemailMfOutboundXdeliveryInstanceRole" ] ] }
          },
          {
            "Key": "Project",
            "Value": "xgemail"
          },
          {
            "Key": "OwnerEmail",
            "Value": "sophosmailops@sophos.com"
          }
        ]
      }
    },
    "XgemailMfOutboundXdeliveryInstanceRolePolicies": {
      "Type": "AWS::IAM::Policy",
      "Properties": {
        "PolicyDocument": {
          "Statement": [
            {
              "Action": [
                "autoscaling:UpdateAutoScalingGroup",
                "autoscaling:DescribeAutoScalingInstances"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action": [
                "ec2:AssociateAddress",
                "ec2:AttachVolume",
                "ec2:CreateSnapshot",
                "ec2:CreateTags",
                "ec2:CreateVolume",
                "ec2:DescribeAddresses",
                "ec2:DescribeImages",
                "ec2:DescribeInstanceAttribute",
                "ec2:DescribeInstances",
                "ec2:DescribeNatGateways",
                "ec2:DescribeNetworkInterfaces",
                "ec2:DescribeRouteTables",
                "ec2:DescribeSnapshots",
                "ec2:DescribeSubnets",
                "ec2:DescribeTags",
                "ec2:DescribeVolumes",
                "ec2:DescribeVpcs",
                "ec2:DetachVolume",
                "ec2:ModifyInstanceAttribute",
                "ec2:ModifySnapshotAttribute"
              ],
              "Effect": "Allow",
              "Resource": [ "*" ]
            },
            {
              "Action": [
                "iam:GetRole"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action": [
                "kms:CreateGrant",
                "kms:Decrypt",
                "kms:DescribeKey",
                "kms:Encrypt",
                "kms:GenerateDataKey",
                "kms:GenerateDataKeyWithoutPlaintext",
                "kms:List*",
                "kms:ReEncrypt*",
                "kms:RevokeGrant"
              ],
              "Effect": "Allow",
              "Resource": [ "*" ]
            },
            {
              "Action": [
                "logs:CreateLogGroup",
                "logs:CreateLogStream",
                "logs:DescribeLogGroups",
                "logs:DescribeLogStreams",
                "logs:DescribeMetricFilters",
                "logs:PutLogEvents"
              ],
              "Effect": "Allow",
              "Resource": [ "*" ]
            },
            {
              "Action" : [
                "s3:GetBucketLocation",
                "s3:ListBucket"
              ],
              "Effect" : "Allow",
              "Resource" : [ { "Fn::Join": [ "-", [ "arn:aws:s3:::logs-sophos-msg", { "Ref": "Environment" }, "*" ] ] } ]
            },
            {
              "Action" : [
                "s3:PutObject"
              ],
              "Effect" : "Allow",
              "Resource" : [ { "Fn::Join": [ "/", [ { "Fn::Join": [ "-", [ "arn:aws:s3:::logs-sophos-msg", { "Ref": "Environment" }, "*" ] ] }, "*" ] ] } ]
            },
            {
              "Action": [
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:PutObject",
                "s3:GetEncryptionConfiguration",
                "s3:AbortMultipartUpload",
                "s3:ListMultipartUploadParts",
                "s3:ListBucket",
                "s3:ListBucketMultipartUploads"
              ],
              "Resource": [
                { "Fn::Join" : ["-", ["arn:aws:s3:::cloud", { "Ref": "Environment" }, "ssm-session-logs/*"]]},
                { "Fn::Join" : ["-", ["arn:aws:s3:::cloud", { "Ref": "Environment" }, "ssm-session-logs" ]]}
              ],
              "Effect": "Allow"
            },
            {
              "Action": [
                "s3:DeleteObject",
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:PutObject"
              ],
              "Effect": "Allow",
              "Resource": [
                "arn:aws:s3:::cloud-*"
              ]
            },
            {
              "Action": [
                "sdb:BatchDeleteAttributes",
                "sdb:BatchPutAttributes",
                "sdb:CreateDomain",
                "sdb:DeleteAttributes",
                "sdb:DeleteDomain",
                "sdb:DomainMetadata",
                "sdb:GetAttributes",
                "sdb:ListDomains",
                "sdb:PutAttributes",
                "sdb:Select"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action": [
                "sns:ListSubscriptionsByTopic",
                "sns:ListTopics",
                "sns:Publish",
                "sns:Subscribe",
                "sns:Unsubscribe"
              ],
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::Join": [
                    ":",
                    [
                      "arn:aws:sns",
                      { "Ref": "AWS::Region" },
                      { "Ref": "AWS::AccountId" },
                      "*"
                    ]
                  ]
                }
              ]
            },
            {
              "Action" : [
                "sqs:ChangeMessageVisibility",
                "sqs:CreateQueue",
                "sqs:DeleteMessage",
                "sqs:DeleteQueue",
                "sqs:GetQueueAttributes",
                "sqs:GetQueueUrl",
                "sqs:ListQueues",
                "sqs:SendMessage",
                "sqs:SetQueueAttributes",
                "sqs:ReceiveMessage"
              ],
              "Effect" : "Allow",
              "Resource" : ["*"]
            },
            {
              "Action" : [
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:ListBucket",
                "s3:PutObject",
                "s3:RestoreObject"
              ],
              "Effect" : "Allow",
              "Resource" : [{ "Fn::Join" : ["", ["arn:aws:s3:::", { "Ref" : "MsgHistoryV2BucketName" }, "/*"]]},
                { "Fn::Join" : ["", ["arn:aws:s3:::", { "Ref" : "MsgHistoryV2BucketName" }]]}]
            },
            {
              "Action": [
                "dynamodb:BatchWriteItem",
                "dynamodb:DeleteItem",
                "dynamodb:BatchGetItem",
                "dynamodb:Scan",
                "dynamodb:ListTables",
                "dynamodb:GetItem",
                "dynamodb:GetRecords",
                "dynamodb:DescribeTable",
                "dynamodb:PutItem",
                "dynamodb:Query",
                "dynamodb:UpdateItem",
                "dynamodb:UpdateTable"
              ],
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::Sub": "arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${MsgHistoryV2DynamoDbTableName}"
                }
              ]
            },
            {
              "Action": [
                "firehose:DescribeDeliveryStream",
                "firehose:PutRecord",
                "firehose:PutRecordBatch"
              ],
              "Effect" : "Allow",
              "Resource": [
                {
                  "Fn::Sub": "arn:aws:firehose:${AWS::Region}:${AWS::AccountId}:deliverystream/${MsgHistoryV2StreamName}"
                }
              ]
            },
            {
              "Action": [
                "kinesis:DescribeStream",
                "kinesis:PutRecord",
                "kinesis:PutRecords"
              ],
              "Effect" : "Allow",
              "Resource": [
                {
                  "Fn::Sub": "arn:aws:kinesis:${AWS::Region}:${AWS::AccountId}:stream/${MsgHistoryDataStreamName}"
                }
              ]
            },
            {
              "Action": [
                "secretsmanager:ListSecrets"
              ],
              "Effect" : "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action": [
                "secretsmanager:GetResourcePolicy",
                "secretsmanager:GetSecretValue",
                "secretsmanager:DescribeSecret",
                "secretsmanager:ListSecretVersionIds"
              ],
              "Effect" : "Allow",
              "Resource": [
                {
                  "Fn::Sub": "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:/central/newrelic/license*"
                }
              ]
            }
          ]
        },
        "PolicyName": "root",
        "Roles": [
          {
            "Ref": "XgemailMfOutboundXdeliveryInstanceRole"
          }
        ]
      }
    },

    "XgemailRiskyDeliveryInstanceProfile": {
      "Type": "AWS::IAM::InstanceProfile",
      "Properties": {
        "Path": "/",
        "Roles": [
          {
            "Ref": "XgemailRiskyDeliveryInstanceRole"
          }
        ]
      }
    },
    "XgemailRiskyDeliveryInstanceRole": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "ManagedPolicyArns": [
          "arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore"
        ],
        "AssumeRolePolicyDocument": {
          "Statement": [
            {
              "Action": [
                "sts:AssumeRole"
              ],
              "Effect": "Allow",
              "Principal": {
                "Service": [
                  "ec2.amazonaws.com"
                ]
              }
            }
          ]
        },
        "Path": "/",
        "Tags": [
          {
            "Key": "Application",
            "Value": "risky-delivery"
          },
          {
            "Key": "BusinessUnit",
            "Value": "MSG"
          },
          {
            "Key": "Name",
            "Value": { "Fn::Join": [ "-", [ { "Ref" : "AWS::StackName" }, "XgemailRiskyDeliveryInstanceRole" ] ] }
          },
          {
            "Key": "Project",
            "Value": "xgemail"
          },
          {
            "Key": "OwnerEmail",
            "Value": "sophosmailops@sophos.com"
          }
        ]
      }
    },
    "XgemailRiskyDeliveryInstanceRolePolicies": {
      "Type": "AWS::IAM::Policy",
      "Properties": {
        "PolicyDocument": {
          "Statement": [
            {
              "Action": [
                "autoscaling:CompleteLifecycleAction",
                "autoscaling:DescribeAutoScalingInstances",
                "autoscaling:DescribeLifecycleHooks",
                "autoscaling:RecordLifecycleActionHeartbeat",
                "autoscaling:UpdateAutoScalingGroup"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action": [
                "ec2:AssociateAddress",
                "ec2:AttachVolume",
                "ec2:CreateSnapshot",
                "ec2:CreateTags",
                "ec2:CreateVolume",
                "ec2:DeleteVolume",
                "ec2:DescribeAddresses",
                "ec2:DescribeImages",
                "ec2:DescribeInstanceAttribute",
                "ec2:DescribeInstances",
                "ec2:DescribeNatGateways",
                "ec2:DescribeNetworkInterfaces",
                "ec2:DescribeRouteTables",
                "ec2:DescribeSnapshots",
                "ec2:DescribeSubnets",
                "ec2:DescribeTags",
                "ec2:DescribeVolumes",
                "ec2:DescribeVpcs",
                "ec2:DetachVolume",
                "ec2:ModifyInstanceAttribute",
                "ec2:ModifySnapshotAttribute"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action": [
                "iam:GetRole"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action": [
                "kms:CreateGrant",
                "kms:Decrypt",
                "kms:DescribeKey",
                "kms:Encrypt",
                "kms:GenerateDataKey",
                "kms:GenerateDataKeyWithoutPlaintext",
                "kms:List*",
                "kms:ReEncrypt*",
                "kms:RevokeGrant"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action": [
                "logs:CreateLogGroup",
                "logs:CreateLogStream",
                "logs:DescribeLogGroups",
                "logs:DescribeLogStreams",
                "logs:DescribeMetricFilters",
                "logs:PutLogEvents"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action": [
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:ListBucket",
                "s3:PutObject",
                "s3:RestoreObject"
              ],
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::Join": [
                    "",
                    [
                      "arn:aws:s3:::",
                      {
                        "Ref": "XgemailMsgHistoryBucketName"
                      },
                      "/*"
                    ]
                  ]
                },
                {
                  "Fn::Join": [
                    "",
                    [
                      "arn:aws:s3:::",
                      {
                        "Ref": "XgemailMsgHistoryBucketName"
                      }
                    ]
                  ]
                }
              ]
            },
            {
              "Action": [
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:ListBucket",
                "s3:PutObject",
                "s3:RestoreObject"
              ],
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::Join": [
                    "",
                    [
                      "arn:aws:s3:::",
                      {
                        "Ref": "XgemailMsgHistoryMsBucketName"
                      },
                      "/*"
                    ]
                  ]
                },
                {
                  "Fn::Join": [
                    "",
                    [
                      "arn:aws:s3:::",
                      {
                        "Ref": "XgemailMsgHistoryMsBucketName"
                      }
                    ]
                  ]
                }
              ]
            },
            {
              "Action" : [
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:ListBucket",
                "s3:PutObject",
                "s3:RestoreObject"
              ],
              "Effect" : "Allow",
              "Resource" : [{ "Fn::Join" : ["", ["arn:aws:s3:::", { "Ref" : "MsgHistoryV2BucketName" }, "/*"]]},
                { "Fn::Join" : ["", ["arn:aws:s3:::", { "Ref" : "MsgHistoryV2BucketName" }]]}]
            },
            {
              "Action": [
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:PutObject",
                "s3:GetEncryptionConfiguration",
                "s3:AbortMultipartUpload",
                "s3:ListMultipartUploadParts",
                "s3:ListBucket",
                "s3:ListBucketMultipartUploads"
              ],
              "Resource": [
                { "Fn::Join" : ["-", ["arn:aws:s3:::cloud", { "Ref": "Environment" }, "ssm-session-logs/*"]]},
                { "Fn::Join" : ["-", ["arn:aws:s3:::cloud", { "Ref": "Environment" }, "ssm-session-logs" ]]}
              ],
              "Effect": "Allow"
            },
            {
              "Action": [
                "s3:DeleteObject",
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:ListBucket"
              ],
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::Join": [
                    "",
                    [
                      "arn:aws:s3:::",
                      {
                        "Ref": "XgemailCustomerSubmitBucketName"
                      },
                      "/*"
                    ]
                  ]
                },
                {
                  "Fn::Join": [
                    "",
                    [
                      "arn:aws:s3:::",
                      {
                        "Ref": "XgemailCustomerSubmitBucketName"
                      }
                    ]
                  ]
                }
              ]
            },
            {
              "Action": [
                "s3:GetBucketLocation",
                "s3:ListBucket"
              ],
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::Join": [
                    "-",
                    [
                      "arn:aws:s3:::logs-sophos-msg",
                      {
                        "Ref": "Environment"
                      },
                      "*"
                    ]
                  ]
                }
              ]
            },
            {
              "Action": [
                "s3:PutObject"
              ],
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::Join": [
                    "/",
                    [
                      {
                        "Fn::Join": [
                          "-",
                          [
                            "arn:aws:s3:::logs-sophos-msg",
                            {
                              "Ref": "Environment"
                            },
                            "*"
                          ]
                        ]
                      },
                      "*"
                    ]
                  ]
                }
              ]
            },
            {
              "Action": [
                "s3:DeleteObject",
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:PutObject"
              ],
              "Effect": "Allow",
              "Resource": [
                "arn:aws:s3:::cloud-*"
              ]
            },
            {
              "Action": [
                "sdb:BatchDeleteAttributes",
                "sdb:BatchPutAttributes",
                "sdb:CreateDomain",
                "sdb:DeleteAttributes",
                "sdb:DeleteDomain",
                "sdb:DomainMetadata",
                "sdb:GetAttributes",
                "sdb:ListDomains",
                "sdb:PutAttributes",
                "sdb:Select"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action": [
                "sns:ListSubscriptionsByTopic",
                "sns:ListTopics",
                "sns:Publish",
                "sns:Subscribe",
                "sns:Unsubscribe"
              ],
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::Join": [
                    ":",
                    [
                      "arn:aws:sns",
                      {
                        "Ref": "AWS::Region"
                      },
                      {
                        "Ref": "AWS::AccountId"
                      },
                      "*"
                    ]
                  ]
                }
              ]
            },
            {
              "Action": [
                "sqs:ChangeMessageVisibility",
                "sqs:CreateQueue",
                "sqs:DeleteMessage",
                "sqs:DeleteQueue",
                "sqs:GetQueueAttributes",
                "sqs:GetQueueUrl",
                "sqs:ListQueues",
                "sqs:SendMessage",
                "sqs:SetQueueAttributes",
                "sqs:ReceiveMessage"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action": [
                "firehose:DescribeDeliveryStream",
                "firehose:PutRecord",
                "firehose:PutRecordBatch"
              ],
              "Effect" : "Allow",
              "Resource": [
                {
                  "Fn::Join": [
                    ":",
                    [
                      "arn:aws:firehose",
                      { "Ref": "AWS::Region" },
                      { "Ref": "AWS::AccountId" },
                      {
                        "Fn::Join": [
                          "-",
                          [
                            "deliverystream/tf-e2e-latency-telemetry",
                            { "Ref": "AWS::Region" },
                            { "Ref": "Environment" },
                            "firehose"
                          ]
                        ]
                      }
                    ]
                  ]
                }
              ]
            },
            {

              "Action": [
                "dynamodb:BatchWriteItem",
                "dynamodb:DeleteItem",
                "dynamodb:BatchGetItem",
                "dynamodb:Scan",
                "dynamodb:ListTables",
                "dynamodb:GetItem",
                "dynamodb:GetRecords",
                "dynamodb:DescribeTable",
                "dynamodb:PutItem",
                "dynamodb:Query",
                "dynamodb:UpdateItem",
                "dynamodb:UpdateTable"
              ],
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::Sub": "arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${MsgHistoryV2DynamoDbTableName}"
                }
              ]
            },
            {
              "Action": [
                "firehose:DescribeDeliveryStream",
                "firehose:PutRecord",
                "firehose:PutRecordBatch"
              ],
              "Effect" : "Allow",
              "Resource": [
                {
                  "Fn::Sub": "arn:aws:firehose:${AWS::Region}:${AWS::AccountId}:deliverystream/${MsgHistoryV2StreamName}"
                }
              ]
            },
            {
              "Action": [
                "kinesis:DescribeStream",
                "kinesis:PutRecord",
                "kinesis:PutRecords"
              ],
              "Effect" : "Allow",
              "Resource": [
                {
                  "Fn::Sub": "arn:aws:kinesis:${AWS::Region}:${AWS::AccountId}:stream/${MsgHistoryDataStreamName}"
                }
              ]
            },
            {
              "Action": [
                "secretsmanager:ListSecrets"
              ],
              "Effect" : "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action": [
                "secretsmanager:GetResourcePolicy",
                "secretsmanager:GetSecretValue",
                "secretsmanager:DescribeSecret",
                "secretsmanager:ListSecretVersionIds"
              ],
              "Effect" : "Allow",
              "Resource": [
                {
                  "Fn::Sub": "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:/central/newrelic/license*"
                }
              ]
            }
          ]
        },
        "PolicyName": "root",
        "Roles": [
          {
            "Ref": "XgemailRiskyDeliveryInstanceRole"
          }
        ]
      }
    },

    "XgemailRiskyXdeliveryInstanceProfile": {
      "Type": "AWS::IAM::InstanceProfile",
      "Properties": {
        "Path": "/",
        "Roles": [
          {
            "Ref": "XgemailRiskyXdeliveryInstanceRole"
          }
        ]
      }
    },
    "XgemailRiskyXdeliveryInstanceRole": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "ManagedPolicyArns": [
          "arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore"
        ],
        "AssumeRolePolicyDocument": {
          "Statement": [
            {
              "Action": [
                "sts:AssumeRole"
              ],
              "Effect": "Allow",
              "Principal": {
                "Service": [
                  "ec2.amazonaws.com"
                ]
              }
            }
          ]
        },
        "Path": "/",
        "Tags": [
          {
            "Key": "Application",
            "Value": "risky-xdelivery"
          },
          {
            "Key": "BusinessUnit",
            "Value": "MSG"
          },
          {
            "Key": "Name",
            "Value": { "Fn::Join": [ "-", [ { "Ref" : "AWS::StackName" }, "XgemailRiskyXdeliveryInstanceRole" ] ] }
          },
          {
            "Key": "Project",
            "Value": "xgemail"
          },
          {
            "Key": "OwnerEmail",
            "Value": "sophosmailops@sophos.com"
          }
        ]
      }
    },
    "XgemailRiskyXdeliveryInstanceRolePolicies": {
      "Type": "AWS::IAM::Policy",
      "Properties": {
        "PolicyDocument": {
          "Statement": [
            {
              "Action": [
                "autoscaling:UpdateAutoScalingGroup",
                "autoscaling:DescribeAutoScalingInstances"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action": [
                "ec2:AssociateAddress",
                "ec2:AttachVolume",
                "ec2:CreateSnapshot",
                "ec2:CreateTags",
                "ec2:CreateVolume",
                "ec2:DescribeAddresses",
                "ec2:DescribeImages",
                "ec2:DescribeInstanceAttribute",
                "ec2:DescribeInstances",
                "ec2:DescribeNatGateways",
                "ec2:DescribeNetworkInterfaces",
                "ec2:DescribeRouteTables",
                "ec2:DescribeSnapshots",
                "ec2:DescribeSubnets",
                "ec2:DescribeTags",
                "ec2:DescribeVolumes",
                "ec2:DescribeVpcs",
                "ec2:DetachVolume",
                "ec2:ModifyInstanceAttribute",
                "ec2:ModifySnapshotAttribute"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action": [
                "iam:GetRole"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action": [
                "kms:CreateGrant",
                "kms:Decrypt",
                "kms:DescribeKey",
                "kms:Encrypt",
                "kms:GenerateDataKey",
                "kms:GenerateDataKeyWithoutPlaintext",
                "kms:List*",
                "kms:ReEncrypt*",
                "kms:RevokeGrant"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action": [
                "logs:CreateLogGroup",
                "logs:CreateLogStream",
                "logs:DescribeLogGroups",
                "logs:DescribeLogStreams",
                "logs:DescribeMetricFilters",
                "logs:PutLogEvents"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action": [
                "s3:GetBucketLocation",
                "s3:ListBucket"
              ],
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::Join": [
                    "-",
                    [
                      "arn:aws:s3:::logs-sophos-msg",
                      {
                        "Ref": "Environment"
                      },
                      "*"
                    ]
                  ]
                }
              ]
            },
            {
              "Action": [
                "s3:PutObject"
              ],
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::Join": [
                    "/",
                    [
                      {
                        "Fn::Join": [
                          "-",
                          [
                            "arn:aws:s3:::logs-sophos-msg",
                            {
                              "Ref": "Environment"
                            },
                            "*"
                          ]
                        ]
                      },
                      "*"
                    ]
                  ]
                }
              ]
            },
            {
              "Action": [
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:PutObject",
                "s3:GetEncryptionConfiguration",
                "s3:AbortMultipartUpload",
                "s3:ListMultipartUploadParts",
                "s3:ListBucket",
                "s3:ListBucketMultipartUploads"
              ],
              "Resource": [
                { "Fn::Join" : ["-", ["arn:aws:s3:::cloud", { "Ref": "Environment" }, "ssm-session-logs/*"]]},
                { "Fn::Join" : ["-", ["arn:aws:s3:::cloud", { "Ref": "Environment" }, "ssm-session-logs" ]]}
              ],
              "Effect": "Allow"
            },
            {
              "Action": [
                "s3:DeleteObject",
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:PutObject"
              ],
              "Effect": "Allow",
              "Resource": [
                "arn:aws:s3:::cloud-*"
              ]
            },
            {
              "Action": [
                "sdb:BatchDeleteAttributes",
                "sdb:BatchPutAttributes",
                "sdb:CreateDomain",
                "sdb:DeleteAttributes",
                "sdb:DeleteDomain",
                "sdb:DomainMetadata",
                "sdb:GetAttributes",
                "sdb:ListDomains",
                "sdb:PutAttributes",
                "sdb:Select"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action": [
                "sns:ListSubscriptionsByTopic",
                "sns:ListTopics",
                "sns:Publish",
                "sns:Subscribe",
                "sns:Unsubscribe"
              ],
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::Join": [
                    ":",
                    [
                      "arn:aws:sns",
                      {
                        "Ref": "AWS::Region"
                      },
                      {
                        "Ref": "AWS::AccountId"
                      },
                      "*"
                    ]
                  ]
                }
              ]
            },
            {
              "Action": [
                "sqs:ChangeMessageVisibility",
                "sqs:CreateQueue",
                "sqs:DeleteMessage",
                "sqs:DeleteQueue",
                "sqs:GetQueueAttributes",
                "sqs:GetQueueUrl",
                "sqs:ListQueues",
                "sqs:SendMessage",
                "sqs:SetQueueAttributes",
                "sqs:ReceiveMessage"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action" : [
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:ListBucket",
                "s3:PutObject",
                "s3:RestoreObject"
              ],
              "Effect" : "Allow",
              "Resource" : [{ "Fn::Join" : ["", ["arn:aws:s3:::", { "Ref" : "MsgHistoryV2BucketName" }, "/*"]]},
                { "Fn::Join" : ["", ["arn:aws:s3:::", { "Ref" : "MsgHistoryV2BucketName" }]]}]
            },
            {
              "Action": [
                "dynamodb:BatchWriteItem",
                "dynamodb:DeleteItem",
                "dynamodb:BatchGetItem",
                "dynamodb:Scan",
                "dynamodb:ListTables",
                "dynamodb:GetItem",
                "dynamodb:GetRecords",
                "dynamodb:DescribeTable",
                "dynamodb:PutItem",
                "dynamodb:Query",
                "dynamodb:UpdateItem",
                "dynamodb:UpdateTable"
              ],
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::Sub": "arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${MsgHistoryV2DynamoDbTableName}"
                }
              ]
            },
            {
              "Action": [
                "firehose:DescribeDeliveryStream",
                "firehose:PutRecord",
                "firehose:PutRecordBatch"
              ],
              "Effect" : "Allow",
              "Resource": [
                {
                  "Fn::Sub": "arn:aws:firehose:${AWS::Region}:${AWS::AccountId}:deliverystream/${MsgHistoryV2StreamName}"
                }
              ]
            },
            {
              "Action": [
                "kinesis:DescribeStream",
                "kinesis:PutRecord",
                "kinesis:PutRecords"
              ],
              "Effect" : "Allow",
              "Resource": [
                {
                  "Fn::Sub": "arn:aws:kinesis:${AWS::Region}:${AWS::AccountId}:stream/${MsgHistoryDataStreamName}"
                }
              ]
            },
            {
              "Action": [
                "secretsmanager:ListSecrets"
              ],
              "Effect" : "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action": [
                "secretsmanager:GetResourcePolicy",
                "secretsmanager:GetSecretValue",
                "secretsmanager:DescribeSecret",
                "secretsmanager:ListSecretVersionIds"
              ],
              "Effect" : "Allow",
              "Resource": [
                {
                  "Fn::Sub": "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:/central/newrelic/license*"
                }
              ]
            }
          ]
        },
        "PolicyName": "root",
        "Roles": [
          {
            "Ref": "XgemailRiskyXdeliveryInstanceRole"
          }
        ]
      }
    },

    "XgemailWarmupDeliveryInstanceProfile": {
      "Type": "AWS::IAM::InstanceProfile",
      "Properties": {
        "Path": "/",
        "Roles": [
          {
            "Ref": "XgemailWarmupDeliveryInstanceRole"
          }
        ]
      }
    },
    "XgemailWarmupDeliveryInstanceRole": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "ManagedPolicyArns": [
          "arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore"
        ],
        "AssumeRolePolicyDocument": {
          "Statement": [
            {
              "Action": [
                "sts:AssumeRole"
              ],
              "Effect": "Allow",
              "Principal": {
                "Service": [
                  "ec2.amazonaws.com"
                ]
              }
            }
          ]
        },
        "Path": "/",
        "Tags": [
          {
            "Key": "Application",
            "Value": "warmup-delivery"
          },
          {
            "Key": "BusinessUnit",
            "Value": "MSG"
          },
          {
            "Key": "Name",
            "Value": { "Fn::Join": [ "-", [ { "Ref" : "AWS::StackName" }, "XgemailWarmupDeliveryInstanceRole" ] ] }
          },
          {
            "Key": "Project",
            "Value": "xgemail"
          },
          {
            "Key": "OwnerEmail",
            "Value": "sophosmailops@sophos.com"
          }
        ]
      }
    },
    "XgemailWarmupDeliveryInstanceRolePolicies": {
      "Type": "AWS::IAM::Policy",
      "Properties": {
        "PolicyDocument": {
          "Statement": [
            {
              "Action": [
                "autoscaling:CompleteLifecycleAction",
                "autoscaling:DescribeAutoScalingInstances",
                "autoscaling:DescribeLifecycleHooks",
                "autoscaling:RecordLifecycleActionHeartbeat",
                "autoscaling:UpdateAutoScalingGroup"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action": [
                "ec2:AssociateAddress",
                "ec2:AttachVolume",
                "ec2:CreateSnapshot",
                "ec2:CreateTags",
                "ec2:CreateVolume",
                "ec2:DeleteVolume",
                "ec2:DescribeAddresses",
                "ec2:DescribeImages",
                "ec2:DescribeInstanceAttribute",
                "ec2:DescribeInstances",
                "ec2:DescribeNatGateways",
                "ec2:DescribeNetworkInterfaces",
                "ec2:DescribeRouteTables",
                "ec2:DescribeSnapshots",
                "ec2:DescribeSubnets",
                "ec2:DescribeTags",
                "ec2:DescribeVolumes",
                "ec2:DescribeVpcs",
                "ec2:DetachVolume",
                "ec2:ModifyInstanceAttribute",
                "ec2:ModifySnapshotAttribute"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action": [
                "iam:GetRole"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action": [
                "kms:CreateGrant",
                "kms:Decrypt",
                "kms:DescribeKey",
                "kms:Encrypt",
                "kms:GenerateDataKey",
                "kms:GenerateDataKeyWithoutPlaintext",
                "kms:List*",
                "kms:ReEncrypt*",
                "kms:RevokeGrant"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action": [
                "logs:CreateLogGroup",
                "logs:CreateLogStream",
                "logs:DescribeLogGroups",
                "logs:DescribeLogStreams",
                "logs:DescribeMetricFilters",
                "logs:PutLogEvents"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action": [
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:ListBucket",
                "s3:PutObject",
                "s3:RestoreObject"
              ],
              "Effect": "Allow",
              "Resource": [
                { "Fn::Join": [ "", [ "arn:aws:s3:::", { "Ref": "XgemailMsgHistoryBucketName" }, "/*" ] ] },
                { "Fn::Join": [ "", [ "arn:aws:s3:::", { "Ref": "XgemailMsgHistoryBucketName" } ] ] } ]
            },
            {
              "Action": [
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:ListBucket",
                "s3:PutObject",
                "s3:RestoreObject"
              ],
              "Effect": "Allow",
              "Resource": [
                { "Fn::Join": [ "", [ "arn:aws:s3:::", { "Ref": "XgemailMsgHistoryMsBucketName" }, "/*" ] ] },
                { "Fn::Join": [ "", [ "arn:aws:s3:::", { "Ref": "XgemailMsgHistoryMsBucketName" } ] ] } ]
            },
            {
              "Action" : [
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:ListBucket",
                "s3:PutObject",
                "s3:RestoreObject"
              ],
              "Effect" : "Allow",
              "Resource" : [{ "Fn::Join" : ["", ["arn:aws:s3:::", { "Ref" : "MsgHistoryV2BucketName" }, "/*"]]},
                { "Fn::Join" : ["", ["arn:aws:s3:::", { "Ref" : "MsgHistoryV2BucketName" }]]}]
            },
            {
              "Action": [
                "s3:DeleteObject",
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:ListBucket"
              ],
              "Effect": "Allow",
              "Resource": [
                { "Fn::Join": [ "", [ "arn:aws:s3:::", { "Ref": "XgemailCustomerSubmitBucketName" }, "/*" ] ] },
                { "Fn::Join": [ "", [ "arn:aws:s3:::", { "Ref": "XgemailCustomerSubmitBucketName" } ] ] } ]
            },
            {
              "Action": [
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:ListBucket"
              ],
              "Effect": "Allow",
              "Resource": [
                { "Fn::Join": [ "", [ "arn:aws:s3:::", { "Ref": "XgemailPolicyBucketName" }, "/*" ] ] },
                { "Fn::Join": [ "", [ "arn:aws:s3:::", { "Ref": "XgemailPolicyBucketName" } ] ] }
              ]
            },
            {
              "Action": [
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:PutObject",
                "s3:GetEncryptionConfiguration",
                "s3:AbortMultipartUpload",
                "s3:ListMultipartUploadParts",
                "s3:ListBucket",
                "s3:ListBucketMultipartUploads"
              ],
              "Resource": [
                { "Fn::Join" : ["-", ["arn:aws:s3:::cloud", { "Ref": "Environment" }, "ssm-session-logs/*"]]},
                { "Fn::Join" : ["-", ["arn:aws:s3:::cloud", { "Ref": "Environment" }, "ssm-session-logs" ]]}
              ],
              "Effect": "Allow"
            },
            {
              "Action": [
                "s3:GetBucketLocation",
                "s3:ListBucket"
              ],
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::Join": [
                    "-",
                    [
                      "arn:aws:s3:::logs-sophos-msg",
                      {
                        "Ref": "Environment"
                      },
                      "*"
                    ]
                  ]
                }
              ]
            },
            {
              "Action": [
                "s3:PutObject"
              ],
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::Join": [
                    "/",
                    [
                      {
                        "Fn::Join": [
                          "-",
                          [
                            "arn:aws:s3:::logs-sophos-msg",
                            {
                              "Ref": "Environment"
                            },
                            "*"
                          ]
                        ]
                      },
                      "*"
                    ]
                  ]
                }
              ]
            },
            {
              "Action": [
                "s3:DeleteObject",
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:PutObject"
              ],
              "Effect": "Allow",
              "Resource": [
                "arn:aws:s3:::cloud-*"
              ]
            },
            {
              "Action": [
                "sns:ListSubscriptionsByTopic",
                "sns:ListTopics",
                "sns:Publish",
                "sns:Subscribe",
                "sns:Unsubscribe"
              ],
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::Join": [
                    ":",
                    [
                      "arn:aws:sns",
                      {
                        "Ref": "AWS::Region"
                      },
                      {
                        "Ref": "AWS::AccountId"
                      },
                      "*"
                    ]
                  ]
                }
              ]
            },
            {
              "Action": [
                "sqs:ChangeMessageVisibility",
                "sqs:CreateQueue",
                "sqs:DeleteMessage",
                "sqs:DeleteQueue",
                "sqs:GetQueueAttributes",
                "sqs:GetQueueUrl",
                "sqs:ListQueues",
                "sqs:SendMessage",
                "sqs:SetQueueAttributes",
                "sqs:ReceiveMessage"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action": [
                "firehose:DescribeDeliveryStream",
                "firehose:PutRecord",
                "firehose:PutRecordBatch"
              ],
              "Effect" : "Allow",
              "Resource": [
                {
                  "Fn::Join": [
                    ":",
                    [
                      "arn:aws:firehose",
                      { "Ref": "AWS::Region" },
                      { "Ref": "AWS::AccountId" },
                      {
                        "Fn::Join": [
                          "-",
                          [
                            "deliverystream/tf-e2e-latency-telemetry",
                            { "Ref": "AWS::Region" },
                            { "Ref": "Environment" },
                            "firehose"
                          ]
                        ]
                      }
                    ]
                  ]
                }
              ]
            },
            {
              "Action": [
                "dynamodb:BatchWriteItem",
                "dynamodb:DeleteItem",
                "dynamodb:BatchGetItem",
                "dynamodb:Scan",
                "dynamodb:ListTables",
                "dynamodb:GetItem",
                "dynamodb:GetRecords",
                "dynamodb:DescribeTable",
                "dynamodb:PutItem",
                "dynamodb:Query",
                "dynamodb:UpdateItem",
                "dynamodb:UpdateTable"
              ],
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::Sub": "arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${MsgHistoryV2DynamoDbTableName}"
                }
              ]
            },
            {
              "Action": [
                "firehose:DescribeDeliveryStream",
                "firehose:PutRecord",
                "firehose:PutRecordBatch"
              ],
              "Effect" : "Allow",
              "Resource": [
                {
                  "Fn::Sub": "arn:aws:firehose:${AWS::Region}:${AWS::AccountId}:deliverystream/${MsgHistoryV2StreamName}"
                }
              ]
            },
            {
              "Action": [
                "kinesis:DescribeStream",
                "kinesis:PutRecord",
                "kinesis:PutRecords"
              ],
              "Effect" : "Allow",
              "Resource": [
                {
                  "Fn::Sub": "arn:aws:kinesis:${AWS::Region}:${AWS::AccountId}:stream/${MsgHistoryDataStreamName}"
                }
              ]
            },
            {
              "Action": [
                "secretsmanager:ListSecrets"
              ],
              "Effect" : "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action": [
                "secretsmanager:GetResourcePolicy",
                "secretsmanager:GetSecretValue",
                "secretsmanager:DescribeSecret",
                "secretsmanager:ListSecretVersionIds"
              ],
              "Effect" : "Allow",
              "Resource": [
                {
                  "Fn::Sub": "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:/central/newrelic/license*"
                }
              ]
            }
          ]
        },
        "PolicyName": "root",
        "Roles": [
          {
            "Ref": "XgemailWarmupDeliveryInstanceRole"
          }
        ]
      }
    },

    "XgemailWarmupXdeliveryInstanceProfile": {
      "Type": "AWS::IAM::InstanceProfile",
      "Properties": {
        "Path": "/",
        "Roles": [
          {
            "Ref": "XgemailWarmupXdeliveryInstanceRole"
          }
        ]
      }
    },
    "XgemailWarmupXdeliveryInstanceRole": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "ManagedPolicyArns": [
          "arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore"
        ],
        "AssumeRolePolicyDocument": {
          "Statement": [
            {
              "Action": [
                "sts:AssumeRole"
              ],
              "Effect": "Allow",
              "Principal": {
                "Service": [
                  "ec2.amazonaws.com"
                ]
              }
            }
          ]
        },
        "Path": "/",
        "Tags": [
          {
            "Key": "Application",
            "Value": "warmup-xdelivery"
          },
          {
            "Key": "BusinessUnit",
            "Value": "MSG"
          },
          {
            "Key": "Name",
            "Value": { "Fn::Join": [ "-", [ { "Ref" : "AWS::StackName" }, "XgemailWarmupXdeliveryInstanceRole" ] ] }
          },
          {
            "Key": "Project",
            "Value": "xgemail"
          },
          {
            "Key": "OwnerEmail",
            "Value": "sophosmailops@sophos.com"
          }
        ]
      }
    },
    "XgemailWarmupXdeliveryInstanceRolePolicies": {
      "Type": "AWS::IAM::Policy",
      "Properties": {
        "PolicyDocument": {
          "Statement": [
            {
              "Action": [
                "autoscaling:UpdateAutoScalingGroup",
                "autoscaling:DescribeAutoScalingInstances"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action": [
                "ec2:AssociateAddress",
                "ec2:AttachVolume",
                "ec2:CreateSnapshot",
                "ec2:CreateTags",
                "ec2:CreateVolume",
                "ec2:DescribeAddresses",
                "ec2:DescribeImages",
                "ec2:DescribeInstanceAttribute",
                "ec2:DescribeInstances",
                "ec2:DescribeNatGateways",
                "ec2:DescribeNetworkInterfaces",
                "ec2:DescribeRouteTables",
                "ec2:DescribeSnapshots",
                "ec2:DescribeSubnets",
                "ec2:DescribeTags",
                "ec2:DescribeVolumes",
                "ec2:DescribeVpcs",
                "ec2:DetachVolume",
                "ec2:ModifyInstanceAttribute",
                "ec2:ModifySnapshotAttribute"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action": [
                "iam:GetRole"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action": [
                "kms:CreateGrant",
                "kms:Decrypt",
                "kms:DescribeKey",
                "kms:Encrypt",
                "kms:GenerateDataKey",
                "kms:GenerateDataKeyWithoutPlaintext",
                "kms:List*",
                "kms:ReEncrypt*",
                "kms:RevokeGrant"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action": [
                "logs:CreateLogGroup",
                "logs:CreateLogStream",
                "logs:DescribeLogGroups",
                "logs:DescribeLogStreams",
                "logs:DescribeMetricFilters",
                "logs:PutLogEvents"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action": [
                "s3:GetBucketLocation",
                "s3:ListBucket"
              ],
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::Join": [
                    "-",
                    [
                      "arn:aws:s3:::logs-sophos-msg",
                      {
                        "Ref": "Environment"
                      },
                      "*"
                    ]
                  ]
                }
              ]
            },
            {
              "Action": [
                "s3:PutObject"
              ],
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::Join": [
                    "/",
                    [
                      {
                        "Fn::Join": [
                          "-",
                          [
                            "arn:aws:s3:::logs-sophos-msg",
                            {
                              "Ref": "Environment"
                            },
                            "*"
                          ]
                        ]
                      },
                      "*"
                    ]
                  ]
                }
              ]
            },
            {
              "Action": [
                "s3:DeleteObject",
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:PutObject"
              ],
              "Effect": "Allow",
              "Resource": [
                "arn:aws:s3:::cloud-*"
              ]
            },
            {
              "Action": [
                "sdb:BatchDeleteAttributes",
                "sdb:BatchPutAttributes",
                "sdb:CreateDomain",
                "sdb:DeleteAttributes",
                "sdb:DeleteDomain",
                "sdb:DomainMetadata",
                "sdb:GetAttributes",
                "sdb:ListDomains",
                "sdb:PutAttributes",
                "sdb:Select"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action": [
                "sns:ListSubscriptionsByTopic",
                "sns:ListTopics",
                "sns:Publish",
                "sns:Subscribe",
                "sns:Unsubscribe"
              ],
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::Join": [
                    ":",
                    [
                      "arn:aws:sns",
                      {
                        "Ref": "AWS::Region"
                      },
                      {
                        "Ref": "AWS::AccountId"
                      },
                      "*"
                    ]
                  ]
                }
              ]
            },
            {
              "Action": [
                "sqs:ChangeMessageVisibility",
                "sqs:CreateQueue",
                "sqs:DeleteMessage",
                "sqs:DeleteQueue",
                "sqs:GetQueueAttributes",
                "sqs:GetQueueUrl",
                "sqs:ListQueues",
                "sqs:SendMessage",
                "sqs:SetQueueAttributes",
                "sqs:ReceiveMessage"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action" : [
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:ListBucket",
                "s3:PutObject",
                "s3:RestoreObject"
              ],
              "Effect" : "Allow",
              "Resource" : [{ "Fn::Join" : ["", ["arn:aws:s3:::", { "Ref" : "MsgHistoryV2BucketName" }, "/*"]]},
                { "Fn::Join" : ["", ["arn:aws:s3:::", { "Ref" : "MsgHistoryV2BucketName" }]]}]
            },
            {
              "Action": [
                "dynamodb:BatchWriteItem",
                "dynamodb:DeleteItem",
                "dynamodb:BatchGetItem",
                "dynamodb:Scan",
                "dynamodb:ListTables",
                "dynamodb:GetItem",
                "dynamodb:GetRecords",
                "dynamodb:DescribeTable",
                "dynamodb:PutItem",
                "dynamodb:Query",
                "dynamodb:UpdateItem",
                "dynamodb:UpdateTable"
              ],
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::Sub": "arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${MsgHistoryV2DynamoDbTableName}"
                }
              ]
            },
            {
              "Action": [
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:PutObject",
                "s3:GetEncryptionConfiguration",
                "s3:AbortMultipartUpload",
                "s3:ListMultipartUploadParts",
                "s3:ListBucket",
                "s3:ListBucketMultipartUploads"
              ],
              "Resource": [
                { "Fn::Join" : ["-", ["arn:aws:s3:::cloud", { "Ref": "Environment" }, "ssm-session-logs/*"]]},
                { "Fn::Join" : ["-", ["arn:aws:s3:::cloud", { "Ref": "Environment" }, "ssm-session-logs" ]]}
              ],
              "Effect": "Allow"
            },
            {
              "Action": [
                "firehose:DescribeDeliveryStream",
                "firehose:PutRecord",
                "firehose:PutRecordBatch"
              ],
              "Effect" : "Allow",
              "Resource": [
                {
                  "Fn::Sub": "arn:aws:firehose:${AWS::Region}:${AWS::AccountId}:deliverystream/${MsgHistoryV2StreamName}"
                }
              ]
            },
            {
              "Action": [
                "kinesis:DescribeStream",
                "kinesis:PutRecord",
                "kinesis:PutRecords"
              ],
              "Effect" : "Allow",
              "Resource": [
                {
                  "Fn::Sub": "arn:aws:kinesis:${AWS::Region}:${AWS::AccountId}:stream/${MsgHistoryDataStreamName}"
                }
              ]
            },
            {
              "Action": [
                "secretsmanager:ListSecrets"
              ],
              "Effect" : "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action": [
                "secretsmanager:GetResourcePolicy",
                "secretsmanager:GetSecretValue",
                "secretsmanager:DescribeSecret",
                "secretsmanager:ListSecretVersionIds"
              ],
              "Effect" : "Allow",
              "Resource": [
                {
                  "Fn::Sub": "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:/central/newrelic/license*"
                }
              ]
            }
          ]
        },
        "PolicyName": "root",
        "Roles": [
          {
            "Ref": "XgemailWarmupXdeliveryInstanceRole"
          }
        ]
      }
    },

    "XgemailDeltaDeliveryInstanceProfile": {
      "Type": "AWS::IAM::InstanceProfile",
      "Properties": {
        "Path": "/",
        "Roles": [
          {
            "Ref": "XgemailDeltaDeliveryInstanceRole"
          }
        ]
      }
    },
    "XgemailDeltaDeliveryInstanceRole": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "ManagedPolicyArns": [
          "arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore"
        ],
        "AssumeRolePolicyDocument": {
          "Statement": [
            {
              "Action": [
                "sts:AssumeRole"
              ],
              "Effect": "Allow",
              "Principal": {
                "Service": [
                  "ec2.amazonaws.com"
                ]
              }
            }
          ]
        },
        "Path": "/",
        "Tags": [
          {
            "Key": "Application",
            "Value": "delta-delivery"
          },
          {
            "Key": "BusinessUnit",
            "Value": "MSG"
          },
          {
            "Key": "Name",
            "Value": { "Fn::Join": [ "-", [ { "Ref" : "AWS::StackName" }, "XgemailDeltaDeliveryInstanceRole" ] ] }
          },
          {
            "Key": "Project",
            "Value": "xgemail"
          },
          {
            "Key": "OwnerEmail",
            "Value": "sophosmailops@sophos.com"
          }
        ]
      }
    },
    "XgemailDeltaDeliveryInstanceRolePolicies": {
      "Type": "AWS::IAM::Policy",
      "Properties": {
        "PolicyDocument": {
          "Statement": [
            {
              "Action": [
                "autoscaling:CompleteLifecycleAction",
                "autoscaling:DescribeAutoScalingInstances",
                "autoscaling:DescribeLifecycleHooks",
                "autoscaling:RecordLifecycleActionHeartbeat",
                "autoscaling:UpdateAutoScalingGroup"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action": [
                "ec2:AssociateAddress",
                "ec2:AttachVolume",
                "ec2:CreateSnapshot",
                "ec2:CreateTags",
                "ec2:CreateVolume",
                "ec2:DeleteVolume",
                "ec2:DescribeAddresses",
                "ec2:DescribeImages",
                "ec2:DescribeInstanceAttribute",
                "ec2:DescribeInstances",
                "ec2:DescribeNatGateways",
                "ec2:DescribeNetworkInterfaces",
                "ec2:DescribeRouteTables",
                "ec2:DescribeSnapshots",
                "ec2:DescribeSubnets",
                "ec2:DescribeTags",
                "ec2:DescribeVolumes",
                "ec2:DescribeVpcs",
                "ec2:DetachVolume",
                "ec2:ModifyInstanceAttribute",
                "ec2:ModifySnapshotAttribute"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action": [
                "iam:GetRole"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action": [
                "kms:CreateGrant",
                "kms:Decrypt",
                "kms:DescribeKey",
                "kms:Encrypt",
                "kms:GenerateDataKey",
                "kms:GenerateDataKeyWithoutPlaintext",
                "kms:List*",
                "kms:ReEncrypt*",
                "kms:RevokeGrant"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action": [
                "logs:CreateLogGroup",
                "logs:CreateLogStream",
                "logs:DescribeLogGroups",
                "logs:DescribeLogStreams",
                "logs:DescribeMetricFilters",
                "logs:PutLogEvents"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action": [
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:ListBucket",
                "s3:PutObject",
                "s3:RestoreObject"
              ],
              "Effect": "Allow",
              "Resource": [
                { "Fn::Join": [ "", [ "arn:aws:s3:::", { "Ref": "XgemailMsgHistoryBucketName" }, "/*" ] ] },
                { "Fn::Join": [ "", [ "arn:aws:s3:::", { "Ref": "XgemailMsgHistoryBucketName" } ] ] } ]
            },
            {
              "Action": [
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:ListBucket",
                "s3:PutObject",
                "s3:RestoreObject"
              ],
              "Effect": "Allow",
              "Resource": [
                { "Fn::Join": [ "", [ "arn:aws:s3:::", { "Ref": "XgemailMsgHistoryMsBucketName" }, "/*" ] ] },
                { "Fn::Join": [ "", [ "arn:aws:s3:::", { "Ref": "XgemailMsgHistoryMsBucketName" } ] ] } ]
            },
            {
              "Action" : [
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:ListBucket",
                "s3:PutObject",
                "s3:RestoreObject"
              ],
              "Effect" : "Allow",
              "Resource" : [{ "Fn::Join" : ["", ["arn:aws:s3:::", { "Ref" : "MsgHistoryV2BucketName" }, "/*"]]},
                { "Fn::Join" : ["", ["arn:aws:s3:::", { "Ref" : "MsgHistoryV2BucketName" }]]}]
            },
            {
              "Action": [
                "s3:DeleteObject",
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:ListBucket"
              ],
              "Effect": "Allow",
              "Resource": [
                { "Fn::Join": [ "", [ "arn:aws:s3:::", { "Ref": "XgemailCustomerSubmitBucketName" }, "/*" ] ] },
                { "Fn::Join": [ "", [ "arn:aws:s3:::", {"Ref": "XgemailCustomerSubmitBucketName" } ] ] } ]
            },
            {
              "Action": [
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:ListBucket"
              ],
              "Effect": "Allow",
              "Resource": [
                { "Fn::Join": [ "", [ "arn:aws:s3:::", { "Ref": "XgemailPolicyBucketName" }, "/*" ] ] },
                { "Fn::Join": [ "", [ "arn:aws:s3:::", { "Ref": "XgemailPolicyBucketName" } ] ] }
              ]
            },
            {
              "Action": [
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:PutObject",
                "s3:GetEncryptionConfiguration",
                "s3:AbortMultipartUpload",
                "s3:ListMultipartUploadParts",
                "s3:ListBucket",
                "s3:ListBucketMultipartUploads"
              ],
              "Resource": [
                { "Fn::Join" : ["-", ["arn:aws:s3:::cloud", { "Ref": "Environment" }, "ssm-session-logs/*"]]},
                { "Fn::Join" : ["-", ["arn:aws:s3:::cloud", { "Ref": "Environment" }, "ssm-session-logs" ]]}
              ],
              "Effect": "Allow"
            },
            {
              "Action": [
                "s3:GetBucketLocation",
                "s3:ListBucket"
              ],
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::Join": [
                    "-",
                    [
                      "arn:aws:s3:::logs-sophos-msg",
                      {
                        "Ref": "Environment"
                      },
                      "*"
                    ]
                  ]
                }
              ]
            },
            {
              "Action": [
                "s3:PutObject"
              ],
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::Join": [
                    "/",
                    [
                      {
                        "Fn::Join": [
                          "-",
                          [
                            "arn:aws:s3:::logs-sophos-msg",
                            {
                              "Ref": "Environment"
                            },
                            "*"
                          ]
                        ]
                      },
                      "*"
                    ]
                  ]
                }
              ]
            },
            {
              "Action": [
                "s3:DeleteObject",
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:PutObject"
              ],
              "Effect": "Allow",
              "Resource": [
                "arn:aws:s3:::cloud-*"
              ]
            },
            {
              "Action": [
                "sns:ListSubscriptionsByTopic",
                "sns:ListTopics",
                "sns:Publish",
                "sns:Subscribe",
                "sns:Unsubscribe"
              ],
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::Join": [
                    ":",
                    [
                      "arn:aws:sns",
                      {
                        "Ref": "AWS::Region"
                      },
                      {
                        "Ref": "AWS::AccountId"
                      },
                      "*"
                    ]
                  ]
                }
              ]
            },
            {
              "Action": [
                "sqs:ChangeMessageVisibility",
                "sqs:CreateQueue",
                "sqs:DeleteMessage",
                "sqs:DeleteQueue",
                "sqs:GetQueueAttributes",
                "sqs:GetQueueUrl",
                "sqs:ListQueues",
                "sqs:SendMessage",
                "sqs:SetQueueAttributes",
                "sqs:ReceiveMessage"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action": [
                "firehose:DescribeDeliveryStream",
                "firehose:PutRecord",
                "firehose:PutRecordBatch"
              ],
              "Effect" : "Allow",
              "Resource": [
                {
                  "Fn::Join": [
                    ":",
                    [
                      "arn:aws:firehose",
                      { "Ref": "AWS::Region" },
                      { "Ref": "AWS::AccountId" },
                      {
                        "Fn::Join": [
                          "-",
                          [
                            "deliverystream/tf-e2e-latency-telemetry",
                            { "Ref": "AWS::Region" },
                            { "Ref": "Environment" },
                            "firehose"
                          ]
                        ]
                      }
                    ]
                  ]
                }
              ]
            },
            {
              "Action": [
                "dynamodb:BatchWriteItem",
                "dynamodb:DeleteItem",
                "dynamodb:BatchGetItem",
                "dynamodb:Scan",
                "dynamodb:ListTables",
                "dynamodb:GetItem",
                "dynamodb:GetRecords",
                "dynamodb:DescribeTable",
                "dynamodb:PutItem",
                "dynamodb:Query",
                "dynamodb:UpdateItem",
                "dynamodb:UpdateTable"
              ],
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::Sub": "arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${MsgHistoryV2DynamoDbTableName}"
                }
              ]
            },
            {
              "Action": [
                "firehose:DescribeDeliveryStream",
                "firehose:PutRecord",
                "firehose:PutRecordBatch"
              ],
              "Effect" : "Allow",
              "Resource": [
                {
                  "Fn::Sub": "arn:aws:firehose:${AWS::Region}:${AWS::AccountId}:deliverystream/${MsgHistoryV2StreamName}"
                }
              ]
            },
            {
              "Action": [
                "kinesis:DescribeStream",
                "kinesis:PutRecord",
                "kinesis:PutRecords"
              ],
              "Effect" : "Allow",
              "Resource": [
                {
                  "Fn::Sub": "arn:aws:kinesis:${AWS::Region}:${AWS::AccountId}:stream/${MsgHistoryDataStreamName}"
                }
              ]
            },
            {
              "Action": [
                "secretsmanager:ListSecrets"
              ],
              "Effect" : "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action": [
                "secretsmanager:GetResourcePolicy",
                "secretsmanager:GetSecretValue",
                "secretsmanager:DescribeSecret",
                "secretsmanager:ListSecretVersionIds"
              ],
              "Effect" : "Allow",
              "Resource": [
                {
                  "Fn::Sub": "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:/central/newrelic/license*"
                }
              ]
            }
          ]
        },
        "PolicyName": "root",
        "Roles": [
          {
            "Ref": "XgemailDeltaDeliveryInstanceRole"
          }
        ]
      }
    },

    "XgemailDeltaXdeliveryInstanceProfile": {
      "Type": "AWS::IAM::InstanceProfile",
      "Properties": {
        "Path": "/",
        "Roles": [
          {
            "Ref": "XgemailDeltaXdeliveryInstanceRole"
          }
        ]
      }
    },
    "XgemailDeltaXdeliveryInstanceRole": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "ManagedPolicyArns": [
          "arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore"
        ],
        "AssumeRolePolicyDocument": {
          "Statement": [
            {
              "Action": [
                "sts:AssumeRole"
              ],
              "Effect": "Allow",
              "Principal": {
                "Service": [
                  "ec2.amazonaws.com"
                ]
              }
            }
          ]
        },
        "Path": "/",
        "Tags": [
          {
            "Key": "Application",
            "Value": "delta-xdelivery"
          },
          {
            "Key": "BusinessUnit",
            "Value": "MSG"
          },
          {
            "Key": "Name",
            "Value": { "Fn::Join": [ "-", [ { "Ref" : "AWS::StackName" }, "XgemailDeltaXdeliveryInstanceRole" ] ] }
          },
          {
            "Key": "Project",
            "Value": "xgemail"
          },
          {
            "Key": "OwnerEmail",
            "Value": "sophosmailops@sophos.com"
          }
        ]
      }
    },
    "XgemailDeltaXdeliveryInstanceRolePolicies": {
      "Type": "AWS::IAM::Policy",
      "Properties": {
        "PolicyDocument": {
          "Statement": [
            {
              "Action": [
                "autoscaling:UpdateAutoScalingGroup",
                "autoscaling:DescribeAutoScalingInstances"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action": [
                "ec2:AssociateAddress",
                "ec2:AttachVolume",
                "ec2:CreateSnapshot",
                "ec2:CreateTags",
                "ec2:CreateVolume",
                "ec2:DescribeAddresses",
                "ec2:DescribeImages",
                "ec2:DescribeInstanceAttribute",
                "ec2:DescribeInstances",
                "ec2:DescribeNatGateways",
                "ec2:DescribeNetworkInterfaces",
                "ec2:DescribeRouteTables",
                "ec2:DescribeSnapshots",
                "ec2:DescribeSubnets",
                "ec2:DescribeTags",
                "ec2:DescribeVolumes",
                "ec2:DescribeVpcs",
                "ec2:DetachVolume",
                "ec2:ModifyInstanceAttribute",
                "ec2:ModifySnapshotAttribute"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action": [
                "iam:GetRole"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action": [
                "kms:CreateGrant",
                "kms:Decrypt",
                "kms:DescribeKey",
                "kms:Encrypt",
                "kms:GenerateDataKey",
                "kms:GenerateDataKeyWithoutPlaintext",
                "kms:List*",
                "kms:ReEncrypt*",
                "kms:RevokeGrant"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action": [
                "logs:CreateLogGroup",
                "logs:CreateLogStream",
                "logs:DescribeLogGroups",
                "logs:DescribeLogStreams",
                "logs:DescribeMetricFilters",
                "logs:PutLogEvents"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action": [
                "s3:GetBucketLocation",
                "s3:ListBucket"
              ],
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::Join": [
                    "-",
                    [
                      "arn:aws:s3:::logs-sophos-msg",
                      {
                        "Ref": "Environment"
                      },
                      "*"
                    ]
                  ]
                }
              ]
            },
            {
              "Action": [
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:PutObject",
                "s3:GetEncryptionConfiguration",
                "s3:AbortMultipartUpload",
                "s3:ListMultipartUploadParts",
                "s3:ListBucket",
                "s3:ListBucketMultipartUploads"
              ],
              "Resource": [
                { "Fn::Join" : ["-", ["arn:aws:s3:::cloud", { "Ref": "Environment" }, "ssm-session-logs/*"]]},
                { "Fn::Join" : ["-", ["arn:aws:s3:::cloud", { "Ref": "Environment" }, "ssm-session-logs" ]]}
              ],
              "Effect": "Allow"
            },
            {
              "Action": [
                "s3:PutObject"
              ],
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::Join": [
                    "/",
                    [
                      {
                        "Fn::Join": [
                          "-",
                          [
                            "arn:aws:s3:::logs-sophos-msg",
                            {
                              "Ref": "Environment"
                            },
                            "*"
                          ]
                        ]
                      },
                      "*"
                    ]
                  ]
                }
              ]
            },
            {
              "Action": [
                "s3:DeleteObject",
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:PutObject"
              ],
              "Effect": "Allow",
              "Resource": [
                "arn:aws:s3:::cloud-*"
              ]
            },
            {
              "Action": [
                "sdb:BatchDeleteAttributes",
                "sdb:BatchPutAttributes",
                "sdb:CreateDomain",
                "sdb:DeleteAttributes",
                "sdb:DeleteDomain",
                "sdb:DomainMetadata",
                "sdb:GetAttributes",
                "sdb:ListDomains",
                "sdb:PutAttributes",
                "sdb:Select"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action": [
                "sns:ListSubscriptionsByTopic",
                "sns:ListTopics",
                "sns:Publish",
                "sns:Subscribe",
                "sns:Unsubscribe"
              ],
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::Join": [
                    ":",
                    [
                      "arn:aws:sns",
                      {
                        "Ref": "AWS::Region"
                      },
                      {
                        "Ref": "AWS::AccountId"
                      },
                      "*"
                    ]
                  ]
                }
              ]
            },
            {
              "Action": [
                "sqs:ChangeMessageVisibility",
                "sqs:CreateQueue",
                "sqs:DeleteMessage",
                "sqs:DeleteQueue",
                "sqs:GetQueueAttributes",
                "sqs:GetQueueUrl",
                "sqs:ListQueues",
                "sqs:SendMessage",
                "sqs:SetQueueAttributes",
                "sqs:ReceiveMessage"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action" : [
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:ListBucket",
                "s3:PutObject",
                "s3:RestoreObject"
              ],
              "Effect" : "Allow",
              "Resource" : [{ "Fn::Join" : ["", ["arn:aws:s3:::", { "Ref" : "MsgHistoryV2BucketName" }, "/*"]]},
                { "Fn::Join" : ["", ["arn:aws:s3:::", { "Ref" : "MsgHistoryV2BucketName" }]]}]
            },
            {
              "Action": [
                "dynamodb:BatchWriteItem",
                "dynamodb:DeleteItem",
                "dynamodb:BatchGetItem",
                "dynamodb:Scan",
                "dynamodb:ListTables",
                "dynamodb:GetItem",
                "dynamodb:GetRecords",
                "dynamodb:DescribeTable",
                "dynamodb:PutItem",
                "dynamodb:Query",
                "dynamodb:UpdateItem",
                "dynamodb:UpdateTable"
              ],
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::Sub": "arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${MsgHistoryV2DynamoDbTableName}"
                }
              ]
            },
            {
              "Action": [
                "firehose:DescribeDeliveryStream",
                "firehose:PutRecord",
                "firehose:PutRecordBatch"
              ],
              "Effect" : "Allow",
              "Resource": [
                {
                  "Fn::Sub": "arn:aws:firehose:${AWS::Region}:${AWS::AccountId}:deliverystream/${MsgHistoryV2StreamName}"
                }
              ]
            },
            {
              "Action": [
                "kinesis:DescribeStream",
                "kinesis:PutRecord",
                "kinesis:PutRecords"
              ],
              "Effect" : "Allow",
              "Resource": [
                {
                  "Fn::Sub": "arn:aws:kinesis:${AWS::Region}:${AWS::AccountId}:stream/${MsgHistoryDataStreamName}"
                }
              ]
            },
            {
              "Action": [
                "secretsmanager:ListSecrets"
              ],
              "Effect" : "Allow",
              "Resource": [
                "*"
              ]
            },
            {
              "Action": [
                "secretsmanager:GetResourcePolicy",
                "secretsmanager:GetSecretValue",
                "secretsmanager:DescribeSecret",
                "secretsmanager:ListSecretVersionIds"
              ],
              "Effect" : "Allow",
              "Resource": [
                {
                  "Fn::Sub": "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:/central/newrelic/license*"
                }
              ]
            }
          ]
        },
        "PolicyName": "root",
        "Roles": [
          {
            "Ref": "XgemailDeltaXdeliveryInstanceRole"
          }
        ]
      }
    },
    "XgemailDevMsgFilterRole" : {
      "Type": "AWS::IAM::Role",
      "Condition": "isPreProd",
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Statement": [
            {
              "Action": [
                "sts:AssumeRole"
              ],
              "Effect": "Allow",
              "Principal": {
                "AWS": [
                  "arn:aws:iam::792368871298:role/MSG-Filter-Role",
                  "arn:aws:iam::792368871298:role/MSG-Filter-CFT-Role",
                  "arn:aws:sts::792368871298:assumed-role/MSG-Filter-CFT-Role/AWSCloudFormation"
                ]
              }
            }
          ]
        },
        "Path": "/",
        "RoleName": "MSG-Filter-Role",
        "Tags": [
          {
            "Key": "Application",
            "Value": "msg-filter-role"
          },
          {
            "Key": "Name",
            "Value": "msg-filter-role"
          },
          {
            "Key": "BusinessUnit",
            "Value": "MSG"
          },
          {
            "Key": "Project",
            "Value": "xgemail"
          },
          {
            "Key": "OwnerEmail",
            "Value": "sophosmailops@sophos.com"
          }
        ]
      }
    },
    "XgemailDevMsgFilterRolePolicies": {
      "Type": "AWS::IAM::Policy",
      "Condition": "isPreProd",
      "Properties": {
        "PolicyDocument": {
          "Statement": [
            {
              "Action": [
                "s3:List*",
                "s3:Get*"
              ],
              "Effect": "Allow",
              "Resource": "arn:aws:s3:::telemetry-dev-eu-west-1-cloudstation"
            }
          ]
        },
        "PolicyName": "telemetry-dev-s3-ro-access",
        "Roles": [
          {
            "Ref": "XgemailDevMsgFilterRole"
          }
        ]
      }
    },
    "XgemailProdMsgFilterRole" : {
      "Type": "AWS::IAM::Role",
      "Condition": "isProd",
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Statement": [
            {
              "Action": [
                "sts:AssumeRole"
              ],
              "Effect": "Allow",
              "Principal": {
                "AWS": [
                  "arn:aws:iam::872445321290:role/MSG-Filter-Role",
                  "arn:aws:iam::872445321290:role/MSG-Filter-CFT-Role",
                  "arn:aws:iam::792368871298:role/MSG-Filter-CFT-Role",
                  "arn:aws:sts::872445321290:assumed-role/MSG-Filter-CFT-Role/AWSCloudFormation"
                ]
              }
            }
          ]
        },
        "Path": "/",
        "RoleName": "MSG-Filter-Role",
        "Tags": [
          {
            "Key": "Application",
            "Value": "msg-filter-role"
          },
          {
            "Key": "Name",
            "Value": "msg-filter-role"
          },
          {
            "Key": "BusinessUnit",
            "Value": "MSG"
          },
          {
            "Key": "Project",
            "Value": "xgemail"
          },
          {
            "Key": "OwnerEmail",
            "Value": "sophosmailops@sophos.com"
          }
        ]
      }
    },
    "XgemailProdMsgFilterRolePolicies": {
      "Type": "AWS::IAM::Policy",
      "Condition": "isProd",
      "Properties": {
        "PolicyDocument": {
          "Statement": [
            {
              "Action": [
                "s3:List*",
                "s3:Get*"
              ],
              "Effect": "Allow",
              "Resource": [
                "arn:aws:s3:::telemetry-prod-*"
              ]
            }
          ]
        },
        "PolicyName": "telemetry-prod-s3-ro-access",
        "Roles": [
          {
            "Ref": "XgemailProdMsgFilterRole"
          }
        ]
      }
    }
  },

  "Outputs": {
    "AutoScalingInstanceRole": {
      "Description": "AutoScaling instance role",
      "Value": { "Ref": "AutoScalingInstanceRole" }
    },
    "AutoScalingInstanceRoleArn": {
      "Description": "AutoScaling instance role ARN",
      "Value": { "Fn::GetAtt" : [ "AutoScalingInstanceRole", "Arn" ] }
    },
    "BastionInstanceProfile": {
      "Description": "Bastion instance profile",
      "Value": { "Ref": "BastionInstanceProfile" }
    },
    "BastionInstanceRole": {
      "Description": "Bastion instance role",
      "Value": { "Ref": "BastionInstanceRole" }
    },
    "BastionInstanceRoleArn": {
      "Description": "Bastion instance role ARN",
      "Value": { "Fn::GetAtt" : [ "BastionInstanceRole", "Arn" ] }
    },
    "EipMonitorLambdaExecutionRole": {
      "Description": "Eip Monitor Lambda Execution role",
      "Value": { "Ref": "EipMonitorLambdaExecutionRole" }
    },
    "EipMonitorLambdaExecutionRoleArn": {
      "Description": "Eip Monitor Lambda Execution role ARN",
      "Value": { "Fn::GetAtt" : [ "EipMonitorLambdaExecutionRole", "Arn" ] }
    },
    "EipRotationLambdaExecutionRole": {
      "Description": "Eip Rotation Lambda Execution role",
      "Value": { "Ref": "EipRotationLambdaExecutionRole" }
    },
    "EipRotationLambdaExecutionRoleArn": {
      "Description": "Eip Rotation Lambda Execution role ARN",
      "Value": { "Fn::GetAtt" : [ "EipRotationLambdaExecutionRole", "Arn" ] }
    },
    "MultiEipRotationLambdaExecutionRole": {
      "Description": "Multi Eip Rotation Lambda Execution role",
      "Value": { "Ref": "MultiEipRotationLambdaExecutionRole" }
    },
    "MultiEipRotationLambdaExecutionRoleArn": {
      "Description": "Multi Eip Rotation Lambda Execution role ARN",
      "Value": { "Fn::GetAtt" : [ "MultiEipRotationLambdaExecutionRole", "Arn" ] }
    },
    "MfElbO365IpSyncLambdaExecutionRole": {
      "Description": "Mf Elb O365 Ip Sync Lambda Execution role",
      "Value": { "Ref": "MfElbO365IpSyncLambdaExecutionRole" }
    },
    "MfElbO365IpSyncLambdaExecutionRoleArn": {
      "Description": "Mf Elb O365 Ip Sync Lambda Execution role ARN",
      "Value": { "Fn::GetAtt" : [ "MfElbO365IpSyncLambdaExecutionRole", "Arn" ] }
    },
    "FirehoseTransformationLambdaExecutionRole": {
      "Description": "Firehose Transformation Lambda Execution role",
      "Value": { "Ref": "FirehoseTransformationLambdaExecutionRole" }
    },
    "FirehoseTransformationLambdaExecutionRoleArn": {
      "Description": "Firehose Transformation Lambda Execution role ARN",
      "Value": { "Fn::GetAtt" : [ "FirehoseTransformationLambdaExecutionRole", "Arn" ] }
    },
    "LogicMonitorInstanceProfile": {
      "Description": "Profile for logic monitor collectors to do their job",
      "Value": { "Ref": "LogicMonitorInstanceProfile" }
    },
    "LogicMonitorInstanceRole": {
      "Description": "LogicMonitor instance role",
      "Value": { "Ref": "LogicMonitorInstanceRole" }
    },
    "LogicMonitorInstanceRoleArn": {
      "Description": "LogicMonitor instance role ARN",
      "Value": { "Fn::GetAtt" : [ "LogicMonitorInstanceRole", "Arn" ] }
    },
    "XgemailCustomerDeliveryInstanceProfile": {
      "Description": "XGEMAIL Customer Delivery instance profile",
      "Value": { "Ref": "XgemailCustomerDeliveryInstanceProfile" }
    },
    "XgemailCustomerDeliveryInstanceRole": {
      "Description": "XGEMAIL Customer Delivery instance role",
      "Value": { "Ref": "XgemailCustomerDeliveryInstanceRole" }
    },
    "XgemailCustomerDeliveryInstanceRoleArn": {
      "Description": "XGEMAIL Customer Delivery instance role ARN",
      "Value": { "Fn::GetAtt" : [ "XgemailCustomerDeliveryInstanceRole", "Arn" ] }
    },
    "XgemailMfInboundDeliveryInstanceProfile": {
      "Description": "XGEMAIL Mf Inbound Delivery instance profile",
      "Value": { "Ref": "XgemailMfInboundDeliveryInstanceProfile" }
    },
    "XgemailMfInboundDeliveryInstanceRole": {
      "Description": "XGEMAIL Mf Inbound Delivery instance role",
      "Value": { "Ref": "XgemailMfInboundDeliveryInstanceRole" }
    },
    "XgemailMfInboundDeliveryInstanceRoleArn": {
      "Description": "XGEMAIL Mf Inbound Delivery instance role ARN",
      "Value": { "Fn::GetAtt" : [ "XgemailMfInboundDeliveryInstanceRole", "Arn" ] }
    },
    "XgemailXdeliveryInstanceProfile": {
      "Description": "XGEMAIL Xdelivery instance profile",
      "Value": { "Ref": "XgemailXdeliveryInstanceProfile" }
    },
    "XgemailXdeliveryInstanceRole": {
      "Description": "XGEMAIL Xdelivery instance role",
      "Value": { "Ref": "XgemailXdeliveryInstanceRole" }
    },
    "XgemailXdeliveryInstanceRoleArn": {
      "Description": "XGEMAIL Xdelivery instance role ARN",
      "Value": { "Fn::GetAtt" : [ "XgemailXdeliveryInstanceRole", "Arn" ] }
    },
    "XgemailInternetDeliveryInstanceProfile": {
      "Description": "XGEMAIL Internet Delivery instance profile",
      "Value": { "Ref": "XgemailInternetDeliveryInstanceProfile" }
    },
    "XgemailInternetDeliveryInstanceRole": {
      "Description": "XGEMAIL Internet Delivery instance role",
      "Value": { "Ref": "XgemailInternetDeliveryInstanceRole" }
    },
    "XgemailInternetDeliveryInstanceRoleArn": {
      "Description": "XGEMAIL Internet Delivery instance role ARN",
      "Value": { "Fn::GetAtt" : [ "XgemailInternetDeliveryInstanceRole", "Arn" ] }
    },
    "XgemailInternetXdeliveryInstanceProfile": {
      "Description": "XGEMAIL Internet Xdelivery instance profile",
      "Value": { "Ref": "XgemailInternetXdeliveryInstanceProfile" }
    },
    "XgemailInternetXdeliveryInstanceRole": {
      "Description": "XGEMAIL Internet Xdelivery instance role",
      "Value": { "Ref": "XgemailInternetXdeliveryInstanceRole" }
    },
    "XgemailInternetXdeliveryInstanceRoleArn": {
      "Description": "XGEMAIL Internet Xdelivery instance role ARN",
      "Value": { "Fn::GetAtt" : [ "XgemailInternetXdeliveryInstanceRole", "Arn" ] }
    },
    "XgemailEncryptionDeliveryInstanceProfile": {
      "Description": "XGEMAIL Encryption Delivery instance profile",
      "Value": { "Ref": "XgemailEncryptionDeliveryInstanceProfile" }
    },
    "XgemailEncryptionDeliveryInstanceRole": {
      "Description": "XGEMAIL Encryption Delivery instance role",
      "Value": { "Ref": "XgemailEncryptionDeliveryInstanceRole" }
    },
    "XgemailEncryptionDeliveryInstanceRoleArn": {
      "Description": "XGEMAIL Encryption Delivery instance role ARN",
      "Value": { "Fn::GetAtt" : [ "XgemailEncryptionDeliveryInstanceRole", "Arn" ] }
    },
    "XgemailRiskyDeliveryInstanceProfile": {
      "Description": "XGEMAIL Risky Delivery instance profile",
      "Value": { "Ref": "XgemailRiskyDeliveryInstanceProfile" }
    },
    "XgemailRiskyDeliveryInstanceRole": {
      "Description": "XGEMAIL Risky Delivery instance role",
      "Value": { "Ref": "XgemailRiskyDeliveryInstanceRole" }
    },
    "XgemailRiskyDeliveryInstanceRoleArn": {
      "Description": "XGEMAIL Risky Delivery instance role ARN",
      "Value": { "Fn::GetAtt" : [ "XgemailRiskyDeliveryInstanceRole", "Arn" ] }
    },
    "XgemailRiskyXdeliveryInstanceProfile": {
      "Description": "XGEMAIL Risky Xdelivery instance profile",
      "Value": { "Ref": "XgemailRiskyXdeliveryInstanceProfile" }
    },
    "XgemailRiskyXdeliveryInstanceRole": {
      "Description": "XGEMAIL Risky Xdelivery instance role",
      "Value": { "Ref": "XgemailRiskyXdeliveryInstanceRole" }
    },
    "XgemailRiskyXdeliveryInstanceRoleArn": {
      "Description": "XGEMAIL Risky Xdelivery instance role ARN",
      "Value": { "Fn::GetAtt" : [ "XgemailRiskyXdeliveryInstanceRole", "Arn" ] }
    },
    "XgemailCustomerSubmitInstanceProfile": {
      "Description": "XGEMAIL Customer Submit instance profile",
      "Value": { "Ref": "XgemailCustomerSubmitInstanceProfile" }
    },
    "XgemailCustomerSubmitInstanceRole": {
      "Description": "XGEMAIL Customer Submit instance role",
      "Value": { "Ref": "XgemailCustomerSubmitInstanceRole" }
    },
    "XgemailCustomerSubmitInstanceRoleArn": {
      "Description": "XGEMAIL Customer Submit instance role ARN",
      "Value": { "Fn::GetAtt" : [ "XgemailCustomerSubmitInstanceRole", "Arn" ] }
    },
    "XgemailInternetSubmitInstanceProfile": {
      "Description": "XGEMAIL Internet Submit instance profile",
      "Value": { "Ref": "XgemailInternetSubmitInstanceProfile" }
    },
    "XgemailInternetSubmitInstanceRole": {
      "Description": "XGEMAIL Internet Submit instance role",
      "Value": { "Ref": "XgemailInternetSubmitInstanceRole" }
    },
    "XgemailInternetSubmitInstanceRoleArn": {
      "Description": "XGEMAIL Internet Submit instance role ARN",
      "Value": { "Fn::GetAtt" : [ "XgemailInternetSubmitInstanceRole", "Arn" ] }
    },
    "XgemailMfInboundSubmitInstanceProfile": {
      "Description": "XGEMAIL Mf Inbound Submit instance profile",
      "Value": { "Ref": "XgemailMfInboundSubmitInstanceProfile" }
    },
    "XgemailMfInboundSubmitInstanceRole": {
      "Description": "XGEMAIL Mf Inbound Submit instance role",
      "Value": { "Ref": "XgemailMfInboundSubmitInstanceRole" }
    },
    "XgemailMfInboundSubmitInstanceRoleArn": {
      "Description": "XGEMAIL Mf Inbound Submit instance role ARN",
      "Value": { "Fn::GetAtt" : [ "XgemailMfInboundSubmitInstanceRole", "Arn" ] }
    },
    "XgemailEncryptionSubmitInstanceProfile": {
      "Description": "XGEMAIL Encryption Submit instance profile",
      "Value": { "Ref": "XgemailEncryptionSubmitInstanceProfile" }
    },
    "XgemailEncryptionSubmitInstanceRole": {
      "Description": "XGEMAIL Encryption Submit instance role",
      "Value": { "Ref": "XgemailEncryptionSubmitInstanceRole" }
    },
    "XgemailEncryptionSubmitInstanceRoleArn": {
      "Description": "XGEMAIL Customer Encryption Submit instance role ARN",
      "Value": { "Fn::GetAtt" : [ "XgemailEncryptionSubmitInstanceRole", "Arn" ] }
    },
    "XgemailMfOutboundSubmitInstanceProfile": {
      "Description": "XGEMAIL Mf Outbound Submit instance profile",
      "Value": { "Ref": "XgemailMfOutboundSubmitInstanceProfile" }
    },
    "XgemailMfOutboundSubmitInstanceRole": {
      "Description": "XGEMAIL Mf Outbound Submit instance role",
      "Value": { "Ref": "XgemailMfOutboundSubmitInstanceRole" }
    },
    "XgemailMfOutboundSubmitInstanceRoleArn": {
      "Description": "XGEMAIL Mf Outbound Submit instance role ARN",
      "Value": { "Fn::GetAtt" : [ "XgemailMfOutboundSubmitInstanceRole", "Arn" ] }
    },
    "XgemailMfOutboundDeliveryInstanceProfile": {
      "Description": "XGEMAIL Mf Outbound Delivery instance profile",
      "Value": { "Ref": "XgemailMfOutboundDeliveryInstanceProfile" }
    },
    "XgemailMfOutboundDeliveryInstanceRole": {
      "Description": "XGEMAIL Mf Outbound Delivery instance role",
      "Value": { "Ref": "XgemailMfOutboundDeliveryInstanceRole" }
    },
    "XgemailMfOutboundDeliveryInstanceRoleArn": {
      "Description": "XGEMAIL Mf Outbound Delivery instance role ARN",
      "Value": { "Fn::GetAtt" : [ "XgemailMfOutboundDeliveryInstanceRole", "Arn" ] }
    },
    "XgemailMfInboundXdeliveryInstanceProfile": {
      "Description": "XGEMAIL Mf Inbound Xdelivery instance profile",
      "Value": { "Ref": "XgemailMfInboundXdeliveryInstanceProfile" }
    },
    "XgemailMfInboundXdeliveryInstanceRole": {
      "Description": "XGEMAIL Mf Inbound Xdelivery instance role",
      "Value": { "Ref": "XgemailMfInboundXdeliveryInstanceRole" }
    },
    "XgemailMfInboundXdeliveryInstanceRolePolicies": {
      "Description": "XGEMAIL Mf Inbound Xdelivery instance role ARN",
      "Value": { "Fn::GetAtt" : [ "XgemailMfInboundXdeliveryInstanceRole", "Arn" ] }
    },
    "XgemailMfOutboundXdeliveryInstanceProfile": {
      "Description": "XGEMAIL Mf Outbound Xdelivery instance profile",
      "Value": { "Ref": "XgemailMfOutboundXdeliveryInstanceProfile" }
    },
    "XgemailMfOutboundXdeliveryInstanceRole": {
      "Description": "XGEMAIL Mf Outbound Xdelivery instance role",
      "Value": { "Ref": "XgemailMfOutboundXdeliveryInstanceRole" }
    },
    "XgemailMfOutboundXdeliveryInstanceRolePolicies": {
      "Description": "XGEMAIL Mf Outbound Xdelivery instance role ARN",
      "Value": { "Fn::GetAtt" : [ "XgemailMfOutboundXdeliveryInstanceRole", "Arn" ] }
    },
    "XgemailWarmupDeliveryInstanceProfile": {
      "Description": "XGEMAIL Warmup Delivery instance profile",
      "Value": { "Ref": "XgemailWarmupDeliveryInstanceProfile" }
    },
    "XgemailWarmupDeliveryInstanceRole": {
      "Description": "XGEMAIL Warmup Delivery instance role",
      "Value": { "Ref": "XgemailWarmupDeliveryInstanceRole" }
    },
    "XgemailWarmupDeliveryInstanceRoleArn": {
      "Description": "XGEMAIL Warmup Delivery instance role ARN",
      "Value": { "Fn::GetAtt" : [ "XgemailWarmupDeliveryInstanceRole", "Arn" ] }
    },
    "XgemailWarmupXdeliveryInstanceProfile": {
      "Description": "XGEMAIL Warmup Xdelivery instance profile",
      "Value": { "Ref": "XgemailWarmupXdeliveryInstanceProfile" }
    },
    "XgemailWarmupXdeliveryInstanceRole": {
      "Description": "XGEMAIL Warmup Xdelivery instance role",
      "Value": { "Ref": "XgemailWarmupXdeliveryInstanceRole" }
    },
    "XgemailWarmupXdeliveryInstanceRoleArn": {
      "Description": "XGEMAIL Warmup Xdelivery instance role ARN",
      "Value": { "Fn::GetAtt" : [ "XgemailWarmupXdeliveryInstanceRole", "Arn" ] }
    },
    "XgemailDeltaDeliveryInstanceProfile": {
      "Description": "XGEMAIL Delta Delivery instance profile",
      "Value": { "Ref": "XgemailDeltaDeliveryInstanceProfile" }
    },
    "XgemailDeltaDeliveryInstanceRole": {
      "Description": "XGEMAIL Delta Delivery instance role",
      "Value": { "Ref": "XgemailDeltaDeliveryInstanceRole" }
    },
    "XgemailDeltaDeliveryInstanceRoleArn": {
      "Description": "XGEMAIL Delta Delivery instance role ARN",
      "Value": { "Fn::GetAtt" : [ "XgemailDeltaDeliveryInstanceRole", "Arn" ] }
    },
    "XgemailDeltaXdeliveryInstanceProfile": {
      "Description": "XGEMAIL Delta Xdelivery instance profile",
      "Value": { "Ref": "XgemailDeltaXdeliveryInstanceProfile" }
    },
    "XgemailDeltaXdeliveryInstanceRole": {
      "Description": "XGEMAIL Delta Xdelivery instance role",
      "Value": { "Ref": "XgemailDeltaXdeliveryInstanceRole" }
    },
    "XgemailDeltaXdeliveryInstanceRoleArn": {
      "Description": "XGEMAIL Delta Xdelivery instance role ARN",
      "Value": { "Fn::GetAtt" : [ "XgemailDeltaXdeliveryInstanceRole", "Arn" ] }
    }
  }
}
