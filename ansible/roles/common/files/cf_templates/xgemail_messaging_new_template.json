{
  "AWSTemplateFormatVersion": "2010-09-09",

  "Description": "Xgemail SNS Subscription Template",

  "Metadata": {
    "Copyright": [
      "Copyright 2020, Sophos Limited. All rights reserved.",
      "",
      "'Sophos' and 'Sophos Anti-Virus' are registered trademarks of",
      "Sophos Limited and Sophos Group.  All other product and company",
      "names mentioned are trademarks or registered trademarks of their",
      "respective owners."
    ],

    "Comments": [
      "Marries SNS topics to SQS queues to support XGEMAIL messaging."
    ]
  },

  "Parameters": {
    "DomainDeliveryTopicArn": {
      "Description": "TopicArn of Domain Delivery Events SNS",
      "Type": "String"
    },
    "AdditionalActionQueue": {
      "Description": "Endpoint ARN for Additional Action SQS Queue",
      "Type": "String"
    },
    "DomainDeliveryQueue": {
      "Description": "Endpoint for Domain delivery SQS queue",
      "Type": "String"
    },
    "MessageHistoryQueue": {
      "Description": "Endpoint for message history SQS queue",
      "Type": "String"
    },
    "MessageStatisticsQueue": {
      "Description": "Endpoint for message statistics SQS queue",
      "Type": "String"
    }
  },

  "Resources": {
    "AdditionalActionQueueToDomainDeliverySnsSubscription": {
      "Type" : "AWS::SNS::Subscription",
      "Properties": {
        "Endpoint": {"Fn::Join": [":", ["arn:aws:sqs", { "Ref" : "AWS::Region" }, { "Ref" : "AWS::AccountId" }, {"Ref": "AdditionalActionQueue"}]]},
        "Protocol": "sqs",
        "TopicArn": { "Ref": "DomainDeliveryTopicArn"}
      }
    },
    "DomainDeliveryQueueToDomainDeliverySnsSubscription": {
      "Type" : "AWS::SNS::Subscription",
      "Properties": {
        "Endpoint": {"Fn::Join": [":", ["arn:aws:sqs", { "Ref" : "AWS::Region" }, { "Ref" : "AWS::AccountId" }, {"Ref": "DomainDeliveryQueue"}]]},
        "Protocol": "sqs",
        "TopicArn": { "Ref": "DomainDeliveryTopicArn"}
      }
    },
    "MessageHistoryQueueToDomainDeliverySnsSubscription": {
      "Type" : "AWS::SNS::Subscription",
      "Properties": {
        "Endpoint": {"Fn::Join": [":", ["arn:aws:sqs", { "Ref" : "AWS::Region" }, { "Ref" : "AWS::AccountId" }, {"Ref": "MessageHistoryQueue"}]]},
        "Protocol": "sqs",
        "TopicArn": { "Ref": "DomainDeliveryTopicArn"}
      }
    },
    "MessageStatisticsQueueToDomainDeliverySnsSubscription": {
      "Type" : "AWS::SNS::Subscription",
      "Properties": {
        "Endpoint": {"Fn::Join": [":", ["arn:aws:sqs", { "Ref" : "AWS::Region" }, { "Ref" : "AWS::AccountId" }, {"Ref": "MessageStatisticsQueue"}]]},
        "Protocol": "sqs",
        "TopicArn": { "Ref": "DomainDeliveryTopicArn"}
      }
    },

    "DomainDeliveryQueuePolicy": {
      "Type": "AWS::SQS::QueuePolicy",
      "Properties": {
        "PolicyDocument": {
          "Version": "2012-10-17",
          "Id": "DomainDeliveryQueuePolicy-id-{0a87be1d-a442-4db0-8863-555056ffeb06}",
          "Statement": [
            {
              "Sid": "Allow-DomainDeliveryTopicArn",
              "Effect": "Allow",
              "Principal": "*",
              "Action": ["sqs:SendMessage"],
              "Resource": "*",
              "Condition": {
                "ArnEquals": {
                  "aws:SourceArn": {"Ref": "DomainDeliveryTopicArn"}
                }
              }
            }
          ]
        },
        "Queues": [{"Fn::Join": ["", ["https://sqs.", { "Ref" : "AWS::Region" }, ".amazonaws.com/", { "Ref" : "AWS::AccountId" }, "/", { "Ref": "DomainDeliveryQueue" }]]}]
      }
    }
  }
}