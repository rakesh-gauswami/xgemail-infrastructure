{
  "AWSTemplateFormatVersion": "2010-09-09",

  "Description": "XGEMAIL security resources template.",

  "Metadata": {
    "Copyright": [
      "Copyright 2021, Sophos Limited. All rights reserved.",
      "",
      "'Sophos' and 'Sophos Anti-Virus' are registered trademarks of",
      "Sophos Limited and Sophos Group.  All other product and company",
      "names mentioned are trademarks or registered trademarks of their",
      "respective owners."
    ],

    "Comments": [
      "SecurityGroup Template for access to and from Instances in the CloudEmail Vpc"
    ]
  },

  "Parameters": {
    "BastionIngressExternalSshCidr": {
      "Description": "The source CIDR allowed SSH access to the bastion.",
      "Type": "String",
      "Default": "198.144.101.0/24"
    },

    "Branch": {
      "Description": "Git branch (develop, feature/CPLAT-9660, etc.).",
      "Type": "String"
    },

    "Environment": {
      "Description": "AWS account being used (inf, dev, qa, etc.).",
      "Type": "String"
    },
    "ExternalIpAccessList": {
      "Description": "List of public IP address of the Burlington office.",
      "Type": "CommaDelimitedList"
    },
    "HopperIpAccessA": {
      "Description": "Public IP of Hopper for ssh tunnel access.",
      "Type": "String"
    },
    "HopperIpAccessB": {
      "Description": "Public IP of Hopper for ssh tunnel access.",
      "Type": "String"
    },
    "HopperIpAccessC": {
      "Description": "Public IP of Hopper for ssh tunnel access.",
      "Type": "String"
    },
    "Vpc": {
      "Description": "Target VPC ID",
      "Type": "AWS::EC2::VPC::Id"
    }
  },

  "Mappings": {
    "RegionMap": {
      "us-west-2": { "VpcCidrBlock": "172.17.0.0/16", "PublicSubnetCidrBlocks": "172.17.0.0/24" },
      "us-east-1": { "VpcCidrBlock": "172.18.0.0/16", "PublicSubnetCidrBlocks": "172.18.0.0/24" },
      "eu-west-1": {"VpcCidrBlock": "172.19.0.0/16", "PublicSubnetCidrBlocks": "172.19.0.0/24" },
      "eu-central-1": {"VpcCidrBlock": "172.20.0.0/16", "PublicSubnetCidrBlocks": "172.20.0.0/24" },
      "us-east-2": {"VpcCidrBlock": "172.21.0.0/16", "PublicSubnetCidrBlocks": "172.21.0.0/24" }
    }
  },

  "Conditions": {
    "OpenToWorld" : {
      "Fn::Or": [
        {
          "Fn::Equals": [
            {"Ref": "Environment"},
            "prod"
          ]
        },
        {
          "Fn::Equals": [
            {"Ref": "Environment"},
            "qa"
          ]
        },
        {
          "Fn::Equals": [
            {"Ref": "Environment"},
            "dev"
          ]
        }
      ]
    },
    "ClosedToWorld" : {
      "Fn::Not": [
        {
          "Fn::Or": [
            {
              "Fn::Equals": [
                {"Ref": "Environment"},
                "prod"
              ]
            },
            {
              "Fn::Equals": [
                {"Ref": "Environment"},
                "qa"
              ]
            },
            {
              "Fn::Equals": [
                {"Ref": "Environment"},
                "dev"
              ]
            }
          ]
        }]
    }
  },

  "Resources": {
    "SecurityGroupBase": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupDescription": "The default security group used by all instances.",
        "SecurityGroupIngress": [
          {
            "CidrIp": { "Ref": "HopperIpAccessA" },
            "FromPort": "22",
            "IpProtocol": "tcp",
            "ToPort": "22"
          },
          {
            "CidrIp": { "Ref": "HopperIpAccessB" },
            "FromPort": "22",
            "IpProtocol": "tcp",
            "ToPort": "22"
          },
          {
            "CidrIp": { "Ref": "HopperIpAccessC" },
            "FromPort": "22",
            "IpProtocol": "tcp",
            "ToPort": "22"
          },
          {
            "IpProtocol": "tcp",
            "FromPort": "161",
            "ToPort": "161",
            "SourceSecurityGroupId": { "Ref": "SecurityGroupLogicMonitor" }
          },
          {
            "IpProtocol": "udp",
            "FromPort": "161",
            "ToPort": "161",
            "SourceSecurityGroupId": { "Ref": "SecurityGroupLogicMonitor" }
          },
          {
            "IpProtocol": "udp",
            "FromPort": "123",
            "ToPort": "123",
            "SourceSecurityGroupId": { "Ref": "SecurityGroupLogicMonitor" }
          },
          {
            "IpProtocol" : "icmp",
            "FromPort" : "8",
            "ToPort" : "-1",
            "SourceSecurityGroupId": { "Ref": "SecurityGroupLogicMonitor" }
          }
        ],
        "SecurityGroupEgress": [
          {
            "CidrIp": "0.0.0.0/0",
            "IpProtocol": "-1"
          }
        ],
        "Tags": [
          {
            "Key": "Name",
            "Value": {
              "Fn::Join": [
                "", [
                  {"Ref" : "Environment"},
                  "-",
                  {"Ref" : "Branch"},
                  "-",
                  {"Ref" : "AWS::StackName"} , "/sg/bastion" ] ] }
          },
          {
            "Key": "Application",
            "Value": "cloudemail"
          },
          {
            "Key": "BusinessUnit",
            "Value": "MSG"
          },
          {
            "Key": "Project",
            "Value": "xgemail"
          },
          {
            "Key": "OwnerEmail",
            "Value": "sophosmailops@sophos.com"
          }
        ],
        "VpcId": {
          "Ref": "Vpc"
        }
      }
    },

    "SecurityGroupBaseIngress": {
      "Type": "AWS::EC2::SecurityGroupIngress",
      "Properties": {
        "GroupId": { "Ref": "SecurityGroupBase" },
        "IpProtocol": "tcp",
        "FromPort": "22",
        "ToPort": "22",
        "SourceSecurityGroupId": { "Ref": "SecurityGroupBase" }
      }
    },

    "SecurityGroupJGroups" : {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties" : {
        "GroupDescription": "Enables JGroups communication.",
        "SecurityGroupEgress": [
          {
            "CidrIp": "0.0.0.0/0",
            "IpProtocol": "-1"
          }
        ],
        "Tags": [
          {
            "Key": "Name",
            "Value": {
              "Fn::Join": [
                "", [
                  {
                    "Ref": "Environment"
                  },
                  "-",
                  {
                    "Ref": "Branch"
                  },
                  "-" ,
                  {
                    "Ref": "AWS::StackName"
                  } ,
                  "/sg/svc/java/jgroups"
                ]
              ]
            }
          },
          {
            "Key": "Application",
            "Value": "cloudemail"
          },
          {
            "Key": "BusinessUnit",
            "Value": "MSG"
          },
          {
            "Key": "Project",
            "Value": "xgemail"
          },
          {
            "Key": "OwnerEmail",
            "Value": "sophosmailops@sophos.com"
          }
        ],
        "VpcId": {
          "Ref": "Vpc"
        }
      }
    },

    "SecurityGroupJGroupsIngress": {
      "Type": "AWS::EC2::SecurityGroupIngress",
      "Properties": {
        "GroupId": { "Ref": "SecurityGroupJGroups" },
        "IpProtocol": "tcp",
        "FromPort": "7800",
        "ToPort": "7825",
        "SourceSecurityGroupId": { "Ref": "SecurityGroupJGroups" }
      }
    },

    "SecurityGroupJavaSvcBaseLb": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupDescription": "Controls access to public facing ELBs.",
        "Tags": [
          {
            "Key": "Branch",
            "Value": { "Ref" : "Branch" }

          },
          {
            "Key": "Environment",
            "Value": { "Ref" : "Environment" }
          },
          {
            "Key": "Role",
            "Value": "svc-java-base-elb"

          },
          {
            "Key": "Name",
            "Value": { "Fn::Join": [ "", [ {"Ref" : "Environment"}, "-", {"Ref" : "Branch"}, "-" ,{"Ref" : "AWS::StackName"} , "/sg/svc/java/elb" ] ] }

          },
          {
            "Key": "Application",
            "Value": "cloudemail"
          },
          {
            "Key": "BusinessUnit",
            "Value": "MSG"
          },
          {
            "Key": "Project",
            "Value": "xgemail"
          },
          {
            "Key": "OwnerEmail",
            "Value": "sophosmailops@sophos.com"
          }
        ],
        "SecurityGroupIngress": [
          {
            "IpProtocol": "tcp",
            "FromPort": "80",
            "ToPort": "80",
            "CidrIp": "0.0.0.0/0"
          },
          {
            "IpProtocol": "tcp",
            "FromPort": "443",
            "ToPort": "443",
            "CidrIp": "0.0.0.0/0"
          },
          {
            "IpProtocol": "tcp",
            "FromPort": "8444",
            "ToPort": "8446",
            "CidrIp": "0.0.0.0/0"
          }
        ],
        "SecurityGroupEgress": [
          {
            "CidrIp": "0.0.0.0/0",
            "IpProtocol": "-1"
          }
        ],
        "VpcId": {
          "Ref": "Vpc"
        }
      }
    },

    "SecurityGroupJavaSvcBase": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupDescription": "The default service security group controls access to all java services.",
        "SecurityGroupEgress": {
          "CidrIp": "0.0.0.0/0",
          "IpProtocol": "-1"
        },
        "SecurityGroupIngress": [
          {
            "IpProtocol": "tcp",
            "FromPort": "22",
            "ToPort": "22",
            "SourceSecurityGroupId": { "Ref": "SecurityGroupBase" }
          },
          {
            "IpProtocol" : "tcp",
            "FromPort" : "80",
            "ToPort" : "80",
            "SourceSecurityGroupId":{ "Ref": "SecurityGroupJavaSvcBaseLb" }
          },
          {
            "IpProtocol" : "tcp",
            "FromPort" : "8080",
            "ToPort" : "8080",
            "SourceSecurityGroupId":{ "Ref": "SecurityGroupJavaSvcBaseLb" }
          },
          {
            "IpProtocol" : "tcp",
            "FromPort" : "443",
            "ToPort" : "443",
            "SourceSecurityGroupId":{ "Ref": "SecurityGroupJavaSvcBaseLb" }
          }
        ],
        "VpcId": {
          "Ref": "Vpc"
        },
        "Tags": [
          {
            "Key": "Branch",
            "Value": { "Ref" : "Branch" }
          },
          {
            "Key": "Environment",
            "Value": { "Ref" : "Environment" }
          },
          {
            "Key" : "Name",
            "Value" : { "Fn::Join": [ "", [ {"Ref" : "Environment"}, "-", {"Ref" : "Branch"}, "-" ,{"Ref" : "AWS::StackName"} , "/sg/svc/java/base" ] ] }
          },
          {
            "Key": "Application",
            "Value": "cloudemail"
          },
          {
            "Key": "BusinessUnit",
            "Value": "MSG"
          },
          {
            "Key": "Project",
            "Value": "xgemail"
          },
          {
            "Key": "OwnerEmail",
            "Value": "sophosmailops@sophos.com"
          }
        ]
      }
    },

    "SecurityGroupJavaSvcBaseJGroupsIngress": {
      "Type": "AWS::EC2::SecurityGroupIngress",
      "Properties": {
        "GroupId": { "Ref": "SecurityGroupJavaSvcBase" },
        "IpProtocol": "tcp",
        "FromPort": "7800",
        "ToPort": "7825",
        "SourceSecurityGroupId": { "Ref": "SecurityGroupJavaSvcBase" }
      }
    },

    "SecurityGroupExternalIpAccess": {
      "Type": "AWS::EC2::SecurityGroup",
      "Condition": "ClosedToWorld",
      "Properties": {
        "GroupDescription": "IP Address of external locations such as the corporate offices..",
        "SecurityGroupIngress": [
          {
            "IpProtocol": "tcp",
            "FromPort": "25",
            "ToPort": "25",
            "CidrIp": { "Fn::Select" : [ 0, {"Ref": "ExternalIpAccessList"} ] }
          },
          {
            "IpProtocol": "tcp",
            "FromPort": "25",
            "ToPort": "25",
            "CidrIp": { "Fn::Select" : [ 1, {"Ref": "ExternalIpAccessList"} ] }
          },
          {
            "IpProtocol": "tcp",
            "FromPort": "25",
            "ToPort": "25",
            "CidrIp": { "Fn::Select" : [ 2, {"Ref": "ExternalIpAccessList"} ] }
          },
          {
            "IpProtocol": "tcp",
            "FromPort": "25",
            "ToPort": "25",
            "CidrIp": { "Fn::Select" : [ 3, {"Ref": "ExternalIpAccessList"} ] }
          },
          {
            "IpProtocol": "tcp",
            "FromPort": "25",
            "ToPort": "25",
            "CidrIp": { "Fn::Select" : [ 4, {"Ref": "ExternalIpAccessList"} ] }
          },
          {
            "IpProtocol": "tcp",
            "FromPort": "587",
            "ToPort": "587",
            "CidrIp": { "Fn::Select" : [ 0, {"Ref": "ExternalIpAccessList"} ] }
          },
          {
            "IpProtocol": "tcp",
            "FromPort": "587",
            "ToPort": "587",
            "CidrIp": { "Fn::Select" : [ 1, {"Ref": "ExternalIpAccessList"} ] }
          },
          {
            "IpProtocol": "tcp",
            "FromPort": "587",
            "ToPort": "587",
            "CidrIp": { "Fn::Select" : [ 2, {"Ref": "ExternalIpAccessList"} ] }
          },
          {
            "IpProtocol": "tcp",
            "FromPort": "587",
            "ToPort": "587",
            "CidrIp": { "Fn::Select" : [ 3, {"Ref": "ExternalIpAccessList"} ] }
          },
          {
            "IpProtocol": "tcp",
            "FromPort": "587",
            "ToPort": "587",
            "CidrIp": { "Fn::Select" : [ 4, {"Ref": "ExternalIpAccessList"} ] }
          }
        ],
        "SecurityGroupEgress": [
          {
            "CidrIp": "0.0.0.0/0",
            "IpProtocol": "-1"
          }
        ],
        "VpcId": {
          "Ref": "Vpc"
        },
        "Tags": [
          {
            "Key": "Branch",
            "Value": { "Ref" : "Branch" }
          },
          {
            "Key": "Environment",
            "Value": { "Ref" : "Environment" }
          },
          {
            "Key" : "Name",
            "Value" : { "Fn::Join": [ "", [ {"Ref" : "Environment"}, "-", {"Ref" : "Branch"}, "-" ,{"Ref" : "AWS::StackName"} , "/sg/xgemail/external/access" ] ] }
          },
          {
            "Key": "Application",
            "Value": "cloudemail"
          },
          {
            "Key": "BusinessUnit",
            "Value": "MSG"
          },
          {
            "Key": "Project",
            "Value": "xgemail"
          },
          {
            "Key": "OwnerEmail",
            "Value": "sophosmailops@sophos.com"
          }
        ]
      }
    },

    "SecurityGroupExternalIpAccessCustomerSubmitSmtp": {
      "Type": "AWS::EC2::SecurityGroupIngress",
      "Condition": "ClosedToWorld",
      "Properties": {
        "GroupId": { "Ref": "XgemailCustomerSubmitSecurityGroupLb" },
        "SourceSecurityGroupId": { "Ref": "SecurityGroupExternalIpAccess" },
        "IpProtocol": "tcp",
        "FromPort": "25",
        "ToPort": "25"
      }
    },

    "SecurityGroupExternalIpAccessCustomerSubmitSmtpTls": {
      "Type": "AWS::EC2::SecurityGroupIngress",
      "Condition": "ClosedToWorld",
      "Properties": {
        "GroupId": { "Ref": "XgemailCustomerSubmitSecurityGroupLb" },
        "SourceSecurityGroupId": { "Ref": "SecurityGroupExternalIpAccess" },
        "IpProtocol": "tcp",
        "FromPort": "587",
        "ToPort": "587"
      }
    },

    "SecurityGroupExternalIpAccessInternetSubmitSmtp": {
      "Type": "AWS::EC2::SecurityGroupIngress",
      "Condition": "ClosedToWorld",
      "Properties": {
        "GroupId": { "Ref": "XgemailInternetSubmitSecurityGroupLb" },
        "SourceSecurityGroupId": { "Ref": "SecurityGroupExternalIpAccess" },
        "IpProtocol": "tcp",
        "FromPort": "25",
        "ToPort": "25"
      }
    },

    "SecurityGroupExternalIpAccessInternetSubmitSmtpTls": {
      "Type": "AWS::EC2::SecurityGroupIngress",
      "Condition": "ClosedToWorld",
      "Properties": {
        "GroupId": { "Ref": "XgemailInternetSubmitSecurityGroupLb" },
        "SourceSecurityGroupId": { "Ref": "SecurityGroupExternalIpAccess" },
        "IpProtocol": "tcp",
        "FromPort": "587",
        "ToPort": "587"
      }
    },

    "SecurityGroupExternalIpAccessMfInboundSubmitSmtp": {
      "Type": "AWS::EC2::SecurityGroupIngress",
      "Condition": "ClosedToWorld",
      "Properties": {
        "GroupId": { "Ref": "XgemailMfInboundSubmitSecurityGroupLb" },
        "SourceSecurityGroupId": { "Ref": "SecurityGroupExternalIpAccess" },
        "IpProtocol": "tcp",
        "FromPort": "25",
        "ToPort": "25"
      }
    },

    "SecurityGroupExternalIpAccessMfOutboundSubmitSmtp": {
      "Type": "AWS::EC2::SecurityGroupIngress",
      "Condition": "ClosedToWorld",
      "Properties": {
        "GroupId": { "Ref": "XgemailMfOutboundSubmitSecurityGroupLb" },
        "SourceSecurityGroupId": { "Ref": "SecurityGroupExternalIpAccess" },
        "IpProtocol": "tcp",
        "FromPort": "25",
        "ToPort": "25"
      }
    },

    "SecurityGroupExternalIpAccessMfInboundSubmitSmtpTls": {
      "Type": "AWS::EC2::SecurityGroupIngress",
      "Condition": "ClosedToWorld",
      "Properties": {
        "GroupId": { "Ref": "XgemailMfInboundSubmitSecurityGroupLb" },
        "SourceSecurityGroupId": { "Ref": "SecurityGroupExternalIpAccess" },
        "IpProtocol": "tcp",
        "FromPort": "587",
        "ToPort": "587"
      }
    },

    "SecurityGroupExternalIpAccessMfOutboundSubmitSmtpTls": {
      "Type": "AWS::EC2::SecurityGroupIngress",
      "Condition": "ClosedToWorld",
      "Properties": {
        "GroupId": { "Ref": "XgemailMfOutboundSubmitSecurityGroupLb" },
        "SourceSecurityGroupId": { "Ref": "SecurityGroupExternalIpAccess" },
        "IpProtocol": "tcp",
        "FromPort": "587",
        "ToPort": "587"
      }
    },

    "SecurityGroupBastion": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupDescription": "Bastion security group.",
        "Tags": [{
          "Key": "Name",
          "Value": {
            "Fn::Join": [ "", [
              { "Ref": "Environment" }, "-",
              { "Ref": "Branch" }, "-",
              { "Ref": "AWS::StackName" }, "/sg/bastion"
            ]]
          }
        }],
        "VpcId": { "Ref": "Vpc" }
      }
    },

    "SecurityGroupBastionEgress": {
      "Type": "AWS::EC2::SecurityGroupEgress",
      "Properties": {
        "GroupId": { "Ref": "SecurityGroupBastion" },
        "CidrIp": "0.0.0.0/0",
        "IpProtocol": "-1"
      }
    },

    "SecurityGroupBastionIngressExternalSsh": {
      "Type": "AWS::EC2::SecurityGroupIngress",
      "Properties": {
        "GroupId": { "Ref": "SecurityGroupBastion" },
        "CidrIp": { "Ref": "BastionIngressExternalSshCidr" },
        "IpProtocol": "tcp",
        "FromPort": "22",
        "ToPort": "22"
      }
    },

    "SecurityGroupBastionHopperIpAccessSshA": {
      "Type": "AWS::EC2::SecurityGroupIngress",
      "Properties": {
        "GroupId": { "Ref": "SecurityGroupBastion" },
        "CidrIp": { "Ref": "HopperIpAccessA" },
        "IpProtocol": "tcp",
        "FromPort": "22",
        "ToPort": "22"
      }
    },

    "SecurityGroupBastionHopperIpAccessSshB": {
      "Type": "AWS::EC2::SecurityGroupIngress",
      "Properties": {
        "GroupId": { "Ref": "SecurityGroupBastion" },
        "CidrIp": { "Ref": "HopperIpAccessB" },
        "IpProtocol": "tcp",
        "FromPort": "22",
        "ToPort": "22"
      }
    },

    "SecurityGroupBastionHopperIpAccessSshC": {
      "Type": "AWS::EC2::SecurityGroupIngress",
      "Properties": {
        "GroupId": { "Ref": "SecurityGroupBastion" },
        "CidrIp": { "Ref": "HopperIpAccessC" },
        "IpProtocol": "tcp",
        "FromPort": "22",
        "ToPort": "22"
      }
    },

    "SecurityGroupBastionIngressInternalSsh": {
      "Type": "AWS::EC2::SecurityGroupIngress",
      "Properties": {
        "GroupId": { "Ref": "SecurityGroupBastion" },
        "SourceSecurityGroupId": { "Ref": "SecurityGroupBastion" },
        "IpProtocol": "tcp",
        "FromPort": "22",
        "ToPort": "22"
      }
    },

    "SecurityGroupLogicMonitor": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupDescription": "Controls the access to and from Logic Monitor.",
        "SecurityGroupEgress": {
          "CidrIp": "0.0.0.0/0",
          "IpProtocol": "-1"
        },

        "SecurityGroupIngress": [
          {
            "IpProtocol": "tcp",
            "FromPort": "22",
            "ToPort": "22",
            "SourceSecurityGroupId": { "Ref": "SecurityGroupBastion" }
          }
        ],
        "VpcId": { "Ref": "Vpc" },
        "Tags": [
          {
            "Key": "Name", "Value": { "Fn::Join": [ "", [ { "Ref": "Environment" }, "-", { "Ref": "Branch" }, "-", { "Ref": "AWS::StackName" }, "/sg/logicmonitor" ] ] }
          },
          {
            "Key": "Application",
            "Value": "logicmonitor"
          },
          {
            "Key": "BusinessUnit",
            "Value": "MSG"
          },
          {
            "Key": "Project",
            "Value": "xgemail"
          },
          {
            "Key": "OwnerEmail",
            "Value": "sophosmailops@sophos.com"
          }
        ]
      }
    },

    "SecurityGroupBastionLogicMonitorSnmpTcpIngress": {
      "Type": "AWS::EC2::SecurityGroupIngress",
      "Properties": {
        "GroupId": { "Ref": "SecurityGroupBastion" },
        "IpProtocol": "tcp",
        "FromPort": "161",
        "ToPort": "162",
        "SourceSecurityGroupId": { "Ref": "SecurityGroupLogicMonitor" }
      }
    },

    "SecurityGroupBastionLogicMonitorSnmpUdpIngress": {
      "Type": "AWS::EC2::SecurityGroupIngress",
      "Properties": {
        "GroupId": { "Ref": "SecurityGroupBastion" },
        "IpProtocol": "udp",
        "FromPort": "161",
        "ToPort": "162",
        "SourceSecurityGroupId": { "Ref": "SecurityGroupLogicMonitor" }
      }
    },

    "SecurityGroupBastionLogicMonitorIcmpIngress": {
      "Type": "AWS::EC2::SecurityGroupIngress",
      "Properties": {
        "GroupId": { "Ref": "SecurityGroupBastion" },
        "IpProtocol": "icmp",
        "FromPort": "-1",
        "ToPort": "-1",
        "SourceSecurityGroupId": { "Ref": "SecurityGroupLogicMonitor" }
      }
    },

    "XgemailInternetSubmitSecurityGroupLb": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupDescription": "Controls access to public facing ELBs.",
        "Tags": [
          {
            "Key": "Branch",
            "Value": { "Ref" : "Branch" }

          },
          {
            "Key": "Environment",
            "Value": { "Ref" : "Environment" }
          },
          {
            "Key": "Role",
            "Value": "svc-xgemail-internet-submit-elb"

          },
          {
            "Key": "Name",
            "Value": {
              "Fn::Join": [
                "",
                [
                  {
                    "Ref": "Environment"
                  },
                  "-",
                  {
                    "Ref": "Branch"
                  },
                  "-",
                  {
                    "Ref": "AWS::StackName"
                  },
                  "/sg/xgemail/internet/submit/elb"
                ]
              ]
            }
          },
          {
            "Key": "Application",
            "Value": "internet-submit"
          },
          {
            "Key": "BusinessUnit",
            "Value": "MSG"
          },
          {
            "Key": "Project",
            "Value": "xgemail"
          },
          {
            "Key": "OwnerEmail",
            "Value": "sophosmailops@sophos.com"
          }
        ],
        "VpcId": {
          "Ref": "Vpc"
        }
      }
    },

    "XgemailInternetSubmitSecurityGroupLbIngressWorldSmtp": {
      "Type": "AWS::EC2::SecurityGroupIngress",
      "Condition" : "OpenToWorld",
      "Description" : "TCP/25 0.0.0.0/0 to internet-submit",
      "Properties": {
        "GroupId": { "Ref": "XgemailInternetSubmitSecurityGroupLb" },
        "CidrIp": "0.0.0.0/0",
        "IpProtocol": "tcp",
        "FromPort": "25",
        "ToPort": "25"
      }
    },

    "XgemailInternetSubmitSecurityGroupLbIngressWorldSmtpTls": {
      "Type": "AWS::EC2::SecurityGroupIngress",
      "Condition" : "OpenToWorld",
      "Description" : "TCP/587 0.0.0.0/0 to internet-submit",
      "Properties": {
        "GroupId": { "Ref": "XgemailInternetSubmitSecurityGroupLb" },
        "CidrIp": "0.0.0.0/0",
        "IpProtocol": "tcp",
        "FromPort": "587",
        "ToPort": "587"
      }
    },

    "XgemailInternetSubmitSecurityGroup": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupDescription": "XGEMAIL Internet Submit security group.",
        "Tags": [{
          "Key": "Name",
          "Value": {
            "Fn::Join": [ "", [
              { "Ref": "Environment" }, "-",
              { "Ref": "Branch" }, "-",
              { "Ref": "AWS::StackName" }, "/sg/xgemail/internet/submit"
            ]]
          }
        },
        {
          "Key": "Application",
          "Value": "internet-submit"
        },
        {
          "Key": "BusinessUnit",
          "Value": "MSG"
        },
        {
          "Key": "Project",
          "Value": "xgemail"
        },
        {
          "Key": "OwnerEmail",
          "Value": "sophosmailops@sophos.com"
        }],
        "SecurityGroupIngress": [
          {
            "IpProtocol": "tcp",
            "FromPort": "25",
            "ToPort": "25",
            "SourceSecurityGroupId": { "Ref": "XgemailInternetSubmitSecurityGroupLb" }
          },
          {
            "IpProtocol": "tcp",
            "FromPort": "587",
            "ToPort": "587",
            "SourceSecurityGroupId": { "Ref": "XgemailInternetSubmitSecurityGroupLb" }
          }
        ],
        "SecurityGroupEgress": [
          {
            "IpProtocol": "-1",
            "CidrIp": "0.0.0.0/0"
          }
        ],
        "VpcId": { "Ref": "Vpc" }
      }
    },

    "XgemailMfInboundSubmitSecurityGroupLb": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupDescription": "Controls access to public facing ELBs.",
        "Tags": [
          {
            "Key": "Branch",
            "Value": { "Ref" : "Branch" }

          },
          {
            "Key": "Environment",
            "Value": { "Ref" : "Environment" }
          },
          {
            "Key": "Role",
            "Value": "svc-xgemail-mf-inbound-submit-elb"

          },
          {
            "Key": "Name",
            "Value": {
              "Fn::Join": [
                "",
                [
                  {
                    "Ref": "Environment"
                  },
                  "-",
                  {
                    "Ref": "Branch"
                  },
                  "-",
                  {
                    "Ref": "AWS::StackName"
                  },
                  "/sg/xgemail/mf/inbound/submit/elb"
                ]
              ]
            }
          },
          {
            "Key": "Application",
            "Value": "mf-inbound-submit"
          },
          {
            "Key": "BusinessUnit",
            "Value": "MSG"
          },
          {
            "Key": "Project",
            "Value": "xgemail"
          },
          {
            "Key": "OwnerEmail",
            "Value": "sophosmailops@sophos.com"
          }
        ],
        "VpcId": {
          "Ref": "Vpc"
        }
      }
    },

    "XgemailMfInboundSubmitSecurityGroup": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupDescription": "XGEMAIL Mf Inbound Submit security group.",
        "Tags": [{
          "Key": "Name",
          "Value": {
            "Fn::Join": [ "", [
              { "Ref": "Environment" }, "-",
              { "Ref": "Branch" }, "-",
              { "Ref": "AWS::StackName" }, "/sg/xgemail/mf/inbound/submit"
            ]]
          }
        },
          {
            "Key": "Application",
            "Value": "mf-inbound-submit"
          },
          {
            "Key": "BusinessUnit",
            "Value": "MSG"
          },
          {
            "Key": "Project",
            "Value": "xgemail"
          },
          {
            "Key": "OwnerEmail",
            "Value": "sophosmailops@sophos.com"
          }],
        "SecurityGroupIngress": [
          {
            "IpProtocol": "tcp",
            "FromPort": "25",
            "ToPort": "25",
            "SourceSecurityGroupId": { "Ref": "XgemailMfInboundSubmitSecurityGroupLb" }
          },
          {
            "IpProtocol": "tcp",
            "FromPort": "587",
            "ToPort": "587",
            "SourceSecurityGroupId": { "Ref": "XgemailMfInboundSubmitSecurityGroupLb" }
          }
        ],
        "SecurityGroupEgress": [
          {
            "IpProtocol": "-1",
            "CidrIp": "0.0.0.0/0"
          }
        ],
        "VpcId": { "Ref": "Vpc" }
      }
    },

    "XgemailCustomerDeliverySecurityGroupLb": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupDescription": "Controls access to public facing ELBs.",
        "Tags": [
          {
            "Key": "Branch",
            "Value": { "Ref" : "Branch" }

          },
          {
            "Key": "Environment",
            "Value": { "Ref" : "Environment" }
          },
          {
            "Key": "Role",
            "Value": "svc-xgemail-customer-delivery-elb"
          },
          {
            "Key": "Name",
            "Value": {
              "Fn::Join": [
                "",
                [
                  {
                    "Ref": "Environment"
                  },
                  "-",
                  {
                    "Ref": "Branch"
                  },
                  "-",
                  {
                    "Ref": "AWS::StackName"
                  },
                  "/sg/xgemail/customer/delivery/elb"
                ]
              ]
            }
          },
          {
            "Key": "Application",
            "Value": "customer-delivery"
          },
          {
            "Key": "BusinessUnit",
            "Value": "MSG"
          },
          {
            "Key": "Project",
            "Value": "xgemail"
          },
          {
            "Key": "OwnerEmail",
            "Value": "sophosmailops@sophos.com"
          }
        ],
        "VpcId": {
          "Ref": "Vpc"
        }
      }
    },

    "XgemailCustomerDeliverySecurityGroupLbPub": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupDescription": "Controls access to public facing ELBs.",
        "Tags": [
          {
            "Key": "Branch",
            "Value": { "Ref" : "Branch" }

          },
          {
            "Key": "Environment",
            "Value": { "Ref" : "Environment" }
          },
          {
            "Key": "Role",
            "Value": "svc-xgemail-customer-delivery-elb"
          },
          {
            "Key": "Name",
            "Value": {
              "Fn::Join": [
                "",
                [
                  {
                    "Ref": "Environment"
                  },
                  "-",
                  {
                    "Ref": "Branch"
                  },
                  "-",
                  {
                    "Ref": "AWS::StackName"
                  },
                  "/sg/xgemail/customer/delivery/elb"
                ]
              ]
            }
          },
          {
            "Key": "Application",
            "Value": "customer-delivery"
          },
          {
            "Key": "BusinessUnit",
            "Value": "MSG"
          },
          {
            "Key": "Project",
            "Value": "xgemail"
          },
          {
            "Key": "OwnerEmail",
            "Value": "sophosmailops@sophos.com"
          }
        ],
        "VpcId": {
          "Ref": "Vpc"
        }
      }
    },

    "XgemailCustomerDeliverySecurityGroup": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupDescription": "Xgemail Submit security group.",
        "Tags": [{
          "Key": "Name",
          "Value": {
            "Fn::Join": [ "", [
              { "Ref": "Environment" }, "-",
              { "Ref": "Branch" }, "-",
              { "Ref": "AWS::StackName" }, "/sg/xgemail/customer/delivery"
            ]]
          }
        },
        {
          "Key": "Application",
          "Value": "customer-delivery"
        },
        {
          "Key": "BusinessUnit",
          "Value": "MSG"
        },
        {
          "Key": "Project",
          "Value": "xgemail"
        },
        {
          "Key": "OwnerEmail",
          "Value": "sophosmailops@sophos.com"
        }],
        "SecurityGroupIngress": [
          {
            "IpProtocol": "tcp",
            "FromPort": "25",
            "ToPort": "25",
            "SourceSecurityGroupId": { "Ref": "XgemailCustomerDeliverySecurityGroupLb" }
          },
          {
            "IpProtocol": "tcp",
            "FromPort": "587",
            "ToPort": "587",
            "SourceSecurityGroupId": { "Ref": "XgemailCustomerDeliverySecurityGroupLb" }
          }
        ],
        "SecurityGroupEgress": [
          {
            "IpProtocol": "-1",
            "CidrIp": "0.0.0.0/0"
          }
        ],
        "VpcId": { "Ref": "Vpc" }
      }
    },

    "XgemailCustomerDeliverySecurityGroupPub": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupDescription": "Xgemail Submit security group.",
        "Tags": [{
          "Key": "Name",
          "Value": {
            "Fn::Join": [ "", [
              { "Ref": "Environment" }, "-",
              { "Ref": "Branch" }, "-",
              { "Ref": "AWS::StackName" }, "/sg/xgemail/customer/delivery"
            ]]
          }
        },
        {
          "Key": "Application",
          "Value": "customer-delivery"
        },
        {
          "Key": "BusinessUnit",
          "Value": "MSG"
        },
        {
          "Key": "Project",
          "Value": "xgemail"
        },
        {
          "Key": "OwnerEmail",
          "Value": "sophosmailops@sophos.com"
        }],
        "SecurityGroupIngress": [
          {
            "IpProtocol": "tcp",
            "FromPort": "25",
            "ToPort": "25",
            "SourceSecurityGroupId": { "Ref": "XgemailCustomerDeliverySecurityGroupLbPub" }
          },
          {
            "IpProtocol": "tcp",
            "FromPort": "587",
            "ToPort": "587",
            "SourceSecurityGroupId": { "Ref": "XgemailCustomerDeliverySecurityGroupLbPub" }
          }
        ],
        "SecurityGroupEgress": [
          {
            "IpProtocol": "-1",
            "CidrIp": "0.0.0.0/0"
          }
        ],
        "VpcId": { "Ref": "Vpc" }
      }
    },

    "XgemailMfInboundDeliverySecurityGroupLb": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupDescription": "Controls access to public facing ELBs.",
        "Tags": [
          {
            "Key": "Branch",
            "Value": { "Ref" : "Branch" }

          },
          {
            "Key": "Environment",
            "Value": { "Ref" : "Environment" }
          },
          {
            "Key": "Role",
            "Value": "svc-xgemail-mf-inbound-delivery-elb"
          },
          {
            "Key": "Name",
            "Value": {
              "Fn::Join": [
                "",
                [
                  {
                    "Ref": "Environment"
                  },
                  "-",
                  {
                    "Ref": "Branch"
                  },
                  "-",
                  {
                    "Ref": "AWS::StackName"
                  },
                  "/sg/xgemail/mf/inbound/delivery/elb"
                ]
              ]
            }
          },
          {
            "Key": "Application",
            "Value": "mf-inbound-delivery"
          },
          {
            "Key": "BusinessUnit",
            "Value": "MSG"
          },
          {
            "Key": "Project",
            "Value": "xgemail"
          },
          {
            "Key": "OwnerEmail",
            "Value": "sophosmailops@sophos.com"
          }
        ],
        "VpcId": {
          "Ref": "Vpc"
        }
      }
    },

    "XgemailMfInboundDeliverySecurityGroup": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupDescription": "Xgemail Mf Inbound Delivery security group.",
        "Tags": [{
          "Key": "Name",
          "Value": {
            "Fn::Join": [ "", [
              { "Ref": "Environment" }, "-",
              { "Ref": "Branch" }, "-",
              { "Ref": "AWS::StackName" }, "/sg/xgemail/mf/inbound/delivery"
            ]]
          }
        },
          {
            "Key": "Application",
            "Value": "mf-inbound-delivery"
          },
          {
            "Key": "BusinessUnit",
            "Value": "MSG"
          },
          {
            "Key": "Project",
            "Value": "xgemail"
          },
          {
            "Key": "OwnerEmail",
            "Value": "sophosmailops@sophos.com"
          }],
        "SecurityGroupIngress": [
          {
            "IpProtocol": "tcp",
            "FromPort": "25",
            "ToPort": "25",
            "SourceSecurityGroupId": { "Ref": "XgemailMfInboundDeliverySecurityGroupLb" }
          },
          {
            "IpProtocol": "tcp",
            "FromPort": "587",
            "ToPort": "587",
            "SourceSecurityGroupId": { "Ref": "XgemailMfInboundDeliverySecurityGroupLb" }
          }
        ],
        "SecurityGroupEgress": [
          {
            "IpProtocol": "-1",
            "CidrIp": "0.0.0.0/0"
          }
        ],
        "VpcId": { "Ref": "Vpc" }
      }
    },

    "XgemailCustomerSubmitSecurityGroupLb": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupDescription": "Controls access to public facing ELBs.",
        "Tags": [
          {
            "Key": "Branch",
            "Value": { "Ref" : "Branch" }

          },
          {
            "Key": "Environment",
            "Value": { "Ref" : "Environment" }
          },
          {
            "Key": "Role",
            "Value": "svc-xgemail-customer-submit-elb"

          },
          {
            "Key": "Name",
            "Value": {
              "Fn::Join": [
                "",
                [
                  {
                    "Ref": "Environment"
                  },
                  "-",
                  {
                    "Ref": "Branch"
                  },
                  "-",
                  {
                    "Ref": "AWS::StackName"
                  },
                  "/sg/xgemail/customer/submit/elb"
                ]
              ]
            }
          },
          {
            "Key": "Application",
            "Value": "customer-submit"
          },
          {
            "Key": "BusinessUnit",
            "Value": "MSG"
          },
          {
            "Key": "Project",
            "Value": "xgemail"
          },
          {
            "Key": "OwnerEmail",
            "Value": "sophosmailops@sophos.com"
          }
        ],
        "VpcId": {
          "Ref": "Vpc"
        }
      }
    },

    "XgemailCustomerSubmitSecurityGroupLbIngressWorldSmtp": {
      "Type": "AWS::EC2::SecurityGroupIngress",
      "Condition" : "OpenToWorld",
      "Description" : "TCP/25 0.0.0.0/0 to customer-submit",
      "Properties": {
        "GroupId": { "Ref": "XgemailCustomerSubmitSecurityGroupLb" },
        "CidrIp": "0.0.0.0/0",
        "IpProtocol": "tcp",
        "FromPort": "25",
        "ToPort": "25"
      }
    },

    "XgemailCustomerSubmitSecurityGroupLbIngressWorldSmtpTls": {
      "Type": "AWS::EC2::SecurityGroupIngress",
      "Condition" : "OpenToWorld",
      "Description" : "TCP/587 0.0.0.0/0 to customer-submit",
      "Properties": {
        "GroupId": { "Ref": "XgemailCustomerSubmitSecurityGroupLb" },
        "CidrIp": "0.0.0.0/0",
        "IpProtocol": "tcp",
        "FromPort": "587",
        "ToPort": "587"
      }
    },

    "XgemailCustomerSubmitSecurityGroup": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupDescription": "XGEMAIL Customer Submit security group.",
        "Tags": [{
          "Key": "Name",
          "Value": {
            "Fn::Join": [ "", [
              { "Ref": "Environment" }, "-",
              { "Ref": "Branch" }, "-",
              { "Ref": "AWS::StackName" }, "/sg/xgemail/customer/submit"
            ]]
          }
        },
        {
          "Key": "Application",
          "Value": "customer-submit"
        },
        {
          "Key": "BusinessUnit",
          "Value": "MSG"
        },
        {
          "Key": "Project",
          "Value": "xgemail"
        },
        {
          "Key": "OwnerEmail",
          "Value": "sophosmailops@sophos.com"
        }],
        "SecurityGroupIngress": [
          {
            "IpProtocol": "tcp",
            "FromPort": "25",
            "ToPort": "25",
            "SourceSecurityGroupId": { "Ref": "XgemailCustomerSubmitSecurityGroupLb" }
          },
          {
            "IpProtocol": "tcp",
            "FromPort": "587",
            "ToPort": "587",
            "SourceSecurityGroupId": { "Ref": "XgemailCustomerSubmitSecurityGroupLb" }
          }
        ],
        "SecurityGroupEgress": [
          {
            "IpProtocol": "-1",
            "CidrIp": "0.0.0.0/0"
          }
        ],
        "VpcId": { "Ref": "Vpc" }
      }
    },

    "XgemailEncryptionDeliverySecurityGroupLb": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupDescription": "Controls access to public facing ELBs.",
        "Tags": [
          {
            "Key": "Branch",
            "Value": { "Ref" : "Branch" }

          },
          {
            "Key": "Environment",
            "Value": { "Ref" : "Environment" }
          },
          {
            "Key": "Role",
            "Value": "svc-xgemail-encryption-delivery-elb"

          },
          {
            "Key": "Name",
            "Value": {
              "Fn::Join": [
                "",
                [
                  {
                    "Ref": "Environment"
                  },
                  "-",
                  {
                    "Ref": "Branch"
                  },
                  "-",
                  {
                    "Ref": "AWS::StackName"
                  },
                  "/sg/xgemail/encryption/delivery/elb"
                ]
              ]
            }
          },
          {
            "Key": "Application",
            "Value": "encryption-delivery"
          },
          {
            "Key": "BusinessUnit",
            "Value": "MSG"
          },
          {
            "Key": "Project",
            "Value": "xgemail"
          },
          {
            "Key": "OwnerEmail",
            "Value": "sophosmailops@sophos.com"
          }
        ],
        "VpcId": {
          "Ref": "Vpc"
        }
      }
    },

    "XgemailEncryptionDeliverySecurityGroup": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupDescription": "Xgemail encryption delivery security group.",
        "Tags": [{
          "Key": "Name",
          "Value": {
            "Fn::Join": [ "", [
              { "Ref": "Environment" }, "-",
              { "Ref": "Branch" }, "-",
              { "Ref": "AWS::StackName" }, "/sg/xgemail/encryption/delivery"
            ]]
          }
        },
        {
          "Key": "Application",
          "Value": "encryption-delivery"
        },
        {
          "Key": "BusinessUnit",
          "Value": "MSG"
        },
        {
          "Key": "Project",
          "Value": "xgemail"
        },
        {
          "Key": "OwnerEmail",
          "Value": "sophosmailops@sophos.com"
        }],
        "SecurityGroupIngress": [
          {
            "IpProtocol": "tcp",
            "FromPort": "25",
            "ToPort": "25",
            "SourceSecurityGroupId": { "Ref": "XgemailEncryptionDeliverySecurityGroupLb" }
          }
        ],
        "SecurityGroupEgress": [
          {
            "IpProtocol": "-1",
            "CidrIp": "0.0.0.0/0"
          }
        ],
        "VpcId": { "Ref": "Vpc" }
      }
    },

    "XgemailEncryptionSubmitSecurityGroupLb": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupDescription": "Controls access to public facing ELBs.",
        "Tags": [
          {
            "Key": "Branch",
            "Value": { "Ref" : "Branch" }

          },
          {
            "Key": "Environment",
            "Value": { "Ref" : "Environment" }
          },
          {
            "Key": "Role",
            "Value": "svc-xgemail-encryption-submit-elb"

          },
          {
            "Key": "Name",
            "Value": {
              "Fn::Join": [
                "",
                [
                  {
                    "Ref": "Environment"
                  },
                  "-",
                  {
                    "Ref": "Branch"
                  },
                  "-",
                  {
                    "Ref": "AWS::StackName"
                  },
                  "/sg/xgemail/encryption/submit/elb"
                ]
              ]
            }
          },
          {
            "Key": "Application",
            "Value": "encryption-submit"
          },
          {
            "Key": "BusinessUnit",
            "Value": "MSG"
          },
          {
            "Key": "Project",
            "Value": "xgemail"
          },
          {
            "Key": "OwnerEmail",
            "Value": "sophosmailops@sophos.com"
          }
        ],
        "SecurityGroupIngress": [
          {
            "IpProtocol": "tcp",
            "FromPort": "25",
            "ToPort": "25",
            "CidrIp": "52.211.15.91/32"
          },
          {
            "IpProtocol": "tcp",
            "FromPort": "25",
            "ToPort": "25",
            "CidrIp": "52.211.67.90/32"
          },
          {
            "IpProtocol": "tcp",
            "FromPort": "25",
            "ToPort": "25",
            "CidrIp": "52.209.4.238/32"
          },
          {
            "IpProtocol": "tcp",
            "FromPort": "25",
            "ToPort": "25",
            "CidrIp": "52.209.219.173/32"
          },
          {
            "IpProtocol": "tcp",
            "FromPort": "25",
            "ToPort": "25",
            "CidrIp": "52.19.12.201/32"
          },
          {
            "IpProtocol": "tcp",
            "FromPort": "25",
            "ToPort": "25",
            "CidrIp": "52.209.235.6/32"
          },
          {
            "IpProtocol": "tcp",
            "FromPort": "25",
            "ToPort": "25",
            "CidrIp": "18.196.89.248/32"
          },
          {
            "IpProtocol": "tcp",
            "FromPort": "25",
            "ToPort": "25",
            "CidrIp": "18.184.91.171/32"
          },
          {
            "IpProtocol": "tcp",
            "FromPort": "25",
            "ToPort": "25",
            "CidrIp": "3.121.221.91/32"
          },
          {
            "IpProtocol": "tcp",
            "FromPort": "25",
            "ToPort": "25",
            "CidrIp": "3.121.255.216/32"
          },
          {
            "IpProtocol": "tcp",
            "FromPort": "25",
            "ToPort": "25",
            "CidrIp": "13.58.136.73/32"
          },
          {
            "IpProtocol": "tcp",
            "FromPort": "25",
            "ToPort": "25",
            "CidrIp": "18.191.85.155/32"
          },
          {
            "IpProtocol": "tcp",
            "FromPort": "25",
            "ToPort": "25",
            "CidrIp": "18.223.14.153/32"
          },
          {
            "IpProtocol": "tcp",
            "FromPort": "25",
            "ToPort": "25",
            "CidrIp": "18.217.225.34/32"
          },
          {
            "IpProtocol": "tcp",
            "FromPort": "25",
            "ToPort": "25",
            "CidrIp": "198.144.101.0/24"
          },
          {
            "IpProtocol": "tcp",
            "FromPort": "25",
            "ToPort": "25",
            "CidrIp": "208.70.208.0/22"
          }
        ],
        "VpcId": {
          "Ref": "Vpc"
        }
      }
    },

    "XgemailEncryptionSubmitSecurityGroup": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupDescription": "Xgemail encryption submit security group.",
        "Tags": [{
          "Key": "Name",
          "Value": {
            "Fn::Join": [ "", [
              { "Ref": "Environment" }, "-",
              { "Ref": "Branch" }, "-",
              { "Ref": "AWS::StackName" }, "/sg/xgemail/encryption/submit"
            ]]
          }
        },
        {
          "Key": "Application",
          "Value": "encryption-submit"
        },
        {
          "Key": "BusinessUnit",
          "Value": "MSG"
        },
        {
          "Key": "Project",
          "Value": "xgemail"
        },
        {
          "Key": "OwnerEmail",
          "Value": "sophosmailops@sophos.com"
        }],
        "SecurityGroupIngress": [
          {
            "IpProtocol": "tcp",
            "FromPort": "25",
            "ToPort": "25",
            "SourceSecurityGroupId": { "Ref": "XgemailEncryptionSubmitSecurityGroupLb" }
          }
        ],
        "SecurityGroupEgress": [
          {
            "IpProtocol": "-1",
            "CidrIp": "0.0.0.0/0"
          }
        ],
        "VpcId": { "Ref": "Vpc" }
      }
    },

    "XgemailInternetDeliverySecurityGroupLb": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupDescription": "Controls access to public facing ELBs.",
        "Tags": [
          {
            "Key": "Branch",
            "Value": { "Ref" : "Branch" }

          },
          {
            "Key": "Environment",
            "Value": { "Ref" : "Environment" }
          },
          {
            "Key": "Role",
            "Value": "svc-xgemail-internet-delivery-elb"

          },
          {
            "Key": "Name",
            "Value": {
              "Fn::Join": [
                "",
                [
                  {
                    "Ref": "Environment"
                  },
                  "-",
                  {
                    "Ref": "Branch"
                  },
                  "-",
                  {
                    "Ref": "AWS::StackName"
                  },
                  "/sg/xgemail/internet/delivery/elb"
                ]
              ]
            }
          },
          {
            "Key": "Application",
            "Value": "internet-delivery"
          },
          {
            "Key": "BusinessUnit",
            "Value": "MSG"
          },
          {
            "Key": "Project",
            "Value": "xgemail"
          },
          {
            "Key": "OwnerEmail",
            "Value": "sophosmailops@sophos.com"
          }
        ],
        "VpcId": {
          "Ref": "Vpc"
        }
      }
    },

    "XgemailInternetDeliverySecurityGroup": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupDescription": "Xgemail Internet Delivery security group.",
        "Tags": [{
          "Key": "Name",
          "Value": {
            "Fn::Join": [ "", [
              { "Ref": "Environment" }, "-",
              { "Ref": "Branch" }, "-",
              { "Ref": "AWS::StackName" }, "/sg/xgemail/internet/delivery"
            ]]
          }
        },
        {
          "Key": "Application",
          "Value": "internet-delivery"
        },
        {
          "Key": "BusinessUnit",
          "Value": "MSG"
        },
        {
          "Key": "Project",
          "Value": "xgemail"
        },
        {
          "Key": "OwnerEmail",
          "Value": "sophosmailops@sophos.com"
        }],
        "SecurityGroupIngress": [
          {
            "IpProtocol": "tcp",
            "FromPort": "25",
            "ToPort": "25",
            "SourceSecurityGroupId": { "Ref": "XgemailInternetDeliverySecurityGroupLb" }
          },
          {
            "IpProtocol": "tcp",
            "FromPort": "587",
            "ToPort": "587",
            "SourceSecurityGroupId": { "Ref": "XgemailInternetDeliverySecurityGroupLb" }
          }
        ],
        "SecurityGroupEgress": [
          {
            "IpProtocol": "-1",
            "CidrIp": "0.0.0.0/0"
          }
        ],
        "VpcId": { "Ref": "Vpc" }
      }
    },

    "XgemailRiskyDeliverySecurityGroupLb": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupDescription": "Controls access to public facing ELBs.",
        "Tags": [
          {
            "Key": "Branch",
            "Value": { "Ref" : "Branch" }

          },
          {
            "Key": "Environment",
            "Value": { "Ref" : "Environment" }
          },
          {
            "Key": "Role",
            "Value": "svc-xgemail-risky-delivery-elb"

          },
          {
            "Key": "Name",
            "Value": {
              "Fn::Join": [
                "",
                [
                  {
                    "Ref": "Environment"
                  },
                  "-",
                  {
                    "Ref": "Branch"
                  },
                  "-",
                  {
                    "Ref": "AWS::StackName"
                  },
                  "/sg/xgemail/risky/delivery/elb"
                ]
              ]
            }
          },
          {
            "Key": "Application",
            "Value": "risky-delivery"
          },
          {
            "Key": "BusinessUnit",
            "Value": "MSG"
          },
          {
            "Key": "Project",
            "Value": "xgemail"
          },
          {
            "Key": "OwnerEmail",
            "Value": "sophosmailops@sophos.com"
          }
        ],
        "VpcId": {
          "Ref": "Vpc"
        }
      }
    },

    "XgemailMfOutboundSubmitSecurityGroupLb": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupDescription": "Controls access to public facing ELBs.",
        "Tags": [
          {
            "Key": "Branch",
            "Value": { "Ref" : "Branch" }

          },
          {
            "Key": "Environment",
            "Value": { "Ref" : "Environment" }
          },
          {
            "Key": "Role",
            "Value": "svc-xgemail-mf-outbound-submit-elb"

          },
          {
            "Key": "Name",
            "Value": {
              "Fn::Join": [
                "",
                [
                  {
                    "Ref": "Environment"
                  },
                  "-",
                  {
                    "Ref": "Branch"
                  },
                  "-",
                  {
                    "Ref": "AWS::StackName"
                  },
                  "/sg/xgemail/mf/outbound/submit/elb"
                ]
              ]
            }
          },
          {
            "Key": "Application",
            "Value": "mf-outbound-submit"
          },
          {
            "Key": "BusinessUnit",
            "Value": "MSG"
          },
          {
            "Key": "Project",
            "Value": "xgemail"
          },
          {
            "Key": "OwnerEmail",
            "Value": "sophosmailops@sophos.com"
          }
        ],
        "VpcId": {
          "Ref": "Vpc"
        }
      }
    },

    "XgemailMfOutboundSubmitSecurityGroup": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupDescription": "XGEMAIL Mf Outbound Submit security group.",
        "Tags": [{
          "Key": "Name",
          "Value": {
            "Fn::Join": [ "", [
              { "Ref": "Environment" }, "-",
              { "Ref": "Branch" }, "-",
              { "Ref": "AWS::StackName" }, "/sg/xgemail/mf/outbound/submit"
            ]]
          }
        },
          {
            "Key": "Application",
            "Value": "mf-outbound-submit"
          },
          {
            "Key": "BusinessUnit",
            "Value": "MSG"
          },
          {
            "Key": "Project",
            "Value": "xgemail"
          },
          {
            "Key": "OwnerEmail",
            "Value": "sophosmailops@sophos.com"
          }],
        "SecurityGroupIngress": [
          {
            "IpProtocol": "tcp",
            "FromPort": "25",
            "ToPort": "25",
            "SourceSecurityGroupId": { "Ref": "XgemailMfOutboundSubmitSecurityGroupLb" }
          },
          {
            "IpProtocol": "tcp",
            "FromPort": "587",
            "ToPort": "587",
            "SourceSecurityGroupId": { "Ref": "XgemailMfOutboundSubmitSecurityGroupLb" }
          }
        ],
        "SecurityGroupEgress": [
          {
            "IpProtocol": "-1",
            "CidrIp": "0.0.0.0/0"
          }
        ],
        "VpcId": { "Ref": "Vpc" }
      }
    },

    "XgemailMfOutboundDeliverySecurityGroupLb": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupDescription": "Controls access to public facing ELBs.",
        "Tags": [
          {
            "Key": "Branch",
            "Value": { "Ref" : "Branch" }

          },
          {
            "Key": "Environment",
            "Value": { "Ref" : "Environment" }
          },
          {
            "Key": "Role",
            "Value": "svc-xgemail-mf-outbound-delivery-elb"

          },
          {
            "Key": "Name",
            "Value": {
              "Fn::Join": [
                "",
                [
                  {
                    "Ref": "Environment"
                  },
                  "-",
                  {
                    "Ref": "Branch"
                  },
                  "-",
                  {
                    "Ref": "AWS::StackName"
                  },
                  "/sg/xgemail/mf/outbound/delivery/elb"
                ]
              ]
            }
          },
          {
            "Key": "Application",
            "Value": "mf-outbound-delivery"
          },
          {
            "Key": "BusinessUnit",
            "Value": "MSG"
          },
          {
            "Key": "Project",
            "Value": "xgemail"
          },
          {
            "Key": "OwnerEmail",
            "Value": "sophosmailops@sophos.com"
          }
        ],
        "VpcId": {
          "Ref": "Vpc"
        }
      }
    },

    "XgemailMfOutboundDeliverySecurityGroup": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupDescription": "Xgemail Mf Outbound Delivery security group.",
        "Tags": [{
          "Key": "Name",
          "Value": {
            "Fn::Join": [ "", [
              { "Ref": "Environment" }, "-",
              { "Ref": "Branch" }, "-",
              { "Ref": "AWS::StackName" }, "/sg/xgemail/mf/outbound/delivery"
            ]]
          }
        },
          {
            "Key": "Application",
            "Value": "mf-outbound-delivery"
          },
          {
            "Key": "BusinessUnit",
            "Value": "MSG"
          },
          {
            "Key": "Project",
            "Value": "xgemail"
          },
          {
            "Key": "OwnerEmail",
            "Value": "sophosmailops@sophos.com"
          }],
        "SecurityGroupIngress": [
          {
            "IpProtocol": "tcp",
            "FromPort": "25",
            "ToPort": "25",
            "SourceSecurityGroupId": { "Ref": "XgemailMfOutboundDeliverySecurityGroupLb" }
          },
          {
            "IpProtocol": "tcp",
            "FromPort": "587",
            "ToPort": "587",
            "SourceSecurityGroupId": { "Ref": "XgemailMfOutboundDeliverySecurityGroupLb" }
          }
        ],
        "SecurityGroupEgress": [
          {
            "IpProtocol": "-1",
            "CidrIp": "0.0.0.0/0"
          }
        ],
        "VpcId": { "Ref": "Vpc" }
      }
    },

    "XgemailMfInboundXdeliverySecurityGroupLb": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupDescription": "Controls access to internal facing Mf Inbound Xdelivery ELB.",
        "Tags": [
          {
            "Key": "Branch",
            "Value": {"Ref": "Branch"}

          },
          {
            "Key": "Environment",
            "Value": {"Ref": "Environment"}
          },
          {
            "Key": "Role",
            "Value": "svc-xgemail-mf-inbound-xdelivery-elb"

          },
          {
            "Key": "Name",
            "Value": {
              "Fn::Join": [
                "",
                [
                  {
                    "Ref": "Environment"
                  },
                  "-",
                  {
                    "Ref": "Branch"
                  },
                  "-",
                  {
                    "Ref": "AWS::StackName"
                  },
                  "/sg/xgemail/mf/inbound/xdelivery/elb"
                ]
              ]
            }
          },
          {
            "Key": "Application",
            "Value": "mf-inbound-xdelivery"
          },
          {
            "Key": "BusinessUnit",
            "Value": "MSG"
          },
          {
            "Key": "Project",
            "Value": "xgemail"
          },
          {
            "Key": "OwnerEmail",
            "Value": "sophosmailops@sophos.com"
          }
        ],
        "VpcId": {
          "Ref": "Vpc"
        }
      }
    },

    "XgemailMfInboundXdeliverySecurityGroup": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupDescription": "Xgemail Mf Inbound Xdelivery security group.",
        "Tags": [
          {
            "Key": "Name",
            "Value": {
              "Fn::Join": [
                "", [
                  { "Ref": "Environment" }, "-",
                  { "Ref": "Branch" }, "-",
                  { "Ref": "AWS::StackName" }, "/sg/xgemail/mf/inbound/xdelivery"
                ]
              ]
            }
          },
          {
            "Key": "Application",
            "Value": "mf-inbound-xdelivery"
          },
          {
            "Key": "BusinessUnit",
            "Value": "MSG"
          },
          {
            "Key": "Project",
            "Value": "xgemail"
          },
          {
            "Key": "OwnerEmail",
            "Value": "sophosmailops@sophos.com"
          }
        ],
        "SecurityGroupIngress": [
          {
            "IpProtocol": "tcp",
            "FromPort": "8025",
            "ToPort": "8025",
            "SourceSecurityGroupId": { "Ref": "XgemailMfInboundXdeliverySecurityGroupLb" }
          }
        ],
        "SecurityGroupEgress": [
          {
            "IpProtocol": "-1",
            "CidrIp": "0.0.0.0/0"
          }
        ],
        "VpcId": { "Ref": "Vpc" }
      }
    },

    "XgemailMfOutboundXdeliverySecurityGroupLb": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupDescription": "Controls access to internal facing Mf Outbound Xdelivery ELB.",
        "Tags": [
          {
            "Key": "Branch",
            "Value": {"Ref": "Branch"}

          },
          {
            "Key": "Environment",
            "Value": {"Ref": "Environment"}
          },
          {
            "Key": "Role",
            "Value": "svc-xgemail-mf-outbound-xdelivery-elb"

          },
          {
            "Key": "Name",
            "Value": {
              "Fn::Join": [
                "",
                [
                  {
                    "Ref": "Environment"
                  },
                  "-",
                  {
                    "Ref": "Branch"
                  },
                  "-",
                  {
                    "Ref": "AWS::StackName"
                  },
                  "/sg/xgemail/mf/outbound/xdelivery/elb"
                ]
              ]
            }
          },
          {
            "Key": "Application",
            "Value": "mf-outbound-xdelivery"
          },
          {
            "Key": "BusinessUnit",
            "Value": "MSG"
          },
          {
            "Key": "Project",
            "Value": "xgemail"
          },
          {
            "Key": "OwnerEmail",
            "Value": "sophosmailops@sophos.com"
          }
        ],
        "VpcId": {
          "Ref": "Vpc"
        }
      }
    },

    "XgemailMfOutboundXdeliverySecurityGroup": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupDescription": "Xgemail Mf Outbound Xdelivery security group.",
        "Tags": [
          {
            "Key": "Name",
            "Value": {
              "Fn::Join": [
                "", [
                  { "Ref": "Environment" }, "-",
                  { "Ref": "Branch" }, "-",
                  { "Ref": "AWS::StackName" }, "/sg/xgemail/mf/outbound/xdelivery"
                ]
              ]
            }
          },
          {
            "Key": "Application",
            "Value": "mf-outbound-xdelivery"
          },
          {
            "Key": "BusinessUnit",
            "Value": "MSG"
          },
          {
            "Key": "Project",
            "Value": "xgemail"
          },
          {
            "Key": "OwnerEmail",
            "Value": "sophosmailops@sophos.com"
          }
        ],
        "SecurityGroupIngress": [
          {
            "IpProtocol": "tcp",
            "FromPort": "8025",
            "ToPort": "8025",
            "SourceSecurityGroupId": { "Ref": "XgemailMfOutboundXdeliverySecurityGroupLb" }
          }
        ],
        "SecurityGroupEgress": [
          {
            "IpProtocol": "-1",
            "CidrIp": "0.0.0.0/0"
          }
        ],
        "VpcId": { "Ref": "Vpc" }
      }
    },

    "XgemailRiskyDeliverySecurityGroup": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupDescription": "Xgemail Risky Delivery security group.",
        "Tags": [{
          "Key": "Name",
          "Value": {
            "Fn::Join": [ "", [
              { "Ref": "Environment" }, "-",
              { "Ref": "Branch" }, "-",
              { "Ref": "AWS::StackName" }, "/sg/xgemail/risky/delivery"
            ]]
          }
        },
        {
          "Key": "Application",
          "Value": "risky-delivery"
        },
        {
          "Key": "BusinessUnit",
          "Value": "MSG"
        },
        {
          "Key": "Project",
          "Value": "xgemail"
        },
        {
          "Key": "OwnerEmail",
          "Value": "sophosmailops@sophos.com"
        }],
        "SecurityGroupIngress": [
          {
            "IpProtocol": "tcp",
            "FromPort": "25",
            "ToPort": "25",
            "SourceSecurityGroupId": { "Ref": "XgemailRiskyDeliverySecurityGroupLb" }
          },
          {
            "IpProtocol": "tcp",
            "FromPort": "587",
            "ToPort": "587",
            "SourceSecurityGroupId": { "Ref": "XgemailRiskyDeliverySecurityGroupLb" }
          }
        ],
        "SecurityGroupEgress": [
          {
            "IpProtocol": "-1",
            "CidrIp": "0.0.0.0/0"
          }
        ],
        "VpcId": { "Ref": "Vpc" }
      }
    },

    "XgemailWarmupDeliverySecurityGroupLb": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupDescription": "Controls access to public facing ELBs.",
        "Tags": [
          {
            "Key": "Branch",
            "Value": { "Ref" : "Branch" }

          },
          {
            "Key": "Environment",
            "Value": { "Ref" : "Environment" }
          },
          {
            "Key": "Role",
            "Value": "svc-xgemail-warmup-delivery-elb"

          },
          {
            "Key": "Name",
            "Value": {
              "Fn::Join": [
                "",
                [
                  {
                    "Ref": "Environment"
                  },
                  "-",
                  {
                    "Ref": "Branch"
                  },
                  "-",
                  {
                    "Ref": "AWS::StackName"
                  },
                  "/sg/xgemail/warmup/delivery/elb"
                ]
              ]
            }
          },
          {
            "Key": "Application",
            "Value": "warmup-delivery"
          },
          {
            "Key": "BusinessUnit",
            "Value": "MSG"
          },
          {
            "Key": "Project",
            "Value": "xgemail"
          },
          {
            "Key": "OwnerEmail",
            "Value": "sophosmailops@sophos.com"
          }
        ],
        "VpcId": {
          "Ref": "Vpc"
        }
      }
    },

    "XgemailWarmupDeliverySecurityGroup": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupDescription": "Xgemail Warmup Delivery security group.",
        "Tags": [{
          "Key": "Name",
          "Value": {
            "Fn::Join": [ "", [
              { "Ref": "Environment" }, "-",
              { "Ref": "Branch" }, "-",
              { "Ref": "AWS::StackName" }, "/sg/xgemail/warmup/delivery"
            ]]
          }
        },
        {
          "Key": "Application",
          "Value": "warmup-delivery"
        },
        {
          "Key": "BusinessUnit",
          "Value": "MSG"
        },
        {
          "Key": "Project",
          "Value": "xgemail"
        },
        {
          "Key": "OwnerEmail",
          "Value": "sophosmailops@sophos.com"
        }],
        "SecurityGroupIngress": [
          {
            "IpProtocol": "tcp",
            "FromPort": "25",
            "ToPort": "25",
            "SourceSecurityGroupId": { "Ref": "XgemailWarmupDeliverySecurityGroupLb" }
          },
          {
            "IpProtocol": "tcp",
            "FromPort": "587",
            "ToPort": "587",
            "SourceSecurityGroupId": { "Ref": "XgemailWarmupDeliverySecurityGroupLb" }
          }
        ],
        "SecurityGroupEgress": [
          {
            "IpProtocol": "-1",
            "CidrIp": "0.0.0.0/0"
          }
        ],
        "VpcId": { "Ref": "Vpc" }
      }
    },

    "XgemailBetaDeliverySecurityGroupLb": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupDescription": "Controls access to public facing ELBs.",
        "Tags": [
          {
            "Key": "Branch",
            "Value": { "Ref" : "Branch" }

          },
          {
            "Key": "Environment",
            "Value": { "Ref" : "Environment" }
          },
          {
            "Key": "Role",
            "Value": "svc-xgemail-beta-delivery-elb"

          },
          {
            "Key": "Name",
            "Value": {
              "Fn::Join": [
                "",
                [
                  {
                    "Ref": "Environment"
                  },
                  "-",
                  {
                    "Ref": "Branch"
                  },
                  "-",
                  {
                    "Ref": "AWS::StackName"
                  },
                  "/sg/xgemail/beta/delivery/elb"
                ]
              ]
            }
          },
          {
            "Key": "Application",
            "Value": "beta-delivery"
          },
          {
            "Key": "BusinessUnit",
            "Value": "MSG"
          },
          {
            "Key": "Project",
            "Value": "xgemail"
          },
          {
            "Key": "OwnerEmail",
            "Value": "sophosmailops@sophos.com"
          }
        ],
        "VpcId": {
          "Ref": "Vpc"
        }
      }
    },

    "XgemailBetaDeliverySecurityGroup": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupDescription": "Xgemail Beta Delivery security group.",
        "Tags": [{
          "Key": "Name",
          "Value": {
            "Fn::Join": [ "", [
              { "Ref": "Environment" }, "-",
              { "Ref": "Branch" }, "-",
              { "Ref": "AWS::StackName" }, "/sg/xgemail/beta/delivery"
            ]]
          }
        },
          {
            "Key": "Application",
            "Value": "beta-delivery"
          },
          {
            "Key": "BusinessUnit",
            "Value": "MSG"
          },
          {
            "Key": "Project",
            "Value": "xgemail"
          },
          {
            "Key": "OwnerEmail",
            "Value": "sophosmailops@sophos.com"
          }],
        "SecurityGroupIngress": [
          {
            "IpProtocol": "tcp",
            "FromPort": "25",
            "ToPort": "25",
            "SourceSecurityGroupId": { "Ref": "XgemailBetaDeliverySecurityGroupLb" }
          },
          {
            "IpProtocol": "tcp",
            "FromPort": "587",
            "ToPort": "587",
            "SourceSecurityGroupId": { "Ref": "XgemailBetaDeliverySecurityGroupLb" }
          }
        ],
        "SecurityGroupEgress": [
          {
            "IpProtocol": "-1",
            "CidrIp": "0.0.0.0/0"
          }
        ],
        "VpcId": { "Ref": "Vpc" }
      }
    },

    "XgemailDeltaDeliverySecurityGroupLb": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupDescription": "Controls access to public facing ELBs.",
        "Tags": [
          {
            "Key": "Branch",
            "Value": { "Ref" : "Branch" }

          },
          {
            "Key": "Environment",
            "Value": { "Ref" : "Environment" }
          },
          {
            "Key": "Role",
            "Value": "svc-xgemail-delta-delivery-elb"

          },
          {
            "Key": "Name",
            "Value": {
              "Fn::Join": [
                "",
                [
                  {
                    "Ref": "Environment"
                  },
                  "-",
                  {
                    "Ref": "Branch"
                  },
                  "-",
                  {
                    "Ref": "AWS::StackName"
                  },
                  "/sg/xgemail/delta/delivery/elb"
                ]
              ]
            }
          },
          {
            "Key": "Application",
            "Value": "delta-delivery"
          },
          {
            "Key": "BusinessUnit",
            "Value": "MSG"
          },
          {
            "Key": "Project",
            "Value": "xgemail"
          },
          {
            "Key": "OwnerEmail",
            "Value": "sophosmailops@sophos.com"
          }
        ],
        "VpcId": {
          "Ref": "Vpc"
        }
      }
    },

    "XgemailDeltaDeliverySecurityGroup": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupDescription": "Xgemail Delta Delivery security group.",
        "Tags": [{
          "Key": "Name",
          "Value": {
            "Fn::Join": [ "", [
              { "Ref": "Environment" }, "-",
              { "Ref": "Branch" }, "-",
              { "Ref": "AWS::StackName" }, "/sg/xgemail/delta/delivery"
            ]]
          }
        },
        {
          "Key": "Application",
          "Value": "delta-delivery"
        },
        {
          "Key": "BusinessUnit",
          "Value": "MSG"
        },
        {
          "Key": "Project",
          "Value": "xgemail"
        },
        {
          "Key": "OwnerEmail",
          "Value": "sophosmailops@sophos.com"
        }],
        "SecurityGroupIngress": [
          {
            "IpProtocol": "tcp",
            "FromPort": "25",
            "ToPort": "25",
            "SourceSecurityGroupId": { "Ref": "XgemailDeltaDeliverySecurityGroupLb" }
          },
          {
            "IpProtocol": "tcp",
            "FromPort": "587",
            "ToPort": "587",
            "SourceSecurityGroupId": { "Ref": "XgemailDeltaDeliverySecurityGroupLb" }
          }
        ],
        "SecurityGroupEgress": [
          {
            "IpProtocol": "-1",
            "CidrIp": "0.0.0.0/0"
          }
        ],
        "VpcId": { "Ref": "Vpc" }
      }
    },

    "XgemailXdeliverySecurityGroupLb": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupDescription": "Controls access to internal facing Xdelivery ELB.",
        "Tags": [
          {
            "Key": "Branch",
            "Value": {"Ref": "Branch"}

          },
          {
            "Key": "Environment",
            "Value": {"Ref": "Environment"}
          },
          {
            "Key": "Role",
            "Value": "svc-xgemail-xdelivery-elb"

          },
          {
            "Key": "Name",
            "Value": {
              "Fn::Join": [
                "",
                [
                  {
                    "Ref": "Environment"
                  },
                  "-",
                  {
                    "Ref": "Branch"
                  },
                  "-",
                  {
                    "Ref": "AWS::StackName"
                  },
                  "/sg/xgemail/xdelivery/elb"
                ]
              ]
            }
          },
          {
            "Key": "Application",
            "Value": "customer-xdelivery"
          },
          {
            "Key": "BusinessUnit",
            "Value": "MSG"
          },
          {
            "Key": "Project",
            "Value": "xgemail"
          },
          {
            "Key": "OwnerEmail",
            "Value": "sophosmailops@sophos.com"
          }
        ],
        "VpcId": {
          "Ref": "Vpc"
        }
      }
    },

    "XgemailXdeliverySecurityGroup": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupDescription": "Xgemail Xdelivery security group.",
        "Tags": [
          {
            "Key": "Name",
            "Value": {
              "Fn::Join": [
                "", [
                  { "Ref": "Environment" }, "-",
                  { "Ref": "Branch" }, "-",
                  { "Ref": "AWS::StackName" }, "/sg/xgemail/xdelivery"
                ]
              ]
            }
          },
          {
            "Key": "Application",
            "Value": "customer-xdelivery"
          },
          {
            "Key": "BusinessUnit",
            "Value": "MSG"
          },
          {
            "Key": "Project",
            "Value": "xgemail"
          },
          {
            "Key": "OwnerEmail",
            "Value": "sophosmailops@sophos.com"
          }
        ],
        "SecurityGroupIngress": [
          {
            "IpProtocol": "tcp",
            "FromPort": "8025",
            "ToPort": "8025",
            "SourceSecurityGroupId": { "Ref": "XgemailXdeliverySecurityGroupLb" }
          }
        ],
        "SecurityGroupEgress": [
          {
            "IpProtocol": "-1",
            "CidrIp": "0.0.0.0/0"
          }
        ],
        "VpcId": { "Ref": "Vpc" }
      }
    },

    "XgemailInternetXdeliverySecurityGroupLb": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupDescription": "Controls access to internal facing internet Xdelivery ELB.",
        "Tags": [
          {
            "Key": "Branch",
            "Value": {"Ref": "Branch"}

          },
          {
            "Key": "Environment",
            "Value": {"Ref": "Environment"}
          },
          {
            "Key": "Role",
            "Value": "svc-xgemail-internet-xdelivery-elb"

          },
          {
            "Key": "Name",
            "Value": {
              "Fn::Join": [
                "",
                [
                  {
                    "Ref": "Environment"
                  },
                  "-",
                  {
                    "Ref": "Branch"
                  },
                  "-",
                  {
                    "Ref": "AWS::StackName"
                  },
                  "/sg/xgemail/internet/xdelivery/elb"
                ]
              ]
            }
          },
          {
            "Key": "Application",
            "Value": "internet-xdelivery"
          },
          {
            "Key": "BusinessUnit",
            "Value": "MSG"
          },
          {
            "Key": "Project",
            "Value": "xgemail"
          },
          {
            "Key": "OwnerEmail",
            "Value": "sophosmailops@sophos.com"
          }
        ],
        "VpcId": {
          "Ref": "Vpc"
        }
      }
    },

    "XgemailInternetXdeliverySecurityGroup": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupDescription": "Xgemail Internet Xdelivery security group.",
        "Tags": [
          {
            "Key": "Name",
            "Value": {
              "Fn::Join": [
                "", [
                  { "Ref": "Environment" }, "-",
                  { "Ref": "Branch" }, "-",
                  { "Ref": "AWS::StackName" }, "/sg/xgemail/internet/xdelivery"
                ]
              ]
            }
          },
          {
            "Key": "Application",
            "Value": "internet-xdelivery"
          },
          {
            "Key": "BusinessUnit",
            "Value": "MSG"
          },
          {
            "Key": "Project",
            "Value": "xgemail"
          },
          {
            "Key": "OwnerEmail",
            "Value": "sophosmailops@sophos.com"
          }
        ],
        "SecurityGroupIngress": [
          {
            "IpProtocol": "tcp",
            "FromPort": "8025",
            "ToPort": "8025",
            "SourceSecurityGroupId": { "Ref": "XgemailInternetXdeliverySecurityGroupLb" }
          }
        ],
        "SecurityGroupEgress": [
          {
            "IpProtocol": "-1",
            "CidrIp": "0.0.0.0/0"
          }
        ],
        "VpcId": { "Ref": "Vpc" }
      }
    },

    "XgemailRiskyXdeliverySecurityGroupLb": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupDescription": "Controls access to internal facing risky Xdelivery ELB.",
        "Tags": [
          {
            "Key": "Branch",
            "Value": {"Ref": "Branch"}

          },
          {
            "Key": "Environment",
            "Value": {"Ref": "Environment"}
          },
          {
            "Key": "Role",
            "Value": "svc-xgemail-risky-xdelivery-elb"

          },
          {
            "Key": "Name",
            "Value": {
              "Fn::Join": [
                "",
                [
                  {
                    "Ref": "Environment"
                  },
                  "-",
                  {
                    "Ref": "Branch"
                  },
                  "-",
                  {
                    "Ref": "AWS::StackName"
                  },
                  "/sg/xgemail/risky/xdelivery/elb"
                ]
              ]
            }
          },
          {
            "Key": "Application",
            "Value": "risky-xdelivery"
          },
          {
            "Key": "BusinessUnit",
            "Value": "MSG"
          },
          {
            "Key": "Project",
            "Value": "xgemail"
          },
          {
            "Key": "OwnerEmail",
            "Value": "sophosmailops@sophos.com"
          }
        ],
        "VpcId": {
          "Ref": "Vpc"
        }
      }
    },

    "XgemailRiskyXdeliverySecurityGroup": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupDescription": "Xgemail Risky Xdelivery security group.",
        "Tags": [
          {
            "Key": "Name",
            "Value": {
              "Fn::Join": [
                "", [
                  { "Ref": "Environment" }, "-",
                  { "Ref": "Branch" }, "-",
                  { "Ref": "AWS::StackName" }, "/sg/xgemail/risky/xdelivery"
                ]
              ]
            }
          },
          {
            "Key": "Application",
            "Value": "risky-xdelivery"
          },
          {
            "Key": "BusinessUnit",
            "Value": "MSG"
          },
          {
            "Key": "Project",
            "Value": "xgemail"
          },
          {
            "Key": "OwnerEmail",
            "Value": "sophosmailops@sophos.com"
          }
        ],
        "SecurityGroupIngress": [
          {
            "IpProtocol": "tcp",
            "FromPort": "8025",
            "ToPort": "8025",
            "SourceSecurityGroupId": { "Ref": "XgemailRiskyXdeliverySecurityGroupLb" }
          }
        ],
        "SecurityGroupEgress": [
          {
            "IpProtocol": "-1",
            "CidrIp": "0.0.0.0/0"
          }
        ],
        "VpcId": { "Ref": "Vpc" }
      }
    },

    "XgemailWarmupXdeliverySecurityGroupLb": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupDescription": "Controls access to internal facing warmup Xdelivery ELB.",
        "Tags": [
          {
            "Key": "Branch",
            "Value": {"Ref": "Branch"}

          },
          {
            "Key": "Environment",
            "Value": {"Ref": "Environment"}
          },
          {
            "Key": "Role",
            "Value": "svc-xgemail-warmup-xdelivery-elb"

          },
          {
            "Key": "Name",
            "Value": {
              "Fn::Join": [
                "",
                [
                  {
                    "Ref": "Environment"
                  },
                  "-",
                  {
                    "Ref": "Branch"
                  },
                  "-",
                  {
                    "Ref": "AWS::StackName"
                  },
                  "/sg/xgemail/warmup/xdelivery/elb"
                ]
              ]
            }
          },
          {
            "Key": "Application",
            "Value": "warmup-xdelivery"
          },
          {
            "Key": "BusinessUnit",
            "Value": "MSG"
          },
          {
            "Key": "Project",
            "Value": "xgemail"
          },
          {
            "Key": "OwnerEmail",
            "Value": "sophosmailops@sophos.com"
          }
        ],
        "VpcId": {
          "Ref": "Vpc"
        }
      }
    },

    "XgemailWarmupXdeliverySecurityGroup": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupDescription": "Xgemail Warmup Xdelivery security group.",
        "Tags": [
          {
            "Key": "Name",
            "Value": {
              "Fn::Join": [
                "", [
                  { "Ref": "Environment" }, "-",
                  { "Ref": "Branch" }, "-",
                  { "Ref": "AWS::StackName" }, "/sg/xgemail/warmup/xdelivery"
                ]
              ]
            }
          },
          {
            "Key": "Application",
            "Value": "warmup-xdelivery"
          },
          {
            "Key": "BusinessUnit",
            "Value": "MSG"
          },
          {
            "Key": "Project",
            "Value": "xgemail"
          },
          {
            "Key": "OwnerEmail",
            "Value": "sophosmailops@sophos.com"
          }
        ],
        "SecurityGroupIngress": [
          {
            "IpProtocol": "tcp",
            "FromPort": "8025",
            "ToPort": "8025",
            "SourceSecurityGroupId": { "Ref": "XgemailWarmupXdeliverySecurityGroupLb" }
          }
        ],
        "SecurityGroupEgress": [
          {
            "IpProtocol": "-1",
            "CidrIp": "0.0.0.0/0"
          }
        ],
        "VpcId": { "Ref": "Vpc" }
      }
    },

    "XgemailDeltaXdeliverySecurityGroupLb": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupDescription": "Controls access to internal facing delta Xdelivery ELB.",
        "Tags": [
          {
            "Key": "Branch",
            "Value": {"Ref": "Branch"}

          },
          {
            "Key": "Environment",
            "Value": {"Ref": "Environment"}
          },
          {
            "Key": "Role",
            "Value": "svc-xgemail-delta-xdelivery-elb"

          },
          {
            "Key": "Name",
            "Value": {
              "Fn::Join": [
                "",
                [
                  {
                    "Ref": "Environment"
                  },
                  "-",
                  {
                    "Ref": "Branch"
                  },
                  "-",
                  {
                    "Ref": "AWS::StackName"
                  },
                  "/sg/xgemail/delta/xdelivery/elb"
                ]
              ]
            }
          },
          {
            "Key": "Application",
            "Value": "delta-xdelivery"
          },
          {
            "Key": "BusinessUnit",
            "Value": "MSG"
          },
          {
            "Key": "Project",
            "Value": "xgemail"
          },
          {
            "Key": "OwnerEmail",
            "Value": "sophosmailops@sophos.com"
          }
        ],
        "VpcId": {
          "Ref": "Vpc"
        }
      }
    },

    "XgemailDeltaXdeliverySecurityGroup": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupDescription": "Xgemail Delta Xdelivery security group.",
        "Tags": [
          {
            "Key": "Name",
            "Value": {
              "Fn::Join": [
                "", [
                  { "Ref": "Environment" }, "-",
                  { "Ref": "Branch" }, "-",
                  { "Ref": "AWS::StackName" }, "/sg/xgemail/delta/xdelivery"
                ]
              ]
            }
          },
          {
            "Key": "Application",
            "Value": "delta-xdelivery"
          },
          {
            "Key": "BusinessUnit",
            "Value": "MSG"
          },
          {
            "Key": "Project",
            "Value": "xgemail"
          },
          {
            "Key": "OwnerEmail",
            "Value": "sophosmailops@sophos.com"
          }
        ],
        "SecurityGroupIngress": [
          {
            "IpProtocol": "tcp",
            "FromPort": "8025",
            "ToPort": "8025",
            "SourceSecurityGroupId": { "Ref": "XgemailDeltaXdeliverySecurityGroupLb" }
          }
        ],
        "SecurityGroupEgress": [
          {
            "IpProtocol": "-1",
            "CidrIp": "0.0.0.0/0"
          }
        ],
        "VpcId": { "Ref": "Vpc" }
      }
    },

    "XgemailBetaXdeliverySecurityGroupLb": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupDescription": "Controls access to internal facing beta Xdelivery ELB.",
        "Tags": [
          {
            "Key": "Branch",
            "Value": {"Ref": "Branch"}

          },
          {
            "Key": "Environment",
            "Value": {"Ref": "Environment"}
          },
          {
            "Key": "Role",
            "Value": "svc-xgemail-beta-xdelivery-elb"

          },
          {
            "Key": "Name",
            "Value": {
              "Fn::Join": [
                "",
                [
                  {
                    "Ref": "Environment"
                  },
                  "-",
                  {
                    "Ref": "Branch"
                  },
                  "-",
                  {
                    "Ref": "AWS::StackName"
                  },
                  "/sg/xgemail/beta/xdelivery/elb"
                ]
              ]
            }
          }
        ],
        "VpcId": {
          "Ref": "Vpc"
        }
      }
    },

    "XgemailBetaXdeliverySecurityGroup": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupDescription": "Xgemail Beta Xdelivery security group.",
        "Tags": [
          {
            "Key": "Name",
            "Value": {
              "Fn::Join": [
                "", [
                  { "Ref": "Environment" }, "-",
                  { "Ref": "Branch" }, "-",
                  { "Ref": "AWS::StackName" }, "/sg/xgemail/beta/xdelivery"
                ]
              ]
            }
          }
        ],
        "SecurityGroupIngress": [
          {
            "IpProtocol": "tcp",
            "FromPort": "8025",
            "ToPort": "8025",
            "SourceSecurityGroupId": { "Ref": "XgemailBetaXdeliverySecurityGroupLb" }
          }
        ],
        "SecurityGroupEgress": [
          {
            "IpProtocol": "-1",
            "CidrIp": "0.0.0.0/0"
          }
        ],
        "VpcId": { "Ref": "Vpc" }
      }
    },

    "XgemailXdeliverySecurityGroupLbIngressCustomerDeliverySmtp": {
      "Type": "AWS::EC2::SecurityGroupIngress",
      "Properties": {
        "GroupId": { "Ref": "XgemailXdeliverySecurityGroupLb" },
        "SourceSecurityGroupId": { "Ref": "XgemailCustomerDeliverySecurityGroup" },
        "IpProtocol": "tcp",
        "FromPort": "8025",
        "ToPort": "8025"
      }
    },

    "XgemailXdeliverySecurityGroupLbIngressCustomerDeliverySmtpPub": {
      "Type": "AWS::EC2::SecurityGroupIngress",
      "Properties": {
        "GroupId": { "Ref": "XgemailXdeliverySecurityGroupLb" },
        "SourceSecurityGroupId": { "Ref": "XgemailCustomerDeliverySecurityGroupPub" },
        "IpProtocol": "tcp",
        "FromPort": "8025",
        "ToPort": "8025"
      }
    },    

    "XgemailInternetXdeliverySecurityGroupLbIngressDeliverySmtp": {
      "Type": "AWS::EC2::SecurityGroupIngress",
      "Properties": {
        "GroupId": { "Ref": "XgemailInternetXdeliverySecurityGroupLb" },
        "SourceSecurityGroupId": { "Ref": "XgemailInternetDeliverySecurityGroup" },
        "IpProtocol": "tcp",
        "FromPort": "8025",
        "ToPort": "8025"
      }
    },

    "XgemailRiskyXdeliverySecurityGroupLbIngressDeliverySmtp": {
      "Type": "AWS::EC2::SecurityGroupIngress",
      "Properties": {
        "GroupId": { "Ref": "XgemailRiskyXdeliverySecurityGroupLb" },
        "SourceSecurityGroupId": { "Ref": "XgemailRiskyDeliverySecurityGroup" },
        "IpProtocol": "tcp",
        "FromPort": "8025",
        "ToPort": "8025"
      }
    },

    "XgemailWarmupXdeliverySecurityGroupLbIngressDeliverySmtp": {
      "Type": "AWS::EC2::SecurityGroupIngress",
      "Properties": {
        "GroupId": { "Ref": "XgemailWarmupXdeliverySecurityGroupLb" },
        "SourceSecurityGroupId": { "Ref": "XgemailWarmupDeliverySecurityGroup" },
        "IpProtocol": "tcp",
        "FromPort": "8025",
        "ToPort": "8025"
      }
    },

    "XgemailBetaXdeliverySecurityGroupLbIngressDeliverySmtp": {
      "Type": "AWS::EC2::SecurityGroupIngress",
      "Properties": {
        "GroupId": { "Ref": "XgemailBetaXdeliverySecurityGroupLb" },
        "SourceSecurityGroupId": { "Ref": "XgemailBetaDeliverySecurityGroup" },
        "IpProtocol": "tcp",
        "FromPort": "8025",
        "ToPort": "8025"
      }
    },

    "XgemailDeltaXdeliverySecurityGroupLbIngressDeliverySmtp": {
      "Type": "AWS::EC2::SecurityGroupIngress",
      "Properties": {
        "GroupId": { "Ref": "XgemailDeltaXdeliverySecurityGroupLb" },
        "SourceSecurityGroupId": { "Ref": "XgemailDeltaDeliverySecurityGroup" },
        "IpProtocol": "tcp",
        "FromPort": "8025",
        "ToPort": "8025"
      }
    },

    "XgemailMfInboundXdeliverySecurityGroupLbIngressSmtp": {
      "Type": "AWS::EC2::SecurityGroupIngress",
      "Properties": {
        "GroupId": { "Ref": "XgemailMfInboundXdeliverySecurityGroupLb" },
        "SourceSecurityGroupId": { "Ref": "XgemailMfInboundDeliverySecurityGroup" },
        "IpProtocol": "tcp",
        "FromPort": "8025",
        "ToPort": "8025"
      }
    },

    "XgemailMfOutboundXdeliverySecurityGroupLbIngressDeliverySmtp": {
      "Type": "AWS::EC2::SecurityGroupIngress",
      "Properties": {
        "GroupId": { "Ref": "XgemailMfOutboundXdeliverySecurityGroupLb" },
        "SourceSecurityGroupId": { "Ref": "XgemailMfOutboundDeliverySecurityGroup" },
        "IpProtocol": "tcp",
        "FromPort": "8025",
        "ToPort": "8025"
      }
    },

    "XgemailInternetSubmitSecurityGroupIngressBastionSsh": {
      "Type": "AWS::EC2::SecurityGroupIngress",
      "Properties": {
        "GroupId": { "Ref": "XgemailInternetSubmitSecurityGroup" },
        "SourceSecurityGroupId": { "Ref": "SecurityGroupBastion" },
        "IpProtocol": "tcp",
        "FromPort": "22",
        "ToPort": "22"
      }
    },

    "XgemailMfInboundDeliverySecurityGroupIngressBastionSsh": {
      "Type": "AWS::EC2::SecurityGroupIngress",
      "Properties": {
        "GroupId": { "Ref": "XgemailMfInboundDeliverySecurityGroup" },
        "SourceSecurityGroupId": { "Ref": "SecurityGroupBastion" },
        "IpProtocol": "tcp",
        "FromPort": "22",
        "ToPort": "22"
      }
    },

    "XgemailMfInboundSubmitSecurityGroupIngressBastionSsh": {
      "Type": "AWS::EC2::SecurityGroupIngress",
      "Properties": {
        "GroupId": { "Ref": "XgemailMfInboundSubmitSecurityGroup" },
        "SourceSecurityGroupId": { "Ref": "SecurityGroupBastion" },
        "IpProtocol": "tcp",
        "FromPort": "22",
        "ToPort": "22"
      }
    },

    "XgemailCustomerSubmitSecurityGroupIngressBastionSsh": {
      "Type": "AWS::EC2::SecurityGroupIngress",
      "Properties": {
        "GroupId": { "Ref": "XgemailCustomerSubmitSecurityGroup" },
        "SourceSecurityGroupId": { "Ref": "SecurityGroupBastion" },
        "IpProtocol": "tcp",
        "FromPort": "22",
        "ToPort": "22"
      }
    },

    "XgemailCustomerDeliverySecurityGroupIngressBastionSsh": {
      "Type": "AWS::EC2::SecurityGroupIngress",
      "Properties": {
        "GroupId": { "Ref": "XgemailCustomerDeliverySecurityGroup" },
        "SourceSecurityGroupId": { "Ref": "SecurityGroupBastion" },
        "IpProtocol": "tcp",
        "FromPort": "22",
        "ToPort": "22"
      }
    },

    "XgemailCustomerDeliverySecurityGroupIngressBastionSshPub": {
      "Type": "AWS::EC2::SecurityGroupIngress",
      "Properties": {
        "GroupId": { "Ref": "XgemailCustomerDeliverySecurityGroupPub" },
        "SourceSecurityGroupId": { "Ref": "SecurityGroupBastion" },
        "IpProtocol": "tcp",
        "FromPort": "22",
        "ToPort": "22"
      }
    },    

    "XgemailDeltaDeliverySecurityGroupIngressBastionSsh": {
      "Type": "AWS::EC2::SecurityGroupIngress",
      "Properties": {
        "GroupId": { "Ref": "XgemailDeltaDeliverySecurityGroup" },
        "SourceSecurityGroupId": { "Ref": "SecurityGroupBastion" },
        "IpProtocol": "tcp",
        "FromPort": "22",
        "ToPort": "22"
      }
    },

    "XgemailInternetDeliverySecurityGroupIngressBastionSsh": {
      "Type": "AWS::EC2::SecurityGroupIngress",
      "Properties": {
        "GroupId": { "Ref": "XgemailInternetDeliverySecurityGroup" },
        "SourceSecurityGroupId": { "Ref": "SecurityGroupBastion" },
        "IpProtocol": "tcp",
        "FromPort": "22",
        "ToPort": "22"
      }
    },

    "XgemailRiskyDeliverySecurityGroupIngressBastionSsh": {
      "Type": "AWS::EC2::SecurityGroupIngress",
      "Properties": {
        "GroupId": { "Ref": "XgemailRiskyDeliverySecurityGroup" },
        "SourceSecurityGroupId": { "Ref": "SecurityGroupBastion" },
        "IpProtocol": "tcp",
        "FromPort": "22",
        "ToPort": "22"
      }
    },

    "XgemailWarmupDeliverySecurityGroupIngressBastionSsh": {
      "Type": "AWS::EC2::SecurityGroupIngress",
      "Properties": {
        "GroupId": { "Ref": "XgemailWarmupDeliverySecurityGroup" },
        "SourceSecurityGroupId": { "Ref": "SecurityGroupBastion" },
        "IpProtocol": "tcp",
        "FromPort": "22",
        "ToPort": "22"
      }
    },

    "XgemailBetaDeliverySecurityGroupIngressBastionSsh": {
      "Type": "AWS::EC2::SecurityGroupIngress",
      "Properties": {
        "GroupId": { "Ref": "XgemailBetaDeliverySecurityGroup" },
        "SourceSecurityGroupId": { "Ref": "SecurityGroupBastion" },
        "IpProtocol": "tcp",
        "FromPort": "22",
        "ToPort": "22"
      }
    },

    "XgemailXdeliverySecurityGroupIngressBastionSsh": {
      "Type": "AWS::EC2::SecurityGroupIngress",
      "Properties": {
        "GroupId": {"Ref": "XgemailXdeliverySecurityGroup"},
        "SourceSecurityGroupId": {"Ref": "SecurityGroupBastion"},
        "IpProtocol": "tcp",
        "FromPort": "22",
        "ToPort": "22"
      }
    },

    "XgemailInternetXdeliverySecurityGroupIngressBastionSsh": {
      "Type": "AWS::EC2::SecurityGroupIngress",
      "Properties": {
        "GroupId": {"Ref": "XgemailInternetXdeliverySecurityGroup"},
        "SourceSecurityGroupId": {"Ref": "SecurityGroupBastion"},
        "IpProtocol": "tcp",
        "FromPort": "22",
        "ToPort": "22"
      }
    },

    "XgemailMfOutboundSubmitSecurityGroupIngressBastionSsh": {
      "Type": "AWS::EC2::SecurityGroupIngress",
      "Properties": {
        "GroupId": { "Ref": "XgemailMfOutboundSubmitSecurityGroup" },
        "SourceSecurityGroupId": { "Ref": "SecurityGroupBastion" },
        "IpProtocol": "tcp",
        "FromPort": "22",
        "ToPort": "22"
      }
    },

    "XgemailMfOutboundDeliverySecurityGroupIngressBastionSsh": {
      "Type": "AWS::EC2::SecurityGroupIngress",
      "Properties": {
        "GroupId": { "Ref": "XgemailMfOutboundDeliverySecurityGroup" },
        "SourceSecurityGroupId": { "Ref": "SecurityGroupBastion" },
        "IpProtocol": "tcp",
        "FromPort": "22",
        "ToPort": "22"
      }
    },

    "XgemailMfInboundXdeliverySecurityGroupIngressBastionSsh": {
      "Type": "AWS::EC2::SecurityGroupIngress",
      "Properties": {
        "GroupId": {"Ref": "XgemailMfInboundXdeliverySecurityGroup"},
        "SourceSecurityGroupId": {"Ref": "SecurityGroupBastion"},
        "IpProtocol": "tcp",
        "FromPort": "22",
        "ToPort": "22"
      }
    },

    "XgemailMfOutboundXdeliverySecurityGroupIngressBastionSsh": {
      "Type": "AWS::EC2::SecurityGroupIngress",
      "Properties": {
        "GroupId": {"Ref": "XgemailMfOutboundXdeliverySecurityGroup"},
        "SourceSecurityGroupId": {"Ref": "SecurityGroupBastion"},
        "IpProtocol": "tcp",
        "FromPort": "22",
        "ToPort": "22"
      }
    },

    "XgemailRiskyXdeliverySecurityGroupIngressBastionSsh": {
      "Type": "AWS::EC2::SecurityGroupIngress",
      "Properties": {
        "GroupId": {"Ref": "XgemailRiskyXdeliverySecurityGroup"},
        "SourceSecurityGroupId": {"Ref": "SecurityGroupBastion"},
        "IpProtocol": "tcp",
        "FromPort": "22",
        "ToPort": "22"
      }
    },

    "XgemailWarmupXdeliverySecurityGroupIngressBastionSsh": {
      "Type": "AWS::EC2::SecurityGroupIngress",
      "Properties": {
        "GroupId": {"Ref": "XgemailWarmupXdeliverySecurityGroup"},
        "SourceSecurityGroupId": {"Ref": "SecurityGroupBastion"},
        "IpProtocol": "tcp",
        "FromPort": "22",
        "ToPort": "22"
      }
    },

    "XgemailBetaXdeliverySecurityGroupIngressBastionSsh": {
      "Type": "AWS::EC2::SecurityGroupIngress",
      "Properties": {
        "GroupId": {"Ref": "XgemailBetaXdeliverySecurityGroup"},
        "SourceSecurityGroupId": {"Ref": "SecurityGroupBastion"},
        "IpProtocol": "tcp",
        "FromPort": "22",
        "ToPort": "22"
      }
    },

    "XgemailDeltaXdeliverySecurityGroupIngressBastionSsh": {
      "Type": "AWS::EC2::SecurityGroupIngress",
      "Properties": {
        "GroupId": {"Ref": "XgemailDeltaXdeliverySecurityGroup"},
        "SourceSecurityGroupId": {"Ref": "SecurityGroupBastion"},
        "IpProtocol": "tcp",
        "FromPort": "22",
        "ToPort": "22"
      }
    },

    "XgemailEncryprionDeliverySecurityGroupIngressBastionSsh": {
      "Type": "AWS::EC2::SecurityGroupIngress",
      "Properties": {
        "GroupId": { "Ref": "XgemailEncryptionDeliverySecurityGroup" },
        "SourceSecurityGroupId": { "Ref": "SecurityGroupBastion" },
        "IpProtocol": "tcp",
        "FromPort": "22",
        "ToPort": "22"
      }
    },

    "XgemailEncryptionSubmitSecurityGroupIngressBastionSsh": {
      "Type": "AWS::EC2::SecurityGroupIngress",
      "Properties": {
        "GroupId": { "Ref": "XgemailEncryptionSubmitSecurityGroup" },
        "SourceSecurityGroupId": { "Ref": "SecurityGroupBastion" },
        "IpProtocol": "tcp",
        "FromPort": "22",
        "ToPort": "22"
      }
    },

    "XgemailPolicyEfsMountTargetSecurityGroup": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "Tags": [{
          "Key": "Name",
          "Value": {
            "Fn::Join": [ "", [
              { "Ref": "Environment" }, "-",
              { "Ref": "Branch" }, "-",
              { "Ref": "AWS::StackName" }, "/sg/xgemail/efs/policymount"
            ]]
          }
        },
        {
          "Key": "Application",
          "Value": "cloudemail"
        },
        {
          "Key": "BusinessUnit",
          "Value": "MSG"
        },
        {
          "Key": "Project",
          "Value": "xgemail"
        },
        {
          "Key": "OwnerEmail",
          "Value": "sophosmailops@sophos.com"
        }],
        "VpcId": { "Ref": "Vpc" },
        "GroupDescription": "Controls access to the policy EFS mount targets",
        "SecurityGroupIngress": [
          {
            "IpProtocol": "tcp",
            "FromPort": "2049",
            "ToPort": "2049",
            "SourceSecurityGroupId": { "Ref": "XgemailCustomerSubmitSecurityGroup" }
          },
          {
            "IpProtocol": "tcp",
            "FromPort": "2049",
            "ToPort": "2049",
            "SourceSecurityGroupId": { "Ref": "XgemailInternetSubmitSecurityGroup" }
          },
          {
            "IpProtocol": "tcp",
            "FromPort": "2049",
            "ToPort": "2049",
            "SourceSecurityGroupId": { "Ref": "XgemailMfInboundSubmitSecurityGroup" }
          },
          {
            "IpProtocol": "tcp",
            "FromPort": "2049",
            "ToPort": "2049",
            "SourceSecurityGroupId": { "Ref": "XgemailMfOutboundSubmitSecurityGroup" }
          }
        ]
      }
    },

    "XgemailEcRedisSecurityGroup": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "Tags": [
          {
            "Key": "Branch",
            "Value": { "Ref" : "Branch" }
          },
          {
            "Key": "Environment",
            "Value": { "Ref" : "Environment" }
          },
          {
          "Key": "Name",
          "Value": {
            "Fn::Join": [ "", [
              { "Ref": "Environment" }, "-",
              { "Ref": "Branch" }, "-",
              { "Ref": "AWS::StackName" }, "/sg/xgemail/redis/ec"
            ]]
          }
          },
          {
            "Key": "Application",
            "Value": "cloudemail"
          },
          {
            "Key": "BusinessUnit",
            "Value": "MSG"
          },
          {
            "Key": "Project",
            "Value": "xgemail"
          },
          {
            "Key": "OwnerEmail",
            "Value": "sophosmailops@sophos.com"
          }],
        "VpcId": { "Ref": "Vpc" },
        "GroupDescription": "Controls access to the xgemail-dqs redis cluster",
        "SecurityGroupIngress": [
          {
            "IpProtocol": "tcp",
            "FromPort": "6379",
            "ToPort": "6379",
            "SourceSecurityGroupId": { "Ref": "XgemailCustomerDeliverySecurityGroup" }
          },
          {
            "IpProtocol": "tcp",
            "FromPort": "6379",
            "ToPort": "6379",
            "SourceSecurityGroupId": { "Ref": "XgemailCustomerDeliverySecurityGroupPub" }
          }
        ]
      }
    }
  },

  "Outputs": {
    "SecurityGroupBase": {
      "Description": "ID of the base security group",
      "Value": { "Ref": "SecurityGroupBase" }
    },
    "SecurityGroupJGroups" : {
      "Description" : "Java service JGroups Security Group",
      "Value": { "Ref" : "SecurityGroupJGroups" }
    },
    "SecurityGroupJavaSvcBaseLb": {
      "Description": "Java Load Balancer Security Group",
      "Value": { "Ref": "SecurityGroupJavaSvcBaseLb" }
    },
    "SecurityGroupJavaSvcBase": {
      "Description": "Java instances base Security Group",
      "Value": { "Ref": "SecurityGroupJavaSvcBase" }
    },
    "SecurityGroupExternalIpAccess": {
      "Condition": "ClosedToWorld",
      "Description": "External IP Access security group",
      "Value": { "Ref": "SecurityGroupExternalIpAccess" }
    },
    "SecurityGroupBastion": {
      "Description": "Bastion security group",
      "Value": { "Ref": "SecurityGroupBastion" }
    },
    "SecurityGroupLogicMonitor": {
      "Description": "LogicMonitor Security Group",
      "Value": { "Ref": "SecurityGroupLogicMonitor" }
    },
    "XgemailBetaDeliverySecurityGroupLb": {
      "Description": "Xgemail Beta Delivery Load Balancer security group",
      "Value": { "Ref": "XgemailBetaDeliverySecurityGroupLb" }
    },
    "XgemailBetaDeliverySecurityGroup": {
      "Description": "Xgemail Beta Delivery security group",
      "Value": { "Ref": "XgemailBetaDeliverySecurityGroup" }
    },
    "XgemailBetaXdeliverySecurityGroupLb": {
      "Description": "Xgemail Beta Xdelivery Load Balancer security group",
      "Value": { "Ref": "XgemailBetaXdeliverySecurityGroupLb" }
    },
    "XgemailBetaXdeliverySecurityGroup": {
      "Description": "Xgemail Beta Xdelivery security group",
      "Value": { "Ref": "XgemailBetaXdeliverySecurityGroup" }
    },
    "XgemailCustomerDeliverySecurityGroupLb": {
      "Description": "Xgemail Customer Delivery Load Balancer security group",
      "Value": { "Ref": "XgemailCustomerDeliverySecurityGroupLb" }
    },
    "XgemailCustomerDeliverySecurityGroup": {
      "Description": "Xgemail Customer Delivery security group",
      "Value": { "Ref": "XgemailCustomerDeliverySecurityGroup" }
    },
    "XgemailCustomerDeliverySecurityGroupLbPub": {
      "Description": "Xgemail Customer Delivery Load Balancer security group",
      "Value": { "Ref": "XgemailCustomerDeliverySecurityGroupLbPub" }
    },
    "XgemailCustomerDeliverySecurityGroupPub": {
      "Description": "Xgemail Customer Delivery security group",
      "Value": { "Ref": "XgemailCustomerDeliverySecurityGroupPub" }
    },    
    "XgemailMfInboundDeliverySecurityGroupLb": {
      "Description": "Xgemail Mf Inbound Delivery Load Balancer security group",
      "Value": { "Ref": "XgemailMfInboundDeliverySecurityGroupLb" }
    },
    "XgemailMfInboundDeliverySecurityGroup": {
      "Description": "Xgemail Mf Inbound Delivery security group",
      "Value": { "Ref": "XgemailMfInboundDeliverySecurityGroup" }
    },
    "XgemailXdeliverySecurityGroupLb": {
      "Description": "Xgemail Xdelivery Load Balancer security group",
      "Value": { "Ref": "XgemailXdeliverySecurityGroupLb" }
    },
    "XgemailXdeliverySecurityGroup": {
      "Description": "Xgemail Xdelivery security group",
      "Value": { "Ref": "XgemailXdeliverySecurityGroup" }
    },
    "XgemailInternetDeliverySecurityGroupLb": {
      "Description": "Xgemail Internet Delivery Load Balancer security group",
      "Value": { "Ref": "XgemailInternetDeliverySecurityGroupLb" }
    },
    "XgemailInternetDeliverySecurityGroup": {
      "Description": "Xgemail Internet Delivery security group",
      "Value": { "Ref": "XgemailInternetDeliverySecurityGroup" }
    },
    "XgemailInternetXdeliverySecurityGroupLb": {
      "Description": "Xgemail Internet Xdelivery Load Balancer security group",
      "Value": { "Ref": "XgemailInternetXdeliverySecurityGroupLb" }
    },
    "XgemailInternetXdeliverySecurityGroup": {
      "Description": "Xgemail Internet Xdelivery security group",
      "Value": { "Ref": "XgemailInternetXdeliverySecurityGroup" }
    },
    "XgemailEncryptionDeliverySecurityGroupLb": {
      "Description": "Xgemail Encryption Delivery Load Balancer security group",
      "Value": { "Ref": "XgemailEncryptionDeliverySecurityGroupLb" }
    },
    "XgemailEncryptionDeliverySecurityGroup": {
      "Description": "Xgemail Encryption Delivery security group",
      "Value": { "Ref": "XgemailEncryptionDeliverySecurityGroup" }
    },
    "XgemailRiskyDeliverySecurityGroupLb": {
      "Description": "Xgemail Risky Delivery Load Balancer security group",
      "Value": { "Ref": "XgemailRiskyDeliverySecurityGroupLb" }
    },
    "XgemailRiskyDeliverySecurityGroup": {
      "Description": "Xgemail Risky Delivery security group",
      "Value": { "Ref": "XgemailRiskyDeliverySecurityGroup" }
    },
    "XgemailRiskyXdeliverySecurityGroupLb": {
      "Description": "Xgemail Risky Xdelivery Load Balancer security group",
      "Value": { "Ref": "XgemailRiskyXdeliverySecurityGroupLb" }
    },
    "XgemailRiskyXdeliverySecurityGroup": {
      "Description": "Xgemail Risky Xdelivery security group",
      "Value": { "Ref": "XgemailRiskyXdeliverySecurityGroup" }
    },
    "XgemailCustomerSubmitSecurityGroupLb": {
      "Description": "Xgemail Customer Submit Load Balancer security group",
      "Value": { "Ref": "XgemailCustomerSubmitSecurityGroupLb" }
    },
    "XgemailCustomerSubmitSecurityGroup": {
      "Description": "Xgemail Customer Submit security group",
      "Value": { "Ref": "XgemailCustomerSubmitSecurityGroup" }
    },
    "XgemailDeltaDeliverySecurityGroupLb": {
      "Description": "Xgemail Delta Delivery Load Balancer security group",
      "Value": { "Ref": "XgemailDeltaDeliverySecurityGroupLb" }
    },
    "XgemailDeltaDeliverySecurityGroup": {
      "Description": "Xgemail Delta Delivery security group",
      "Value": { "Ref": "XgemailDeltaDeliverySecurityGroup" }
    },
    "XgemailDeltaXdeliverySecurityGroupLb": {
      "Description": "Xgemail Delta Xdelivery Load Balancer security group",
      "Value": { "Ref": "XgemailDeltaXdeliverySecurityGroupLb" }
    },
    "XgemailDeltaXdeliverySecurityGroup": {
      "Description": "Xgemail Delta Xdelivery security group",
      "Value": { "Ref": "XgemailDeltaXdeliverySecurityGroup" }
    },
    "XgemailInternetSubmitSecurityGroupLb": {
      "Description": "Xgemail Internet Submit Load Balancer security group",
      "Value": { "Ref": "XgemailInternetSubmitSecurityGroupLb" }
    },
    "XgemailInternetSubmitSecurityGroup": {
      "Description": "Xgemail Internet Submit security group",
      "Value": { "Ref": "XgemailInternetSubmitSecurityGroup" }
    },
    "XgemailMfInboundSubmitSecurityGroupLb": {
      "Description": "Xgemail Mf Inbound Submit Load Balancer security group",
      "Value": { "Ref": "XgemailMfInboundSubmitSecurityGroupLb" }
    },
    "XgemailMfInboundSubmitSecurityGroup": {
      "Description": "Xgemail Mf Inbound Submit security group",
      "Value": { "Ref": "XgemailMfInboundSubmitSecurityGroup" }
    },
    "XgemailEncryptionSubmitSecurityGroupLb": {
      "Description": "Xgemail Encryption Submit Load Balancer security group",
      "Value": { "Ref": "XgemailEncryptionSubmitSecurityGroupLb" }
    },
    "XgemailEncryptionSubmitSecurityGroup": {
      "Description": "Xgemail Encryption Submit security group",
      "Value": { "Ref": "XgemailEncryptionSubmitSecurityGroup" }
    },
    "XgemailMfOutboundSubmitSecurityGroupLb": {
      "Description": "Xgemail Mf Outbound Submit Load Balancer security group",
      "Value": { "Ref": "XgemailMfOutboundSubmitSecurityGroupLb" }
    },
    "XgemailMfOutboundSubmitSecurityGroup": {
      "Description": "Xgemail Mf Outbound Submit security group",
      "Value": { "Ref": "XgemailMfOutboundSubmitSecurityGroup" }
    },
    "XgemailMfOutboundDeliverySecurityGroupLb": {
      "Description": "Xgemail Mf Outbound Delivery Load Balancer security group",
      "Value": { "Ref": "XgemailMfOutboundDeliverySecurityGroupLb" }
    },
    "XgemailMfOutboundDeliverySecurityGroup": {
      "Description": "Xgemail Mf Outbound Delivery security group",
      "Value": { "Ref": "XgemailMfOutboundDeliverySecurityGroup" }
    },
    "XgemailMfInboundXdeliverySecurityGroupLb": {
      "Description": "Xgemail Mf Inbound Xdelivery Load Balancer security group",
      "Value": { "Ref": "XgemailMfInboundXdeliverySecurityGroupLb" }
    },
    "XgemailMfInboundXdeliverySecurityGroup": {
      "Description": "Xgemail Mf Inbound Xdelivery security group",
      "Value": { "Ref": "XgemailMfInboundXdeliverySecurityGroup" }
    },
    "XgemailMfOutboundXdeliverySecurityGroupLb": {
      "Description": "Xgemail Mf Outbound Xdelivery Load Balancer security group",
      "Value": { "Ref": "XgemailMfOutboundXdeliverySecurityGroupLb" }
    },
    "XgemailMfOutboundXdeliverySecurityGroup": {
      "Description": "Xgemail Mf Outbound Xdelivery security group",
      "Value": { "Ref": "XgemailMfOutboundXdeliverySecurityGroup" }
    },
    "XgemailPolicyEfsMountTargetSecurityGroup": {
      "Description": "Xgemail EFS mount target security group",
      "Value": { "Ref": "XgemailPolicyEfsMountTargetSecurityGroup" }
    },
    "XgemailPolicyEfsMountTargetSecurityGroupId": {
      "Description": "Xgemail EFS mount target security group Id",
      "Value": { "Fn::GetAtt" : [ "XgemailPolicyEfsMountTargetSecurityGroup", "GroupId" ] }
    },
    "XgemailWarmupDeliverySecurityGroupLb": {
      "Description": "Xgemail Warmup Delivery Load Balancer security group",
      "Value": { "Ref": "XgemailWarmupDeliverySecurityGroupLb" }
    },
    "XgemailWarmupDeliverySecurityGroup": {
      "Description": "Xgemail Warmup Delivery security group",
      "Value": { "Ref": "XgemailWarmupDeliverySecurityGroup" }
    },
    "XgemailWarmupXdeliverySecurityGroupLb": {
      "Description": "Xgemail Warmup Xdelivery Load Balancer security group",
      "Value": { "Ref": "XgemailWarmupXdeliverySecurityGroupLb" }
    },
    "XgemailWarmupXdeliverySecurityGroup": {
      "Description": "Xgemail Warmup Xdelivery security group",
      "Value": { "Ref": "XgemailWarmupXdeliverySecurityGroup" }
    },
    "XgemailElastiCacheRedisSecurityGroup": {
      "Description" : "Security group for Sophos Email ElastiCache Redis",
      "Value": {"Ref": "XgemailEcRedisSecurityGroup"}
    }
  }
}
